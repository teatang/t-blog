<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Peewee ORM 详解：接口使用与实践 | 1024 维度</title><meta name="author" content="TeaTang"><meta name="copyright" content="TeaTang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Peewee 是一个小型、富有表现力、功能齐全的 Python ORM (Object-Relational Mapper)。它提供了一种简单且 Pythonic 的方式来与数据库进行交互，支持 SQLite、PostgreSQL 和 MySQL 等多种关系型数据库。Peewee 的设计理念是轻量级和易用性，使得开发者可以快速地构建应用程序，而无需编写大量的 SQL 语句。  核心思想：将数据库">
<meta property="og:type" content="article">
<meta property="og:title" content="Peewee ORM 详解：接口使用与实践">
<meta property="og:url" content="https://blog.tbf1211.xx.kg/91353ff26772/index.html">
<meta property="og:site_name" content="1024 维度">
<meta property="og:description" content="Peewee 是一个小型、富有表现力、功能齐全的 Python ORM (Object-Relational Mapper)。它提供了一种简单且 Pythonic 的方式来与数据库进行交互，支持 SQLite、PostgreSQL 和 MySQL 等多种关系型数据库。Peewee 的设计理念是轻量级和易用性，使得开发者可以快速地构建应用程序，而无需编写大量的 SQL 语句。  核心思想：将数据库">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-20.jpg">
<meta property="article:published_time" content="2023-11-10T22:24:00.000Z">
<meta property="article:modified_time" content="2026-01-28T09:11:10.453Z">
<meta property="article:author" content="TeaTang">
<meta property="article:tag" content="2023">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="ORM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-20.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Peewee ORM 详解：接口使用与实践",
  "url": "https://blog.tbf1211.xx.kg/91353ff26772/",
  "image": "https://blog.tbf1211.xx.kg/img/cover/default_cover-20.jpg",
  "datePublished": "2023-11-10T22:24:00.000Z",
  "dateModified": "2026-01-28T09:11:10.453Z",
  "author": [
    {
      "@type": "Person",
      "name": "TeaTang",
      "url": "https://blog.tbf1211.xx.kg"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon-1.ico"><link rel="canonical" href="https://blog.tbf1211.xx.kg/91353ff26772/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.9/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":true,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: TeaTang","link":"链接: ","source":"来源: 1024 维度","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Peewee ORM 详解：接口使用与实践',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="1024 维度" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">527</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">229</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/cover/default_cover-20.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">1024 维度</span></a><a class="nav-page-title" href="/"><span class="site-name">Peewee ORM 详解：接口使用与实践</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Peewee ORM 详解：接口使用与实践</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-11-10T22:24:00.000Z" title="发表于 2023-11-11 06:24:00">2023-11-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Python/">Python</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Python/%E5%BA%93/">库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">5.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>21分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><strong>Peewee</strong> 是一个小型、富有表现力、功能齐全的 Python ORM (Object-Relational Mapper)。它提供了一种简单且 Pythonic 的方式来与数据库进行交互，支持 SQLite、PostgreSQL 和 MySQL 等多种关系型数据库。Peewee 的设计理念是轻量级和易用性，使得开发者可以快速地构建应用程序，而无需编写大量的 SQL 语句。</p>
</blockquote>
<div class="note info flat"><p>核心思想：<strong>将数据库表映射为 Python 类，将表的行映射为类的实例，将表的列映射为类的属性。</strong> 通过 Python 对象和方法来操作数据库，从而抽象掉底层的 SQL 细节。</p>
</div>
<hr>
<h2 id="一、为什么选择-Peewee？"><a href="#一、为什么选择-Peewee？" class="headerlink" title="一、为什么选择 Peewee？"></a>一、为什么选择 Peewee？</h2><p>在 Python 生态中，存在多种 ORM 解决方案，如 SQLAlchemy、Django ORM 等。Peewee 在其中脱颖而出，主要归因于以下特点：</p>
<ol>
<li><strong>轻量级与简洁性</strong>：Peewee 本身代码量较少，API 设计简洁直观，学习曲线平缓。</li>
<li><strong>富有表现力</strong>：其查询 API 允许开发者使用类似 Python 原生语法的方式链式调用，构建复杂的查询。</li>
<li><strong>兼容性强</strong>：支持 SQLite、PostgreSQL 和 MySQL 等主流关系型数据库，通过安装对应的驱动即可切换。</li>
<li><strong>灵活性</strong>：虽然是 ORM，但不完全限制对 SQL 的使用，允许执行原始 SQL 语句。</li>
<li><strong>活跃开发</strong>：项目维护者积极响应问题和功能请求。</li>
</ol>
<h2 id="二、关键概念"><a href="#二、关键概念" class="headerlink" title="二、关键概念"></a>二、关键概念</h2><p>在使用 Peewee 之前，理解几个核心概念至关重要。</p>
<ol>
<li><strong>ORM (Object-Relational Mapper)</strong><ul>
<li><strong>定义</strong>：ORM 是一种编程技术，用于在面向对象编程语言和关系型数据库之间转换数据。它允许开发者使用对象的概念来操作数据库，而不是直接编写 SQL 语句。ORM 充当了对象模型和关系模型之间的桥梁。</li>
</ul>
</li>
<li><strong>Database (数据库)</strong><ul>
<li><strong>定义</strong>：在 Peewee 中，<code>Database</code> 类（如 <code>SqliteDatabase</code>, <code>PostgresqlDatabase</code>, <code>MySQLDatabase</code>）代表一个特定的数据库连接。所有模型都必须绑定到一个数据库实例才能执行操作。</li>
</ul>
</li>
<li><strong>Model (模型)</strong><ul>
<li><strong>定义</strong>：<code>Model</code> 类是 Peewee 的核心。每个 <code>Model</code> 子类都映射到数据库中的一张表。<code>Model</code> 定义了表的结构，包括字段、关系和元信息。</li>
</ul>
</li>
<li><strong>Field (字段)</strong><ul>
<li><strong>定义</strong>：<code>Field</code> 类（如 <code>CharField</code>, <code>IntegerField</code>, <code>DateTimeField</code>）映射到数据库表中的列。每个字段定义了列的数据类型、约束（如主键、非空、默认值、唯一性）以及其他属性。</li>
</ul>
</li>
<li><strong>Query (查询)</strong><ul>
<li><strong>定义</strong>：Peewee 提供了强大的查询 API，用于构建 <code>SELECT</code>、<code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code> 等 SQL 操作。这些查询通常通过 <code>Model</code> 类的方法或 <code>SelectQuery</code> 对象链式调用来完成。</li>
</ul>
</li>
<li><strong>Transaction (事务)</strong><ul>
<li><strong>定义</strong>：事务是一组原子操作，要么全部成功提交，要么全部失败回滚。Peewee 提供了 <code>atomic()</code> 上下文管理器来简化事务管理。</li>
</ul>
</li>
</ol>
<h2 id="三、数据库设置与连接"><a href="#三、数据库设置与连接" class="headerlink" title="三、数据库设置与连接"></a>三、数据库设置与连接</h2><p>Peewee 支持多种数据库。首先需要安装相应的 Python 驱动（例如，SQLite 无需额外安装，PostgreSQL 需要 <code>psycopg2</code>，MySQL 需要 <code>PyMySQL</code> 或 <code>mysqlclient</code>）。</p>
<h3 id="3-1-引入数据库模块"><a href="#3-1-引入数据库模块" class="headerlink" title="3.1 引入数据库模块"></a>3.1 引入数据库模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 针对不同数据库类型，引入对应的数据库类</span></span><br><span class="line"><span class="comment"># SQLite</span></span><br><span class="line"><span class="comment"># db = SqliteDatabase(&#x27;my_database.db&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PostgreSQL</span></span><br><span class="line"><span class="comment"># db = PostgresqlDatabase(&#x27;my_database&#x27;, user=&#x27;my_user&#x27;, password=&#x27;my_password&#x27;, host=&#x27;localhost&#x27;, port=5432)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL</span></span><br><span class="line"><span class="comment"># db = MySQLDatabase(&#x27;my_database&#x27;, user=&#x27;my_user&#x27;, password=&#x27;my_password&#x27;, host=&#x27;localhost&#x27;, port=3306)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以 SQLite 为例进行演示</span></span><br><span class="line">db = SqliteDatabase(<span class="string">&#x27;example.db&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-2-连接与关闭"><a href="#3-2-连接与关闭" class="headerlink" title="3.2 连接与关闭"></a>3.2 连接与关闭</h3><p>数据库连接一般通过 <code>db.connect()</code> 建立，并在操作完成后通过 <code>db.close()</code> 关闭。推荐使用 <code>with</code> 语句进行连接管理，确保连接正确关闭。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手动连接与关闭</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    db.connect()</span><br><span class="line">    <span class="comment"># 数据库操作</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    db.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用上下文管理器 (推荐)</span></span><br><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    <span class="comment"># 数据库操作</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;数据库连接已建立并将在退出with块后自动关闭。&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="四、定义模型-Model"><a href="#四、定义模型-Model" class="headerlink" title="四、定义模型 (Model)"></a>四、定义模型 (Model)</h2><p>模型是 Peewee 中映射数据库表的核心。每个模型类都应继承自 <code>peewee.Model</code>，并定义对应的字段。</p>
<h3 id="4-1-基本模型定义"><a href="#4-1-基本模型定义" class="headerlink" title="4.1 基本模型定义"></a>4.1 基本模型定义</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BaseModel</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        database = db <span class="comment"># 将模型绑定到之前定义的数据库实例</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="comment"># Field definitions -- start</span></span><br><span class="line">    <span class="built_in">id</span> = AutoField(primary_key=<span class="literal">True</span>) <span class="comment"># 主键，自增</span></span><br><span class="line">    username = CharField(max_length=<span class="number">50</span>, unique=<span class="literal">True</span>, index=<span class="literal">True</span>) <span class="comment"># 字符串，最大长度50，唯一，上有索引</span></span><br><span class="line">    email = CharField(max_length=<span class="number">100</span>, unique=<span class="literal">True</span>, null=<span class="literal">False</span>) <span class="comment"># 非空，唯一</span></span><br><span class="line">    password_hash = CharField(max_length=<span class="number">128</span>)</span><br><span class="line">    is_active = BooleanField(default=<span class="literal">True</span>) <span class="comment"># 布尔类型，默认True</span></span><br><span class="line">    created_at = DateTimeField(default=datetime.datetime.now) <span class="comment"># 日期时间类型，默认当前时间</span></span><br><span class="line">    <span class="comment"># Field definitions -- end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        table_name = <span class="string">&#x27;users&#x27;</span> <span class="comment"># 可选，指定表名，默认为类名小写</span></span><br><span class="line">        order_by = (<span class="string">&#x27;username&#x27;</span>,) <span class="comment"># 可选，查询时默认排序</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Post</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    title = CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    content = TextField() <span class="comment"># 文本类型，无长度限制</span></span><br><span class="line">    author = ForeignKeyField(User, backref=<span class="string">&#x27;posts&#x27;</span>) <span class="comment"># 外键，关联 User 模型，通过 user.posts 反向查询</span></span><br><span class="line">    published_at = DateTimeField(null=<span class="literal">True</span>)</span><br><span class="line">    is_published = BooleanField(default=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p><strong>关键字段类型与选项</strong>：</p>
<ul>
<li><strong><code>AutoField</code></strong>: 主键，自动增长。</li>
<li><strong><code>CharField(max_length)</code></strong>: 字符串类型，必须指定最大长度。</li>
<li><strong><code>TextField()</code></strong>: 长文本类型，无长度限制。</li>
<li><strong><code>IntegerField()</code></strong>: 整数类型。</li>
<li><strong><code>BigIntegerField()</code></strong>: 大整数类型。</li>
<li><strong><code>FloatField()</code></strong>: 浮点数类型。</li>
<li><strong><code>BooleanField()</code></strong>: 布尔类型。</li>
<li><strong><code>DateTimeField()</code>&#x2F;<code>DateField()</code>&#x2F;<code>TimeField()</code></strong>: 日期&#x2F;时间类型。</li>
<li><strong><code>DecimalField(max_digits, decimal_places)</code></strong>: 定点数类型，用于精确的货币等。</li>
<li><strong><code>BlobField()</code></strong>: 二进制数据类型。</li>
<li><strong><code>ForeignKeyField(Model, backref=...)</code></strong>: 外键，<code>backref</code> 用于反向查询。</li>
</ul>
<p><strong>常见字段选项</strong>：</p>
<ul>
<li><code>primary_key=True</code>: 设为表主键。</li>
<li><code>unique=True</code>: 确保列值唯一。</li>
<li><code>null=True</code>&#x2F;<code>null=False</code>: 允许&#x2F;不允许 NULL 值。</li>
<li><code>default=...</code>: 列的默认值。</li>
<li><code>index=True</code>: 为列创建索引，加快查询速度。</li>
<li><code>verbose_name=&quot;...&quot;</code>: 字段的描述性名称（仅在一些高级ORM中用于表单&#x2F;管理界面）。</li>
</ul>
<h3 id="4-2-定义关系-Relationships"><a href="#4-2-定义关系-Relationships" class="headerlink" title="4.2 定义关系 (Relationships)"></a>4.2 定义关系 (Relationships)</h3><p>Peewee 通过 <code>ForeignKeyField</code> 定义模型之间的关系。</p>
<p><strong>一对多 (One-to-Many)</strong>：<br>在 <code>Post</code> 模型中的 <code>author = ForeignKeyField(User, backref=&#39;posts&#39;)</code> 定义了 <code>Post</code> 与 <code>User</code> 之间的一对多关系：一个用户可以有多篇文章，一篇文章只属于一个用户。<br><code>backref=&#39;posts&#39;</code> 允许我们通过 <code>user_instance.posts</code> 访问该用户的所有文章。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Comment</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    text = TextField()</span><br><span class="line">    user = ForeignKeyField(User, backref=<span class="string">&#x27;comments&#x27;</span>) <span class="comment"># 评论属于哪个用户</span></span><br><span class="line">    post = ForeignKeyField(Post, backref=<span class="string">&#x27;comments&#x27;</span>) <span class="comment"># 评论属于哪篇文章</span></span><br><span class="line">    created_at = DateTimeField(default=datetime.datetime.now)</span><br></pre></td></tr></table></figure>

<p>现在，我们有一个用户、文章和评论的简单 ERD (Entity-Relationship Diagram)：</p>
<div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    erDiagram
    USER ||--o{ POST : posts
    USER ||--o{ COMMENT : comments
    POST ||--o{ COMMENT : comments
    USER {
        int id PK
        varchar username &quot;UK,IX&quot;
        varchar email UK
        varchar password_hash
        boolean is_active
        datetime created_at
    }
    POST {
        int id PK
        varchar title
        text content
        int author_id FK
        datetime published_at
        boolean is_published
    }
    COMMENT {
        int id PK
        text text
        int user_id FK
        int post_id FK
        datetime created_at
    }
  </pre></div>

<h2 id="五、数据库操作-CRUD"><a href="#五、数据库操作-CRUD" class="headerlink" title="五、数据库操作 (CRUD)"></a>五、数据库操作 (CRUD)</h2><h3 id="5-1-创建表"><a href="#5-1-创建表" class="headerlink" title="5.1 创建表"></a>5.1 创建表</h3><p>在模型定义完成后，需要将它们同步到数据库中，创建实际的表。<br><strong>注意：</strong> <code>db.create_tables()</code> 只会创建不存在的表。如果表已存在，它不会做任何操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    db.create_tables([User, Post, Comment])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;表已创建或已存在。&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-2-增加数据-Create"><a href="#5-2-增加数据-Create" class="headerlink" title="5.2 增加数据 (Create)"></a>5.2 增加数据 (Create)</h3><h4 id="5-2-1-Model-create"><a href="#5-2-1-Model-create" class="headerlink" title="5.2.1 Model.create()"></a>5.2.1 <code>Model.create()</code></h4><p>这是最常见的创建新对象的方式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    <span class="comment"># 创建用户</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        alice = User.create(username=<span class="string">&#x27;alice&#x27;</span>, email=<span class="string">&#x27;alice@example.com&#x27;</span>, password_hash=<span class="string">&#x27;hash1&#x27;</span>)</span><br><span class="line">        bob = User.create(username=<span class="string">&#x27;bob&#x27;</span>, email=<span class="string">&#x27;bob@example.com&#x27;</span>, password_hash=<span class="string">&#x27;hash2&#x27;</span>)</span><br><span class="line">        charlie = User.create(username=<span class="string">&#x27;charlie&#x27;</span>, email=<span class="string">&#x27;charlie@example.com&#x27;</span>, password_hash=<span class="string">&#x27;hash3&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;用户 <span class="subst">&#123;alice.username&#125;</span>, <span class="subst">&#123;bob.username&#125;</span>, <span class="subst">&#123;charlie.username&#125;</span> 已创建。&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> IntegrityError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;创建用户失败 (可能已存在): <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建文章</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        post1 = Post.create(title=<span class="string">&#x27;Peewee入门&#x27;</span>, content=<span class="string">&#x27;这是一篇关于Peewee的文章。&#x27;</span>, author=alice, is_published=<span class="literal">True</span>)</span><br><span class="line">        post2 = Post.create(title=<span class="string">&#x27;Peewee高级特性&#x27;</span>, content=<span class="string">&#x27;本文探讨Peewee的一些高级用法。&#x27;</span>, author=alice, is_published=<span class="literal">False</span>)</span><br><span class="line">        post3 = Post.create(title=<span class="string">&#x27;我的第一篇文章&#x27;</span>, content=<span class="string">&#x27;Hello World!&#x27;</span>, author=bob, is_published=<span class="literal">True</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;文章 <span class="subst">&#123;post1.title&#125;</span>, <span class="subst">&#123;post2.title&#125;</span>, <span class="subst">&#123;post3.title&#125;</span> 已创建。&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> IntegrityError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;创建文章失败 (可能已存在): <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建评论</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        Comment.create(text=<span class="string">&#x27;很棒的入门教程！&#x27;</span>, user=bob, post=post1)</span><br><span class="line">        Comment.create(text=<span class="string">&#x27;期待高级特性。&#x27;</span>, user=charlie, post=post1)</span><br><span class="line">        Comment.create(text=<span class="string">&#x27;学习了！&#x27;</span>, user=alice, post=post3)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;评论已创建。&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> IntegrityError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;创建评论失败 (可能已存在): <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="5-2-2-实例创建和-save"><a href="#5-2-2-实例创建和-save" class="headerlink" title="5.2.2 实例创建和 save()"></a>5.2.2 实例创建和 <code>save()</code></h4><p>可以先创建模型实例，设置属性，再通过 <code>save()</code> 存储到数据库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    eve = User(username=<span class="string">&#x27;eve&#x27;</span>, email=<span class="string">&#x27;eve@example.com&#x27;</span>, password_hash=<span class="string">&#x27;hash_eve&#x27;</span>)</span><br><span class="line">    eve.save() <span class="comment"># 插入新记录</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;用户 <span class="subst">&#123;eve.username&#125;</span> 已通过实例方法创建。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果是更新现有记录，也使用 save()</span></span><br><span class="line">    eve.email = <span class="string">&#x27;new_eve@example.com&#x27;</span></span><br><span class="line">    eve.save() <span class="comment"># 更新现有记录</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;用户 <span class="subst">&#123;eve.username&#125;</span> 的邮箱已更新。&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="5-2-3-bulk-create-insert-many"><a href="#5-2-3-bulk-create-insert-many" class="headerlink" title="5.2.3 bulk_create() &#x2F; insert_many()"></a>5.2.3 <code>bulk_create()</code> &#x2F; <code>insert_many()</code></h4><p>用于批量插入数据，效率更高。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    users_to_add = [</span><br><span class="line">        &#123;<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;frank&#x27;</span>, <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;frank@example.com&#x27;</span>, <span class="string">&#x27;password_hash&#x27;</span>: <span class="string">&#x27;h1&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;grace&#x27;</span>, <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;grace@example.com&#x27;</span>, <span class="string">&#x27;password_hash&#x27;</span>: <span class="string">&#x27;h2&#x27;</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># Peewee 3.x 使用 insert_many</span></span><br><span class="line">    User.insert_many(users_to_add).execute()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Frank 和 Grace 已批量创建。&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-3-查询数据-Read"><a href="#5-3-查询数据-Read" class="headerlink" title="5.3 查询数据 (Read)"></a>5.3 查询数据 (Read)</h3><p>查询是 ORM 最常用和最重要的功能之一。</p>
<h4 id="5-3-1-Model-select"><a href="#5-3-1-Model-select" class="headerlink" title="5.3.1 Model.select()"></a>5.3.1 <code>Model.select()</code></h4><p><code>select()</code> 方法返回一个 <code>SelectQuery</code> 对象，可以用于构建复杂的查询。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    <span class="comment"># 查询所有用户</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 所有用户 ---&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> User.select():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ID: <span class="subst">&#123;user.<span class="built_in">id</span>&#125;</span>, Username: <span class="subst">&#123;user.username&#125;</span>, Email: <span class="subst">&#123;user.email&#125;</span>, Active: <span class="subst">&#123;user.is_active&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询特定用户 (使用 .get() 方法，如果未找到会抛出 DoesNotExist 异常)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 特定用户 (alice) ---&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        alice = User.get(User.username == <span class="string">&#x27;alice&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;找到了 Alice: ID=<span class="subst">&#123;alice.<span class="built_in">id</span>&#125;</span>, Email=<span class="subst">&#123;alice.email&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> User.DoesNotExist:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;未找到 Alice。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询特定用户 (使用 .get_or_none() 方法，未找到返回 None)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 特定用户 (not_exist_user) ---&quot;</span>)</span><br><span class="line">    not_exist_user = User.get_or_none(User.username == <span class="string">&#x27;not_exist_user&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> not_exist_user:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;找到了 Not Exist User: <span class="subst">&#123;not_exist_user.username&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;未找到 Not Exist User。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询所有已发布的文章</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 所有已发布的文章 ---&quot;</span>)</span><br><span class="line">    published_posts = Post.select().where(Post.is_published == <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> post <span class="keyword">in</span> published_posts:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Title: <span class="subst">&#123;post.title&#125;</span>, Author: <span class="subst">&#123;post.author.username&#125;</span>&quot;</span>) <span class="comment"># .author 是一个 User 对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询 Alice 发布的所有文章</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- Alice 发布的所有文章 ---&quot;</span>)</span><br><span class="line">    alice_posts = Post.select().join(User).where(User.username == <span class="string">&#x27;alice&#x27;</span>)</span><br><span class="line">    <span class="comment"># 或者直接使用 alice 实例</span></span><br><span class="line">    <span class="comment"># alice = User.get(User.username == &#x27;alice&#x27;)</span></span><br><span class="line">    <span class="comment"># alice_posts = Post.select().where(Post.author == alice)</span></span><br><span class="line">    <span class="keyword">for</span> post <span class="keyword">in</span> alice_posts:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Title: <span class="subst">&#123;post.title&#125;</span>, Content: <span class="subst">&#123;post.content[:<span class="number">30</span>]&#125;</span>...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询包含特定关键词的文章，并按发布时间倒序</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 包含&#x27;Peewee&#x27;关键词的文章，按发布时间倒序 ---&quot;</span>)</span><br><span class="line">    peewee_posts = Post.select().where(Post.title.contains(<span class="string">&#x27;Peewee&#x27;</span>)).order_by(Post.published_at.desc())</span><br><span class="line">    <span class="keyword">for</span> post <span class="keyword">in</span> peewee_posts:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Title: <span class="subst">&#123;post.title&#125;</span>, Published At: <span class="subst">&#123;post.published_at&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 限制和偏移 (Limit &amp; Offset)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 最新的2篇文章 ---&quot;</span>)</span><br><span class="line">    latest_posts = Post.select().order_by(Post.created_at.desc()).limit(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> post <span class="keyword">in</span> latest_posts:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Title: <span class="subst">&#123;post.title&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 聚合查询 (Count)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n--- 文章总数: <span class="subst">&#123;Post.select().count()&#125;</span> ---&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Alice 发布的文章数量: <span class="subst">&#123;Post.select().where(Post.author.username == <span class="string">&#x27;alice&#x27;</span>).count()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 聚合查询 (Average)</span></span><br><span class="line">    <span class="comment"># 假设我们有一个 NumericField，这里使用一个不存在的字段作为示例</span></span><br><span class="line">    <span class="comment"># avg_value = Post.select(fn.AVG(Post.views_count)).scalar()</span></span><br><span class="line">    <span class="comment"># print(f&quot;平均浏览量: &#123;avg_value&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用 `fn` (Functions)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 按用户统计文章数量 ---&quot;</span>)</span><br><span class="line">    posts_by_author = (User</span><br><span class="line">                       .select(User.username, fn.COUNT(Post.<span class="built_in">id</span>).alias(<span class="string">&#x27;post_count&#x27;</span>))</span><br><span class="line">                       .join(Post, JOIN.LEFT_OUTER) <span class="comment"># 使用左连接，即使没有文章的用户也会被统计</span></span><br><span class="line">                       .group_by(User.username)</span><br><span class="line">                       .order_by(fn.COUNT(Post.<span class="built_in">id</span>).desc()))</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> posts_by_author:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;用户: <span class="subst">&#123;item.username&#125;</span>, 文章数量: <span class="subst">&#123;item.post_count&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询所有评论，并同时获取评论的用户和文章信息 (N+1 问题优化)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 查询所有评论及关联的用户和文章 ---&quot;</span>)</span><br><span class="line">    <span class="comment"># `prefetch` 会执行两次查询：一次获取Comment，一次获取关联的User和Post</span></span><br><span class="line">    <span class="keyword">for</span> comment <span class="keyword">in</span> Comment.select().prefetch(User, Post):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;评论: &#x27;<span class="subst">&#123;comment.text&#125;</span>&#x27; by <span class="subst">&#123;comment.user.username&#125;</span> on &#x27;<span class="subst">&#123;comment.post.title&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 指定 select 哪些列</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 仅查询用户名和邮箱 ---&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> user_data <span class="keyword">in</span> User.select(User.username, User.email):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Username: <span class="subst">&#123;user_data.username&#125;</span>, Email: <span class="subst">&#123;user_data.email&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="5-3-2-复杂的-where-条件"><a href="#5-3-2-复杂的-where-条件" class="headerlink" title="5.3.2 复杂的 where 条件"></a>5.3.2 复杂的 <code>where</code> 条件</h4><p>使用 <code>&amp;</code> (AND) 和 <code>|</code> (OR) 操作符来组合条件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    <span class="comment"># 查询 Alice 或 Bob 发布且已发布的文章</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- Alice 或 Bob 发布且已发布的文章 ---&quot;</span>)</span><br><span class="line">    users = (User.username == <span class="string">&#x27;alice&#x27;</span>) | (User.username == <span class="string">&#x27;bob&#x27;</span>)</span><br><span class="line">    published_by_alice_or_bob = Post.select().join(User).where(users &amp; (Post.is_published == <span class="literal">True</span>))</span><br><span class="line">    <span class="keyword">for</span> post <span class="keyword">in</span> published_by_alice_or_bob:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Title: <span class="subst">&#123;post.title&#125;</span>, Author: <span class="subst">&#123;post.author.username&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用 `in_` 和 `not_in`</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 用户名在列表中的用户 ---&quot;</span>)</span><br><span class="line">    users_in_list = User.select().where(User.username.in_([<span class="string">&#x27;alice&#x27;</span>, <span class="string">&#x27;charlie&#x27;</span>]))</span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> users_in_list:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Username: <span class="subst">&#123;user.username&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="5-3-3-原始-SQL"><a href="#5-3-3-原始-SQL" class="headerlink" title="5.3.3 原始 SQL"></a>5.3.3 原始 SQL</h4><p>当 Peewee 的查询 API 无法满足需求时，可以使用原始 SQL。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 原始 SQL 查询 (所有用户) ---&quot;</span>)</span><br><span class="line">    cursor = db.execute_sql(<span class="string">&#x27;SELECT id, username, email FROM users;&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> cursor.fetchall():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ID: <span class="subst">&#123;row[<span class="number">0</span>]&#125;</span>, Username: <span class="subst">&#123;row[<span class="number">1</span>]&#125;</span>, Email: <span class="subst">&#123;row[<span class="number">2</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 原始 SQL 查询 (带参数) ---&quot;</span>)</span><br><span class="line">    <span class="comment"># 参数化查询防止 SQL 注入</span></span><br><span class="line">    username_param = <span class="string">&#x27;bob&#x27;</span></span><br><span class="line">    cursor = db.execute_sql(<span class="string">&#x27;SELECT * FROM users WHERE username = ?;&#x27;</span>, (username_param,))</span><br><span class="line">    bob_user_raw = cursor.fetchone()</span><br><span class="line">    <span class="keyword">if</span> bob_user_raw:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Raw query found Bob: <span class="subst">&#123;bob_user_raw&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 通过 Model.raw() 返回 Model 实例</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- Model.raw() 查询 ---&quot;</span>)</span><br><span class="line">    raw_query_users = User.raw(<span class="string">&#x27;SELECT * FROM users WHERE is_active = ?&#x27;</span>, <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> raw_query_users:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Raw query model: <span class="subst">&#123;user.username&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-4-更新数据-Update"><a href="#5-4-更新数据-Update" class="headerlink" title="5.4 更新数据 (Update)"></a>5.4 更新数据 (Update)</h3><h4 id="5-4-1-更新单个实例"><a href="#5-4-1-更新单个实例" class="headerlink" title="5.4.1 更新单个实例"></a>5.4.1 更新单个实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    <span class="comment"># 获取需要更新的实例</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        alice = User.get(User.username == <span class="string">&#x27;alice&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n--- 更新 Alice 的邮箱 ---&quot;</span>)</span><br><span class="line">        old_email = alice.email</span><br><span class="line">        alice.email = <span class="string">&#x27;alice_new@example.com&#x27;</span> <span class="comment"># 修改属性</span></span><br><span class="line">        alice.save() <span class="comment"># 保存更改到数据库</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Alice 的邮箱从 <span class="subst">&#123;old_email&#125;</span> 更新为 <span class="subst">&#123;alice.email&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> User.DoesNotExist:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Alice 不存在，无法更新。&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="5-4-2-批量更新"><a href="#5-4-2-批量更新" class="headerlink" title="5.4.2 批量更新"></a>5.4.2 批量更新</h4><p>使用 <code>Model.update().where()</code> 进行批量更新。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    <span class="comment"># 启用所有非活跃用户</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 批量更新：启用所有非活跃用户 ---&quot;</span>)</span><br><span class="line">    inactive_count = User.select().where(User.is_active == <span class="literal">False</span>).count()</span><br><span class="line">    <span class="keyword">if</span> inactive_count &gt; <span class="number">0</span>:</span><br><span class="line">        updated_count = User.update(is_active=<span class="literal">True</span>).where(User.is_active == <span class="literal">False</span>).execute()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;更新了 <span class="subst">&#123;updated_count&#125;</span> 个非活跃用户，将其设为活跃。&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;没有非活跃用户需要更新。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 批量发布 Bob 的文章</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 批量发布 Bob 的文章 ---&quot;</span>)</span><br><span class="line">    updated_posts_count = Post.update(is_published=<span class="literal">True</span>, published_at=datetime.datetime.now()).where(Post.author.username == <span class="string">&#x27;bob&#x27;</span>).execute()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;发布了 <span class="subst">&#123;updated_posts_count&#125;</span> 篇 Bob 的文章。&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-5-删除数据-Delete"><a href="#5-5-删除数据-Delete" class="headerlink" title="5.5 删除数据 (Delete)"></a>5.5 删除数据 (Delete)</h3><h4 id="5-5-1-删除单个实例"><a href="#5-5-1-删除单个实例" class="headerlink" title="5.5.1 删除单个实例"></a>5.5.1 删除单个实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    <span class="comment"># 删除 Grace 用户</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        grace = User.get(User.username == <span class="string">&#x27;grace&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n--- 删除 Grace 用户 ---&quot;</span>)</span><br><span class="line">        grace.delete_instance() <span class="comment"># 删除实例</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;用户 <span class="subst">&#123;grace.username&#125;</span> 已删除。&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> User.DoesNotExist:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Grace 不存在，无法删除。&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="5-5-2-批量删除"><a href="#5-5-2-批量删除" class="headerlink" title="5.5.2 批量删除"></a>5.5.2 批量删除</h4><p>使用 <code>Model.delete().where()</code> 进行批量删除。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    <span class="comment"># 删除所有未发布的文章</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- 批量删除：删除所有未发布的文章 ---&quot;</span>)</span><br><span class="line">    deleted_count = Post.delete().where(Post.is_published == <span class="literal">False</span>).execute()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;删除了 <span class="subst">&#123;deleted_count&#125;</span> 篇未发布的文章。&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：外键约束 (Foreign Key Constraints) 可能会影响删除操作。默认情况下，如果存在依赖该记录的外键时进行删除，数据库会阻止删除操作。可以通过在 <code>ForeignKeyField</code> 中设置 <code>on_delete=&#39;CASCADE&#39;</code> 来实现级联删除。</p>
<h2 id="六、事务-Transactions"><a href="#六、事务-Transactions" class="headerlink" title="六、事务 (Transactions)"></a>六、事务 (Transactions)</h2><p>事务确保一组数据库操作的原子性。如果其中任何一个操作失败，整个事务都会回滚，所有更改都不会被保存。</p>
<p>Peewee 提供了 <code>db.atomic()</code> 上下文管理器来简化事务处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    <span class="comment"># 模拟一个事务，其中一个操作会失败</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> db.atomic(): <span class="comment"># 开启一个事务</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n--- 事务开始 ---&quot;</span>)</span><br><span class="line">            <span class="comment"># 这是一个成功的操作</span></span><br><span class="line">            User.create(username=<span class="string">&#x27;transaction_user_1&#x27;</span>, email=<span class="string">&#x27;t1@example.com&#x27;</span>, password_hash=<span class="string">&#x27;t1&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;创建了 transaction_user_1&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 这是一个会失败的操作 (attempt to create a user with existing unique username &#x27;alice&#x27;)</span></span><br><span class="line">            User.create(username=<span class="string">&#x27;alice&#x27;</span>, email=<span class="string">&#x27;t2@example.com&#x27;</span>, password_hash=<span class="string">&#x27;t2&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;尝试创建 transaction_user_2 (应该失败)&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果上面语句成功，才会执行到这里</span></span><br><span class="line">            User.create(username=<span class="string">&#x27;transaction_user_3&#x27;</span>, email=<span class="string">&#x27;t3@example.com&#x27;</span>, password_hash=<span class="string">&#x27;t3&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;创建了 transaction_user_3&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--- 事务提交 (如果所有操作成功) ---&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> IntegrityError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;--- 事务回滚！发生错误: <span class="subst">&#123;e&#125;</span> ---&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;--- 事务回滚！发生未知错误: <span class="subst">&#123;e&#125;</span> ---&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    <span class="comment"># 验证事务回滚：确保 transaction_user_1 和 transaction_user_3 不存在</span></span><br><span class="line">    t1 = User.get_or_none(User.username == <span class="string">&#x27;transaction_user_1&#x27;</span>)</span><br><span class="line">    t3 = User.get_or_none(User.username == <span class="string">&#x27;transaction_user_3&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;User transaction_user_1 存在: <span class="subst">&#123;<span class="built_in">bool</span>(t1)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;User transaction_user_3 存在: <span class="subst">&#123;<span class="built_in">bool</span>(t3)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>运行上述代码，<code>transaction_user_1</code> 和 <code>transaction_user_3</code> 都不会被创建，因为 <code>User.create(username=&#39;alice&#39;, ...)</code> 违反了唯一性约束，导致事务回滚。</p>
<h2 id="七、高级特性"><a href="#七、高级特性" class="headerlink" title="七、高级特性"></a>七、高级特性</h2><h3 id="7-1-数据库代理-DatabaseProxy"><a href="#7-1-数据库代理-DatabaseProxy" class="headerlink" title="7.1 数据库代理 (DatabaseProxy)"></a>7.1 数据库代理 (<code>DatabaseProxy</code>)</h3><p>在某些场景下，你可能无法在定义模型时立即提供数据库实例（例如，在应用启动时动态配置数据库）。<code>DatabaseProxy</code> 允许你先定义模型，之后再将实际的数据库实例绑定到代理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建一个数据库代理</span></span><br><span class="line">proxy_db = DatabaseProxy()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProxyBaseModel</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        database = proxy_db <span class="comment"># 模型绑定到代理</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserProxy</span>(<span class="title class_ inherited__">ProxyBaseModel</span>):</span><br><span class="line">    name = CharField()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时，UserProxy 无法进行数据库操作</span></span><br><span class="line"><span class="comment"># UserProxy.create_table() 会报错</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 之后，将实际的数据库绑定到代理</span></span><br><span class="line">actual_db = SqliteDatabase(<span class="string">&#x27;:memory:&#x27;</span>) <span class="comment"># 使用内存数据库</span></span><br><span class="line">proxy_db.init(actual_db) <span class="comment"># 绑定实际数据库实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 现在，UserProxy 可以进行数据库操作了</span></span><br><span class="line"><span class="keyword">with</span> actual_db:</span><br><span class="line">    actual_db.create_tables([UserProxy])</span><br><span class="line">    UserProxy.create(name=<span class="string">&#x27;Proxy User&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;通过代理创建的用户: <span class="subst">&#123;UserProxy.get(name=<span class="string">&#x27;Proxy User&#x27;</span>).name&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="7-2-迁移-Migrations"><a href="#7-2-迁移-Migrations" class="headerlink" title="7.2 迁移 (Migrations)"></a>7.2 迁移 (Migrations)</h3><p>Peewee 本身没有像 Django 或 Alembic 那样内置的高级数据库迁移工具。对于复杂的生产环境，通常需要结合第三方库或手动管理迁移。</p>
<ul>
<li><strong>手动管理</strong>：通过编写 SQL 脚本或使用 <code>Model.add_column()</code>, <code>Model.drop_column()</code>, <code>db.execute_sql()</code> 等方法来手动进行 schema 变更。</li>
<li><strong>第三方工具</strong>：可以使用 <code>peewee_migrations</code> 等社区项目来辅助管理。</li>
</ul>
<h3 id="7-3-连接池-Connection-Pooling"><a href="#7-3-连接池-Connection-Pooling" class="headerlink" title="7.3 连接池 (Connection Pooling)"></a>7.3 连接池 (Connection Pooling)</h3><p>对于需要频繁打开&#x2F;关闭数据库连接的生产环境，使用连接池可以提高性能。Peewee 的数据库类支持连接池。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PostgreSQL 示例, min_connections 和 max_connections 是关键参数</span></span><br><span class="line"><span class="comment"># db = PostgresqlDatabase(</span></span><br><span class="line"><span class="comment">#     &#x27;my_database&#x27;,</span></span><br><span class="line"><span class="comment">#     user=&#x27;my_user&#x27;,</span></span><br><span class="line"><span class="comment">#     password=&#x27;my_password&#x27;,</span></span><br><span class="line"><span class="comment">#     host=&#x27;localhost&#x27;,</span></span><br><span class="line"><span class="comment">#     max_connections=20, # 最大连接数</span></span><br><span class="line"><span class="comment">#     stale_timeout=300 # 连接在300秒不活跃后关闭</span></span><br><span class="line"><span class="comment"># )</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SqliteDatabase 也有 pool_size 和 thread_safe 等参数</span></span><br><span class="line"><span class="comment"># db = SqliteDatabase(&#x27;my_database.db&#x27;, pragmas=&#123;&#x27;journal_mode&#x27;: &#x27;wal&#x27;&#125;, autoconnect=True, check_same_thread=False)</span></span><br></pre></td></tr></table></figure>

<h2 id="八、优缺点与适用场景"><a href="#八、优缺点与适用场景" class="headerlink" title="八、优缺点与适用场景"></a>八、优缺点与适用场景</h2><h3 id="8-1-优点："><a href="#8-1-优点：" class="headerlink" title="8.1 优点："></a>8.1 优点：</h3><ol>
<li><strong>轻量与快速</strong>：代码库小，启动速度快，对资源占用低。</li>
<li><strong>API 简洁直观</strong>：学习成本低，非常适合小型项目或对 ORM 复杂性有要求的场景。</li>
<li><strong>表达力强</strong>：链式调用和 Pythonic 的 API 使得查询构建自然。</li>
<li><strong>性能良好</strong>：虽然是 ORM，但在许多情况下能够生成高效的 SQL。</li>
<li><strong>灵活性高</strong>：支持混合使用 ORM 查询和原始 SQL。</li>
</ol>
<h3 id="8-2-缺点："><a href="#8-2-缺点：" class="headerlink" title="8.2 缺点："></a>8.2 缺点：</h3><ol>
<li><strong>功能相对精简</strong>：相较于 SQLAlchemy 这种全功能 ORM，Peewee 在一些高级功能（如声明式混入、复杂的会话管理、详细的事件系统）上可能有所欠缺。</li>
<li><strong>社区规模较小</strong>：相对于 Django 或 SQLAlchemy，Peewee 的用户社区和第三方工具生态可能不那么庞大。</li>
<li><strong>缺乏内置迁移工具</strong>：需要手动编写或结合第三方工具进行数据库 schema 迁移。</li>
</ol>
<h3 id="8-3-适用场景："><a href="#8-3-适用场景：" class="headerlink" title="8.3 适用场景："></a>8.3 适用场景：</h3><ul>
<li><strong>小型到中型 Web 应用</strong>：快速原型开发，RESTful API 后端。</li>
<li><strong>命令行工具和脚本</strong>：需要快速与数据库交互的自动化脚本。</li>
<li><strong>微服务</strong>：作为轻量级的数据访问层。</li>
<li><strong>教育和学习</strong>：作为入门 ORM 的优秀选择。</li>
<li><strong>对性能和资源占用有较高要求，但又不想牺牲开发效率的场景</strong>。</li>
</ul>
<h2 id="九、总结"><a href="#九、总结" class="headerlink" title="九、总结"></a>九、总结</h2><p>Peewee 是一个出色的 Python ORM，以其简洁、轻量和富有表现力的特点，在 Python 数据库操作中占据一席之地。通过本文详细讲解的数据库设置、模型定义、CRUD 操作及事务管理等接口使用方式，开发者可以高效地利用 Peewee 构建健壮且易于维护的应用程序。虽然它在某些高级功能上可能不如更重量级的 ORM 完善，但其简洁的 API 和优雅的设计使其成为许多 Python 项目的理想选择。在实际开发中，根据项目需求权衡其优缺点，结合最佳实践，将能充分发挥 Peewee 的强大能力。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg">TeaTang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg/91353ff26772/">https://blog.tbf1211.xx.kg/91353ff26772/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tbf1211.xx.kg" target="_blank">1024 维度</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/2023/">2023</a><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/ORM/">ORM</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover-20.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/946675bf7dca/" title="WebAssembly(Wasm)详解：浏览器中的下一代高性能计算"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-32.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">WebAssembly(Wasm)详解：浏览器中的下一代高性能计算</div></div><div class="info-2"><div class="info-item-1"> WebAssembly (Wasm) 是一种二进制指令格式，它提供了一种在现代Web浏览器中执行接近原生性能代码的方法。它被设计为一个可移植、体积小、加载快且与Web兼容的编译目标。Wasm 不仅限于浏览器环境，通过 WASI (WebAssembly System Interface) 等标准，它也能在服务器、物联网设备等非浏览器环境中高效运行。  核心思想：为各种编程语言（如 C&#x2F;C++、Rust、Go、Python 等）提供一个高性能、安全的编译目标，使其代码能在Web或其他沙盒环境中以接近原生速度运行。    一、为什么需要 WebAssembly？在 WebAssembly 出现之前，JavaScript 是 Web 平台唯一的编程语言。尽管 JavaScript 及其引擎（如 V8）在性能方面取得了巨大进步，但仍然存在一些固有局限性：  性能瓶颈：对于计算密集型任务（如图形处理、视频编码&#x2F;解码、科学计算、大型游戏），JavaScript 的动态类型、垃圾回收机制以及解释&#x2F;JIT编译特性，使其难以达到原生代码的性能水平。 语言选择受限：开...</div></div></div></a><a class="pagination-related" href="/198b48a1edc3/" title="WebGL详解：浏览器中的3D图形魔法"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-14.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">WebGL详解：浏览器中的3D图形魔法</div></div><div class="info-2"><div class="info-item-1"> WebGL (Web Graphics Library) 是一种 JavaScript API，用于在任何兼容的网页浏览器中渲染高性能的交互式 3D 和 2D 图形，而无需使用插件。它通过将 JavaScript 和 OpenGL ES 2.0 (或 3.0，对应 WebGL2) 的功能结合起来，直接在 HTML5 Canvas 元素中利用用户的 GPU 硬件加速进行渲染。  核心思想：WebGL 是一个基于 JavaScript 的浏览器 3D 图形 API，通过 HTML Canvas 元素将 OpenGL ES (2.0&#x2F;3.0) 硬件加速能力带到 Web 端，允许开发者直接与 GPU 交互，利用着色器程序渲染高性能、交互式的 3D 内容。   一、WebGL 简介1.1 什么是 WebGL？WebGL 是一种底层图形 API，它允许 Web 开发者在浏览器中直接访问和控制 GPU。简而言之，它是一个将 JavaScript 代码转换为 GPU 指令的桥梁。这意味着你可以用 JavaScript 编写程序来绘制复杂的 3D 模型、创建游戏、进行数据可视化等，而这...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/8ba79d4c7826/" title="Python SQLAlchemy 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-15.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-17</div><div class="info-item-2">Python SQLAlchemy 详解</div></div><div class="info-2"><div class="info-item-1"> SQLAlchemy 是一个强大的 Python SQL 工具包和 ORM (Object Relational Mapper)，它为应用程序和数据库之间提供了完整的抽象层。SQLAlchemy 旨在提供高效且灵活的数据库访问，支持多种数据库后端，并允许开发者在对象操作和原生 SQL 语句之间进行灵活切换。  核心思想：将数据库操作封装为 Python 对象，既提供高层次的 ORM 抽象，简化数据模型管理；又保留低层次的 SQL 表达式语言，允许执行复杂的 SQL 查询，兼顾开发效率与性能优化。   一、为什么需要 SQLAlchemy？在 Python 应用中与数据库交互时，通常会遇到以下挑战：  数据库类型差异：不同的数据库（MySQL, PostgreSQL, SQLite, Oracle 等）有不同的 SQL 语法和连接 API。直接使用原生驱动代码会导致代码难以跨数据库移植。 SQL 语句管理：手动编写和维护 SQL 字符串容易出错，尤其是在处理复杂查询、表连接和条件过滤时，且存在 SQL 注入风险。 数据与对象映射：将数据库行数据手动转换为 Python 对象，以及...</div></div></div></a><a class="pagination-related" href="/10b74b4460f9/" title="Python 异步编程详解：从并发到协程"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-02.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-22</div><div class="info-item-2">Python 异步编程详解：从并发到协程</div></div><div class="info-2"><div class="info-item-1"> Python 异步编程 是一种处理并发任务的编程范式，它允许程序在等待某些操作（如 I&#x2F;O 操作、网络请求、数据库查询）完成时，切换到执行其他任务，从而提高程序的吞吐量和响应速度。与传统的多线程&#x2F;多进程并发模型不同，异步编程通常使用协程 (Coroutines) 和事件循环 (Event Loop) 来实现，避免了线程&#x2F;进程切换的开销，也绕开了 Python 的全局解释器锁 (GIL) 对 CPU 密集型任务的限制（尽管异步编程主要适用于 I&#x2F;O 密集型任务）。  核心思想：异步编程通过在等待 I&#x2F;O 完成时“暂停”当前任务，并“切换”到其他可执行任务，从而在单线程内实现并发和最大化 I&#x2F;O 利用率。   一、为什么需要异步编程？传统的 Python 程序（同步阻塞式）在执行 I&#x2F;O 操作时会阻塞整个程序，直到 I&#x2F;O 完成。例如，一个 Web 服务器在处理一个耗时的网络请求时，就无法处理其他用户的请求，导致性能低下。 1.1 同步阻塞 (Synchronous Blocking)123456789...</div></div></div></a><a class="pagination-related" href="/3226a64cc8bb/" title="Python元类(Metaclass)深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-21.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-09</div><div class="info-item-2">Python元类(Metaclass)深度解析</div></div><div class="info-2"><div class="info-item-1"> 元类 (Metaclass) 在 Python 中是一个非常高级且强大的概念，它是创建类的类。在 Python 中，一切皆对象，包括类本身。当我们定义一个类时，这个类实际上也是一个对象，而创建这个类对象的“类”就是元类。换句话说，元类是 Python 类型系统中最深层次的抽象之一，它允许开发者在类被创建时对其行为进行拦截和修改。  核心思想：如果你想在创建类时自动修改或定制类的行为（例如，添加方法、强制继承特定接口、实现单例模式等），那么元类就是你的工具。它提供了一个钩子，让你能在类定义完成后、但类对象实际实例化之前介入。   一、Python 中的“一切皆对象”与 type理解元类，首先要牢记 Python 的核心哲学：“一切皆对象”。  基本数据类型是对象：数字、字符串、列表、字典等都是对象。 123x = 10         # 10 是一个 int 对象s = &quot;hello&quot;    # &quot;hello&quot; 是一个 str 对象l = [1, 2]     # [1, 2] 是一个 list 对象  函数是对象：函数可以像其他对象一样...</div></div></div></a><a class="pagination-related" href="/cb923ba84dd9/" title="Python NumPy详解：科学计算的基石"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-32.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-15</div><div class="info-item-2">Python NumPy详解：科学计算的基石</div></div><div class="info-2"><div class="info-item-1"> NumPy (Numerical Python) 是 Python 中用于科学计算的核心库。它提供了一个高性能的多维数组对象 ndarray，以及用于处理这些数组的工具。NumPy 是 Python 数据科学和机器学习生态系统的基石，许多其他库（如 SciPy, Pandas, Matplotlib, Scikit-learn）都建立在 NumPy 数组之上。  核心思想：NumPy 引入了高效的 ndarray 数据结构，通过向量化操作显著提升了 Python 处理数值数据的性能。   一、为什么选择 NumPy？Python 语言本身处理列表等数据结构时效率较高，但对于大规模数值计算而言，原生的 Python 列表效率低下。NumPy 通过以下方式解决了这个问题：  高性能 ndarray 对象：ndarray 存储同类型数据，在内存中连续存储，相比 Python 列表，占用的内存更少，访问速度更快。 向量化操作：NumPy 允许对整个数组进行操作，而无需编写显式的循环。这些操作通常在 C 或 Fortran 中实现，执行速度远超 Python 循环。 广播 (Broadc...</div></div></div></a><a class="pagination-related" href="/60590698f89d/" title="Python abc模块详解 - 抽象基类 (Abstract Base Classes)"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-19.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-27</div><div class="info-item-2">Python abc模块详解 - 抽象基类 (Abstract Base Classes)</div></div><div class="info-2"><div class="info-item-1"> Python 的 abc 模块 (Abstract Base Classes) 提供了一种定义抽象基类 (ABC) 的方式。抽象基类强制其子类实现特定的方法，从而为类结构引入了正式的接口定义能力。这在没有显式接口概念的 Python 中，是一种实现“鸭子类型 (Duck Typing)”的更严格、更可控的方式。它有助于构建可预测且易于维护的面向对象代码结构。  核心思想：强制子类遵循父类定义的“契约”，即必须实现某些方法，以确保API的一致性。这提升了代码的可读性、可维护性和健壮性。    一、为什么需要抽象基类 (ABC)？Python 是一种动态类型语言，其核心原则之一是“鸭子类型” (Duck Typing)：  “如果它走起来像鸭子，叫起来像鸭子，那么它就是一只鸭子。”  这意味着，只要一个对象实现了某个方法，我们就可以像对待具有该方法的任何其他对象一样使用它，而无需关心其继承关系或具体类型。 鸭子类型非常灵活，但在某些情况下也会带来问题：  接口不明确：当你在设计一个库或框架时，你可能希望用户提供的类必须实现某些方法。没有明确的接口，用户可能不知道要实现哪些方法，或者...</div></div></div></a><a class="pagination-related" href="/f52f9b242f1c/" title="Python装饰器详解：从基础到高级应用"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-10.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-15</div><div class="info-item-2">Python装饰器详解：从基础到高级应用</div></div><div class="info-2"><div class="info-item-1"> Python 装饰器 (Decorators) 是一种高级的 Python 语法糖，它允许你在不修改原始函数定义的情况下，增强或修改函数的功能。装饰器本质上是一个 Python 函数，它接收一个函数作为参数，并返回一个修改后或增强后的新函数。它们是实现“开闭原则”（对扩展开放，对修改关闭）的重要工具，常用于日志记录、性能测试、事务处理、权限验证等场景，属于面向切面编程 (AOP) 的范畴。  核心思想：装饰器是“函数套函数”的语法糖，通过闭包的特性，在不改变被装饰函数代码的情况下，为其添加预处理、后处理或其他功能。    一、理解装饰器前的预备知识要真正理解装饰器，我们需要先掌握几个 Python 核心概念： 1.1 函数是第一类对象 (First-Class Objects)在 Python 中，函数与其他数据类型（如整数、字符串）一样，是第一类对象。这意味着你可以：  将函数赋值给变量 将函数作为参数传递给其他函数 将函数作为另一个函数的返回值 在数据结构中存储函数  示例： 123456789101112131415161718192021def greet(name):...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TeaTang</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">527</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">229</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/teatang"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:tea.tang1211@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站更多功能即将上线，敬请期待！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9-Peewee%EF%BC%9F"><span class="toc-text">一、为什么选择 Peewee？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-text">二、关键概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E7%BD%AE%E4%B8%8E%E8%BF%9E%E6%8E%A5"><span class="toc-text">三、数据库设置与连接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%BC%95%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A8%A1%E5%9D%97"><span class="toc-text">3.1 引入数据库模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E8%BF%9E%E6%8E%A5%E4%B8%8E%E5%85%B3%E9%97%AD"><span class="toc-text">3.2 连接与关闭</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9E%8B-Model"><span class="toc-text">四、定义模型 (Model)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%9F%BA%E6%9C%AC%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="toc-text">4.1 基本模型定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%AE%9A%E4%B9%89%E5%85%B3%E7%B3%BB-Relationships"><span class="toc-text">4.2 定义关系 (Relationships)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C-CRUD"><span class="toc-text">五、数据库操作 (CRUD)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="toc-text">5.1 创建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%A2%9E%E5%8A%A0%E6%95%B0%E6%8D%AE-Create"><span class="toc-text">5.2 增加数据 (Create)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-Model-create"><span class="toc-text">5.2.1 Model.create()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-%E5%AE%9E%E4%BE%8B%E5%88%9B%E5%BB%BA%E5%92%8C-save"><span class="toc-text">5.2.2 实例创建和 save()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-3-bulk-create-insert-many"><span class="toc-text">5.2.3 bulk_create() &#x2F; insert_many()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-Read"><span class="toc-text">5.3 查询数据 (Read)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-Model-select"><span class="toc-text">5.3.1 Model.select()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-%E5%A4%8D%E6%9D%82%E7%9A%84-where-%E6%9D%A1%E4%BB%B6"><span class="toc-text">5.3.2 复杂的 where 条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-3-%E5%8E%9F%E5%A7%8B-SQL"><span class="toc-text">5.3.3 原始 SQL</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE-Update"><span class="toc-text">5.4 更新数据 (Update)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-%E6%9B%B4%E6%96%B0%E5%8D%95%E4%B8%AA%E5%AE%9E%E4%BE%8B"><span class="toc-text">5.4.1 更新单个实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0"><span class="toc-text">5.4.2 批量更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE-Delete"><span class="toc-text">5.5 删除数据 (Delete)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-1-%E5%88%A0%E9%99%A4%E5%8D%95%E4%B8%AA%E5%AE%9E%E4%BE%8B"><span class="toc-text">5.5.1 删除单个实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-2-%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4"><span class="toc-text">5.5.2 批量删除</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%BA%8B%E5%8A%A1-Transactions"><span class="toc-text">六、事务 (Transactions)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="toc-text">七、高级特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BB%A3%E7%90%86-DatabaseProxy"><span class="toc-text">7.1 数据库代理 (DatabaseProxy)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E8%BF%81%E7%A7%BB-Migrations"><span class="toc-text">7.2 迁移 (Migrations)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E8%BF%9E%E6%8E%A5%E6%B1%A0-Connection-Pooling"><span class="toc-text">7.3 连接池 (Connection Pooling)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E4%BC%98%E7%BC%BA%E7%82%B9%E4%B8%8E%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">八、优缺点与适用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E4%BC%98%E7%82%B9%EF%BC%9A"><span class="toc-text">8.1 优点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E7%BC%BA%E7%82%B9%EF%BC%9A"><span class="toc-text">8.2 缺点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A"><span class="toc-text">8.3 适用场景：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">九、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/5341a0037256/" title="CSS-in-JS 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-08.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CSS-in-JS 详解"/></a><div class="content"><a class="title" href="/5341a0037256/" title="CSS-in-JS 详解">CSS-in-JS 详解</a><time datetime="2026-01-25T22:24:00.000Z" title="发表于 2026-01-26 06:24:00">2026-01-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/0b52cb819619/" title="Git 核心对象：Commit, Tree, Blob 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-30.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Git 核心对象：Commit, Tree, Blob 详解"/></a><div class="content"><a class="title" href="/0b52cb819619/" title="Git 核心对象：Commit, Tree, Blob 详解">Git 核心对象：Commit, Tree, Blob 详解</a><time datetime="2026-01-21T22:24:00.000Z" title="发表于 2026-01-22 06:24:00">2026-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/1d2a942bda1e/" title="Terraform 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-21.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Terraform 详解"/></a><div class="content"><a class="title" href="/1d2a942bda1e/" title="Terraform 详解">Terraform 详解</a><time datetime="2026-01-19T22:24:00.000Z" title="发表于 2026-01-20 06:24:00">2026-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/26cdb2447b3d/" title="WebView 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-09.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WebView 详解"/></a><div class="content"><a class="title" href="/26cdb2447b3d/" title="WebView 详解">WebView 详解</a><time datetime="2026-01-17T22:24:00.000Z" title="发表于 2026-01-18 06:24:00">2026-01-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/e62a1e8acade/" title="AI 辅助编程的关键要点与代码幻觉防范"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-03.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI 辅助编程的关键要点与代码幻觉防范"/></a><div class="content"><a class="title" href="/e62a1e8acade/" title="AI 辅助编程的关键要点与代码幻觉防范">AI 辅助编程的关键要点与代码幻觉防范</a><time datetime="2026-01-15T22:24:00.000Z" title="发表于 2026-01-16 06:24:00">2026-01-16</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/default_cover-20.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">我的轨迹</div><div class="footer-flex-content"><a href="/archives/2023/" target="_blank" title="🆕 2023">🆕 2023</a><a href="/archives/2024/" target="_blank" title="🆒 2024">🆒 2024</a><a href="/archives/2025/" target="_blank" title="👨‍👩‍👦 2025">👨‍👩‍👦 2025</a><a href="/archives/2026/" target="_blank" title="🆙 2026">🆙 2026</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">维度</div><div class="footer-flex-content"><a href="/categories/" target="_blank" title="📁 分类">📁 分类</a><a href="/tags/" target="_blank" title="🔖 标签">🔖 标签</a><a href="/categories/" target="_blank" title="📽️ 时间线">📽️ 时间线</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/shuoshuo" target="_blank" title="💬 说说">💬 说说</a></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By TeaTang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.9/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (true) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script></div><script data-pjax src="/self/btf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="ture"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,200,200" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js" defer="defer"></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      true
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.4"></script></div></div></body></html>