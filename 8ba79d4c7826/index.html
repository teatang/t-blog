<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Python SQLAlchemy 详解 | 1024 维度</title><meta name="author" content="TeaTang"><meta name="copyright" content="TeaTang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SQLAlchemy 是一个强大的 Python SQL 工具包和 ORM (Object Relational Mapper)，它为应用程序和数据库之间提供了完整的抽象层。SQLAlchemy 旨在提供高效且灵活的数据库访问，支持多种数据库后端，并允许开发者在对象操作和原生 SQL 语句之间进行灵活切换。  核心思想：将数据库操作封装为 Python 对象，既提供高层次的 ORM 抽象，简化数">
<meta property="og:type" content="article">
<meta property="og:title" content="Python SQLAlchemy 详解">
<meta property="og:url" content="https://blog.tbf1211.xx.kg/8ba79d4c7826/index.html">
<meta property="og:site_name" content="1024 维度">
<meta property="og:description" content="SQLAlchemy 是一个强大的 Python SQL 工具包和 ORM (Object Relational Mapper)，它为应用程序和数据库之间提供了完整的抽象层。SQLAlchemy 旨在提供高效且灵活的数据库访问，支持多种数据库后端，并允许开发者在对象操作和原生 SQL 语句之间进行灵活切换。  核心思想：将数据库操作封装为 Python 对象，既提供高层次的 ORM 抽象，简化数">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-16.jpg">
<meta property="article:published_time" content="2023-11-16T22:24:00.000Z">
<meta property="article:modified_time" content="2026-02-01T07:40:52.282Z">
<meta property="article:author" content="TeaTang">
<meta property="article:tag" content="2023">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="ORM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-16.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Python SQLAlchemy 详解",
  "url": "https://blog.tbf1211.xx.kg/8ba79d4c7826/",
  "image": "https://blog.tbf1211.xx.kg/img/cover/default_cover-16.jpg",
  "datePublished": "2023-11-16T22:24:00.000Z",
  "dateModified": "2026-02-01T07:40:52.282Z",
  "author": [
    {
      "@type": "Person",
      "name": "TeaTang",
      "url": "https://blog.tbf1211.xx.kg"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon-1.ico"><link rel="canonical" href="https://blog.tbf1211.xx.kg/8ba79d4c7826/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.9/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":true,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: TeaTang","link":"链接: ","source":"来源: 1024 维度","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Python SQLAlchemy 详解',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="1024 维度" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">536</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">229</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/cover/default_cover-16.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">1024 维度</span></a><a class="nav-page-title" href="/"><span class="site-name">Python SQLAlchemy 详解</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Python SQLAlchemy 详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-11-16T22:24:00.000Z" title="发表于 2023-11-17 06:24:00">2023-11-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Python/">Python</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Python/%E5%BA%93/">库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">6.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>26分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><strong>SQLAlchemy</strong> 是一个强大的 <strong>Python SQL 工具包和 ORM (Object Relational Mapper)</strong>，它为应用程序和数据库之间提供了完整的抽象层。SQLAlchemy 旨在提供高效且灵活的数据库访问，支持多种数据库后端，并允许开发者在对象操作和原生 SQL 语句之间进行灵活切换。</p>
</blockquote>
<div class="note info flat"><p>核心思想：<strong>将数据库操作封装为 Python 对象，既提供高层次的 ORM 抽象，简化数据模型管理；又保留低层次的 SQL 表达式语言，允许执行复杂的 SQL 查询，兼顾开发效率与性能优化。</strong></p>
</div>
<hr>
<h2 id="一、为什么需要-SQLAlchemy？"><a href="#一、为什么需要-SQLAlchemy？" class="headerlink" title="一、为什么需要 SQLAlchemy？"></a>一、为什么需要 SQLAlchemy？</h2><p>在 Python 应用中与数据库交互时，通常会遇到以下挑战：</p>
<ol>
<li><strong>数据库类型差异</strong>：不同的数据库（MySQL, PostgreSQL, SQLite, Oracle 等）有不同的 SQL 语法和连接 API。直接使用原生驱动代码会导致代码难以跨数据库移植。</li>
<li><strong>SQL 语句管理</strong>：手动编写和维护 SQL 字符串容易出错，尤其是在处理复杂查询、表连接和条件过滤时，且存在 SQL 注入风险。</li>
<li><strong>数据与对象映射</strong>：将数据库行数据手动转换为 Python 对象，以及将 Python 对象转换为数据库行数据进行存储，过程繁琐且易错。</li>
<li><strong>连接管理</strong>：高效地管理数据库连接（如连接池）对于高并发应用至关重要，但手动实现复杂且容易出现资源泄露。</li>
<li><strong>事务管理</strong>：确保数据库操作的原子性、一致性、隔离性和持久性 (ACID) 需要细致的事务控制。</li>
</ol>
<p>SQLAlchemy 旨在解决这些问题，提供一个全面而灵活的解决方案：</p>
<ul>
<li><strong>数据库抽象</strong>：提供统一的 API，屏蔽底层数据库驱动和 SQL 语法差异，使代码更具可移植性。</li>
<li><strong>ORM (Object Relational Mapper)</strong>：允许开发者使用 Python 类和对象来定义数据库模型，并通过操作对象来执行数据库的 CRUD (Create, Read, Update, Delete) 操作，大大提高开发效率。</li>
<li><strong>SQL 表达式语言</strong>：在需要精细控制或优化性能时，可以直接使用 Python 代码构建 SQL 表达式，而不是原始字符串，兼具灵活性和安全性。</li>
<li><strong>连接池与事务管理</strong>：内置连接池和强大的事务管理功能，简化了这些复杂任务的实现。</li>
<li><strong>数据类型映射</strong>：自动处理 Python 数据类型与数据库数据类型之间的转换。</li>
</ul>
<h2 id="二、SQLAlchemy-的核心概念"><a href="#二、SQLAlchemy-的核心概念" class="headerlink" title="二、SQLAlchemy 的核心概念"></a>二、SQLAlchemy 的核心概念</h2><p>SQLAlchemy 围绕几个核心概念构建，理解它们是掌握 SQLAlchemy 的关键：</p>
<ol>
<li><p><strong>Engine (引擎)</strong></p>
<ul>
<li><strong>定义</strong>：<code>Engine</code> 是数据库的<strong>连接器和入口</strong>。它负责处理与特定数据库的实际连接、方言适配以及数据库操作的执行。一个 <code>Engine</code> 实例代表一个数据库的连接池。</li>
<li><strong>作用</strong>：建立与数据库的通信桥梁。</li>
</ul>
</li>
<li><p><strong>Connection (连接)</strong></p>
<ul>
<li><strong>定义</strong>：通过 <code>Engine</code> 获得的实际数据库连接。它是一个低层次的接口，用于执行原始 SQL 语句或 SQL Expression Language 构建的语句。</li>
<li><strong>作用</strong>：直接与数据库交互，执行 SQL。</li>
</ul>
</li>
<li><p><strong>Session (会话)</strong></p>
<ul>
<li><strong>定义</strong>：<code>Session</code> 是 SQLAlchemy ORM 的核心，它是一个**“单位工作” (Unit of Work)** 的概念。<code>Session</code> 维护着从数据库加载的对象，跟踪它们的更改，并在提交时将这些更改同步到数据库。</li>
<li><strong>作用</strong>：管理 ORM 对象的生命周期、状态，并协调事务。</li>
</ul>
</li>
<li><p><strong>MetaData (元数据)</strong></p>
<ul>
<li><strong>定义</strong>：一个包含数据库模式信息（如表、列等）的对象集合。</li>
<li><strong>作用</strong>：描述数据库结构。</li>
</ul>
</li>
<li><p><strong>Table (表)</strong></p>
<ul>
<li><strong>定义</strong>：<code>Table</code> 对象是数据库中表的 Python 表示。它包含了表的名称、列的定义以及其他约束信息。</li>
<li><strong>作用</strong>：在 SQL Expression Language 或 ORM 中直接代表一个数据库表。</li>
</ul>
</li>
<li><p><strong>Column (列)</strong></p>
<ul>
<li><strong>定义</strong>：<code>Column</code> 对象是数据库表中列的 Python 表示，它定义了列的名称、数据类型、主键、外键、默认值等属性。</li>
<li><strong>作用</strong>：定义表的结构和数据约束。</li>
</ul>
</li>
<li><p><strong>Declarative Base (声明式基类)</strong></p>
<ul>
<li><strong>定义</strong>：在使用 ORM 时，通常会创建一个声明式基类，所有的数据库模型（Python 类）都继承自这个基类。</li>
<li><strong>作用</strong>：提供了将 Python 类映射到数据库表的机制。</li>
</ul>
</li>
<li><p><strong>Mapped Class &#x2F; Model (映射类&#x2F;模型)</strong></p>
<ul>
<li><strong>定义</strong>：继承自 <code>Declarative Base</code> 的 Python 类，它们直接映射到数据库中的表。每个实例代表表中的一行数据。</li>
<li><strong>作用</strong>：用面向对象的方式操作数据库数据。</li>
</ul>
</li>
<li><p><strong>Relationship (关系)</strong></p>
<ul>
<li><strong>定义</strong>：在 ORM 中用于定义不同映射类（表）之间的关联，如一对一、一对多、多对多。</li>
<li><strong>作用</strong>：通过对象属性导航和操作相关联的数据。</li>
</ul>
</li>
</ol>
<h2 id="三、SQLAlchemy-架构与工作流程"><a href="#三、SQLAlchemy-架构与工作流程" class="headerlink" title="三、SQLAlchemy 架构与工作流程"></a>三、SQLAlchemy 架构与工作流程</h2><p>SQLAlchemy 的架构可以分为两个主要部分：<strong>SQL Expression Language (SQL Core)</strong> 和 <strong>ORM (Object Relational Mapper)</strong>。它们可以独立使用，也可以结合使用。</p>
<h3 id="3-1-架构图"><a href="#3-1-架构图" class="headerlink" title="3.1 架构图"></a>3.1 架构图</h3><div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    graph TD
    subgraph Application
        A[Python Code &#x2F; User Interaction]
    end

    subgraph SQLAlchemy Framework
        direction LR
        S[Session] --&gt;|ORM Operations| M[Mapped Classes &#x2F; Models]
        M --&gt;|Defined by| DB[Declarative Base]
        S --&gt;|Executes SQL via| E[Engine]
        E --&gt;|DBAPI Calls| DBC[&quot;DBAPI Driver (e.g., psycopg2, mysqlclient)&quot;]
        E -- &quot;Manages&quot; --&gt; CP[Connection Pool]
        T[Table Objects] --&gt;|Part of| MD[MetaData]
        C[Column Objects] --&gt;|Part of| T
        SQL[SQL Expression Language Constructs] --&gt;|Can be executed directly by| E
        SQL --&gt;|Can be wrapped by| S
    end

    subgraph Database Backend
        DBB[&quot;(PostgreSQL, MySQL, SQLite, etc.)&quot;]
    end

    A -- &quot;Uses ORM to Interact&quot; --&gt; S
    A -- &quot;Uses SQL Core Directly&quot; --&gt; E

    CP -- &quot;Provides Connections to&quot; --&gt; DBC
    DBC &lt;--&gt; DBB

    M -- &quot;Maps to&quot; --&gt; T
    M -- &quot;Uses&quot; --&gt; C
  </pre></div>

<h3 id="3-2-工作流程-ORM-模式"><a href="#3-2-工作流程-ORM-模式" class="headerlink" title="3.2 工作流程 (ORM 模式)"></a>3.2 工作流程 (ORM 模式)</h3><p>一个典型的 SQLAlchemy ORM 工作流程如下：</p>
<div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    sequenceDiagram
    participant App as 应用程序
    participant ORM as SQLAlchemy ORM (Session)
    participant Core as SQLAlchemy Core (Engine&#x2F;Connection)
    participant DB as 数据库

    App-&gt;&gt;App: 1. 定义数据库模型 (Mapped Classes)
    App-&gt;&gt;Core: 2. 创建 Engine (连接数据库)
    App-&gt;&gt;ORM: 3. 创建 Session (绑定 Engine)

    App-&gt;&gt;ORM: 4. 实例化模型对象 (e.g., new_user &#x3D; User(...))
    App-&gt;&gt;ORM: 5. 将对象添加到 Session (session.add(new_user))

    App-&gt;&gt;ORM: 6. 执行查询 (e.g., session.query(User).filter_by(...))
    ORM-&gt;&gt;Core: 7. 将 ORM 查询转换为 SQL 语句
    Core-&gt;&gt;DB: 8. 执行 SQL 语句
    DB--&gt;&gt;Core: 9. 返回结果集 (Rows)
    Core--&gt;&gt;ORM: 10. 接收结果集
    ORM-&gt;&gt;App: 11. 将结果集转换为 Python 对象 (Lazy Loading&#x2F;Eager Loading)

    App-&gt;&gt;ORM: 12. 修改对象属性 (e.g., user.name &#x3D; &quot;New Name&quot;)
    App-&gt;&gt;ORM: 13. 从 Session 删除对象 (e.g., session.delete(user))

    App-&gt;&gt;ORM: 14. 提交事务 (session.commit())
    ORM-&gt;&gt;Core: 15. 将所有待定更改 (增删改) 转换为 SQL 语句
    Core-&gt;&gt;DB: 16. 批量执行 SQL 语句
    DB--&gt;&gt;Core: 17. 确认事务成功
    Core--&gt;&gt;ORM: 18. 通知 ORM
    App--&gt;&gt;App: 19. 应用程序获得持久化对象状态

    alt 如果发生错误
        App-&gt;&gt;ORM: 14. 回滚事务 (session.rollback())
        ORM-&gt;&gt;App: 15. 对象状态恢复到提交前的状态
    end

    App-&gt;&gt;ORM: 20. 关闭 Session (session.close())
  </pre></div>

<h2 id="四、SQLAlchemy-入门与基本用法"><a href="#四、SQLAlchemy-入门与基本用法" class="headerlink" title="四、SQLAlchemy 入门与基本用法"></a>四、SQLAlchemy 入门与基本用法</h2><h3 id="4-1-安装"><a href="#4-1-安装" class="headerlink" title="4.1 安装"></a>4.1 安装</h3><p>使用 pip 安装 SQLAlchemy：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install sqlalchemy</span><br><span class="line"><span class="comment"># 如果需要特定数据库驱动，例如 SQLite 不需要额外安装，但 MySQL/PostgreSQL 需要：</span></span><br><span class="line"><span class="comment"># pip install pymysql       # for MySQL</span></span><br><span class="line"><span class="comment"># pip install psycopg2-binary # for PostgreSQL</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-最小示例：环境设置与模型定义"><a href="#4-2-最小示例：环境设置与模型定义" class="headerlink" title="4.2 最小示例：环境设置与模型定义"></a>4.2 最小示例：环境设置与模型定义</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Column, Integer, String, Text, ForeignKey, desc, or_, and_, not_</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base, sessionmaker, relationship, aliased, load_only</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.sql <span class="keyword">import</span> func, text</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.exc <span class="keyword">import</span> IntegrityError</span><br><span class="line"><span class="keyword">import</span> os <span class="comment"># 用于清理数据库文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理旧的数据库文件以便每次运行都是全新开始</span></span><br><span class="line"><span class="keyword">if</span> os.path.exists(<span class="string">&#x27;example.db&#x27;</span>):</span><br><span class="line">    os.remove(<span class="string">&#x27;example.db&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Deleted existing &#x27;example.db&#x27; for a clean run.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 创建 Engine (引擎)</span></span><br><span class="line"><span class="comment"># SQLite 文件数据库：&#x27;sqlite:///example.db&#x27;</span></span><br><span class="line"><span class="comment"># echo=True 会打印所有执行的 SQL 语句，方便调试</span></span><br><span class="line">engine = create_engine(<span class="string">&#x27;sqlite:///example.db&#x27;</span>, echo=<span class="literal">False</span>) <span class="comment"># 调试时可设为True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 定义 Declarative Base (声明式基类)</span></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 定义 Mapped Classes / Models (映射类/模型)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span> <span class="comment"># 映射到的数据库表名</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">50</span>), nullable=<span class="literal">False</span>) <span class="comment"># name 列，最大长度50，不允许为空</span></span><br><span class="line">    email = Column(String(<span class="number">100</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>) <span class="comment"># email 列，唯一且不允许为空</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义与 Post 的关系：一个 User 可以有多个 Post</span></span><br><span class="line">    <span class="comment"># back_populates 是双向关系的推荐用法，它定义了两个模型之间如何互相引用</span></span><br><span class="line">    <span class="comment"># lazy=&#x27;dynamic&#x27; 会返回一个查询对象，而不是直接加载所有帖子</span></span><br><span class="line">    posts = relationship(<span class="string">&quot;Post&quot;</span>, back_populates=<span class="string">&quot;author&quot;</span>, lazy=<span class="string">&quot;dynamic&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;&lt;User(id=<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name=&#x27;<span class="subst">&#123;self.name&#125;</span>&#x27;, email=&#x27;<span class="subst">&#123;self.email&#125;</span>&#x27;)&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Post</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;posts&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = Column(String(<span class="number">100</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    content = Column(Text, nullable=<span class="literal">True</span>) <span class="comment"># Text 类型用于存储长文本</span></span><br><span class="line">    user_id = Column(Integer, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>)) <span class="comment"># 外键，关联 users 表的 id 列</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义与 User 的关系：一个 Post 属于一个 User</span></span><br><span class="line">    author = relationship(<span class="string">&quot;User&quot;</span>, back_populates=<span class="string">&quot;posts&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;&lt;Post(id=<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, title=&#x27;<span class="subst">&#123;self.title&#125;</span>&#x27;, user_id=<span class="subst">&#123;self.user_id&#125;</span>)&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 创建数据库表</span></span><br><span class="line"><span class="comment"># Base.metadata.create_all(engine) 会检查 engine 绑定的数据库中是否存在这些表，</span></span><br><span class="line"><span class="comment"># 如果不存在则创建。</span></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 配置 Sessionmaker (会话工厂)</span></span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;数据库环境和模型已设置完成。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 辅助函数，用于填充初始数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_initial_data</span>():</span><br><span class="line">    <span class="keyword">with</span> Session() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n--- 填充初始数据 ---&quot;</span>)</span><br><span class="line">        user_data = [</span><br><span class="line">            &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;alice@example.com&#x27;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;bob@example.com&#x27;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Charlie&#x27;</span>, <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;charlie@example.com&#x27;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;David&#x27;</span>, <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;david@example.com&#x27;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Eve&#x27;</span>, <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;eve@example.com&#x27;</span>&#125;,</span><br><span class="line">        ]</span><br><span class="line">        users = [User(**data) <span class="keyword">for</span> data <span class="keyword">in</span> user_data]</span><br><span class="line">        session.add_all(users)</span><br><span class="line">        session.commit()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 重新加载用户以获取其ID，以便关联帖子</span></span><br><span class="line">        alice = session.query(User).filter_by(name=<span class="string">&#x27;Alice&#x27;</span>).first()</span><br><span class="line">        bob = session.query(User).filter_by(name=<span class="string">&#x27;Bob&#x27;</span>).first()</span><br><span class="line">        charlie = session.query(User).filter_by(name=<span class="string">&#x27;Charlie&#x27;</span>).first()</span><br><span class="line">        david = session.query(User).filter_by(name=<span class="string">&#x27;David&#x27;</span>).first()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> alice <span class="keyword">and</span> bob <span class="keyword">and</span> charlie <span class="keyword">and</span> david:</span><br><span class="line">            post_data = [</span><br><span class="line">                &#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;Alice\&#x27;s First Post&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;Hello World from Alice!&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: alice&#125;,</span><br><span class="line">                &#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;Bob\&#x27;s Great Adventure&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;Journey to the mountains.&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: bob&#125;,</span><br><span class="line">                &#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;Alice\&#x27;s Second Post&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;More thoughts on Python.&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: alice&#125;,</span><br><span class="line">                &#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;Charlie\&#x27;s Wisdom&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;Knowledge is power.&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: charlie&#125;,</span><br><span class="line">                &#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;David\&#x27;s New Project&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;Exploring machine learning.&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: david&#125;,</span><br><span class="line">                &#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;Alice\&#x27;s Third Post&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;Advanced SQLAlchemy tips.&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: alice&#125;,</span><br><span class="line">                &#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;Bob\&#x27;s Coding Challenge&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;Solving a difficult algorithm.&#x27;</span>, <span class="string">&#x27;author&#x27;</span>: bob&#125;,</span><br><span class="line">            ]</span><br><span class="line">            posts = [Post(**data) <span class="keyword">for</span> data <span class="keyword">in</span> post_data]</span><br><span class="line">            session.add_all(posts)</span><br><span class="line">            session.commit()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;初始用户和帖子数据已成功填充。&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;未能找到所有用户，无法填充帖子数据。&quot;</span>)</span><br><span class="line"></span><br><span class="line">setup_initial_data()</span><br></pre></td></tr></table></figure>

<h2 id="五、SQLAlchemy-各种-SQL-操作方法详解"><a href="#五、SQLAlchemy-各种-SQL-操作方法详解" class="headerlink" title="五、SQLAlchemy 各种 SQL 操作方法详解"></a>五、SQLAlchemy 各种 SQL 操作方法详解</h2><h3 id="5-1-Ⅰ-创建数据-INSERT"><a href="#5-1-Ⅰ-创建数据-INSERT" class="headerlink" title="5.1 Ⅰ. 创建数据 (INSERT)"></a>5.1 Ⅰ. 创建数据 (INSERT)</h3><p>使用 <code>session.add()</code> 或 <code>session.add_all()</code> 添加新对象到会话，然后通过 <code>session.commit()</code> 将其持久化到数据库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Session() <span class="keyword">as</span> session:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- Ⅰ. 创建数据 (INSERT) ---&quot;</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 1. 创建单个对象</span></span><br><span class="line">    new_user = User(name=<span class="string">&#x27;Frank&#x27;</span>, email=<span class="string">&#x27;frank@example.com&#x27;</span>)</span><br><span class="line">    session.add(new_user)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 2. 创建多个对象</span></span><br><span class="line">    user_g = User(name=<span class="string">&#x27;Grace&#x27;</span>, email=<span class="string">&#x27;grace@example.com&#x27;</span>)</span><br><span class="line">    user_h = User(name=<span class="string">&#x27;Heidi&#x27;</span>, email=<span class="string">&#x27;heidi@example.com&#x27;</span>)</span><br><span class="line">    session.add_all([user_g, user_h])</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        session.commit()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;成功创建新用户: <span class="subst">&#123;new_user&#125;</span>, <span class="subst">&#123;user_g&#125;</span>, <span class="subst">&#123;user_h&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> IntegrityError <span class="keyword">as</span> e:</span><br><span class="line">        session.rollback()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;创建用户失败 (可能邮箱已存在): <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建带外键关联的对象</span></span><br><span class="line">    user_frank = session.query(User).filter_by(name=<span class="string">&#x27;Frank&#x27;</span>).first()</span><br><span class="line">    <span class="keyword">if</span> user_frank:</span><br><span class="line">        new_post = Post(title=<span class="string">&#x27;Frank\&#x27;s First Blog&#x27;</span>, content=<span class="string">&#x27;Exciting new content!&#x27;</span>, author=user_frank)</span><br><span class="line">        session.add(new_post)</span><br><span class="line">        session.commit()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;成功创建新帖子并关联到 Frank: <span class="subst">&#123;new_post&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-2-Ⅱ-读取数据-SELECT"><a href="#5-2-Ⅱ-读取数据-SELECT" class="headerlink" title="5.2 Ⅱ. 读取数据 (SELECT)"></a>5.2 Ⅱ. 读取数据 (SELECT)</h3><p>读取数据是 SQLAlchemy 最核心且功能最丰富的操作之一。<code>session.query()</code> 是 ORM 查询的起点。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Session() <span class="keyword">as</span> session:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- Ⅱ. 读取数据 (SELECT) ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 查询所有对象</span></span><br><span class="line">    all_users = session.query(User).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;所有用户:&quot;</span>, all_users)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 查询单个对象</span></span><br><span class="line">    <span class="comment"># first()：返回查询到的第一个结果，如果没有则返回 None</span></span><br><span class="line">    alice = session.query(User).filter_by(name=<span class="string">&#x27;Alice&#x27;</span>).first()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;第一个名为 Alice 的用户:&quot;</span>, alice)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># one()：返回一个结果，如果不是一个结果（0个或多于1个）则抛出异常</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bob_post = session.query(Post).filter_by(title=<span class="string">&#x27;Bob\&#x27;s Great Adventure&#x27;</span>).one()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Bob 的帖子 (one()):&quot;</span>, bob_post)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;one() 查询失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># scalar_one_or_none()：返回一个标量结果，如果不是一个结果（0个或多于1个）则抛出异常/返回None</span></span><br><span class="line">    <span class="comment"># 常用场景：查询 COUNT(*)</span></span><br><span class="line">    user_count = session.query(func.count(User.<span class="built_in">id</span>)).scalar_one_or_none()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;用户总数 (scalar_one_or_none()):&quot;</span>, user_count)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 条件过滤</span></span><br><span class="line">    <span class="comment"># filter_by()：使用关键字参数进行等值过滤</span></span><br><span class="line">    users_with_e = session.query(User).filter_by(email=<span class="string">&#x27;eve@example.com&#x27;</span>).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;邮箱是 &#x27;eve@example.com&#x27; 的用户:&quot;</span>, users_with_e)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># filter()：使用表达式进行更复杂的过滤，支持各种比较运算符</span></span><br><span class="line">    <span class="comment"># User.id &gt; 3</span></span><br><span class="line">    <span class="comment"># User.name.like(&#x27;%i%&#x27;)  # 名字包含 &#x27;i&#x27;</span></span><br><span class="line">    <span class="comment"># User.email.ilike(&#x27;%example.com&#x27;) # 邮箱以 &#x27;example.com&#x27; 结尾 (不区分大小写)</span></span><br><span class="line">    <span class="comment"># User.name.in_([&#x27;Alice&#x27;, &#x27;Bob&#x27;]) # 名字在列表中</span></span><br><span class="line">    <span class="comment"># User.email.is_(None) # 邮箱为空</span></span><br><span class="line">    <span class="comment"># User.email.isnot(None) # 邮箱不为空</span></span><br><span class="line">  </span><br><span class="line">    users_gt_id_3 = session.query(User).<span class="built_in">filter</span>(User.<span class="built_in">id</span> &gt; <span class="number">3</span>).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ID 大于 3 的用户:&quot;</span>, users_gt_id_3)</span><br><span class="line"></span><br><span class="line">    users_containing_i = session.query(User).<span class="built_in">filter</span>(User.name.like(<span class="string">&#x27;%i%&#x27;</span>)).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;名字包含 &#x27;i&#x27; 的用户:&quot;</span>, users_containing_i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># and_(), or_(), not_()：组合多个条件</span></span><br><span class="line">    users_alice_bob = session.query(User).<span class="built_in">filter</span>(or_(User.name == <span class="string">&#x27;Alice&#x27;</span>, User.name == <span class="string">&#x27;Bob&#x27;</span>)).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;名字是 Alice 或 Bob 的用户:&quot;</span>, users_alice_bob)</span><br><span class="line"></span><br><span class="line">    active_users_not_alice = session.query(User).<span class="built_in">filter</span>(and_(User.<span class="built_in">id</span> &gt; <span class="number">0</span>, not_(User.name == <span class="string">&#x27;Alice&#x27;</span>))).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ID大于0且不是Alice的用户:&quot;</span>, active_users_not_alice)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. 排序 (Ordering)</span></span><br><span class="line">    <span class="comment"># order_by()：默认升序</span></span><br><span class="line">    users_ordered_by_name = session.query(User).order_by(User.name).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;按名字升序排序的用户:&quot;</span>, users_ordered_by_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># desc()：降序</span></span><br><span class="line">    users_ordered_by_id_desc = session.query(User).order_by(desc(User.<span class="built_in">id</span>)).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;按 ID 降序排序的用户:&quot;</span>, users_ordered_by_id_desc)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. 限制与偏移 (Limiting and Offsetting)</span></span><br><span class="line">    <span class="comment"># limit()：限制返回结果的数量</span></span><br><span class="line">    <span class="comment"># offset()：偏移量</span></span><br><span class="line">    first_two_users = session.query(User).limit(<span class="number">2</span>).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;前两个用户:&quot;</span>, first_two_users)</span><br><span class="line"></span><br><span class="line">    users_from_third = session.query(User).offset(<span class="number">2</span>).limit(<span class="number">2</span>).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;从第三个开始的两个用户:&quot;</span>, users_from_third)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 6. 关联查询 (Joining)</span></span><br><span class="line">    <span class="comment"># join()：内连接 (INNER JOIN)</span></span><br><span class="line">    posts_with_authors = session.query(Post).join(User).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;所有帖子及其作者 (INNER JOIN):&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> post <span class="keyword">in</span> posts_with_authors:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;post.title&#125;</span> by <span class="subst">&#123;post.author.name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># outerjoin()：外连接 (LEFT OUTER JOIN)</span></span><br><span class="line">    <span class="comment"># 查找所有用户，即使他们没有帖子</span></span><br><span class="line">    users_and_their_posts = session.query(User, Post).outerjoin(Post, User.<span class="built_in">id</span> == Post.user_id).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;所有用户及其帖子 (LEFT OUTER JOIN):&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> user, post <span class="keyword">in</span> users_and_their_posts:</span><br><span class="line">        post_title = post.title <span class="keyword">if</span> post <span class="keyword">else</span> <span class="string">&quot;No Post&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  - User: <span class="subst">&#123;user.name&#125;</span>, Post: <span class="subst">&#123;post_title&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 7. 聚合函数 (Aggregation Functions) 与分组 (Grouping)</span></span><br><span class="line">    <span class="comment"># func.count(), func.sum(), func.avg(), func.max(), func.min()</span></span><br><span class="line">    user_post_counts = session.query(User.name, func.count(Post.<span class="built_in">id</span>)).join(Post).group_by(User.name).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;各用户发帖数量:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> name, count <span class="keyword">in</span> user_post_counts:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;name&#125;</span>: <span class="subst">&#123;count&#125;</span> 帖子&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># having()：对分组后的结果进行过滤</span></span><br><span class="line">    users_with_more_than_2_posts = session.query(User.name, func.count(Post.<span class="built_in">id</span>)).join(Post).group_by(User.name).having(func.count(Post.<span class="built_in">id</span>) &gt; <span class="number">2</span>).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;发帖数超过2个的用户:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> name, count <span class="keyword">in</span> users_with_more_than_2_posts:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;name&#125;</span>: <span class="subst">&#123;count&#125;</span> 帖子&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 8. 加载策略 (Loading Strategies) 与关系查询</span></span><br><span class="line">    <span class="comment"># 通过 User 对象的 posts 属性访问其关联的 Post 对象 (lazy=&#x27;dynamic&#x27; 需进一步查询)</span></span><br><span class="line">    alice = session.query(User).filter_by(name=<span class="string">&#x27;Alice&#x27;</span>).first()</span><br><span class="line">    <span class="keyword">if</span> alice:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Alice 的帖子 (通过关系属性): <span class="subst">&#123;alice.posts.<span class="built_in">all</span>()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 预先加载 (Eager Loading) 避免 N+1 查询问题</span></span><br><span class="line">    <span class="comment"># joinedload()：使用 JOIN 语句一次性加载主对象和关联对象</span></span><br><span class="line">    users_with_posts_joined = session.query(User).options(relationship(User.posts)).filter_by(name=<span class="string">&#x27;Alice&#x27;</span>).first()</span><br><span class="line">    <span class="keyword">if</span> users_with_posts_joined:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Alice 和她的帖子 (Joined Load):&quot;</span>, users_with_posts_joined.posts.<span class="built_in">all</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># selectinload()：使用单独的 SELECT IN 语句加载关联对象（推荐用于一对多）</span></span><br><span class="line">    users_with_posts_selectin = session.query(User).options(relationship(User.posts, lazy=<span class="string">&#x27;selectin&#x27;</span>)).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;所有用户和他们的帖子 (Select In Load):&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> users_with_posts_selectin:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  - User: <span class="subst">&#123;user.name&#125;</span>, Posts: <span class="subst">&#123;[p.title <span class="keyword">for</span> p <span class="keyword">in</span> user.posts]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># load_only()：只加载指定列，减少数据传输</span></span><br><span class="line">    partial_users = session.query(User).options(load_only(User.name)).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;只加载名字的用户:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> partial_users:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  - Name: <span class="subst">&#123;user.name&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># print(user.email) # 访问未加载的属性会触发惰性加载或抛出错误</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-Ⅲ-更新数据-UPDATE"><a href="#5-3-Ⅲ-更新数据-UPDATE" class="headerlink" title="5.3 Ⅲ. 更新数据 (UPDATE)"></a>5.3 Ⅲ. 更新数据 (UPDATE)</h3><p>修改已从数据库加载的对象属性，然后提交会话。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Session() <span class="keyword">as</span> session:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- Ⅲ. 更新数据 (UPDATE) ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 查询并修改单个对象</span></span><br><span class="line">    bob = session.query(User).filter_by(name=<span class="string">&#x27;Bob&#x27;</span>).first()</span><br><span class="line">    <span class="keyword">if</span> bob:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;更新前 Bob 的名字: <span class="subst">&#123;bob.name&#125;</span>, 邮箱: <span class="subst">&#123;bob.email&#125;</span>&quot;</span>)</span><br><span class="line">        bob.name = <span class="string">&#x27;Robert&#x27;</span></span><br><span class="line">        bob.email = <span class="string">&#x27;robert@example.com&#x27;</span></span><br><span class="line">        session.commit() <span class="comment"># 提交更改</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;更新后 Bob 的名字: <span class="subst">&#123;bob.name&#125;</span>, 邮箱: <span class="subst">&#123;bob.email&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 批量更新 (不加载对象，直接发送 UPDATE 语句)</span></span><br><span class="line">    <span class="comment"># 注意：这种方式不会触发 ORM 对象的事件监听器，也不会更新会话中已存在的对象状态</span></span><br><span class="line">    session.query(Post).<span class="built_in">filter</span>(Post.title.like(<span class="string">&#x27;%Alice%&#x27;</span>)).update(</span><br><span class="line">        &#123;Post.content: Post.content + <span class="string">&#x27; (UPDATED!)&#x27;</span>&#125;,</span><br><span class="line">        synchronize_session=<span class="string">&#x27;fetch&#x27;</span> <span class="comment"># &#x27;fetch&#x27; 会在更新后刷新会话中受影响的对象</span></span><br><span class="line">    )</span><br><span class="line">    session.commit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;所有 Alice 的帖子内容已批量更新。&quot;</span>)</span><br><span class="line">    <span class="comment"># 验证更新</span></span><br><span class="line">    alice_posts_updated = session.query(Post).<span class="built_in">filter</span>(Post.title.like(<span class="string">&#x27;%Alice%&#x27;</span>)).<span class="built_in">all</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;更新后的 Alice 帖子内容:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> post <span class="keyword">in</span> alice_posts_updated:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;post.title&#125;</span>: <span class="subst">&#123;post.content&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-4-Ⅳ-删除数据-DELETE"><a href="#5-4-Ⅳ-删除数据-DELETE" class="headerlink" title="5.4 Ⅳ. 删除数据 (DELETE)"></a>5.4 Ⅳ. 删除数据 (DELETE)</h3><p>从会话中删除对象，然后提交会话。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Session() <span class="keyword">as</span> session:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- Ⅳ. 删除数据 (DELETE) ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 查询并删除单个对象</span></span><br><span class="line">    david = session.query(User).filter_by(name=<span class="string">&#x27;David&#x27;</span>).first()</span><br><span class="line">    <span class="keyword">if</span> david:</span><br><span class="line">        session.delete(david)</span><br><span class="line">        session.commit()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;成功删除用户 David: <span class="subst">&#123;david&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 验证 David 是否已被删除</span></span><br><span class="line">    deleted_david = session.query(User).filter_by(name=<span class="string">&#x27;David&#x27;</span>).first()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;再次查询 David: <span class="subst">&#123;deleted_david&#125;</span> (应为 None)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 批量删除 (不加载对象，直接发送 DELETE 语句)</span></span><br><span class="line">    <span class="comment"># 注意：此方法不会触发 ORM 对象的事件监听器</span></span><br><span class="line">    <span class="comment"># 删除所有名为 &#x27;Grace&#x27; 的用户</span></span><br><span class="line">    session.query(User).filter_by(name=<span class="string">&#x27;Grace&#x27;</span>).delete(synchronize_session=<span class="string">&#x27;fetch&#x27;</span>)</span><br><span class="line">    session.commit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;所有名为 Grace 的用户已批量删除。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 验证 Grace 是否已被删除</span></span><br><span class="line">    deleted_grace = session.query(User).filter_by(name=<span class="string">&#x27;Grace&#x27;</span>).first()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;再次查询 Grace: <span class="subst">&#123;deleted_grace&#125;</span> (应为 None)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 级联删除 (Cascading Deletes)</span></span><br><span class="line">    <span class="comment"># 可以在 relationship 中配置 cascade=&quot;all, delete-orphan&quot; 来实现级联删除</span></span><br><span class="line">    <span class="comment"># 例如，删除一个用户时，自动删除其所有帖子。</span></span><br><span class="line">    <span class="comment"># (此示例中未配置 cascade，因此删除用户不会自动删除帖子，需要手动处理或配置)</span></span><br><span class="line">    eve = session.query(User).filter_by(name=<span class="string">&#x27;Eve&#x27;</span>).first()</span><br><span class="line">    <span class="keyword">if</span> eve:</span><br><span class="line">        eve_posts = session.query(Post).filter_by(author=eve).<span class="built_in">all</span>()</span><br><span class="line">        <span class="keyword">for</span> post <span class="keyword">in</span> eve_posts:</span><br><span class="line">            session.delete(post) <span class="comment"># 先删除帖子</span></span><br><span class="line">        session.delete(eve) <span class="comment"># 再删除用户</span></span><br><span class="line">        session.commit()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;成功删除用户 Eve 及其所有帖子。&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-5-Ⅴ-原生-SQL-与-SQL-Expression-Language"><a href="#5-5-Ⅴ-原生-SQL-与-SQL-Expression-Language" class="headerlink" title="5.5 Ⅴ. 原生 SQL 与 SQL Expression Language"></a>5.5 Ⅴ. 原生 SQL 与 SQL Expression Language</h3><p>虽然 ORM 提供了高级抽象，但有时需要直接执行原生 SQL 或构建更底层的 SQL 表达式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Session() <span class="keyword">as</span> session:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- Ⅴ. 原生 SQL 与 SQL Expression Language ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 使用 text() 执行原生 SQL</span></span><br><span class="line">    <span class="comment"># 用于查询</span></span><br><span class="line">    result = session.execute(text(<span class="string">&quot;SELECT id, name, email FROM users WHERE id &gt; :min_id&quot;</span>), &#123;<span class="string">&quot;min_id&quot;</span>: <span class="number">2</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;原生 SQL 查询用户 (ID &gt; 2):&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  - ID: <span class="subst">&#123;row.<span class="built_in">id</span>&#125;</span>, Name: <span class="subst">&#123;row.name&#125;</span>, Email: <span class="subst">&#123;row.email&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用于 DML (Data Manipulation Language) 操作</span></span><br><span class="line">    session.execute(text(<span class="string">&quot;UPDATE users SET name = :new_name WHERE id = :user_id&quot;</span>), &#123;<span class="string">&quot;new_name&quot;</span>: <span class="string">&quot;Robert Smith&quot;</span>, <span class="string">&quot;user_id&quot;</span>: <span class="number">2</span>&#125;)</span><br><span class="line">    session.commit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;原生 SQL 更新用户 ID 2 的姓名成功。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 绕过 ORM 直接使用 Engine.connect()</span></span><br><span class="line">    <span class="comment"># 当只需要执行 DDL (Data Definition Language) 或不需要 ORM 对象映射时</span></span><br><span class="line">    <span class="keyword">with</span> engine.connect() <span class="keyword">as</span> connection:</span><br><span class="line">        res = connection.execute(text(<span class="string">&quot;SELECT id, title FROM posts ORDER BY id DESC LIMIT 1&quot;</span>))</span><br><span class="line">        latest_post = res.fetchone()</span><br><span class="line">        <span class="keyword">if</span> latest_post:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;最新帖子 (通过 Connection.execute): ID: <span class="subst">&#123;latest_post.<span class="built_in">id</span>&#125;</span>, Title: <span class="subst">&#123;latest_post.title&#125;</span>&quot;</span>)</span><br><span class="line">        connection.commit() <span class="comment"># Connection 也有 commit() 方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. SQL Expression Language (更 Pythonic 的方式构建 SQL)</span></span><br><span class="line">    <span class="comment"># 例如，使用 select() 构造器</span></span><br><span class="line">    <span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> select, func</span><br><span class="line"></span><br><span class="line">    stmt = select(User.name, User.email).where(User.<span class="built_in">id</span> == <span class="number">1</span>)</span><br><span class="line">    user_data = session.execute(stmt).fetchone()</span><br><span class="line">    <span class="keyword">if</span> user_data:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;SQL Expression Language 查询用户 ID 1: Name: <span class="subst">&#123;user_data.name&#125;</span>, Email: <span class="subst">&#123;user_data.email&#125;</span>&quot;</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 结合 func 聚合函数</span></span><br><span class="line">    stmt_count = select(func.count(User.<span class="built_in">id</span>))</span><br><span class="line">    user_count_expr = session.execute(stmt_count).scalar_one()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;SQL Expression Language 查询用户总数:&quot;</span>, user_count_expr)</span><br></pre></td></tr></table></figure>

<h2 id="六、SQLAlchemy-的优缺点与适用场景"><a href="#六、SQLAlchemy-的优缺点与适用场景" class="headerlink" title="六、SQLAlchemy 的优缺点与适用场景"></a>六、SQLAlchemy 的优缺点与适用场景</h2><h3 id="6-1-优点："><a href="#6-1-优点：" class="headerlink" title="6.1 优点："></a>6.1 优点：</h3><ol>
<li><strong>高度灵活</strong>：兼顾 ORM 的高效开发和 SQL Expression Language 的精细控制，开发者可以根据需求选择不同的抽象层次。</li>
<li><strong>数据库无关性</strong>：通过方言系统支持多种关系型数据库，无需修改应用代码即可切换数据库后端。</li>
<li><strong>强大的 ORM</strong>：提供丰富的功能，如惰性加载 (Lazy Loading)、急切加载 (Eager Loading)、对象状态管理、事务管理等，极大地简化了数据模型操作。</li>
<li><strong>防范 SQL 注入</strong>：SQL Expression Language 和 ORM 自动处理参数绑定，有效防止 SQL 注入攻击。</li>
<li><strong>性能优化</strong>：内置连接池，可以优化数据库连接的创建和复用。对于复杂查询，可以通过 SQL Expression Language 直接优化，甚至执行原生 SQL。</li>
<li><strong>成熟稳定</strong>：拥有庞大的社区和详细的文档，经过长时间的考验，在大型项目中广泛使用。</li>
<li><strong>可扩展性</strong>：提供了插件和事件监听机制，允许开发者扩展其功能。</li>
</ol>
<h3 id="6-2-缺点："><a href="#6-2-缺点：" class="headerlink" title="6.2 缺点："></a>6.2 缺点：</h3><ol>
<li><strong>学习曲线陡峭</strong>：由于其高度抽象和灵活性，SQLAlchemy 拥有复杂的概念和大量的 API，初学者需要投入较多时间来学习和理解。</li>
<li><strong>复杂性增加</strong>：对于简单的 CRUD 应用，使用 SQLAlchemy 可能会显得过于“重型”，引入不必要的复杂性。</li>
<li><strong>性能陷阱</strong>：如果不理解 ORM 的工作原理（特别是惰性加载和 N+1 查询问题），可能会导致性能问题。</li>
<li><strong>SQL 知识仍需</strong>：尽管 ORM 抽象了 SQL，但为了编写高效的查询和理解数据库行为，仍然需要扎实的 SQL 知识。</li>
<li><strong>模型定义冗长</strong>：相比于 Django ORM 等，SQLAlchemy 的模型定义可能更冗长，需要手动指定 <code>Column</code> 类型和约束。</li>
</ol>
<h3 id="6-3-适用场景："><a href="#6-3-适用场景：" class="headerlink" title="6.3 适用场景："></a>6.3 适用场景：</h3><ul>
<li><strong>需要高性能和灵活性的 Web 应用后端</strong>：如使用 Flask、FastAPI 等框架构建的 API 服务。</li>
<li><strong>数据密集型应用</strong>：需要处理复杂数据模型、大量数据查询和操作的应用。</li>
<li><strong>需要跨数据库兼容的应用</strong>：方便未来更换数据库后端。</li>
<li><strong>长期维护的项目</strong>：其健壮性和灵活性使得代码易于维护和扩展。</li>
<li><strong>对数据库操作有精细控制需求的项目</strong>：既需要 ORM 的便利，又需要能够随时降级到 SQL Expression Language 进行性能优化。</li>
<li><strong>数据分析和科学计算</strong>：可以作为数据持久化和查询的强大工具。</li>
</ul>
<h2 id="七、安全性考虑"><a href="#七、安全性考虑" class="headerlink" title="七、安全性考虑"></a>七、安全性考虑</h2><p>在使用 SQLAlchemy 时，以下安全实践至关重要：</p>
<ol>
<li><p><strong>防范 SQL 注入</strong>：</p>
<ul>
<li><strong>自动处理</strong>：SQLAlchemy 的 ORM 和 SQL Expression Language 会自动处理参数绑定，这是防止 SQL 注入最有效的方式。</li>
<li><strong>避免拼接</strong>：<strong>绝不</strong>将用户输入直接拼接进 <code>text()</code> 函数的 SQL 字符串中。始终使用参数化查询。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 错误示例 (容易被注入)</span></span><br><span class="line"><span class="comment"># user_input_name = &quot;&#x27;; DROP TABLE users; --&quot;</span></span><br><span class="line"><span class="comment"># session.execute(text(f&quot;SELECT * FROM users WHERE name = &#x27;&#123;user_input_name&#125;&#x27;&quot;))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 正确示例 (使用参数化查询)</span></span><br><span class="line">user_input_name = <span class="string">&quot;Alice&quot;</span></span><br><span class="line">session.execute(text(<span class="string">&quot;SELECT * FROM users WHERE name = :name&quot;</span>), &#123;<span class="string">&quot;name&quot;</span>: user_input_name&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>保护数据库连接字符串</strong>：</p>
<ul>
<li>连接字符串包含敏感信息（如用户名、密码）。<strong>绝不</strong>将其硬编码在代码中。</li>
<li>使用环境变量、配置文件或秘密管理服务 (如 Vault, AWS Secrets Manager) 来存储和加载连接字符串。</li>
</ul>
</li>
<li><p><strong>事务管理</strong>：</p>
<ul>
<li>确保所有修改数据库的操作都在事务中进行。使用 <code>session.commit()</code> 和 <code>session.rollback()</code> 来保证数据一致性。</li>
<li>推荐使用 <code>with Session() as session:</code> 这样的上下文管理器，它会自动处理提交或回滚。</li>
</ul>
</li>
<li><p><strong>最小权限原则</strong>：</p>
<ul>
<li>为应用程序使用的数据库用户配置最小必要的权限。例如，如果应用程序只需要读取和写入某些表，就不应该赋予其删除数据库的权限。</li>
</ul>
</li>
<li><p><strong>敏感数据加密</strong>：</p>
<ul>
<li>对于数据库中存储的敏感数据（如用户密码），应使用单向哈希加盐进行存储，而不是明文。</li>
<li>对于其他需要保密的敏感数据，考虑在应用层进行加密，只在数据库中存储密文。</li>
</ul>
</li>
</ol>
<h2 id="八、总结"><a href="#八、总结" class="headerlink" title="八、总结"></a>八、总结</h2><p>SQLAlchemy 是 Python 生态系统中最强大、最成熟的数据库工具之一。它以其独特的混合方法，为开发者提供了 ORM 的便利性和 SQL Expression Language 的灵活性，完美地桥接了对象世界和关系型数据库世界。</p>
<p>虽然它的学习曲线相对陡峭，但一旦掌握，它能极大地提高开发效率、代码质量和应用的可维护性。对于任何需要与关系型数据库进行复杂或高性能交互的 Python 项目而言，SQLAlchemy 都是一个值得深入学习和使用的首选库。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg">TeaTang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg/8ba79d4c7826/">https://blog.tbf1211.xx.kg/8ba79d4c7826/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tbf1211.xx.kg" target="_blank">1024 维度</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/2023/">2023</a><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/ORM/">ORM</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover-16.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/56481bc27387/" title="Docker Swarm 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-01.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Docker Swarm 详解</div></div><div class="info-2"><div class="info-item-1"> Docker Swarm 是 Docker 官方提供的原生容器编排工具。它将一组 Docker 主机（宿主机）聚合成一个集群，并将这些主机视为单个虚拟的 Docker 主机。通过 Docker Swarm，用户可以轻松地部署、管理和扩展在多个节点上运行的容器化应用程序。它简化了容器集群的搭建和管理，特别适合那些希望在不引入过多复杂性的情况下，实现容器高可用和负载均衡的用户。  核心思想：将多台物理机&#x2F;虚拟机抽象成一个统一的资源池，并提供原生 Docker API 接口，从而实现容器的集群化部署、服务发现、负载均衡和故障恢复。    一、为什么需要 Docker Swarm？Docker Compose 解决了单机多容器应用的编排问题，但现代分布式应用程序通常需要运行在多台服务器（节点）上，以实现：  高可用性 (High Availability)：单个节点故障不影响整个应用程序的运行。 负载均衡 (Load Balancing)：将流量均匀分配到多个容器实例，提高应用程序的响应速度和吞吐量。 伸缩性 (Scalability)：根据需求动态增加或减少应用程序的容器实...</div></div></div></a><a class="pagination-related" href="/ab44062dd349/" title="深入理解虚拟 DOM 与 Vue 核心补丁机制：patch(), patchVnode(), updateChildren()"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-13.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">深入理解虚拟 DOM 与 Vue 核心补丁机制：patch(), patchVnode(), updateChildren()</div></div><div class="info-2"><div class="info-item-1"> 现代前端框架如 Vue 和 React 之所以能提供高性能和优秀的开发体验，很大程度上要归功于 虚拟 DOM (Virtual DOM) 及其配套的 Diff 算法 (补丁机制)。虚拟 DOM 充当了真实 DOM 的一个轻量级抽象层，而 Vue 的补丁机制则负责将虚拟 DOM 的变化高效地反映到真实的浏览器 DOM 上。本文将深入解析虚拟 DOM 的概念，并聚焦 Vue 2 中驱动这一机制的三个核心函数：patch(), patchVnode(), 和 updateChildren()，并辅以 Mermaid 流程图进行可视化说明。  “虚拟 DOM 是前端性能优化的基石，而 Vue 的 patch() 系列函数正是将这块基石转化为实际渲染效率的魔法棒。”   一、虚拟 DOM (Virtual DOM) 再探1.1 什么是虚拟 DOM？虚拟 DOM 是一个用 JavaScript 对象来模拟真实 DOM 节点的数据结构。它是一个轻量级的、内存中的真实 DOM 树的抽象。每一个虚拟节点（VNode）都包含构建一个真实 DOM 节点所需的所有信息，例如：  tag：标签名（如 d...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/91353ff26772/" title="Peewee ORM 详解：接口使用与实践"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-18.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-11</div><div class="info-item-2">Peewee ORM 详解：接口使用与实践</div></div><div class="info-2"><div class="info-item-1"> Peewee 是一个小型、富有表现力、功能齐全的 Python ORM (Object-Relational Mapper)。它提供了一种简单且 Pythonic 的方式来与数据库进行交互，支持 SQLite、PostgreSQL 和 MySQL 等多种关系型数据库。Peewee 的设计理念是轻量级和易用性，使得开发者可以快速地构建应用程序，而无需编写大量的 SQL 语句。  核心思想：将数据库表映射为 Python 类，将表的行映射为类的实例，将表的列映射为类的属性。 通过 Python 对象和方法来操作数据库，从而抽象掉底层的 SQL 细节。   一、为什么选择 Peewee？在 Python 生态中，存在多种 ORM 解决方案，如 SQLAlchemy、Django ORM 等。Peewee 在其中脱颖而出，主要归因于以下特点：  轻量级与简洁性：Peewee 本身代码量较少，API 设计简洁直观，学习曲线平缓。 富有表现力：其查询 API 允许开发者使用类似 Python 原生语法的方式链式调用，构建复杂的查询。 兼容性强：支持 SQLite、PostgreSQL 和 ...</div></div></div></a><a class="pagination-related" href="/97dc2f650f49/" title="Jinja2 深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-30.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-12</div><div class="info-item-2">Jinja2 深度解析</div></div><div class="info-2"><div class="info-item-1"> Jinja2 是一个功能强大、灵活且广泛使用的 Python 模板引擎。它由 Armin Ronacher 创建，是 Flask Web 框架默认的模板引擎，但也常用于其他 Python 项目，如静态网站生成、自动化配置管理（例如 Ansible）等。Jinja2 的设计灵感来源于 Django 模板语言，但提供了更多高级功能和更易用的 API。 本文将深入探讨 Jinja2 的核心特性，并着重介绍一系列高效使用技巧，帮助开发者更优雅、更高效地构建动态内容。  核心思想：Jinja2 旨在将应用的逻辑（Python 代码）与展示逻辑（HTML&#x2F;文本）清晰地分离。它提供了一种简洁的语法，允许开发者在模板中嵌入变量、控制结构（如循环、条件判断）和自定义过滤器，从而动态生成文本内容。高效利用 Jinja2 的高级功能和最佳实践，可以显著提升开发效率和模板的可维护性。   一、为什么需要模板引擎？在 Web 开发或其他需要生成动态文本内容的场景中，我们经常需要将程序数据（如从数据库获取的数据、用户输入等）与预定义的结构化文本（如 HTML 页面、配置文件、邮件内容）结合起来。...</div></div></div></a><a class="pagination-related" href="/c0ed8953ea7d/" title="Python 编码规范详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-22.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-06</div><div class="info-item-2">Python 编码规范详解</div></div><div class="info-2"><div class="info-item-1"> Python 编码规范 旨在提供一套指导原则和最佳实践，以确保 Python 代码的一致性、可读性、可维护性、可协作性和**“Pythonic”**（符合 Python 语言哲学）风格。Python 社区的核心编码规范是 PEP 8 (Python Enhancement Proposal 8)，它定义了 Python 代码的风格指南。遵循 PEP 8 不仅能让你的代码更容易被其他 Python 开发者理解，也能提高代码本身的质量和减少潜在错误。  核心思想：一致性至关重要。代码是写给人看的，不是机器。清晰、简洁、可读的代码能够极大地提高开发效率和项目成功率。   一、Python 编码哲学与 PEP 8Python 语言的设计哲学（可在 import this 中查看“The Zen of Python”）强调简洁、明确和可读性。PEP 8 是将这些哲学转化为具体编码实践的基石。 PEP 8 是什么？PEP 8 是 Python 官方的风格指南，由 Guido van Rossum (Python 创始人)、Barry Warsaw 和 Nick Coghlan 共同撰写。它...</div></div></div></a><a class="pagination-related" href="/06bc4d655ced/" title="Python Beautiful Soup详解：高效网页数据抓取与解析利器"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-25.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-09</div><div class="info-item-2">Python Beautiful Soup详解：高效网页数据抓取与解析利器</div></div><div class="info-2"><div class="info-item-1"> Beautiful Soup 是一个 Python 库，用于从 HTML 或 XML 文件中提取数据。它通过解析文档并提供用于导航、搜索和修改解析树的 Pythonic 接口，将复杂的 HTML&#x2F;XML 文档转化为易于处理的数据结构。Beautiful Soup 与 requests 等 HTTP 库结合使用，是构建网络爬虫进行数据抓取的强大工具。  核心思想：Beautiful Soup 将杂乱的 HTML&#x2F;XML 文档“煲成一锅美味的汤”，让你能够轻松地在其中挑选出你需要的数据元素，如同在厨房里筛选食材一样简单。   一、为什么需要 Beautiful Soup？在网络上，大量有价值的信息以 HTML 页面的形式存在。如果我们需要从这些页面中获取结构化数据（例如，产品信息、新闻标题、评论内容），直接操作原始的 HTML 字符串是非常困难和脆弱的。传统的字符串查找和正则表达式虽然可行，但存在以下问题：  HTML 结构复杂：HTML 标签嵌套层级深，结构不规则，使用正则表达式难以精确匹配。 HTML 容错性：浏览器会自动纠正不规范的 HTML 结构，但正则...</div></div></div></a><a class="pagination-related" href="/60590698f89d/" title="Python abc模块详解 - 抽象基类 (Abstract Base Classes)"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-21.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-27</div><div class="info-item-2">Python abc模块详解 - 抽象基类 (Abstract Base Classes)</div></div><div class="info-2"><div class="info-item-1"> Python 的 abc 模块 (Abstract Base Classes) 提供了一种定义抽象基类 (ABC) 的方式。抽象基类强制其子类实现特定的方法，从而为类结构引入了正式的接口定义能力。这在没有显式接口概念的 Python 中，是一种实现“鸭子类型 (Duck Typing)”的更严格、更可控的方式。它有助于构建可预测且易于维护的面向对象代码结构。  核心思想：强制子类遵循父类定义的“契约”，即必须实现某些方法，以确保API的一致性。这提升了代码的可读性、可维护性和健壮性。    一、为什么需要抽象基类 (ABC)？Python 是一种动态类型语言，其核心原则之一是“鸭子类型” (Duck Typing)：  “如果它走起来像鸭子，叫起来像鸭子，那么它就是一只鸭子。”  这意味着，只要一个对象实现了某个方法，我们就可以像对待具有该方法的任何其他对象一样使用它，而无需关心其继承关系或具体类型。 鸭子类型非常灵活，但在某些情况下也会带来问题：  接口不明确：当你在设计一个库或框架时，你可能希望用户提供的类必须实现某些方法。没有明确的接口，用户可能不知道要实现哪些方法，或者...</div></div></div></a><a class="pagination-related" href="/1b5035114ad1/" title="Python Requests库详解：HTTP请求的艺术"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-32.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-28</div><div class="info-item-2">Python Requests库详解：HTTP请求的艺术</div></div><div class="info-2"><div class="info-item-1"> requests 库 是 Python 生态系统中最流行、最强大、也是最优雅的 HTTP 客户端库之一。它简化了复杂的 HTTP 请求操作，让开发者能够以极少量的代码发送各种类型的 HTTP 请求，并轻松处理响应。与 Python 内置的 urllib 模块相比，requests 提供了更友好、更直观的 API，被誉为“面向人类的 HTTP 服务”。  核心思想：requests 封装了底层 HTTP 协议的复杂性，提供简洁的 API，让开发者专注于业务逻辑而非网络通信的细节。   一、为什么选择 Requests？在 Python 中进行 HTTP 请求有多种方式，例如内置的 urllib 模块。但 requests 库之所以广受欢迎，主要得益于以下优势：  友好的 API：设计直观，易学易用，代码可读性高。 功能强大：支持几乎所有 HTTP 功能，包括 GET, POST, PUT, DELETE 等方法，以及请求头、数据、文件上传、Cookie、身份认证、代理、SSL 验证等。 自动处理：自动处理 URL 编码、重定向、会话管理等常见任务。 JSON 支持：内置 JSON...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TeaTang</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">536</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">229</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/teatang"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:tea.tang1211@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站更多功能即将上线，敬请期待！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-SQLAlchemy%EF%BC%9F"><span class="toc-text">一、为什么需要 SQLAlchemy？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81SQLAlchemy-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">二、SQLAlchemy 的核心概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81SQLAlchemy-%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-text">三、SQLAlchemy 架构与工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">3.1 架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-ORM-%E6%A8%A1%E5%BC%8F"><span class="toc-text">3.2 工作流程 (ORM 模式)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81SQLAlchemy-%E5%85%A5%E9%97%A8%E4%B8%8E%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-text">四、SQLAlchemy 入门与基本用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%AE%89%E8%A3%85"><span class="toc-text">4.1 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E6%9C%80%E5%B0%8F%E7%A4%BA%E4%BE%8B%EF%BC%9A%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="toc-text">4.2 最小示例：环境设置与模型定义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81SQLAlchemy-%E5%90%84%E7%A7%8D-SQL-%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3"><span class="toc-text">五、SQLAlchemy 各种 SQL 操作方法详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E2%85%A0-%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE-INSERT"><span class="toc-text">5.1 Ⅰ. 创建数据 (INSERT)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E2%85%A1-%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE-SELECT"><span class="toc-text">5.2 Ⅱ. 读取数据 (SELECT)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E2%85%A2-%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE-UPDATE"><span class="toc-text">5.3 Ⅲ. 更新数据 (UPDATE)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E2%85%A3-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE-DELETE"><span class="toc-text">5.4 Ⅳ. 删除数据 (DELETE)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E2%85%A4-%E5%8E%9F%E7%94%9F-SQL-%E4%B8%8E-SQL-Expression-Language"><span class="toc-text">5.5 Ⅴ. 原生 SQL 与 SQL Expression Language</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81SQLAlchemy-%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9%E4%B8%8E%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">六、SQLAlchemy 的优缺点与适用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E4%BC%98%E7%82%B9%EF%BC%9A"><span class="toc-text">6.1 优点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E7%BC%BA%E7%82%B9%EF%BC%9A"><span class="toc-text">6.2 缺点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A"><span class="toc-text">6.3 适用场景：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%AE%89%E5%85%A8%E6%80%A7%E8%80%83%E8%99%91"><span class="toc-text">七、安全性考虑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">八、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/8fc7e3e72510/" title="前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-02.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解"/></a><div class="content"><a class="title" href="/8fc7e3e72510/" title="前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解">前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解</a><time datetime="2026-01-27T22:24:00.000Z" title="发表于 2026-01-28 06:24:00">2026-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/5341a0037256/" title="CSS-in-JS 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-19.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CSS-in-JS 详解"/></a><div class="content"><a class="title" href="/5341a0037256/" title="CSS-in-JS 详解">CSS-in-JS 详解</a><time datetime="2026-01-25T22:24:00.000Z" title="发表于 2026-01-26 06:24:00">2026-01-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/0b52cb819619/" title="Git 核心对象：Commit, Tree, Blob 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-17.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Git 核心对象：Commit, Tree, Blob 详解"/></a><div class="content"><a class="title" href="/0b52cb819619/" title="Git 核心对象：Commit, Tree, Blob 详解">Git 核心对象：Commit, Tree, Blob 详解</a><time datetime="2026-01-21T22:24:00.000Z" title="发表于 2026-01-22 06:24:00">2026-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/1d2a942bda1e/" title="Terraform 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-12.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Terraform 详解"/></a><div class="content"><a class="title" href="/1d2a942bda1e/" title="Terraform 详解">Terraform 详解</a><time datetime="2026-01-19T22:24:00.000Z" title="发表于 2026-01-20 06:24:00">2026-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/26cdb2447b3d/" title="WebView 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-13.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WebView 详解"/></a><div class="content"><a class="title" href="/26cdb2447b3d/" title="WebView 详解">WebView 详解</a><time datetime="2026-01-17T22:24:00.000Z" title="发表于 2026-01-18 06:24:00">2026-01-18</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/default_cover-16.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">我的轨迹</div><div class="footer-flex-content"><a href="/archives/2023/" target="_blank" title="🆕 2023">🆕 2023</a><a href="/archives/2024/" target="_blank" title="🆒 2024">🆒 2024</a><a href="/archives/2025/" target="_blank" title="👨‍👩‍👦 2025">👨‍👩‍👦 2025</a><a href="/archives/2026/" target="_blank" title="🆙 2026">🆙 2026</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">维度</div><div class="footer-flex-content"><a href="/categories/" target="_blank" title="📁 分类">📁 分类</a><a href="/tags/" target="_blank" title="🔖 标签">🔖 标签</a><a href="/categories/" target="_blank" title="📽️ 时间线">📽️ 时间线</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/shuoshuo" target="_blank" title="💬 说说">💬 说说</a></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By TeaTang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.9/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (true) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script></div><script data-pjax src="/self/btf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="ture"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,200,200" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js" defer="defer"></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      true
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.4"></script></div></div></body></html>