<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Go 语言 Casbin 授权库详解 | 1024 维度</title><meta name="author" content="TeaTang"><meta name="copyright" content="TeaTang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Casbin 是一个强大且高效的开源访问控制库，它支持多种访问控制模型，例如 ACL (Access Control List)、RBAC (Role-Based Access Control)、ABAC (Attribute-Based Access Control) 等。Casbin 的设计理念是“授权逻辑与业务逻辑分离”，它将授权策略存储在外部配置中，并通过统一的 API 进行管理和验证。">
<meta property="og:type" content="article">
<meta property="og:title" content="Go 语言 Casbin 授权库详解">
<meta property="og:url" content="https://blog.tbf1211.xx.kg/6b2d6f99090f/index.html">
<meta property="og:site_name" content="1024 维度">
<meta property="og:description" content="Casbin 是一个强大且高效的开源访问控制库，它支持多种访问控制模型，例如 ACL (Access Control List)、RBAC (Role-Based Access Control)、ABAC (Attribute-Based Access Control) 等。Casbin 的设计理念是“授权逻辑与业务逻辑分离”，它将授权策略存储在外部配置中，并通过统一的 API 进行管理和验证。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-24.jpg">
<meta property="article:published_time" content="2025-04-20T22:24:00.000Z">
<meta property="article:modified_time" content="2025-12-04T04:40:07.940Z">
<meta property="article:author" content="TeaTang">
<meta property="article:tag" content="Golang">
<meta property="article:tag" content="2025">
<meta property="article:tag" content="Cron">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-24.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go 语言 Casbin 授权库详解",
  "url": "https://blog.tbf1211.xx.kg/6b2d6f99090f/",
  "image": "https://blog.tbf1211.xx.kg/img/cover/default_cover-24.jpg",
  "datePublished": "2025-04-20T22:24:00.000Z",
  "dateModified": "2025-12-04T04:40:07.940Z",
  "author": [
    {
      "@type": "Person",
      "name": "TeaTang",
      "url": "https://blog.tbf1211.xx.kg"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon-1.ico"><link rel="canonical" href="https://blog.tbf1211.xx.kg/6b2d6f99090f/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.4/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":true,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: TeaTang","link":"链接: ","source":"来源: 1024 维度","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Go 语言 Casbin 授权库详解',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="1024 维度" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">345</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">206</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">74</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/cover/default_cover-24.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">1024 维度</span></a><a class="nav-page-title" href="/"><span class="site-name">Go 语言 Casbin 授权库详解</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Go 语言 Casbin 授权库详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2025-04-20T22:24:00.000Z" title="发表于 2025-04-21 06:24:00">2025-04-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Golang/">Golang</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Golang/%E5%BA%93/">库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">3.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>15分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="umamiPV" data-path="/6b2d6f99090f/"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><strong>Casbin</strong> 是一个强大且高效的开源访问控制库，它支持多种访问控制模型，例如 ACL (Access Control List)、RBAC (Role-Based Access Control)、ABAC (Attribute-Based Access Control) 等。Casbin 的设计理念是“<strong>授权逻辑与业务逻辑分离</strong>”，它将授权策略存储在外部配置中，并通过统一的 API 进行管理和验证。Go 语言版本的 <code>github.com/casbin/casbin/v2</code> 是其最活跃和功能最完善的实现之一。</p>
</blockquote>
<div class="note info flat"><p>核心思想：<strong>提供一个通用的访问控制框架，通过独立的模型配置 (Model) 和策略数据 (Policy) 来定义和管理应用程序的授权规则，使授权逻辑与核心业务代码解耦，实现高度的灵活性和可维护性。</strong></p>
</div>
<hr>
<h2 id="一、为什么需要-Casbin？传统授权方式的局限性"><a href="#一、为什么需要-Casbin？传统授权方式的局限性" class="headerlink" title="一、为什么需要 Casbin？传统授权方式的局限性"></a>一、为什么需要 Casbin？传统授权方式的局限性</h2><p>在构建应用程序时，授权 (Authorization) 是一个不可或缺的安全组件，它决定了<strong>谁 (Subject)</strong> 可以对<strong>什么资源 (Object)</strong> 执行<strong>什么操作 (Action)</strong>。传统的授权方式可能面临以下挑战：</p>
<ol>
<li><strong>逻辑分散</strong>：授权规则通常硬编码在业务逻辑中，分散在多个地方，导致代码难以维护和审计。</li>
<li><strong>模型僵化</strong>：一旦确定了某种授权模型 (如简单的 ACL)，后续要切换到更复杂的模型 (如 RBAC 或 ABAC) 成本很高。</li>
<li><strong>缺乏统一管理</strong>：没有统一的 API 或界面来管理用户的角色、权限或属性。</li>
<li><strong>可扩展性差</strong>：随着业务发展，授权规则变得越来越复杂，硬编码的方式难以适应变化。</li>
</ol>
<p>Casbin 旨在解决这些问题，提供一个<strong>通用、灵活、可扩展</strong>的授权解决方案：</p>
<ul>
<li><strong>模型无关</strong>：支持多种访问控制模型，并且可以通过配置轻松切换。</li>
<li><strong>策略与代码分离</strong>：授权策略以独立的文本文件 (模型) 和数据 (策略) 形式存在，与业务逻辑解耦。</li>
<li><strong>实时更新</strong>：策略可以动态加载和修改，无需重启应用。</li>
<li><strong>高性能</strong>：内部优化，支持缓存，适用于高并发场景。</li>
<li><strong>多语言支持</strong>：除了 Go，还有 Java, PHP, Node.js, Python, Rust 等多种语言实现。</li>
</ul>
<h2 id="二、Casbin-的核心概念"><a href="#二、Casbin-的核心概念" class="headerlink" title="二、Casbin 的核心概念"></a>二、Casbin 的核心概念</h2><p>Casbin 的核心是它的两个配置文件：<strong>模型 (Model)</strong> 和<strong>策略 (Policy)</strong>。</p>
<h3 id="2-1-模型-Model"><a href="#2-1-模型-Model" class="headerlink" title="2.1 模型 (Model)"></a>2.1 模型 (Model)</h3><p>模型文件 (通常是 <code>.conf</code> 格式) 定义了 Casbin 使用的访问控制模型结构。它指定了授权规则的<strong>通用框架</strong>，包括请求者、资源、操作的定义，以及如何组合这些元素进行匹配。</p>
<p>一个典型的 Casbin 模型文件包含以下六个部分：</p>
<ul>
<li><code>[request_definition]</code>：请求定义，通常是 <code>r = sub, obj, act</code> (请求者，资源，操作)。</li>
<li><code>[policy_definition]</code>：策略定义，通常是 <code>p = sub, obj, act</code> (策略中的请求者，资源，操作)。</li>
<li><code>[policy_effect]</code>：策略生效原则，定义了多个匹配策略时的决策逻辑 (例如 <code>allow</code> 或 <code>deny</code>)。<ul>
<li><code>e = some(where (p.eft == allow))</code>：只要有一个策略允许，就允许。</li>
<li><code>e = !some(where (p.eft == deny))</code>：只要没有策略拒绝，就允许。</li>
<li><code>e = some(where (p.eft == allow)) &amp;&amp; !some(where (p.eft == deny))</code>：有允许策略且没有拒绝策略。</li>
</ul>
</li>
<li><code>[matchers]</code>：匹配器，定义了请求和策略如何进行匹配的逻辑表达式。这是 Casbin 灵活性的关键所在。<ul>
<li><code>m = r.sub == p.sub &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act</code> (基本匹配)</li>
</ul>
</li>
<li><code>[rbac_model]</code> (可选)：RBAC 模型定义，用于定义角色与用户、角色与权限之间的关系。<ul>
<li><code>g = _, _</code> (表示角色继承或用户-角色关系)</li>
</ul>
</li>
<li><code>[function_definition]</code> (可选)：自定义函数定义，允许在匹配器中使用自定义的 Go 函数。</li>
</ul>
<p><strong>示例：基本 RBAC 模型 (<code>rbac_model.conf</code>)</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[request_definition]</span></span><br><span class="line"><span class="attr">r</span> = sub, obj, act</span><br><span class="line"></span><br><span class="line"><span class="section">[policy_definition]</span></span><br><span class="line"><span class="attr">p</span> = sub, obj, act</span><br><span class="line"></span><br><span class="line"><span class="section">[role_definition]</span></span><br><span class="line"><span class="attr">g</span> = _, _</span><br><span class="line"></span><br><span class="line"><span class="section">[policy_effect]</span></span><br><span class="line"><span class="attr">e</span> = some(where (p.eft == allow))</span><br><span class="line"></span><br><span class="line"><span class="section">[matchers]</span></span><br><span class="line"><span class="attr">m</span> = g(r.sub, p.sub) &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：</p>
<ul>
<li><code>r = sub, obj, act</code>：一个请求包含主题 (用户&#x2F;角色)、对象 (资源) 和动作。</li>
<li><code>p = sub, obj, act</code>：一个策略包含主题、对象和动作。</li>
<li><code>g = _, _</code>：定义了一个角色继承关系或用户-角色关系，Casbin 的 <code>g</code> 函数会处理这个关系。</li>
<li><code>e = some(where (p.eft == allow))</code>：只要有一条匹配的允许策略，请求就被允许。</li>
<li><code>m = g(r.sub, p.sub) &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act</code>：匹配规则是：请求的主体 <code>r.sub</code> 必须在策略的主体 <code>p.sub</code> 的角色组中，并且请求的资源和动作必须与策略的资源和动作完全匹配。</li>
</ul>
<h3 id="2-2-策略-Policy"><a href="#2-2-策略-Policy" class="headerlink" title="2.2 策略 (Policy)"></a>2.2 策略 (Policy)</h3><p>策略文件 (通常是 <code>.csv</code> 格式，也可以存储在数据库中) 包含了具体的授权规则数据，这些数据会填充到模型定义的框架中。</p>
<p><strong>示例：基本 RBAC 策略 (<code>policy.csv</code>)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p, admin, /data1, read</span><br><span class="line">p, admin, /data1, write</span><br><span class="line">p, alice, /data2, read</span><br><span class="line"></span><br><span class="line">g, bob, admin</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：</p>
<ul>
<li><code>p, admin, /data1, read</code>：策略 <code>p</code> 允许 <code>admin</code> 角色对 <code>/data1</code> 资源执行 <code>read</code> 操作。</li>
<li><code>g, bob, admin</code>：关系 <code>g</code> 表示 <code>bob</code> 是 <code>admin</code> 角色的成员。</li>
</ul>
<h3 id="2-3-适配器-Adapter"><a href="#2-3-适配器-Adapter" class="headerlink" title="2.3 适配器 (Adapter)"></a>2.3 适配器 (Adapter)</h3><p>适配器 (Adapter) 是 Casbin 用来从各种持久化存储中加载和保存策略数据的一种机制。Casbin 提供了多种适配器，支持数据库 (MySQL, PostgreSQL, MongoDB, Redis 等)、文件、内存等多种存储方式。</p>
<h2 id="三、基本使用"><a href="#三、基本使用" class="headerlink" title="三、基本使用"></a>三、基本使用</h2><h3 id="3-1-安装-Casbin"><a href="#3-1-安装-Casbin" class="headerlink" title="3.1 安装 Casbin"></a>3.1 安装 Casbin</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/casbin/casbin/v2</span><br><span class="line">go get github.com/casbin/go-plugin/v2 <span class="comment"># 如果需要自定义函数</span></span><br><span class="line"><span class="comment"># 其他适配器根据需要安装，例如 MySQL 适配器:</span></span><br><span class="line"><span class="comment"># go get github.com/casbin/gorm-adapter/v3</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-快速入门示例"><a href="#3-2-快速入门示例" class="headerlink" title="3.2 快速入门示例"></a>3.2 快速入门示例</h3><p>首先，创建模型文件 <code>rbac_model.conf</code> 和策略文件 <code>policy.csv</code>。</p>
<p><strong><code>rbac_model.conf</code></strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[request_definition]</span></span><br><span class="line"><span class="attr">r</span> = sub, obj, act</span><br><span class="line"></span><br><span class="line"><span class="section">[policy_definition]</span></span><br><span class="line"><span class="attr">p</span> = sub, obj, act</span><br><span class="line"></span><br><span class="line"><span class="section">[role_definition]</span></span><br><span class="line"><span class="attr">g</span> = _, _</span><br><span class="line"></span><br><span class="line"><span class="section">[policy_effect]</span></span><br><span class="line"><span class="attr">e</span> = some(where (p.eft == allow))</span><br><span class="line"></span><br><span class="line"><span class="section">[matchers]</span></span><br><span class="line"><span class="attr">m</span> = g(r.sub, p.sub) &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act</span><br></pre></td></tr></table></figure>

<p><strong><code>policy.csv</code></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">p, admin, /data1, read</span><br><span class="line">p, admin, /data1, write</span><br><span class="line">p, alice, /data2, read</span><br><span class="line">p, alice, /data2, write</span><br><span class="line"></span><br><span class="line">g, bob, admin</span><br></pre></td></tr></table></figure>

<p><strong>Go 代码 (<code>main.go</code>)</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/casbin/casbin/v2&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/casbin/casbin/v2/util&quot;</span> <span class="comment">// 用于匹配器中的一些实用函数，如 keyMatch</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">check</span><span class="params">(e *casbin.Enforcer, sub, obj, act <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">	ok, err := e.Enforce(sub, obj, act)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;授权检查出错: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ok &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;%s 可以 %s %s\n&quot;</span>, sub, act, obj)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;%s 不可以 %s %s\n&quot;</span>, sub, act, obj)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 1. 从文件加载模型和策略，创建 Enforcer</span></span><br><span class="line">	<span class="comment">// enforcer, err := casbin.NewEnforcer(&quot;rbac_model.conf&quot;, &quot;policy.csv&quot;)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1.1 使用 NewEnforcerWithSyncedAdapter 以支持策略热加载 (当使用数据库适配器时尤其有用)</span></span><br><span class="line">	<span class="comment">// 本地文件系统也可以使用 NewEnforcer</span></span><br><span class="line">	enforcer, err := casbin.NewEnforcer(<span class="string">&quot;rbac_model.conf&quot;</span>, <span class="string">&quot;policy.csv&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;创建 Casbin Enforcer 失败: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 将一些实用函数注册到 Casbin，以便在匹配器中使用</span></span><br><span class="line">	<span class="comment">// 例如，keyMatch 可以在匹配器中进行通配符路径匹配</span></span><br><span class="line">	enforcer.AddFunction(<span class="string">&quot;keyMatch&quot;</span>, util.KeyMatch)</span><br><span class="line">	enforcer.AddFunction(<span class="string">&quot;keyMatch2&quot;</span>, util.KeyMatch2) <span class="comment">// 支持更复杂的通配符模式</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. 授权检查</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;--- 授权检查开始 ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// admin 角色的权限</span></span><br><span class="line">	check(enforcer, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;/data1&quot;</span>, <span class="string">&quot;read&quot;</span>)  <span class="comment">// admin 可以 read /data1</span></span><br><span class="line">	check(enforcer, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;/data1&quot;</span>, <span class="string">&quot;write&quot;</span>) <span class="comment">// admin 可以 write /data1</span></span><br><span class="line">	check(enforcer, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;/data2&quot;</span>, <span class="string">&quot;read&quot;</span>)  <span class="comment">// admin 不可以 read /data2 (通过策略，admin没有此权限)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// bob (是 admin 角色的成员) 的权限</span></span><br><span class="line">	check(enforcer, <span class="string">&quot;bob&quot;</span>, <span class="string">&quot;/data1&quot;</span>, <span class="string">&quot;read&quot;</span>)  <span class="comment">// bob 可以 read /data1 (通过 g 关系继承 admin 权限)</span></span><br><span class="line">	check(enforcer, <span class="string">&quot;bob&quot;</span>, <span class="string">&quot;/data1&quot;</span>, <span class="string">&quot;write&quot;</span>) <span class="comment">// bob 可以 write /data1</span></span><br><span class="line">	check(enforcer, <span class="string">&quot;bob&quot;</span>, <span class="string">&quot;/data2&quot;</span>, <span class="string">&quot;read&quot;</span>)  <span class="comment">// bob 不可以 read /data2</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// alice 的权限</span></span><br><span class="line">	check(enforcer, <span class="string">&quot;alice&quot;</span>, <span class="string">&quot;/data1&quot;</span>, <span class="string">&quot;read&quot;</span>)  <span class="comment">// alice 不可以 read /data1</span></span><br><span class="line">	check(enforcer, <span class="string">&quot;alice&quot;</span>, <span class="string">&quot;/data2&quot;</span>, <span class="string">&quot;read&quot;</span>)  <span class="comment">// alice 可以 read /data2</span></span><br><span class="line">	check(enforcer, <span class="string">&quot;alice&quot;</span>, <span class="string">&quot;/data2&quot;</span>, <span class="string">&quot;write&quot;</span>) <span class="comment">// alice 可以 write /data2</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 测试一个不存在的用户</span></span><br><span class="line">	check(enforcer, <span class="string">&quot;charlie&quot;</span>, <span class="string">&quot;/data1&quot;</span>, <span class="string">&quot;read&quot;</span>) <span class="comment">// charlie 不可以 read /data1</span></span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;--- 授权检查结束 ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4. 运行时管理策略 (如果使用文件适配器，这些修改不会持久化到 policy.csv)</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- 运行时管理策略 ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加策略</span></span><br><span class="line">	<span class="comment">// AddPolicy(p.sub, p.obj, p.act)</span></span><br><span class="line">	enforcer.AddPolicy(<span class="string">&quot;alice&quot;</span>, <span class="string">&quot;/data3&quot;</span>, <span class="string">&quot;read&quot;</span>)</span><br><span class="line">	check(enforcer, <span class="string">&quot;alice&quot;</span>, <span class="string">&quot;/data3&quot;</span>, <span class="string">&quot;read&quot;</span>) <span class="comment">// alice 现在可以 read /data3</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加角色继承关系</span></span><br><span class="line">	<span class="comment">// AddGroupingPolicy(user, role)</span></span><br><span class="line">	enforcer.AddGroupingPolicy(<span class="string">&quot;charlie&quot;</span>, <span class="string">&quot;alice&quot;</span>) <span class="comment">// charlie 成为 alice 角色的成员</span></span><br><span class="line">	check(enforcer, <span class="string">&quot;charlie&quot;</span>, <span class="string">&quot;/data2&quot;</span>, <span class="string">&quot;read&quot;</span>)   <span class="comment">// charlie 现在可以 read /data2 (继承 alice 权限)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 移除策略</span></span><br><span class="line">	<span class="comment">// RemovePolicy(p.sub, p.obj, p.act)</span></span><br><span class="line">	enforcer.RemovePolicy(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;/data1&quot;</span>, <span class="string">&quot;write&quot;</span>)</span><br><span class="line">	check(enforcer, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;/data1&quot;</span>, <span class="string">&quot;write&quot;</span>) <span class="comment">// admin 不可以 write /data1 了</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 移除角色继承关系</span></span><br><span class="line">	enforcer.RemoveGroupingPolicy(<span class="string">&quot;bob&quot;</span>, <span class="string">&quot;admin&quot;</span>)</span><br><span class="line">	check(enforcer, <span class="string">&quot;bob&quot;</span>, <span class="string">&quot;/data1&quot;</span>, <span class="string">&quot;read&quot;</span>) <span class="comment">// bob 不可以 read /data1 了</span></span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;--- 运行时管理策略结束 ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 持久化策略 (仅当使用支持持久化的适配器时有效，如数据库适配器)</span></span><br><span class="line">	<span class="comment">// enforcer.SavePolicy()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、Casbin-访问控制模型详解"><a href="#四、Casbin-访问控制模型详解" class="headerlink" title="四、Casbin 访问控制模型详解"></a>四、Casbin 访问控制模型详解</h2><p>Casbin 的强大之处在于其灵活的模型配置。通过修改 <code>rbac_model.conf</code>，你可以实现多种访问控制模型。</p>
<h3 id="4-1-ACL-Access-Control-List-访问控制列表"><a href="#4-1-ACL-Access-Control-List-访问控制列表" class="headerlink" title="4.1 ACL (Access Control List - 访问控制列表)"></a>4.1 ACL (Access Control List - 访问控制列表)</h3><p>这是最基础的模型，直接指定用户对资源的权限。</p>
<p><strong>模型 (<code>acl_model.conf</code>)</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[request_definition]</span></span><br><span class="line"><span class="attr">r</span> = sub, obj, act</span><br><span class="line"></span><br><span class="line"><span class="section">[policy_definition]</span></span><br><span class="line"><span class="attr">p</span> = sub, obj, act</span><br><span class="line"></span><br><span class="line"><span class="section">[policy_effect]</span></span><br><span class="line"><span class="attr">e</span> = some(where (p.eft == allow))</span><br><span class="line"></span><br><span class="line"><span class="section">[matchers]</span></span><br><span class="line"><span class="attr">m</span> = r.sub == p.sub &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act</span><br></pre></td></tr></table></figure>

<p><strong>策略 (<code>acl_policy.csv</code>)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p, alice, /data1, read</span><br><span class="line">p, bob, /data2, write</span><br></pre></td></tr></table></figure>

<h3 id="4-2-RBAC-Role-Based-Access-Control-基于角色的访问控制"><a href="#4-2-RBAC-Role-Based-Access-Control-基于角色的访问控制" class="headerlink" title="4.2 RBAC (Role-Based Access Control - 基于角色的访问控制)"></a>4.2 RBAC (Role-Based Access Control - 基于角色的访问控制)</h3><p>通过引入角色层，将权限赋予角色，再将用户赋予角色。这是最常用的模型之一。</p>
<p><strong>模型 (<code>rbac_model.conf</code>)</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[request_definition]</span></span><br><span class="line"><span class="attr">r</span> = sub, obj, act</span><br><span class="line"></span><br><span class="line"><span class="section">[policy_definition]</span></span><br><span class="line"><span class="attr">p</span> = sub, obj, act</span><br><span class="line"></span><br><span class="line"><span class="section">[role_definition]</span></span><br><span class="line"><span class="attr">g</span> = _, _ <span class="comment"># 定义了角色关系</span></span><br><span class="line"></span><br><span class="line"><span class="section">[policy_effect]</span></span><br><span class="line"><span class="attr">e</span> = some(where (p.eft == allow))</span><br><span class="line"></span><br><span class="line"><span class="section">[matchers]</span></span><br><span class="line"><span class="attr">m</span> = g(r.sub, p.sub) &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act</span><br></pre></td></tr></table></figure>

<p><strong>策略 (<code>rbac_policy.csv</code>)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">p, admin, /data1, read</span><br><span class="line">p, admin, /data1, write</span><br><span class="line">p, viewer, /data2, read</span><br><span class="line"></span><br><span class="line">g, alice, admin # alice 是 admin 角色</span><br><span class="line">g, bob, viewer  # bob 是 viewer 角色</span><br></pre></td></tr></table></figure>
<p>这里 <code>g(r.sub, p.sub)</code> 是 Casbin 内置函数，用于检查 <code>r.sub</code> 是否属于 <code>p.sub</code> 角色组。</p>
<h3 id="4-3-ABAC-Attribute-Based-Access-Control-基于属性的访问控制"><a href="#4-3-ABAC-Attribute-Based-Access-Control-基于属性的访问控制" class="headerlink" title="4.3 ABAC (Attribute-Based Access Control - 基于属性的访问控制)"></a>4.3 ABAC (Attribute-Based Access Control - 基于属性的访问控制)</h3><p>根据用户、资源、操作的属性以及环境属性来动态决定访问权限。这是最灵活但也最复杂的模型。</p>
<p><strong>模型 (<code>abac_model.conf</code>)</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[request_definition]</span></span><br><span class="line"><span class="attr">r</span> = sub, obj, act</span><br><span class="line"></span><br><span class="line"><span class="section">[policy_definition]</span></span><br><span class="line"><span class="attr">p</span> = sub_age, obj_owner, act</span><br><span class="line"></span><br><span class="line"><span class="section">[policy_effect]</span></span><br><span class="line"><span class="attr">e</span> = some(where (p.eft == allow))</span><br><span class="line"></span><br><span class="line"><span class="section">[matchers]</span></span><br><span class="line"><span class="comment"># 匹配器中直接引用请求的属性和策略的属性</span></span><br><span class="line"><span class="attr">m</span> = r.sub.age &gt; <span class="number">18</span> &amp;&amp; r.obj.owner == r.sub.name &amp;&amp; r.act == p.act</span><br></pre></td></tr></table></figure>

<p><strong>策略 (<code>abac_policy.csv</code>)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 这里 p.sub_age 和 p.obj_owner 都是数字或字符串，用于比较</span><br><span class="line">p, 18, bob, read # 策略允许年龄 &gt; 18 且 obj_owner 是 bob 的用户 read</span><br></pre></td></tr></table></figure>
<p>在 Go 代码中，<code>Enforce</code> 时需要传递结构体或 map 来表示属性：<br><code>e.Enforce(map[string]interface&#123;&#125;&#123;&quot;age&quot;: 20, &quot;name&quot;: &quot;bob&quot;&#125;, map[string]interface&#123;&#125;&#123;&quot;owner&quot;: &quot;bob&quot;&#125;, &quot;read&quot;)</code></p>
<h3 id="4-4-RESTful-风格的路径匹配"><a href="#4-4-RESTful-风格的路径匹配" class="headerlink" title="4.4 RESTful 风格的路径匹配"></a>4.4 RESTful 风格的路径匹配</h3><p>利用 Casbin 的 <code>keyMatch</code> 或 <code>keyMatch2</code> 函数可以在匹配器中实现 URL 路径的通配符匹配。</p>
<p><strong>模型 (<code>restful_model.conf</code>)</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[request_definition]</span></span><br><span class="line"><span class="attr">r</span> = sub, obj, act</span><br><span class="line"></span><br><span class="line"><span class="section">[policy_definition]</span></span><br><span class="line"><span class="attr">p</span> = sub, obj, act</span><br><span class="line"></span><br><span class="line"><span class="section">[policy_effect]</span></span><br><span class="line"><span class="attr">e</span> = some(where (p.eft == allow))</span><br><span class="line"></span><br><span class="line"><span class="section">[matchers]</span></span><br><span class="line"><span class="attr">m</span> = r.sub == p.sub &amp;&amp; keyMatch2(r.obj, p.obj) &amp;&amp; r.act == p.act</span><br></pre></td></tr></table></figure>

<p><strong>策略 (<code>restful_policy.csv</code>)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p, alice, /users/:id, GET # 允许 alice GET /users/1, /users/2 等</span><br><span class="line">p, admin, /admin/*, *   # 允许 admin 对 /admin/ 下的所有资源执行所有操作</span><br></pre></td></tr></table></figure>

<h2 id="五、Casbin-的架构图"><a href="#五、Casbin-的架构图" class="headerlink" title="五、Casbin 的架构图"></a>五、Casbin 的架构图</h2><div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    graph TD
    A[应用] --&gt; B[Casbin Enforcer]

    subgraph Casbin Core
        B --加载--&gt; C[&quot;模型 (Model.conf)&quot;]
        B --加载&#x2F;保存--&gt; D[&quot;策略 (Policy.csv &#x2F; DB)&quot;]
        D --适配器 (Adapter)--&gt; E[&quot;持久化存储 (文件&#x2F;数据库)&quot;]
    end

    B --授权请求 (sub, &lt;br&gt;obj, act, ... )--&gt; F[&quot;匹配器 (Matchers)&quot;]
    F --根据模型和策略计算--&gt; G{&quot;授权结果 (允许&#x2F;拒绝)&quot;}
    G --&gt; B
    B --&gt; H[应用响应]
  </pre></div>

<p><strong>说明</strong>：</p>
<ul>
<li><strong>Enforcer</strong>：Casbin 的核心执行器，是与应用程序交互的主要接口。它加载模型和策略，并进行授权检查。</li>
<li><strong>Model (模型)</strong>：定义了访问控制规则的结构。</li>
<li><strong>Policy (策略)</strong>：包含具体的访问控制数据。</li>
<li><strong>Adapter (适配器)</strong>：负责 Enforcer 与持久化存储之间的数据交换。</li>
<li><strong>Matcher (匹配器)</strong>：根据模型中定义的逻辑表达式，将授权请求与策略进行匹配，并结合策略生效原则 (Policy Effect) 决定最终的授权结果。</li>
</ul>
<h2 id="六、高级特性与最佳实践"><a href="#六、高级特性与最佳实践" class="headerlink" title="六、高级特性与最佳实践"></a>六、高级特性与最佳实践</h2><ol>
<li><p><strong>数据库适配器</strong>：生产环境强烈建议使用数据库适配器 (如 <code>gorm-adapter</code>, <code>xorm-adapter</code>) 来存储策略，以便动态更新和管理。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/casbin/gorm-adapter/v3&quot;</span> <span class="comment">// GORM 适配器</span></span><br><span class="line">    _ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span> <span class="comment">// MySQL 驱动</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 初始化数据库适配器</span></span><br><span class="line">a, err := gormadapter.NewAdapter(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;user:password@tcp(127.0.0.1:3306)/casbin?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;</span>, <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;创建数据库适配器失败: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从数据库加载模型和策略</span></span><br><span class="line">e, err := casbin.NewEnforcer(<span class="string">&quot;rbac_model.conf&quot;</span>, a)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;创建 Casbin Enforcer 失败: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">e.LoadPolicy() <span class="comment">// 从数据库加载策略</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 运行时修改策略后，记得调用 e.SavePolicy() 来持久化</span></span><br><span class="line"><span class="comment">// e.SavePolicy()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Watcher (观察者)</strong>：当策略在多个 Casbin 实例之间共享时 (例如在分布式系统中)，Watcher 可以通知所有实例策略发生了变化，促使它们重新加载策略，实现策略的热更新。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/casbin/casbin/v2/persist/watcher&quot;</span> <span class="comment">// Redis Watcher</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">w, err := watcher.NewRedisWatcher(<span class="string">&quot;redis://localhost:6379/0&quot;</span>) <span class="comment">// 例如 Redis Watcher</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;创建 Watcher 失败: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">e.SetWatcher(w)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当策略发生变化时，调用 e.SavePolicy() 会通过 Watcher 通知其他实例</span></span><br><span class="line"><span class="comment">// w.Update() 也可以手动触发通知</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>日志记录 (<code>Logger</code>)</strong>：Casbin 支持自定义日志记录，方便调试和审计。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/casbin/casbin/v2/log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 启用 Casbin 内部日志</span></span><br><span class="line">log.Set <span class="string">&quot;); // Example: log.SetLogger(&amp;myCustomLogger&#123;&#125;)</span></span><br><span class="line"><span class="string">e.EnableLog(true)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>性能优化</strong>：</p>
<ul>
<li><strong>启用缓存</strong>：<code>e.EnableAutoSave(false)</code> 和 <code>e.EnableAutoLoad(false)</code>，然后手动控制 <code>LoadPolicy()</code> 和 <code>SavePolicy()</code>。</li>
<li><strong>批处理查询</strong>：使用 <code>e.BatchEnforce()</code> 进行批量授权检查。</li>
<li><strong>最小化策略</strong>：只存储必要的策略数据。</li>
</ul>
</li>
<li><p><strong>自定义函数</strong>：在匹配器中可以使用自定义的 Go 函数来处理更复杂的逻辑。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hasPermission</span><span class="params">(user <span class="type">string</span>, permission <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// ... 自定义权限逻辑</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 Go 代码中注册</span></span><br><span class="line">e.AddFunction(<span class="string">&quot;hasPermission&quot;</span>, hasPermission)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在模型中使用</span></span><br><span class="line"><span class="comment">// [matchers]</span></span><br><span class="line"><span class="comment">// m = hasPermission(r.sub, p.sub_permission) &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>安全考虑</strong>：</p>
<ul>
<li><strong>保护模型和策略文件</strong>：确保它们不被未经授权的人修改。</li>
<li><strong>最小权限原则</strong>：只授予用户或角色所需的最小权限。</li>
<li><strong>定期审计</strong>：定期审查授权策略，确保其仍然符合业务需求。</li>
</ul>
</li>
</ol>
<h2 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h2><p>Casbin 是一个功能强大、高度灵活的 Go 语言授权库。它通过<strong>模型与策略分离</strong>的设计理念，将授权逻辑从业务代码中解耦，使得应用程序的授权管理变得更加清晰、可维护和可扩展。无论是简单的 ACL、复杂的 RBAC 还是动态的 ABAC，Casbin 都能通过配置模型文件轻松实现。结合其丰富的适配器、Watcher、日志和性能优化选项，Casbin 成为了 Go 应用程序中实现企业级访问控制的理想选择。开发者应深入理解其核心概念，并结合最佳实践来构建健壮、安全的授权系统。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg">TeaTang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg/6b2d6f99090f/">https://blog.tbf1211.xx.kg/6b2d6f99090f/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tbf1211.xx.kg" target="_blank">1024 维度</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Golang/">Golang</a><a class="post-meta__tags" href="/tags/2025/">2025</a><a class="post-meta__tags" href="/tags/Cron/">Cron</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover-24.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/bd9bce873bad/" title="Node.js 本地静态服务详解：http-server 与 live-server"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-14.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Node.js 本地静态服务详解：http-server 与 live-server</div></div><div class="info-2"><div class="info-item-1"> 在前端开发过程中，我们经常需要一个本地服务器来预览 HTML、CSS、JavaScript 等静态文件。虽然许多现代前端框架（如 React, Vue, Angular）都自带了开发服务器，但对于一些简单的项目、纯静态网站或快速原型开发，使用 Node.js 提供轻量级的本地静态服务器会更加方便快捷。本文将详细介绍两个广受欢迎的 Node.js 静态服务器工具：http-server 和 live-server。  “好的本地开发服务器，让你的前端工作流如丝般顺滑。”   一、为什么需要本地静态服务？在浏览器中直接打开本地的 HTML 文件（file:/// 协议）通常会有一些限制和问题：  AJAX&#x2F;Fetch 请求受限：浏览器出于安全考虑（同源策略），不允许 file:/// 协议下的页面进行跨域 AJAX 请求，甚至无法加载本地其他文件的 AJAX 请求。 动态加载问题：某些 JavaScript 模块加载器（如 ES Module import 语句）在 file:/// 协议下可能无法正常工作。 开发工具功能不全：一些浏览器扩展或开发工具可能依赖于 HTTP...</div></div></div></a><a class="pagination-related" href="/f71cbfee727d/" title="Go 语言 Cron 任务调度详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-17.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Go 语言 Cron 任务调度详解</div></div><div class="info-2"><div class="info-item-1"> Cron 是一种广泛应用于 Unix-like 操作系统中的时间任务调度工具。在 Go 语言中，为了方便地实现类似的功能，开发者通常会借助第三方库。其中，github.com/robfig/cron/v3 是一个功能强大、广泛采用且维护良好的 Go 语言 Cron 库，它提供了一个灵活、可靠的方式来定义和执行周期性任务。  核心思想：将遵循标准 Cron 表达式的任务调度逻辑封装在一个 Go 协程安全 (Goroutine-safe) 的调度器中，允许开发者以声明式的方式定义定时任务，并自动在指定时间触发执行。   一、为什么需要 Cron 任务调度？在软件开发中，许多场景需要定时执行特定的任务，例如：  数据同步与备份：每天凌晨备份数据库，或每小时同步一次外部数据源。 报告生成：每周、每月自动生成业务报表。 清理任务：定期清理过期缓存、日志文件或无效用户数据。 监控与告警：每隔几分钟检查系统状态或服务健康状况。 批量处理：在业务低峰期处理大量离线数据。  手动触发或简单的 time.Sleep 循环无法有效管理这些任务：  time.Sleep 难以处理复杂的时间规则（如“每...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/f71cbfee727d/" title="Go 语言 Cron 任务调度详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-17.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-19</div><div class="info-item-2">Go 语言 Cron 任务调度详解</div></div><div class="info-2"><div class="info-item-1"> Cron 是一种广泛应用于 Unix-like 操作系统中的时间任务调度工具。在 Go 语言中，为了方便地实现类似的功能，开发者通常会借助第三方库。其中，github.com/robfig/cron/v3 是一个功能强大、广泛采用且维护良好的 Go 语言 Cron 库，它提供了一个灵活、可靠的方式来定义和执行周期性任务。  核心思想：将遵循标准 Cron 表达式的任务调度逻辑封装在一个 Go 协程安全 (Goroutine-safe) 的调度器中，允许开发者以声明式的方式定义定时任务，并自动在指定时间触发执行。   一、为什么需要 Cron 任务调度？在软件开发中，许多场景需要定时执行特定的任务，例如：  数据同步与备份：每天凌晨备份数据库，或每小时同步一次外部数据源。 报告生成：每周、每月自动生成业务报表。 清理任务：定期清理过期缓存、日志文件或无效用户数据。 监控与告警：每隔几分钟检查系统状态或服务健康状况。 批量处理：在业务低峰期处理大量离线数据。  手动触发或简单的 time.Sleep 循环无法有效管理这些任务：  time.Sleep 难以处理复杂的时间规则（如“每...</div></div></div></a><a class="pagination-related" href="/7642665c9bbb/" title="Golang context 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-09.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-03</div><div class="info-item-2">Golang context 详解</div></div><div class="info-2"><div class="info-item-1"> context 包 是 Go 语言标准库中的一个关键组件，自 Go 1.7 版本引入，它提供了一种在 Goroutine 之间传递请求范围的数据 (request-scoped data)、取消信号 (cancellation signals) 和截止时间 (deadlines) 的标准机制。在构建复杂的并发系统、微服务架构以及处理网络请求链时，context 包是管理 Goroutine 生命周期和避免资源泄露的基石。  核心思想：context.Context 接口允许在 Goroutine 树中安全地传递控制流信息。其核心价值在于实现对计算任务的统一取消、超时控制和值传递，从而提升程序的健壮性和资源利用效率。   一、context 包的必要性在 Go 语言中，Goroutine 是轻量级并发的基础。然而，当应用程序的并发逻辑变得复杂时，以下问题会变得突出：  并发操作的取消：当一个上游操作（如用户取消请求）不再需要其下游的所有并发子任务时，如何有效地通知并停止这些子任务，避免不必要的计算和资源消耗？ 操作超时控制：如何在复杂的请求链中，为整个链条或其中某个环节设置统一的...</div></div></div></a><a class="pagination-related" href="/2565d3c3db01/" title="Go语言embed包详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-13.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-12</div><div class="info-item-2">Go语言embed包详解</div></div><div class="info-2"><div class="info-item-1"> Go 标准库从 Go 1.16 版本开始引入了 embed 1 包。这个包提供了一种简单、声明式的方式，允许开发者将静态文件（如 HTML 模板、CSS、JavaScript、图片、配置文件等）直接嵌入到 Go 可执行文件中。这意味着你可以通过一个独立的二进制文件分发所有应用程序所需的资源，而无需额外管理外部文件，极大地简化了部署和分发过程。  核心思想：将应用程序的外部资源（静态文件）编译进最终的二进制文件，实现“单一二进制文件”的发布和部署，消除外部文件依赖带来的复杂性。   一、为什么需要 embed 包？在 embed 包之前，Go 语言应用程序处理静态资源通常有以下几种方式：  外部文件：将静态文件与可执行文件放在一起分发。这会带来：  部署复杂性：需要确保文件结构正确，并处理文件丢失或路径错误的问题。 文件篡改风险：外部文件容易被修改，可能影响程序的行为或安全性。 分发不便：每次更新都需要同步可执行文件和所有相关资源文件。   go:embed 第三方库：许多第三方库（如 go-bindata, packr）实现了文件嵌入功能。这些库虽然有效，但通常需要一些额外的构...</div></div></div></a><a class="pagination-related" href="/fec0454e87d6/" title="Golang Gin 框架深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-14.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-24</div><div class="info-item-2">Golang Gin 框架深度解析</div></div><div class="info-2"><div class="info-item-1"> Gin 是一个用 Go 语言编写的 HTTP Web 框架，它以高性能和易用性著称。Gin 框架通过一个类似 Martini 的 API，但拥有显著更高的性能，这得益于其底层优化的路由引擎 httprouter。它非常适合构建 RESTful API 服务、微服务和高并发的 Web 应用程序。  核心思想：Gin 通过一个轻量级的路由引擎和可插拔的中间件机制，提供了一个快速、灵活且强大的 Web 开发骨架，将请求处理分解为一系列可管理的阶段。   一、为什么选择 Gin？在 Go 语言的 Web 框架中，Gin 凭借以下优势脱颖而出：  极高性能：Gin 宣称其性能比其他 Go 框架（如 net/http 原生路由器、Martini 等）高出 40 倍，因为它使用了优化的 httprouter 库，并且避免了反射。 易于使用：简洁的 API 设计使得学习曲线平缓，开发者可以快速上手并构建应用。 中间件支持：强大的中间件机制允许开发者在请求处理流程中插入自定义逻辑，如日志记录、认证、错误恢复等，实现代码复用和模块化。 路由灵活：支持丰富的路由定义，包括参数路由、通配符路由和路由组...</div></div></div></a><a class="pagination-related" href="/6f6d3fe5250e/" title="fasthttp 深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-10.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-29</div><div class="info-item-2">fasthttp 深度解析</div></div><div class="info-2"><div class="info-item-1"> fasthttp 是一个用 Go 语言编写的、高性能的 HTTP 服务器和客户端库。它旨在提供比 Go 标准库 net/http 更快的 HTTP 处理速度和更低的资源消耗。fasthttp 尤其适用于构建高性能的 API 服务、反向代理、负载均衡器以及任何对延迟和吞吐量有严苛要求的应用。  核心思想：fasthttp 通过零内存分配、请求&#x2F;响应对象重用、定制化的 HTTP 解析器以及对标准库的精简依赖，实现了极高的性能。它在设计上对性能进行了极致优化，但代价是与 net/http API 不完全兼容。   一、为什么选择 fasthttp？(与 Go 标准库 net/http 的对比)Go 语言标准库 net/http 提供了功能完善且易于使用的 HTTP 服务器和客户端，适用于绝大多数 Web 应用场景。然而，在某些对性能有极致要求的场景下，fasthttp 可以提供显著的优势：    特性 net/http (标准库) fasthttp    性能 良好，但在高并发下可能存在 GC 压力和额外开销。 卓越，旨在实现业界领先的性能 (通常比标准库快 5-10 倍)...</div></div></div></a><a class="pagination-related" href="/dd01f3539cef/" title="GORM (Go Object Relational Mapper) 深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-05.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-01</div><div class="info-item-2">GORM (Go Object Relational Mapper) 深度解析</div></div><div class="info-2"><div class="info-item-1"> GORM 是 Go 语言中一个功能强大、对开发者友好的 ORM (Object Relational Mapper) 库。它旨在简化 Go 应用程序与数据库之间的交互，通过 Go 结构体（struct）来定义数据模型，并提供了一套丰富的 API 来执行数据库的 CRUD (Create, Read, Update, Delete) 操作、管理数据库迁移、处理关联关系、事务等。GORM 拥有广泛的数据库支持，包括 MySQL, PostgreSQL, SQLite, SQL Server 等。  核心思想：将数据库表映射为 Go 结构体，将数据库操作转换为 Go 对象的增删改查。 屏蔽了底层 SQL 的复杂性，提高了开发效率和代码可维护性。   一、为什么需要 ORM 及 GORM 的优势1.1 传统 SQL 操作的局限性在没有 ORM 的情况下，使用 Go 语言操作数据库通常涉及：  手动编写 SQL 语句：需要为每种操作（增、删、改、查）编写相应的 SQL 语句。 手动映射数据：从数据库查询结果集 (rows) 手动扫描到 Go 结构体中。 类型转换和错误处理：需要处理数据库...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TeaTang</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">345</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">206</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">74</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/teatang"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:tea.tang1211@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站更多功能即将上线，敬请期待！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-Casbin%EF%BC%9F%E4%BC%A0%E7%BB%9F%E6%8E%88%E6%9D%83%E6%96%B9%E5%BC%8F%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-text">一、为什么需要 Casbin？传统授权方式的局限性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Casbin-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">二、Casbin 的核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%A8%A1%E5%9E%8B-Model"><span class="toc-text">2.1 模型 (Model)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%AD%96%E7%95%A5-Policy"><span class="toc-text">2.2 策略 (Policy)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E9%80%82%E9%85%8D%E5%99%A8-Adapter"><span class="toc-text">2.3 适配器 (Adapter)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">三、基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%AE%89%E8%A3%85-Casbin"><span class="toc-text">3.1 安装 Casbin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E7%A4%BA%E4%BE%8B"><span class="toc-text">3.2 快速入门示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Casbin-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E6%A8%A1%E5%9E%8B%E8%AF%A6%E8%A7%A3"><span class="toc-text">四、Casbin 访问控制模型详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-ACL-Access-Control-List-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E5%88%97%E8%A1%A8"><span class="toc-text">4.1 ACL (Access Control List - 访问控制列表)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-RBAC-Role-Based-Access-Control-%E5%9F%BA%E4%BA%8E%E8%A7%92%E8%89%B2%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-text">4.2 RBAC (Role-Based Access Control - 基于角色的访问控制)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-ABAC-Attribute-Based-Access-Control-%E5%9F%BA%E4%BA%8E%E5%B1%9E%E6%80%A7%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-text">4.3 ABAC (Attribute-Based Access Control - 基于属性的访问控制)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-RESTful-%E9%A3%8E%E6%A0%BC%E7%9A%84%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D"><span class="toc-text">4.4 RESTful 风格的路径匹配</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81Casbin-%E7%9A%84%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">五、Casbin 的架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">六、高级特性与最佳实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">七、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/15920229f914/" title="Supabase 深度解析"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-06.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Supabase 深度解析"/></a><div class="content"><a class="title" href="/15920229f914/" title="Supabase 深度解析">Supabase 深度解析</a><time datetime="2025-12-02T22:24:00.000Z" title="发表于 2025-12-03 06:24:00">2025-12-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/1ae20d2726d8/" title="MiniRTC 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-14.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MiniRTC 详解"/></a><div class="content"><a class="title" href="/1ae20d2726d8/" title="MiniRTC 详解">MiniRTC 详解</a><time datetime="2025-11-28T22:24:00.000Z" title="发表于 2025-11-29 06:24:00">2025-11-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/be24ef88e59a/" title="WebRTC 技术详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-25.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WebRTC 技术详解"/></a><div class="content"><a class="title" href="/be24ef88e59a/" title="WebRTC 技术详解">WebRTC 技术详解</a><time datetime="2025-11-27T22:24:00.000Z" title="发表于 2025-11-28 06:24:00">2025-11-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/53e63dc49a04/" title="PyInstaller 深度解析与指令详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-03.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PyInstaller 深度解析与指令详解"/></a><div class="content"><a class="title" href="/53e63dc49a04/" title="PyInstaller 深度解析与指令详解">PyInstaller 深度解析与指令详解</a><time datetime="2025-11-24T22:24:00.000Z" title="发表于 2025-11-25 06:24:00">2025-11-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/61fddda6a7a8/" title="Go 语言 GC (Garbage Collection) 机制详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-20.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go 语言 GC (Garbage Collection) 机制详解"/></a><div class="content"><a class="title" href="/61fddda6a7a8/" title="Go 语言 GC (Garbage Collection) 机制详解">Go 语言 GC (Garbage Collection) 机制详解</a><time datetime="2025-11-23T22:24:00.000Z" title="发表于 2025-11-24 06:24:00">2025-11-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/default_cover-24.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">我的轨迹</div><div class="footer-flex-content"><a href="/archives/2023/" target="_blank" title="📌 2023">📌 2023</a><a href="/archives/2024/" target="_blank" title="❓ 2024">❓ 2024</a><a href="/archives/2025/" target="_blank" title="🚀 2025">🚀 2025</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">维度</div><div class="footer-flex-content"><a href="/categories/" target="_blank" title="分类">分类</a><a href="/tags/" target="_blank" title="标签">标签</a><a href="/categories/" target="_blank" title="时间线">时间线</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/shuoshuo" target="_blank" title="说说">说说</a></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2025 By TeaTang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.4/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script></div><script data-pjax src="/self/btf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="ture"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,200,200" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      true
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script>(() => {
  const option = null
  const config = {"site_uv":true,"site_pv":true,"page_pv":true,"token":"qTvz1SkmPDt785fgh6BpiA5qiFFIVUwxj8Ft+rPW+cdN59v1hXjwRgSmy0+ji9m+oLlcxvo2NfDSMa6epVl3NTlsN3ejCIwWeP8Y51aEJ0Sbem4UexGmJLspB7AkOBId2SdtT6QWEBlGmFIIQgchQ2zAKYxTmc/kpBED5aLSr+3uvmQ9/G7FJQeVFpveDkK0xM1hu36xq4a6/FSeROxtoEp5zabzTWiYTlLsQzIl/NlELnCq3nxK+oo/vl3UQo/oM/rae/gJX/MaVKsgIUCd2ABJogNkx2KTenBIBpbPki5FzOgPh6/z4GPa4HvhNO51DDVG1SEQZooqEYmt/gnybLBWFbN+7liZWw=="}

  const runTrack = () => {
    if (typeof umami !== 'undefined' && typeof umami.track === 'function') {
      umami.track(props => ({ ...props, url: window.location.pathname, title: GLOBAL_CONFIG_SITE.title }))
    } else {
      console.warn('Umami Analytics: umami.track is not available')
    }
  }

  const loadUmamiJS = () => {
    btf.getScript('https://umami.012700.xyz/script.js', {
      'data-website-id': '2a796d6c-6499-42d8-8eb4-d9a2930b0ff3',
      'data-auto-track': 'false',
      ...option
    }).then(() => {
      runTrack()
    }).catch(error => {
      console.error('Umami Analytics: Error loading script', error)
    })
  }

  const getData = async (isPost) => {
    try {
      const now = Date.now()
      const keyUrl = isPost ? `&url=${window.location.pathname}` : ''
      const headerList = { 'Accept': 'application/json' }

      if (true) {
        headerList['Authorization'] = `Bearer ${config.token}`
      } else {
        headerList['x-umami-api-key'] = config.token
      }

      const res = await fetch(`https://umami.012700.xyz/api/websites/2a796d6c-6499-42d8-8eb4-d9a2930b0ff3/stats?startAt=0000000000&endAt=${now}${keyUrl}`, {
        method: "GET",
        headers: headerList
      })

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`)
      }

      return await res.json()
    } catch (error) {
      console.error('Umami Analytics: Failed to fetch data', error)
      throw error
    }
  }

  const insertData = async () => {
    try {
      if (GLOBAL_CONFIG_SITE.pageType === 'post' && config.page_pv) {
        const pagePV = document.getElementById('umamiPV')
        if (pagePV) {
          const data = await getData(true)
          if (data && data.pageviews && typeof data.pageviews.value !== 'undefined') {
            pagePV.textContent = data.pageviews.value
          } else {
            console.warn('Umami Analytics: Invalid page view data received')
          }
        }
      }

      if (config.site_uv || config.site_pv) {
        const data = await getData(false)

        if (config.site_uv) {
          const siteUV = document.getElementById('umami-site-uv')
          if (siteUV && data && data.visitors && typeof data.visitors.value !== 'undefined') {
            siteUV.textContent = data.visitors.value
          } else if (siteUV) {
            console.warn('Umami Analytics: Invalid site UV data received')
          }
        }

        if (config.site_pv) {
          const sitePV = document.getElementById('umami-site-pv')
          if (sitePV && data && data.pageviews && typeof data.pageviews.value !== 'undefined') {
            sitePV.textContent = data.pageviews.value
          } else if (sitePV) {
            console.warn('Umami Analytics: Invalid site PV data received')
          }
        }
      }
    } catch (error) {
      console.error('Umami Analytics: Failed to insert data', error)
    }
  }

  btf.addGlobalFn('pjaxComplete', runTrack, 'umami_analytics_run_track')
  btf.addGlobalFn('pjaxComplete', insertData, 'umami_analytics_insert')


  loadUmamiJS()

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', insertData)
  } else {
    setTimeout(insertData, 100)
  }
})()</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.2"></script></div></div></body></html>