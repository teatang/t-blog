<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Golang sqlc 框架详解 | 1024 维度</title><meta name="author" content="TeaTang"><meta name="copyright" content="TeaTang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="sqlc 是一个SQL 编译器 (SQL Compiler)，它能够根据用户定义的 SQL 查询和数据库 Schema 自动生成类型安全 (type-safe) 的 Go 代码。与传统的 ORM (Object-Relational Mapping) 工具不同，sqlc 的核心理念是“写 SQL，生成 Go (Write SQL, Get Go)”。开发者专注于编写原生的 SQL 查询，sqlc">
<meta property="og:type" content="article">
<meta property="og:title" content="Golang sqlc 框架详解">
<meta property="og:url" content="https://blog.tbf1211.xx.kg/3059cdc5f529/index.html">
<meta property="og:site_name" content="1024 维度">
<meta property="og:description" content="sqlc 是一个SQL 编译器 (SQL Compiler)，它能够根据用户定义的 SQL 查询和数据库 Schema 自动生成类型安全 (type-safe) 的 Go 代码。与传统的 ORM (Object-Relational Mapping) 工具不同，sqlc 的核心理念是“写 SQL，生成 Go (Write SQL, Get Go)”。开发者专注于编写原生的 SQL 查询，sqlc">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-12.jpg">
<meta property="article:published_time" content="2026-01-01T22:24:00.000Z">
<meta property="article:modified_time" content="2026-01-16T10:25:31.981Z">
<meta property="article:author" content="TeaTang">
<meta property="article:tag" content="Golang">
<meta property="article:tag" content="2025">
<meta property="article:tag" content="SQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-12.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Golang sqlc 框架详解",
  "url": "https://blog.tbf1211.xx.kg/3059cdc5f529/",
  "image": "https://blog.tbf1211.xx.kg/img/cover/default_cover-12.jpg",
  "datePublished": "2026-01-01T22:24:00.000Z",
  "dateModified": "2026-01-16T10:25:31.981Z",
  "author": [
    {
      "@type": "Person",
      "name": "TeaTang",
      "url": "https://blog.tbf1211.xx.kg"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon-1.ico"><link rel="canonical" href="https://blog.tbf1211.xx.kg/3059cdc5f529/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.7/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":true,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: TeaTang","link":"链接: ","source":"来源: 1024 维度","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Golang sqlc 框架详解',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="1024 维度" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">497</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">226</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/cover/default_cover-12.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">1024 维度</span></a><a class="nav-page-title" href="/"><span class="site-name">Golang sqlc 框架详解</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Golang sqlc 框架详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2026-01-01T22:24:00.000Z" title="发表于 2026-01-02 06:24:00">2026-01-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Golang/">Golang</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Golang/%E5%BA%93/">库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><strong>sqlc</strong> 是一个<strong>SQL 编译器 (SQL Compiler)</strong>，它能够根据用户定义的 SQL 查询和数据库 Schema 自动生成类型安全 (type-safe) 的 Go 代码。与传统的 ORM (Object-Relational Mapping) 工具不同，<code>sqlc</code> 的核心理念是“<strong>写 SQL，生成 Go (Write SQL, Get Go)</strong>”。开发者专注于编写原生的 SQL 查询，<code>sqlc</code> 则负责将其转换为易于在 Go 应用程序中使用的、无反射、高性能的 API。</p>
</blockquote>
<div class="note info flat"><p>核心思想：<strong>保持 SQL 源码作为事实的唯一来源，并通过代码生成器将其无缝集成到 Go 代码中，实现类型安全和高效的数据库操作。</strong> 它不尝试将 SQL 抽象化，而是将 SQL 语句转换为可直接调用的 Go 函数。</p>
</div>

<hr>
<h2 id="一、为什么选择-sqlc？"><a href="#一、为什么选择-sqlc？" class="headerlink" title="一、为什么选择 sqlc？"></a>一、为什么选择 sqlc？</h2><p>在 Golang 中进行数据库操作，开发者通常面临几种选择：</p>
<ol>
<li><strong>直接使用 <code>database/sql</code> 库</strong>：最底层、最灵活，但需要手动处理行扫描、错误检查、参数绑定等，代码量大且容易出错。</li>
<li><strong>使用传统 ORM (如 GORM, XORM)</strong>：提供了高层次的抽象，通过 Go 结构体标签或方法调用来构建 SQL，但可能引入“魔术”、性能开销 (反射)、N+1 查询问题，以及在复杂查询时难以控制生成的 SQL。</li>
<li><strong>使用 <code>sqlc</code></strong>：介于两者之间，它结合了 <code>database/sql</code> 的性能和 SQL 的控制力，同时提供了 ORM 的类型安全和便利性。</li>
</ol>
<p><code>sqlc</code> 的主要优势包括：</p>
<ol>
<li><strong>类型安全 (Type-Safety)</strong>：<code>sqlc</code> 在编译时就能够检查 SQL 查询的语法和参数类型。它根据数据库 Schema 和 SQL 查询的返回结果，生成具有精确类型签名的 Go 函数和结构体。这意味着你可以在编码阶段捕获许多潜在的数据库错误，而不是在运行时。</li>
<li><strong>性能 (Performance)</strong>：<code>sqlc</code> 不使用反射，生成的 Go 代码直接调用 <code>database/sql</code> 的方法，性能接近手写 SQL。</li>
<li><strong>SQL 主导 (SQL-First)</strong>：开发者直接编写和维护原生的 SQL 查询。这使得数据库专家可以专注于优化 SQL 语句，而无需关心 Go 层的实现细节。生成的 Go 代码只是 SQL 的一个类型安全封装。</li>
<li><strong>可维护性 (Maintainability)</strong>：SQL 查询清晰可见，易于理解和调试。生成的 Go 代码是可读且可预测的，便于集成到项目中。</li>
<li><strong>避免 ORM 弊端</strong>：无需学习复杂的 ORM API，不必担心 ORM 隐式生成的低效 SQL 或 N+1 查询问题。</li>
<li><strong>多数据库支持</strong>：支持 PostgreSQL, MySQL, SQLite, Oracle 等主流关系型数据库。</li>
<li><strong>工具友好</strong>：由于 SQL 查询是独立的 <code>.sql</code> 文件，可以利用各种 SQL 编辑器、格式化工具和 Lint 工具进行管理。</li>
</ol>
<h2 id="二、sqlc-的核心概念"><a href="#二、sqlc-的核心概念" class="headerlink" title="二、sqlc 的核心概念"></a>二、sqlc 的核心概念</h2><p><code>sqlc</code> 的工作流程和核心概念相对直观：</p>
<h3 id="2-1-数据库-Schema-DDL"><a href="#2-1-数据库-Schema-DDL" class="headerlink" title="2.1 数据库 Schema (DDL)"></a>2.1 数据库 Schema (DDL)</h3><p><code>sqlc</code> 需要你的数据库 Schema 来理解表结构、列类型和约束。你通常会提供一个或多个 SQL 文件，其中包含 <code>CREATE TABLE</code> 等 DDL (Data Definition Language) 语句。<code>sqlc</code> 会解析这些文件，构建数据库的内部表示。</p>
<h3 id="2-2-SQL-查询文件"><a href="#2-2-SQL-查询文件" class="headerlink" title="2.2 SQL 查询文件"></a>2.2 SQL 查询文件</h3><p>这是你编写原生 SQL 查询的地方。每个 SQL 文件可以包含多个查询，每个查询都应该有一个唯一的名称（通过 SQL 注释指定），<code>sqlc</code> 会根据这个名称生成对应的 Go 函数。</p>
<p><strong>示例：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- name: GetUser :one</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name, email <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> ?;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- name: ListUsers :many</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name, email <span class="keyword">FROM</span> users <span class="keyword">ORDER</span> <span class="keyword">BY</span> name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- name: CreateUser :execrows</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, email) <span class="keyword">VALUES</span> (?, ?);</span><br></pre></td></tr></table></figure>

<h3 id="2-3-sqlc-yaml-配置文件"><a href="#2-3-sqlc-yaml-配置文件" class="headerlink" title="2.3 sqlc.yaml 配置文件"></a>2.3 <code>sqlc.yaml</code> 配置文件</h3><p>这个 YAML 文件定义了 <code>sqlc</code> 的行为，包括：</p>
<ul>
<li><code>schema</code>: 指向你的数据库 Schema DDL 文件。</li>
<li><code>queries</code>: 指向你的 SQL 查询文件。</li>
<li><code>version</code>: <code>sqlc</code> 配置的版本 (目前是 <code>v2</code>)。</li>
<li><code>plugins</code>: 定义要生成的语言和目标路径。</li>
<li><code>overrides</code>: 允许你将特定的 SQL 类型映射到自定义的 Go 类型。</li>
<li><code>sql</code>: 数据库类型 (<code>mysql</code>, <code>postgresql</code>, <code>sqlite</code>)，以及其他 SQL 相关的配置。</li>
</ul>
<h3 id="2-4-生成的代码-Go"><a href="#2-4-生成的代码-Go" class="headerlink" title="2.4 生成的代码 (Go)"></a>2.4 生成的代码 (Go)</h3><p><code>sqlc</code> 会根据 Schema 和查询文件生成以下 Go 代码：</p>
<ul>
<li><strong><code>models.go</code></strong>: 包含与数据库表行对应的 Go 结构体。例如，如果 <code>SELECT id, name, email FROM users</code>，则会生成一个 <code>User</code> 结构体。</li>
<li><strong><code>queries.go</code></strong>: 包含所有 SQL 查询对应的 Go 函数。每个函数都接受 <code>context.Context</code> 和查询参数，并返回查询结果或错误。</li>
<li><strong><code>db.go</code></strong>: 包含 <code>Querier</code> 接口 (定义了所有查询函数) 和 <code>New</code> 函数 (用于创建 <code>Querier</code> 实例)。</li>
<li><strong><code>copyfrom.go</code> (可选)</strong>: 如果启用，用于批量插入优化。</li>
</ul>
<h3 id="2-5-Querier-接口"><a href="#2-5-Querier-接口" class="headerlink" title="2.5 Querier 接口"></a>2.5 <code>Querier</code> 接口</h3><p><code>sqlc</code> 会自动生成一个 <code>Querier</code> 接口，其中包含了所有你在 SQL 查询文件中定义的查询函数。你的应用程序代码将主要通过这个接口来与数据库进行交互。</p>
<h2 id="三、sqlc-的工作流程"><a href="#三、sqlc-的工作流程" class="headerlink" title="三、sqlc 的工作流程"></a>三、sqlc 的工作流程</h2><p><code>sqlc</code> 的典型工作流程如下：</p>
<div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    graph TD
    A[定义数据库Schema] --&gt; B[编写SQL查询];
    B --&gt; C[配置sqlc.yaml];
    C -- 运行 sqlc generate --&gt; D[生成类型安全的Go代码];
    D --&gt; E[在应用程序中使用&lt;br&gt;生成的Go代码];

    subgraph Schema 定义
        A1[&quot;schema.sql (DDL)&quot;]
        A --&gt; A1
    end

    subgraph SQL 查询
        B1[&quot;query.sql (SELECT, &lt;br&gt;INSERT, UPDATE, DELETE)&quot;]
        B --&gt; B1
    end

    subgraph sqlc 配置
        C1[sqlc.yaml]
        C --&gt; C1
    end

    subgraph Go 应用程序
        E1[main.go, service.go 等]
        E --&gt; E1
    end
  </pre></div>

<p><strong>详细步骤：</strong></p>
<ol>
<li><strong>编写 DDL (Data Definition Language) 文件 (<code>schema.sql</code>)</strong>: 定义你的数据库表结构。</li>
<li><strong>编写 SQL 查询文件 (<code>query.sql</code>)</strong>: 包含你想要在 Go 代码中使用的所有 <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code> 语句。每个查询前加上 <code>--- name: QueryName :returntype</code> 注释。</li>
<li><strong>创建 <code>sqlc.yaml</code> 配置文件</strong>: 指明 Schema 文件、查询文件、目标语言和输出路径等。</li>
<li><strong>运行 <code>sqlc generate</code> 命令</strong>: <code>sqlc</code> 会读取配置文件、Schema 文件和查询文件，然后生成相应的 Go 代码。</li>
<li><strong>在 Go 应用程序中使用生成的代码</strong>: 你可以通过 <code>sqlc.New(db)</code> 创建 <code>Querier</code> 实例，然后调用其上的方法来执行数据库操作。</li>
</ol>
<h2 id="四、sqlc-实践示例-MySQL"><a href="#四、sqlc-实践示例-MySQL" class="headerlink" title="四、sqlc 实践示例 (MySQL)"></a>四、sqlc 实践示例 (MySQL)</h2><p>本示例将创建一个简单的 <code>users</code> 表，并实现 CRUD 操作。</p>
<h3 id="4-1-准备工作"><a href="#4-1-准备工作" class="headerlink" title="4.1 准备工作"></a>4.1 准备工作</h3><ol>
<li><p><strong>初始化 Go 项目</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> sqlc-demo &amp;&amp; <span class="built_in">cd</span> sqlc-demo</span><br><span class="line">go mod init sqlc-demo</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>安装 <code>sqlc</code> CLI 工具和数据库驱动</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest</span><br><span class="line">go get github.com/go-sql-driver/mysql <span class="comment"># 或者 github.com/lib/pq for PostgreSQL</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="4-2-定义数据库-Schema-schema-sql"><a href="#4-2-定义数据库-Schema-schema-sql" class="headerlink" title="4.2 定义数据库 Schema (schema.sql)"></a>4.2 定义数据库 Schema (<code>schema.sql</code>)</h3><p>创建一个 <code>schema.sql</code> 文件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- schema.sql</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="4-3-编写-SQL-查询-query-sql"><a href="#4-3-编写-SQL-查询-query-sql" class="headerlink" title="4.3 编写 SQL 查询 (query.sql)"></a>4.3 编写 SQL 查询 (<code>query.sql</code>)</h3><p>创建一个 <code>query.sql</code> 文件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- query.sql</span></span><br><span class="line"><span class="comment">-- name: CreateUser :execresult</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, email) <span class="keyword">VALUES</span> (?, ?);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- name: GetUserByID :one</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name, email, created_at <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> ?;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- name: GetUserByEmail :one</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name, email, created_at <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> email <span class="operator">=</span> ?;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- name: ListUsers :many</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name, email, created_at <span class="keyword">FROM</span> users <span class="keyword">ORDER</span> <span class="keyword">BY</span> name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- name: UpdateUserName :execrows</span></span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> name <span class="operator">=</span> ? <span class="keyword">WHERE</span> id <span class="operator">=</span> ?;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- name: DeleteUser :exec</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> ?;</span><br></pre></td></tr></table></figure>
<p><strong><code>:</code> 后面的注释 (<code>:one</code>, <code>:many</code>, <code>:exec</code>, <code>:execresult</code>, <code>:execrows</code>) 是 <code>sqlc</code> 特定的，用于指示查询的返回类型：</strong></p>
<ul>
<li><code>:one</code>: 期望返回单行结果。生成的函数返回一个结构体和一个错误 (如果未找到则为 <code>sql.ErrNoRows</code>)。</li>
<li><code>:many</code>: 期望返回多行结果。生成的函数返回一个结构体切片和一个错误。</li>
<li><code>:exec</code>: 执行 DML (INSERT, UPDATE, DELETE) 语句，不返回结果集。生成的函数返回 <code>error</code>。</li>
<li><code>:execrows</code>: 执行 DML 语句，返回受影响的行数 (<code>int64</code>)。</li>
<li><code>:execresult</code>: 执行 DML 语句，返回 <code>sql.Result</code> 接口 (包含 <code>LastInsertId</code> 和 <code>RowsAffected</code>)。</li>
</ul>
<h3 id="4-4-配置-sqlc-yaml"><a href="#4-4-配置-sqlc-yaml" class="headerlink" title="4.4 配置 sqlc.yaml"></a>4.4 配置 <code>sqlc.yaml</code></h3><p>创建一个 <code>sqlc.yaml</code> 文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sqlc.yaml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="attr">sql:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">engine:</span> <span class="string">&quot;mysql&quot;</span> <span class="comment"># 或 &quot;postgresql&quot;, &quot;sqlite&quot;</span></span><br><span class="line">    <span class="attr">queries:</span> <span class="string">&quot;query.sql&quot;</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">&quot;schema.sql&quot;</span></span><br><span class="line">    <span class="attr">codegen:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">out:</span> <span class="string">&quot;sqlc&quot;</span> <span class="comment"># 生成的 Go 代码的输出目录</span></span><br><span class="line">        <span class="attr">plugin:</span> <span class="string">&quot;go&quot;</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">package:</span> <span class="string">&quot;sqlc&quot;</span> <span class="comment"># 生成的 Go 包名</span></span><br><span class="line">          <span class="attr">emit_json_tags:</span> <span class="literal">true</span> <span class="comment"># 为生成的结构体字段添加 JSON tag</span></span><br><span class="line">          <span class="attr">emit_prepared_queries:</span> <span class="literal">false</span> <span class="comment"># 不生成预处理语句，默认 false</span></span><br><span class="line">          <span class="attr">emit_interface:</span> <span class="literal">true</span> <span class="comment"># 生成 Querier 接口</span></span><br><span class="line">          <span class="attr">emit_exact_table_names:</span> <span class="literal">false</span> <span class="comment"># 使用小写单数形式作为默认结构体名</span></span><br><span class="line">          <span class="attr">emit_empty_slices:</span> <span class="literal">true</span> <span class="comment"># 查询结果为空时返回空切片而不是 nil</span></span><br><span class="line">          <span class="comment"># sql_type_to_go_type: # 可选：自定义 SQL 类型到 Go 类型的映射</span></span><br><span class="line">          <span class="comment">#   - db_type: &quot;timestamptz&quot;</span></span><br><span class="line">          <span class="comment">#     go_type: &quot;github.com/jackc/pgx/v5/pgtype.Timestamptz&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-5-生成-Go-代码"><a href="#4-5-生成-Go-代码" class="headerlink" title="4.5 生成 Go 代码"></a>4.5 生成 Go 代码</h3><p>运行 <code>sqlc generate</code> 命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlc generate</span><br></pre></td></tr></table></figure>
<p>这将在 <code>sqlc/</code> 目录下生成 <code>db.go</code>, <code>models.go</code>, <code>query.go</code> 文件。</p>
<h3 id="4-6-编写-Go-应用程序-main-go"><a href="#4-6-编写-Go-应用程序-main-go" class="headerlink" title="4.6 编写 Go 应用程序 (main.go)"></a>4.6 编写 Go 应用程序 (<code>main.go</code>)</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;database/sql&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;sqlc-demo/sqlc&quot;</span> <span class="comment">// 引入 sqlc 生成的包</span></span><br><span class="line"></span><br><span class="line">	_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span> <span class="comment">// 引入 MySQL 驱动</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 1. 连接数据库</span></span><br><span class="line">	db, err := sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;root:pass@tcp(127.0.0.1:3306)/sqlc_demo?parseTime=true&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to open database connection: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> db.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err = db.Ping(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to connect to database: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="string">&quot;Successfully connected to the database!&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 确保数据库中存在 &#x27;sqlc_demo&#x27; 数据库，并已执行 schema.sql</span></span><br><span class="line">	<span class="comment">// 在生产环境中，你会使用专门的迁移工具来管理 schema。</span></span><br><span class="line">	<span class="comment">// 这里为了演示，假设表已存在。</span></span><br><span class="line"></span><br><span class="line">	ctx := context.Background()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 创建 sqlc.Queries 实例</span></span><br><span class="line">	queries := sqlc.New(db)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- CRUD Operations ---</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create User</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- Create User ---&quot;</span>)</span><br><span class="line">	createResult, err := queries.CreateUser(ctx, sqlc.CreateUserParams&#123;</span><br><span class="line">		Name:  <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">		Email: <span class="string">&quot;alice@example.com&quot;</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to create user: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	aliceID, _ := createResult.LastInsertId()</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Created user Alice with ID: %d\n&quot;</span>, aliceID)</span><br><span class="line"></span><br><span class="line">	createResult, err = queries.CreateUser(ctx, sqlc.CreateUserParams&#123;</span><br><span class="line">		Name:  <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">		Email: <span class="string">&quot;bob@example.com&quot;</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to create user: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	bobID, _ := createResult.LastInsertId()</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Created user Bob with ID: %d\n&quot;</span>, bobID)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get User by ID</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- Get User by ID ---&quot;</span>)</span><br><span class="line">	userAlice, err := queries.GetUserByID(ctx, <span class="type">int32</span>(aliceID))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err == sql.ErrNoRows &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;User with ID %d not found.\n&quot;</span>, aliceID)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">&quot;failed to get user by ID: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Found user by ID: %+v\n&quot;</span>, userAlice)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get User by Email</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- Get User by Email ---&quot;</span>)</span><br><span class="line">	userBob, err := queries.GetUserByEmail(ctx, <span class="string">&quot;bob@example.com&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err == sql.ErrNoRows &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;User with email bob@example.com not found.&quot;</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">&quot;failed to get user by email: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Found user by email: %+v\n&quot;</span>, userBob)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// List Users</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- List Users ---&quot;</span>)</span><br><span class="line">	users, err := queries.ListUsers(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to list users: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;All users:&quot;</span>)</span><br><span class="line">	<span class="keyword">for</span> _, u := <span class="keyword">range</span> users &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;- %+v\n&quot;</span>, u)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update User Name</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- Update User Name ---&quot;</span>)</span><br><span class="line">	rowsAffected, err := queries.UpdateUserName(ctx, sqlc.UpdateUserNameParams&#123;</span><br><span class="line">		Name: <span class="string">&quot;Alice Smith&quot;</span>,</span><br><span class="line">		ID:   <span class="type">int32</span>(aliceID),</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to update user name: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Updated %d rows for user ID %d\n&quot;</span>, rowsAffected, aliceID)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Verify update</span></span><br><span class="line">	userAliceUpdated, err := queries.GetUserByID(ctx, <span class="type">int32</span>(aliceID))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to get updated user: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Updated user Alice: %+v\n&quot;</span>, userAliceUpdated)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Delete User</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- Delete User ---&quot;</span>)</span><br><span class="line">	err = queries.DeleteUser(ctx, <span class="type">int32</span>(bobID))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to delete user: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Deleted user with ID: %d\n&quot;</span>, bobID)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Verify deletion</span></span><br><span class="line">	_, err = queries.GetUserByID(ctx, <span class="type">int32</span>(bobID))</span><br><span class="line">	<span class="keyword">if</span> err == sql.ErrNoRows &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;User with ID %d not found after deletion (as expected).\n&quot;</span>, bobID)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to get deleted user: %v&quot;</span>, err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;User found after deletion (deletion failed).&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- Transaction Example ---</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- Transaction Example ---&quot;</span>)</span><br><span class="line">	tx, err := db.BeginTx(ctx, <span class="literal">nil</span>) <span class="comment">// 开始事务</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to begin transaction: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 在事务中使用 sqlc.Queries</span></span><br><span class="line">	txQueries := queries.WithTx(tx) <span class="comment">// 重要：使用 WithTx 创建一个事务专用的 Querier 实例</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 在事务中创建新用户</span></span><br><span class="line">	carolResult, err := txQueries.CreateUser(ctx, sqlc.CreateUserParams&#123;</span><br><span class="line">		Name:  <span class="string">&quot;Carol&quot;</span>,</span><br><span class="line">		Email: fmt.Sprintf(<span class="string">&quot;carol_%d@example.com&quot;</span>, time.Now().UnixNano()),</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback() <span class="comment">// 失败时回滚</span></span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to create Carol in transaction: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	carolID, _ := carolResult.LastInsertId()</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Created user Carol in transaction with ID: %d\n&quot;</span>, carolID)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 假设这里有一些业务逻辑，可能导致错误</span></span><br><span class="line">	<span class="keyword">if</span> <span class="literal">false</span> &#123; <span class="comment">// 模拟一个错误，这将导致回滚</span></span><br><span class="line">		tx.Rollback()</span><br><span class="line">		fmt.Println(<span class="string">&quot;Transaction rolled back due to error.&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		tx.Commit() <span class="comment">// 成功时提交</span></span><br><span class="line">		fmt.Println(<span class="string">&quot;Transaction committed successfully.&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 确认 Carol 是否存在 (如果提交了事务)</span></span><br><span class="line">	userCarol, err := queries.GetUserByID(ctx, <span class="type">int32</span>(carolID))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Carol not found after transaction (expected if rolled back): %v\n&quot;</span>, err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Carol found after transaction commit: %+v\n&quot;</span>, userCarol)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-7-运行示例"><a href="#4-7-运行示例" class="headerlink" title="4.7 运行示例"></a>4.7 运行示例</h3><ol>
<li>确保 MySQL 数据库已运行，并创建了名为 <code>sqlc_demo</code> 的数据库。</li>
<li>更新 <code>main.go</code> 中的数据库连接字符串。</li>
<li>手动在 <code>sqlc_demo</code> 数据库中执行 <code>schema.sql</code> 中的 <code>CREATE TABLE</code> 语句，或者在 <code>main.go</code> 中添加自动执行 <code>schema.sql</code> 的逻辑 (不推荐在生产环境)。</li>
<li>运行 <code>main.go</code>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="五、高级用法和特性"><a href="#五、高级用法和特性" class="headerlink" title="五、高级用法和特性"></a>五、高级用法和特性</h2><ol>
<li><strong>Null 值处理</strong>：<code>sqlc</code> 可以配置如何处理数据库中的 <code>NULL</code> 值。默认情况下，它会生成 Go 语言的 <code>sql.NullString</code>, <code>sql.NullInt32</code> 等类型。你也可以在 <code>sqlc.yaml</code> 中配置 <code>sql_type_to_go_type</code> 将其映射为 Go 指针类型 (如 <code>*string</code>) 或第三方库的 Nullable 类型 (如 <code>pgx/v5/pgtype</code>)。</li>
<li><strong>自定义类型</strong>：通过 <code>sql_type_to_go_type</code> 配置，你可以将数据库的自定义类型 (如 PostgreSQL 的 <code>UUID</code> 类型) 映射到 Go 中的特定类型。</li>
<li><strong>事务</strong>：<code>sqlc</code> 支持事务操作。你可以通过 <code>db.BeginTx(ctx, nil)</code> 开始一个事务，然后使用 <code>queries.WithTx(tx)</code> 方法创建一个新的 <code>Querier</code> 实例，该实例的所有操作都会在同一个事务中执行。</li>
<li><strong>Prepared Statements</strong>：<code>sqlc</code> 默认生成的查询会使用预处理语句，这提高了性能并防止了 SQL 注入。</li>
<li><strong>批量插入&#x2F;更新</strong>：对于支持 <code>COPY FROM</code> (PostgreSQL) 或 <code>LOAD DATA LOCAL INFILE</code> (MySQL) 等批量操作的数据库，<code>sqlc</code> 可以生成相应的代码，显著提高数据导入效率。</li>
<li><strong>Hooks</strong>：通过 <code>sqlc.yaml</code> 配置，可以运行自定义 Go 命令来处理生成的代码，例如格式化或 Lint。</li>
</ol>
<h2 id="六、sqlc-的优缺点与适用场景"><a href="#六、sqlc-的优缺点与适用场景" class="headerlink" title="六、sqlc 的优缺点与适用场景"></a>六、sqlc 的优缺点与适用场景</h2><h3 id="6-1-优点："><a href="#6-1-优点：" class="headerlink" title="6.1 优点："></a>6.1 优点：</h3><ol>
<li><strong>极高的类型安全性</strong>：编译时捕获 SQL 错误和类型不匹配，提高代码质量和稳定性。</li>
<li><strong>高性能</strong>：无反射开销，生成的代码直接使用 <code>database/sql</code>，性能接近手写 SQL。</li>
<li><strong>SQL 主导</strong>：保持 SQL 的原生优势和控制力，方便数据库专家进行优化。</li>
<li><strong>易于维护和调试</strong>：SQL 和 Go 代码都清晰可见，逻辑透明。</li>
<li><strong>避免 ORM 陷阱</strong>：避免了 ORM 可能带来的复杂性、隐式行为和性能问题。</li>
<li><strong>工具生态友好</strong>：可以直接使用现有 SQL 工具链进行 SQL 文件的管理。</li>
</ol>
<h3 id="6-2-缺点："><a href="#6-2-缺点：" class="headerlink" title="6.2 缺点："></a>6.2 缺点：</h3><ol>
<li><strong>学习曲线</strong>：对于习惯了 ORM 的开发者，需要适应 <code>sqlc</code> 的代码生成和 SQL-First 范式。</li>
<li><strong>SQL 文件的管理</strong>：随着项目增长，SQL 查询文件会增多，需要良好的组织和命名规范。</li>
<li><strong>不处理 Schema 迁移</strong>：<code>sqlc</code> 仅关注查询，Schema 迁移仍需配合其他工具（如 <code>golang-migrate</code>, <code>flyway</code>, <code>ent</code> 的迁移工具等）。</li>
<li><strong>关联查询的复杂性</strong>：对于非常复杂的 JOIN 查询，可能需要手动编写更多的 SQL，而 ORM 可能会提供更高级的抽象。然而，这也可以看作是一种优势，因为它迫使你更清楚地理解 SQL。</li>
<li><strong>少量样板代码</strong>：每次修改 Schema 或 <code>query.sql</code> 都需要重新运行 <code>sqlc generate</code>。</li>
</ol>
<h3 id="6-3-适用场景："><a href="#6-3-适用场景：" class="headerlink" title="6.3 适用场景："></a>6.3 适用场景：</h3><ul>
<li><strong>对性能和类型安全有高要求</strong>：例如高性能后端服务、数据处理服务。</li>
<li><strong>希望保持 SQL 原生控制力</strong>：当开发者希望完全控制 SQL 语句，不希望被 ORM 框架过度封装时。</li>
<li><strong>微服务架构</strong>：在微服务中，每个服务可以拥有自己的数据库 Schema 和 <code>sqlc</code> 生成的客户端。</li>
<li><strong>与数据库专家紧密协作</strong>：DBA 或后端开发者可以专注于优化 SQL 语句，Go 开发者只需使用生成的 API。</li>
<li><strong>不希望引入复杂 ORM 依赖的项目</strong>。</li>
</ul>
<h2 id="七、安全性考虑"><a href="#七、安全性考虑" class="headerlink" title="七、安全性考虑"></a>七、安全性考虑</h2><ol>
<li><strong>SQL 注入防护</strong>：<code>sqlc</code> 通过生成参数化查询的代码来<strong>自动防止 SQL 注入</strong>。你只需要在 SQL 中使用占位符 (<code>?</code> for MySQL&#x2F;SQLite, <code>$1, $2</code> for PostgreSQL)，<code>sqlc</code> 会负责将 Go 参数安全地绑定到这些占位符上。</li>
<li><strong>敏感数据处理</strong>：在数据库 Schema 和查询中不应直接暴露敏感信息，例如密码应存储哈希值。</li>
<li><strong>错误处理</strong>：始终检查 <code>sqlc</code> 生成函数返回的 <code>error</code>。特别是 <code>sql.ErrNoRows</code> 表示未找到数据，而不是错误。</li>
<li><strong>数据库连接安全</strong>：数据库连接字符串应从环境变量、配置文件或秘密管理服务中安全加载，绝不硬编码在代码中。</li>
<li><strong>权限控制</strong>：<code>sqlc</code> 专注于数据库交互，不提供应用层面的权限管理。应用程序需要自行实现身份验证和授权逻辑。</li>
<li><strong>Schema 变更审查</strong>：虽然 <code>sqlc</code> 不直接处理迁移，但在更改 <code>schema.sql</code> 后重新生成代码时，应配合版本化的数据库迁移工具，并在生产环境部署前仔细审查迁移脚本。</li>
</ol>
<h2 id="八、总结"><a href="#八、总结" class="headerlink" title="八、总结"></a>八、总结</h2><p><code>sqlc</code> 为 Golang 开发者提供了一个独特且强大的数据库访问方法。它在 <code>database/sql</code> 的性能和 SQL 的控制力之上，构建了一个类型安全的代码生成层。通过将 SQL 查询作为核心，<code>sqlc</code> 使得 Go 应用程序能够以最小的开销和最大的可靠性与数据库进行交互。对于那些重视性能、类型安全、SQL 透明度并乐于编写原生 SQL 的项目和团队来说，<code>sqlc</code> 是一个非常优秀的数据库工具。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg">TeaTang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg/3059cdc5f529/">https://blog.tbf1211.xx.kg/3059cdc5f529/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tbf1211.xx.kg" target="_blank">1024 维度</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Golang/">Golang</a><a class="post-meta__tags" href="/tags/2025/">2025</a><a class="post-meta__tags" href="/tags/SQL/">SQL</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover-12.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/cecf96486ef4/" title="IPC (Inter-Process Communication) 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-21.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">IPC (Inter-Process Communication) 详解</div></div><div class="info-2"><div class="info-item-1"> IPC (Inter-Process Communication)，即进程间通信，是指在多任务操作系统中，不同进程之间进行数据交换和同步行为的一种机制。由于每个进程通常拥有独立的内存空间，不能直接访问其他进程的数据，因此 IPC 机制是构建复杂、协作型多进程应用的关键。它使得进程能够共享信息、协调活动，从而实现更强大的功能和更高的系统效率。  核心思想：克服进程间内存隔离的障碍，提供一套规范化的方法，让独立运行的进程能够安全、有效地交换数据和同步操作。   一、为什么需要 IPC？在现代操作系统中，进程是资源分配和调度的基本单位。为了保证系统的稳定性和安全性，操作系统为每个进程分配独立的内存地址空间。这种内存隔离虽然能有效防止一个进程的错误影响其他进程，但也带来了以下问题：  信息共享：进程间需要共享数据或状态。例如，一个数据生产者进程生成数据，一个数据消费者进程处理数据。 模块化：将一个大型复杂的应用程序拆分成多个独立的、职责单一的进程，每个进程专注于特定任务。这些进程需要相互协作才能完成整体功能。 性能提升：通过并行处理，将不同的任务分配给不同的进程在多核处理器上同时执行，...</div></div></div></a><a class="pagination-related" href="/2e2570e368f1/" title="Golang 并发 Map 详解：sync.Mutex、sync.RWMutex 与 sync.Map 对比"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-22.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Golang 并发 Map 详解：sync.Mutex、sync.RWMutex 与 sync.Map 对比</div></div><div class="info-2"><div class="info-item-1"> 在 Golang 中，内置的 map 类型不是并发安全的。当多个 goroutine 同时对 map 进行读写操作时，会导致竞争条件 (Race Condition)，甚至引发程序崩溃 (fatal error: concurrent map writes)。为了在并发环境下安全地使用 map，我们需要引入同步机制。本文将深入探讨三种常见的解决方案：使用 sync.Mutex 保护 map、使用 sync.RWMutex 保护 map，以及 Go 1.9 引入的 sync.Map，并对它们的特点、适用场景和性能进行对比分析。  核心问题：Go 内置 map 非并发安全。核心解决方案：  sync.Mutex：最简单粗暴，读写都加排他锁。 sync.RWMutex：读写分离锁，允许多个读操作并行，写操作独占。 sync.Map：专为读多写少、键不冲突或键值对持续增长的场景优化，内置无锁或乐观锁机制。     一、Go 内置 map 的并发问题Go 语言设计者有意将内置 map 设计为非并发安全的，主要出于以下考虑：  性能：为了避免在每次 map 操作时都承担锁的开销，从而在单线...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/f200f6bfe5fa/" title="Golang 特殊注释 (Special Comments) 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-04.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-15</div><div class="info-item-2">Golang 特殊注释 (Special Comments) 详解</div></div><div class="info-2"><div class="info-item-1"> 在 Go 语言中，除了我们日常用于解释代码逻辑的普通注释 // 和 /* */ 之外，还存在一些具有特殊含义的注释。这些特殊注释通常以 //go: 或 // + 开头，它们并不是为程序员阅读而生，而是作为指令直接与 Go 工具链（编译器、链接器、go generate 等）交互，用于控制编译行为、生成代码、导入 C 代码，或者提供额外的信息。  核心思想：特殊注释是 Go 工具链的“命令”，用于扩展 Go 语言的能力，例如嵌入文件、生成代码、与 C 语言交互或进行性能优化。   一、Go 特殊注释的分类与作用Go 的特殊注释大致可以分为几类：  编译器指令 (Build Constraints)：控制哪些文件或代码块在特定条件下编译。 代码生成指令 (go generate)：标记需要执行特定外部工具来生成代码的位置。 cgo 指令：用于 Go 和 C&#x2F;C++ 代码之间的互操作。 embed 指令：将静态文件嵌入到 Go 二进制文件中 (Go 1.16+)。 运行时或工具指令：用于性能分析、内存管理等内部或高级用途。  接下来的章节将详细介绍这些特殊注释。 二、//g...</div></div></div></a><a class="pagination-related" href="/fec0454e87d6/" title="Golang Gin 框架深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-31.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-24</div><div class="info-item-2">Golang Gin 框架深度解析</div></div><div class="info-2"><div class="info-item-1"> Gin 是一个用 Go 语言编写的 HTTP Web 框架，它以高性能和易用性著称。Gin 框架通过一个类似 Martini 的 API，但拥有显著更高的性能，这得益于其底层优化的路由引擎 httprouter。它非常适合构建 RESTful API 服务、微服务和高并发的 Web 应用程序。  核心思想：Gin 通过一个轻量级的路由引擎和可插拔的中间件机制，提供了一个快速、灵活且强大的 Web 开发骨架，将请求处理分解为一系列可管理的阶段。   一、为什么选择 Gin？在 Go 语言的 Web 框架中，Gin 凭借以下优势脱颖而出：  极高性能：Gin 宣称其性能比其他 Go 框架（如 net/http 原生路由器、Martini 等）高出 40 倍，因为它使用了优化的 httprouter 库，并且避免了反射。 易于使用：简洁的 API 设计使得学习曲线平缓，开发者可以快速上手并构建应用。 中间件支持：强大的中间件机制允许开发者在请求处理流程中插入自定义逻辑，如日志记录、认证、错误恢复等，实现代码复用和模块化。 路由灵活：支持丰富的路由定义，包括参数路由、通配符路由和路由组...</div></div></div></a><a class="pagination-related" href="/98c39f8e2307/" title="Go 语言协程设计与调度原理"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-10.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-05</div><div class="info-item-2">Go 语言协程设计与调度原理</div></div><div class="info-2"><div class="info-item-1"> Go 语言以其强大的并发特性而闻名，其核心是轻量级协程 (Goroutine) 和高效的调度器。理解 Goroutine 的设计理念以及 Go 运行时如何调度这些协程，对于编写高性能、高并发的 Go 应用程序至关重要。本文将深入探讨 Go 语言协程的设计哲学，并详细解析其背后支撑的 GMP 调度模型。  核心概念：  Goroutine：Go 语言的轻量级并发单元，用户态线程。 GMP 模型：Go 语言运行时调度 Goroutine 的核心模型，由 G (Goroutine)、M (Machine&#x2F;Thread)、P (Processor) 三要素组成。     一、Go 语言协程 (Goroutine) 的设计哲学传统的并发编程通常基于操作系统线程。虽然线程提供了并发能力，但它们也带来了不小的开销：  创建&#x2F;销毁开销大：创建和销毁线程需要向操作系统内核申请资源，涉及系统调用，开销较大。 上下文切换开销大：线程的上下文切换由操作系统内核完成，需要保存和恢复大量的寄存器信息，开销较大。 内存消耗大：每个线程通常需要 MB 级别的栈空间，大量线程会导致内存消耗巨...</div></div></div></a><a class="pagination-related" href="/4e0d929e572f/" title="如何防止 Golang Goroutine 泄漏"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-06.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-31</div><div class="info-item-2">如何防止 Golang Goroutine 泄漏</div></div><div class="info-2"><div class="info-item-1"> 在 Go 语言中，Goroutine 是轻量级的并发执行单元，相比操作系统线程，其创建和销毁的开销极小。然而，这并不意味着我们可以随意创建 Goroutine 而不进行管理。当一个 Goroutine 启动后，如果它无法正常退出，就会一直占用内存和 CPU 资源，这种现象称为 Goroutine 泄漏 (Goroutine Leak)。Goroutine 泄漏会导致程序内存持续增长，最终耗尽系统资源，甚至引发 OOM (Out Of Memory) 错误，严重影响程序的稳定性和性能。  核心思想：Goroutine 泄漏的本质是，一个 Goroutine 完成了其预期的任务，但由于某种原因无法终止或被回收，持续占用资源。防止泄漏的关键在于确保每个 Goroutine 都有明确的退出条件和机制。   一、什么是 Goroutine 泄漏？Goroutine 泄漏是指 Goroutine 在其生命周期结束后未能被 Go 运行时回收，从而持续驻留在内存中。一个泄漏的 Goroutine 会一直占用：  栈内存：每个 Goroutine 都会分配栈空间 (初始 2KB 并动态伸缩)。大...</div></div></div></a><a class="pagination-related" href="/f93f336b1901/" title="Golang 底层的多路复用和调度详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-11.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-21</div><div class="info-item-2">Golang 底层的多路复用和调度详解</div></div><div class="info-2"><div class="info-item-1"> 多路复用 (Multiplexing) 在计算机网络编程中，通常指的是 I&#x2F;O 多路复用 (I&#x2F;O Multiplexing)，它是一种允许单个进程或线程监视多个 I&#x2F;O 事件（如网络连接、文件描述符）并在任何一个 I&#x2F;O 事件准备就绪时通知应用程序的机制。相较于传统的“一个连接一个线程&#x2F;进程”模型，I&#x2F;O 多路复用能够以更低的资源消耗处理大量并发连接，是构建高性能网络服务的基础。  核心思想：Go 语言通过其独特的运行时 (Runtime) 调度器和轻量级协程 (Goroutine) 机制，巧妙地将底层操作系统的 I&#x2F;O 多路复用能力抽象化，为开发者提供了编写简洁、高效且易于并发的网络服务的能力，让 I&#x2F;O 操作看起来像阻塞的，实则在底层是非阻塞的。   一、为什么需要多路复用？在理解 Go 语言如何实现多路复用之前，我们首先需要理解为什么它如此重要，以及它解决了哪些传统网络编程模型的痛点。 1.1 传统模型的问题1.1.1 阻塞 I&#x2F;O (Blocking I&#x2F;O)传统的阻塞...</div></div></div></a><a class="pagination-related" href="/18a421861554/" title="Golang 项目的 Makefile 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-25.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-17</div><div class="info-item-2">Golang 项目的 Makefile 详解</div></div><div class="info-2"><div class="info-item-1"> Makefile 是一种自动化构建工具，它通过定义文件之间的依赖关系和生成这些文件的命令，帮助开发者管理和自动化项目中的各种任务。尽管 Golang 自身提供了强大的内置工具链 (go build, go test, go run 等)，Makefile 在 Go 项目中依然扮演着重要角色，尤其是在需要协调多个任务、管理复杂构建流程、实现跨平台编译、集成外部工具或自动化部署脚本的场景下。  核心思想：将一系列 go 命令、Shell 脚本以及其他工具的调用封装成可复用的、有依赖关系的任务，实现一键式项目管理和自动化。   一、为什么 Go 项目需要 Makefile？Go 语言的工具链设计得非常出色，go build 能够自动处理依赖，go test 能够运行测试，go run 可以直接运行源代码。那么，为什么我们还需要 Makefile 呢？  任务编排与自动化： 一个 Go 项目通常不仅仅是编译代码。它可能涉及代码格式化 (go fmt)、静态分析 (go vet, golangci-lint)、代码生成 (go generate)、测试、构建 Docker 镜像、部署、清...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TeaTang</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">497</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">226</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/teatang"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:tea.tang1211@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站更多功能即将上线，敬请期待！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9-sqlc%EF%BC%9F"><span class="toc-text">一、为什么选择 sqlc？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81sqlc-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">二、sqlc 的核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%95%B0%E6%8D%AE%E5%BA%93-Schema-DDL"><span class="toc-text">2.1 数据库 Schema (DDL)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-SQL-%E6%9F%A5%E8%AF%A2%E6%96%87%E4%BB%B6"><span class="toc-text">2.2 SQL 查询文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-sqlc-yaml-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2.3 sqlc.yaml 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81-Go"><span class="toc-text">2.4 生成的代码 (Go)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Querier-%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.5 Querier 接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81sqlc-%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-text">三、sqlc 的工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81sqlc-%E5%AE%9E%E8%B7%B5%E7%A4%BA%E4%BE%8B-MySQL"><span class="toc-text">四、sqlc 实践示例 (MySQL)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-text">4.1 准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93-Schema-schema-sql"><span class="toc-text">4.2 定义数据库 Schema (schema.sql)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E7%BC%96%E5%86%99-SQL-%E6%9F%A5%E8%AF%A2-query-sql"><span class="toc-text">4.3 编写 SQL 查询 (query.sql)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E9%85%8D%E7%BD%AE-sqlc-yaml"><span class="toc-text">4.4 配置 sqlc.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E7%94%9F%E6%88%90-Go-%E4%BB%A3%E7%A0%81"><span class="toc-text">4.5 生成 Go 代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E7%BC%96%E5%86%99-Go-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F-main-go"><span class="toc-text">4.6 编写 Go 应用程序 (main.go)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B"><span class="toc-text">4.7 运行示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95%E5%92%8C%E7%89%B9%E6%80%A7"><span class="toc-text">五、高级用法和特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81sqlc-%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9%E4%B8%8E%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">六、sqlc 的优缺点与适用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E4%BC%98%E7%82%B9%EF%BC%9A"><span class="toc-text">6.1 优点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E7%BC%BA%E7%82%B9%EF%BC%9A"><span class="toc-text">6.2 缺点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A"><span class="toc-text">6.3 适用场景：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%AE%89%E5%85%A8%E6%80%A7%E8%80%83%E8%99%91"><span class="toc-text">七、安全性考虑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">八、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/e62a1e8acade/" title="AI 辅助编程的关键要点与代码幻觉防范"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-02.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI 辅助编程的关键要点与代码幻觉防范"/></a><div class="content"><a class="title" href="/e62a1e8acade/" title="AI 辅助编程的关键要点与代码幻觉防范">AI 辅助编程的关键要点与代码幻觉防范</a><time datetime="2026-01-15T22:24:00.000Z" title="发表于 2026-01-16 06:24:00">2026-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/fa3d796f3333/" title="MessagePack 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-26.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MessagePack 详解"/></a><div class="content"><a class="title" href="/fa3d796f3333/" title="MessagePack 详解">MessagePack 详解</a><time datetime="2026-01-08T22:24:00.000Z" title="发表于 2026-01-09 06:24:00">2026-01-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/82bf00e3828f/" title="传统命令行工具的现代补强与替代方案详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-11.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="传统命令行工具的现代补强与替代方案详解"/></a><div class="content"><a class="title" href="/82bf00e3828f/" title="传统命令行工具的现代补强与替代方案详解">传统命令行工具的现代补强与替代方案详解</a><time datetime="2026-01-06T22:24:00.000Z" title="发表于 2026-01-07 06:24:00">2026-01-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/cecf96486ef4/" title="IPC (Inter-Process Communication) 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-21.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="IPC (Inter-Process Communication) 详解"/></a><div class="content"><a class="title" href="/cecf96486ef4/" title="IPC (Inter-Process Communication) 详解">IPC (Inter-Process Communication) 详解</a><time datetime="2026-01-04T22:24:00.000Z" title="发表于 2026-01-05 06:24:00">2026-01-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/3059cdc5f529/" title="Golang sqlc 框架详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-12.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Golang sqlc 框架详解"/></a><div class="content"><a class="title" href="/3059cdc5f529/" title="Golang sqlc 框架详解">Golang sqlc 框架详解</a><time datetime="2026-01-01T22:24:00.000Z" title="发表于 2026-01-02 06:24:00">2026-01-02</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/default_cover-12.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">我的轨迹</div><div class="footer-flex-content"><a href="/archives/2023/" target="_blank" title="🆕 2023">🆕 2023</a><a href="/archives/2024/" target="_blank" title="🆒 2024">🆒 2024</a><a href="/archives/2025/" target="_blank" title="👨‍👩‍👦 2025">👨‍👩‍👦 2025</a><a href="/archives/2026/" target="_blank" title="🆙 2026">🆙 2026</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">维度</div><div class="footer-flex-content"><a href="/categories/" target="_blank" title="📁 分类">📁 分类</a><a href="/tags/" target="_blank" title="🔖 标签">🔖 标签</a><a href="/categories/" target="_blank" title="📽️ 时间线">📽️ 时间线</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/shuoshuo" target="_blank" title="💬 说说">💬 说说</a></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By TeaTang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.7/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script></div><script data-pjax src="/self/btf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="ture"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,200,200" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js" defer="defer"></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      true
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.3"></script></div></div></body></html>