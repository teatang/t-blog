<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>LSP (Language Server Protocol) 详解 | 1024 维度</title><meta name="author" content="TeaTang"><meta name="copyright" content="TeaTang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="LSP (Language Server Protocol) 是一个开放的、基于 JSON-RPC 的协议，用于在编程语言特有的服务（通常称为 Language Server）和开发工具（通常是 Editor 或 IDE，称为 Client）之间进行通信。其核心目标是解耦语言特有的功能实现与开发工具的用户界面，从而极大地简化了多语言、多工具环境下的开发体验。  核心思想：将语言的智能特性（如代码">
<meta property="og:type" content="article">
<meta property="og:title" content="LSP (Language Server Protocol) 详解">
<meta property="og:url" content="https://blog.tbf1211.xx.kg/8a2eec4e192e/index.html">
<meta property="og:site_name" content="1024 维度">
<meta property="og:description" content="LSP (Language Server Protocol) 是一个开放的、基于 JSON-RPC 的协议，用于在编程语言特有的服务（通常称为 Language Server）和开发工具（通常是 Editor 或 IDE，称为 Client）之间进行通信。其核心目标是解耦语言特有的功能实现与开发工具的用户界面，从而极大地简化了多语言、多工具环境下的开发体验。  核心思想：将语言的智能特性（如代码">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-03.jpg">
<meta property="article:published_time" content="2025-06-29T22:24:00.000Z">
<meta property="article:modified_time" content="2026-02-05T09:25:21.082Z">
<meta property="article:author" content="TeaTang">
<meta property="article:tag" content="计算机网络">
<meta property="article:tag" content="网络协议">
<meta property="article:tag" content="2025">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-03.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "LSP (Language Server Protocol) 详解",
  "url": "https://blog.tbf1211.xx.kg/8a2eec4e192e/",
  "image": "https://blog.tbf1211.xx.kg/img/cover/default_cover-03.jpg",
  "datePublished": "2025-06-29T22:24:00.000Z",
  "dateModified": "2026-02-05T09:25:21.082Z",
  "author": [
    {
      "@type": "Person",
      "name": "TeaTang",
      "url": "https://blog.tbf1211.xx.kg"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon-1.ico"><link rel="canonical" href="https://blog.tbf1211.xx.kg/8a2eec4e192e/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.9/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":true,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: TeaTang","link":"链接: ","source":"来源: 1024 维度","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'LSP (Language Server Protocol) 详解',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="1024 维度" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">545</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">230</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/cover/default_cover-03.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">1024 维度</span></a><a class="nav-page-title" href="/"><span class="site-name">LSP (Language Server Protocol) 详解</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">LSP (Language Server Protocol) 详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2025-06-29T22:24:00.000Z" title="发表于 2025-06-30 06:24:00">2025-06-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">网络协议</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>21分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><strong>LSP (Language Server Protocol)</strong> 是一个<strong>开放的、基于 JSON-RPC 的协议</strong>，用于在编程语言特有的服务（通常称为 <strong>Language Server</strong>）和开发工具（通常是 <strong>Editor 或 IDE</strong>，称为 <strong>Client</strong>）之间进行通信。其核心目标是<strong>解耦语言特有的功能实现与开发工具的用户界面</strong>，从而极大地简化了多语言、多工具环境下的开发体验。</p>
</blockquote>
<div class="note info flat"><p>核心思想：<strong>将语言的智能特性（如代码补全、跳转定义、错误检查等）从开发工具中抽离出来，放入一个独立的进程（Language Server），然后开发工具通过标准协议（LSP）与这个进程通信。</strong></p>
</div>

<hr>
<h2 id="一、为什么需要-LSP？"><a href="#一、为什么需要-LSP？" class="headerlink" title="一、为什么需要 LSP？"></a>一、为什么需要 LSP？</h2><p>在 LSP 出现之前，每当要为一个新的编程语言或一个新的开发工具提供智能特性时，开发者都需要进行大量的重复工作。这个问题可以形象地描述为 <strong>N*M 问题</strong>：</p>
<ul>
<li><strong>N 种编程语言</strong> (Python, Java, Go, C#, JavaScript…)</li>
<li><strong>M 种开发工具</strong> (VS Code, Vim, Emacs, Sublime Text, Eclipse, IntelliJ…)</li>
</ul>
<p>传统模式下，如果要在 M 种编辑器中为 N 种语言提供代码补全、定义跳转、错误提示等功能，就需要实现 <code>N * M</code> 次集成。例如，VS Code 需要独立实现 Go 语言的解析、Python 的解析；Vim 也需要独立实现 Go 语言的解析、Python 的解析，等等。这导致了：</p>
<ol>
<li><strong>重复劳动</strong>：不同的编辑器需要各自实现相同语言的智能功能。</li>
<li><strong>功能不一致</strong>：不同编辑器对同一语言的支持程度和质量可能大相径庭。</li>
<li><strong>维护困难</strong>：语言规范更新时，所有相关的编辑器插件都需要同步更新。</li>
</ol>
<p>LSP 旨在解决这一痛点，将 <code>N * M</code> 的集成模式转化为 <code>N + M</code>：</p>
<ul>
<li><strong>N 个 Language Server</strong> (每个语言只需要一个核心的 Language Server 实现)</li>
<li><strong>M 个 LSP Client</strong> (每个编辑器只需要实现一次 LSP 客户端逻辑)</li>
</ul>
<p>通过这种方式，编辑器只需实现一次 LSP 客户端逻辑，就可以与任何支持 LSP 的语言服务器通信；而语言服务器只需实现一次 LSP 协议，就可以为任何支持 LSP 的编辑器提供服务。</p>
<div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    graph TD
    subgraph &quot;传统模式 (N*M)&quot;
        E1_traditional[Editor 1]
        E2_traditional[Editor 2]
        L1_traditional[Language A]
        L2_traditional[Language B]

        E1_traditional --&gt;|实现对A的支持| L1_traditional
        E1_traditional --&gt;|实现对B的支持| L2_traditional
        E2_traditional --&gt;|实现对A的支持| L1_traditional
        E2_traditional --&gt;|实现对B的支持| L2_traditional
    end

    subgraph &quot;LSP 模式 (N+M)&quot;
        E1_lsp[&quot;Editor 1 (LSP Client)&quot;]
        E2_lsp[&quot;Editor 2 (LSP Client)&quot;]
        LS1[Language Server A]
        LS2[Language Server B]

        E1_lsp --&gt;|通过LSP通信| LS1
        E1_lsp --&gt;|通过LSP通信| LS2
        E2_lsp --&gt;|通过LSP通信| LS1
        E2_lsp --&gt;|通过LSP通信| LS2
    end
  </pre></div>

<h2 id="二、LSP-的核心概念"><a href="#二、LSP-的核心概念" class="headerlink" title="二、LSP 的核心概念"></a>二、LSP 的核心概念</h2><h3 id="2-1-Language-Server-语言服务器"><a href="#2-1-Language-Server-语言服务器" class="headerlink" title="2.1 Language Server (语言服务器)"></a>2.1 Language Server (语言服务器)</h3><p>一个独立的进程，运行在后台，负责处理所有与特定编程语言相关的“智能”功能，例如：</p>
<ul>
<li><strong>代码补全 (Completion)</strong></li>
<li><strong>定义跳转 (Go to Definition)</strong></li>
<li><strong>引用查找 (Find References)</strong></li>
<li><strong>诊断信息 (Diagnostics)</strong>，如错误、警告和代码风格检查</li>
<li><strong>悬停提示 (Hover)</strong></li>
<li><strong>符号重命名 (Rename Symbol)</strong></li>
<li><strong>代码格式化 (Formatting)</strong></li>
<li><strong>代码操作 (Code Actions)</strong>，如快速修复、重构建议</li>
</ul>
<p>语言服务器通常通过标准输入&#x2F;输出 (stdin&#x2F;stdout) 或 TCP Socket 与客户端通信。</p>
<h3 id="2-2-LSP-Client-LSP-客户端"><a href="#2-2-LSP-Client-LSP-客户端" class="headerlink" title="2.2 LSP Client (LSP 客户端)"></a>2.2 LSP Client (LSP 客户端)</h3><p>集成到开发工具（如 VS Code, NeoVim, Emacs）中的组件，负责：</p>
<ul>
<li><strong>启动和管理</strong>相应的 Language Server 进程。</li>
<li><strong>发送请求</strong>给 Language Server，例如当用户请求代码补全时。</li>
<li><strong>接收并处理</strong> Language Server 返回的响应和通知，例如显示诊断信息或补全列表。</li>
<li><strong>同步文档内容</strong>：当用户在编辑器中修改文件时，客户端需要将这些更改通知给服务器。</li>
</ul>
<h3 id="2-3-JSON-RPC"><a href="#2-3-JSON-RPC" class="headerlink" title="2.3 JSON-RPC"></a>2.3 JSON-RPC</h3><p>LSP 使用 <strong>JSON-RPC 2.0</strong> 作为其底层的通信协议。JSON-RPC 是一种轻量级的远程过程调用协议，它定义了客户端和服务器之间如何发送请求、响应和通知，这些消息都以 JSON 格式编码。</p>
<p><strong>消息类型：</strong></p>
<ul>
<li><strong>Request (请求)</strong>：客户端向服务器（或服务器向客户端，如 <code>client/registerCapability</code>）发送一个带有方法名和参数的消息，并期望收到一个响应。请求包含一个 <code>id</code> 字段，用于匹配响应。</li>
<li><strong>Response (响应)</strong>：对 Request 的回复，包含请求的 <code>id</code> 以及结果 (<code>result</code>) 或错误 (<code>error</code>)。</li>
<li><strong>Notification (通知)</strong>：发送一个不期望收到响应的消息。通常用于传递信息或状态更新，例如当文件内容发生变化时。通知不包含 <code>id</code> 字段。</li>
</ul>
<p><strong>消息格式 (基本结构):</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textDocument/definition&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;textDocument&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file:///path/to/project/main.go&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;character&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Response (Success)</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file:///path/to/project/utils.go&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="attr">&quot;character&quot;</span><span class="punctuation">:</span> <span class="number">0</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="attr">&quot;character&quot;</span><span class="punctuation">:</span> <span class="number">5</span> <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Notification</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textDocument/didChange&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;textDocument&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file:///path/to/project/main.go&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;contentChanges&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> <span class="attr">&quot;character&quot;</span><span class="punctuation">:</span> <span class="number">0</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> <span class="attr">&quot;character&quot;</span><span class="punctuation">:</span> <span class="number">5</span> <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;package main&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-通信管道"><a href="#2-4-通信管道" class="headerlink" title="2.4 通信管道"></a>2.4 通信管道</h3><p>LSP 消息通常通过以下方式传输：</p>
<ul>
<li><strong>标准输入&#x2F;输出 (stdin&#x2F;stdout)</strong>：最常见的传输方式。每个 JSON-RPC 消息前面都必须有一个 HTTP 风格的头部，包含 <code>Content-Length</code> (消息体字节数) 和可选的 <code>Content-Type</code> (通常是 <code>application/json</code>)。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Content-Length: &lt;length&gt;\r\n</span><br><span class="line">Content-Type: application/json\r\n</span><br><span class="line">\r\n</span><br><span class="line">&lt;JSON-RPC message&gt;</span><br></pre></td></tr></table></figure></li>
<li><strong>TCP Socket</strong>：在某些情况下，也可以通过 TCP 连接进行通信。</li>
</ul>
<h3 id="2-5-工作空间与文档-URI"><a href="#2-5-工作空间与文档-URI" class="headerlink" title="2.5 工作空间与文档 URI"></a>2.5 工作空间与文档 URI</h3><ul>
<li><strong>工作空间 (Workspace)</strong>：LSP 通过一个或多个根文件夹来定义一个项目的工作空间。</li>
<li><strong>文档 URI (Document URI)</strong>：LSP 使用标准的 URI (Uniform Resource Identifier) 来唯一标识文件。例如，<code>file:///home/user/project/src/main.go</code>。这确保了跨平台和跨系统的文件引用一致性。</li>
</ul>
<h2 id="三、LSP-的生命周期"><a href="#三、LSP-的生命周期" class="headerlink" title="三、LSP 的生命周期"></a>三、LSP 的生命周期</h2><p>一个典型的 LSP 客户端和服务器的交互生命周期如下：</p>
<div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    sequenceDiagram
    participant Client as LSP Client (Editor)
    participant Server as Language Server

    Client-&gt;&gt;Server: 1. 启动 Language Server 进程
    Client-&gt;&gt;Server: 2. 初始化请求 (initialize)&lt;br&#x2F;&gt;(发送客户端能力, 期望服务器能力)
    Server-&gt;&gt;Client: 3. 初始化响应 (initialize response)&lt;br&#x2F;&gt;(返回服务器能力)
    Client-&gt;&gt;Server: 4. 初始化完成通知 (initialized)&lt;br&#x2F;&gt;(告知服务器客户端已准备好)

    loop 用户操作
        Client-&gt;&gt;Server: 5. 打开文档通知 (textDocument&#x2F;didOpen)&lt;br&#x2F;&gt;(用户打开文件)
        Client-&gt;&gt;Server: 6. 变更文档通知 (textDocument&#x2F;didChange)&lt;br&#x2F;&gt;(用户编辑文件)
        Server-&gt;&gt;Client: 7. 发布诊断信息通知 (textDocument&#x2F;publishDiagnostics)&lt;br&#x2F;&gt;(如错误、警告)
        Client-&gt;&gt;Server: 8. 请求代码补全 (textDocument&#x2F;completion)&lt;br&#x2F;&gt;(用户触发补全)
        Server-&gt;&gt;Client: 9. 代码补全响应
        Client-&gt;&gt;Server: 10. 请求定义跳转 (textDocument&#x2F;definition)&lt;br&#x2F;&gt;(用户点击跳转)
        Server-&gt;&gt;Client: 11. 定义跳转响应
        Client-&gt;&gt;Server: ... 其他功能请求和响应
    end

    Client-&gt;&gt;Server: 12. 关闭文档通知 (textDocument&#x2F;didClose)&lt;br&#x2F;&gt;(用户关闭文件)
    Client-&gt;&gt;Server: 13. 关闭请求 (shutdown)&lt;br&#x2F;&gt;(告知服务器准备停止)
    Server-&gt;&gt;Client: 14. 关闭响应
    Client-&gt;&gt;Server: 15. 退出通知 (exit)&lt;br&#x2F;&gt;(强制服务器进程退出)
    Client-&gt;&gt;Server: 16. 关闭 Language Server 进程
  </pre></div>

<p><strong>关键阶段：</strong></p>
<ol>
<li><strong>Initialization (初始化)</strong>:<ul>
<li>客户端发送 <code>initialize</code> 请求给服务器，告知其支持的功能和工作空间信息。</li>
<li>服务器返回 <code>initialize</code> 响应，告知其支持的功能。</li>
<li>客户端发送 <code>initialized</code> 通知，确认初始化完成。</li>
</ul>
</li>
<li><strong>Text Document Synchronization (文本文档同步)</strong>:<ul>
<li>客户端通过 <code>textDocument/didOpen</code>、<code>textDocument/didChange</code>、<code>textDocument/didClose</code> 等通知，将文档的打开、修改、关闭状态同步给服务器。这是确保服务器拥有最新文件内容的关键。</li>
</ul>
</li>
<li><strong>Feature Requests (功能请求)</strong>:<ul>
<li>客户端根据用户操作发送各种功能请求（如 <code>textDocument/completion</code>, <code>textDocument/definition</code>）。</li>
<li>服务器处理请求并返回响应。</li>
</ul>
</li>
<li><strong>Diagnostics (诊断)</strong>:<ul>
<li>服务器主动通过 <code>textDocument/publishDiagnostics</code> 通知客户端文件中的错误、警告等信息。</li>
</ul>
</li>
<li><strong>Shutdown (关闭)</strong>:<ul>
<li>客户端发送 <code>shutdown</code> 请求，服务器停止处理新请求并完成手头工作。</li>
<li>客户端发送 <code>exit</code> 通知，服务器进程终止。</li>
</ul>
</li>
</ol>
<h2 id="四、LSP-的主要功能"><a href="#四、LSP-的主要功能" class="headerlink" title="四、LSP 的主要功能"></a>四、LSP 的主要功能</h2><p>LSP 定义了丰富的消息类型，涵盖了现代 IDE 的大部分智能特性：</p>
<h3 id="4-1-代码补全-Completion"><a href="#4-1-代码补全-Completion" class="headerlink" title="4.1 代码补全 (Completion)"></a>4.1 代码补全 (Completion)</h3><ul>
<li><strong>方法</strong>：<code>textDocument/completion</code></li>
<li><strong>描述</strong>：当用户输入代码时，客户端请求服务器提供可能的补全建议。</li>
<li><strong>示例参数</strong>：文件 URI、光标位置。</li>
<li><strong>示例响应</strong>：一个 <code>CompletionList</code>，包含 <code>CompletionItem</code> 数组，每个 <code>CompletionItem</code> 包含标签、类型、详情、插入文本等。</li>
</ul>
<h3 id="4-2-定义跳转-Go-to-Definition"><a href="#4-2-定义跳转-Go-to-Definition" class="headerlink" title="4.2 定义跳转 (Go to Definition)"></a>4.2 定义跳转 (Go to Definition)</h3><ul>
<li><strong>方法</strong>：<code>textDocument/definition</code></li>
<li><strong>描述</strong>：用户选中一个符号（如变量名、函数名），请求服务器定位其定义的位置。</li>
<li><strong>示例参数</strong>：文件 URI、光标位置。</li>
<li><strong>示例响应</strong>：一个 <code>Location</code> 或 <code>LocationLink</code> 数组，指示定义所在的文件和范围。</li>
</ul>
<h3 id="4-3-引用查找-Find-All-References"><a href="#4-3-引用查找-Find-All-References" class="headerlink" title="4.3 引用查找 (Find All References)"></a>4.3 引用查找 (Find All References)</h3><ul>
<li><strong>方法</strong>：<code>textDocument/references</code></li>
<li><strong>描述</strong>：用户选中一个符号，请求服务器查找所有引用该符号的位置。</li>
<li><strong>示例参数</strong>：文件 URI、光标位置、是否包含定义自身。</li>
<li><strong>示例响应</strong>：一个 <code>Location</code> 数组。</li>
</ul>
<h3 id="4-4-诊断信息-Diagnostics"><a href="#4-4-诊断信息-Diagnostics" class="headerlink" title="4.4 诊断信息 (Diagnostics)"></a>4.4 诊断信息 (Diagnostics)</h3><ul>
<li><strong>方法</strong>：<code>textDocument/publishDiagnostics</code> (这是一个由服务器向客户端发送的通知)</li>
<li><strong>描述</strong>：服务器向客户端发送文件中的错误、警告、信息或提示。</li>
<li><strong>示例参数</strong>：文件 URI、诊断信息数组 (<code>Diagnostic[]</code>)。每个 <code>Diagnostic</code> 包含范围、严重性、消息、代码等。</li>
</ul>
<h3 id="4-5-悬停提示-Hover"><a href="#4-5-悬停提示-Hover" class="headerlink" title="4.5 悬停提示 (Hover)"></a>4.5 悬停提示 (Hover)</h3><ul>
<li><strong>方法</strong>：<code>textDocument/hover</code></li>
<li><strong>描述</strong>：当用户鼠标悬停在某个符号上时，客户端请求服务器提供该符号的详细信息（如类型签名、文档注释）。</li>
<li><strong>示例参数</strong>：文件 URI、光标位置。</li>
<li><strong>示例响应</strong>：一个 <code>Hover</code> 对象，包含标记内容 (<code>MarkedString[]</code> 或 <code>MarkupContent</code>) 和可选的范围。</li>
</ul>
<h3 id="4-6-符号重命名-Rename-Symbol"><a href="#4-6-符号重命名-Rename-Symbol" class="headerlink" title="4.6 符号重命名 (Rename Symbol)"></a>4.6 符号重命名 (Rename Symbol)</h3><ul>
<li><strong>方法</strong>：<code>textDocument/rename</code></li>
<li><strong>描述</strong>：用户请求将一个符号及其所有引用重命名。</li>
<li><strong>示例参数</strong>：文件 URI、光标位置、新名称。</li>
<li><strong>示例响应</strong>：一个 <code>WorkspaceEdit</code> 对象，包含一组文本修改操作。</li>
</ul>
<h3 id="4-7-代码格式化-Formatting"><a href="#4-7-代码格式化-Formatting" class="headerlink" title="4.7 代码格式化 (Formatting)"></a>4.7 代码格式化 (Formatting)</h3><ul>
<li><strong>方法</strong>：<code>textDocument/formatting</code>, <code>textDocument/rangeFormatting</code>, <code>textDocument/onTypeFormatting</code></li>
<li><strong>描述</strong>：请求服务器格式化整个文档、某个范围的代码或在特定字符输入后格式化。</li>
<li><strong>示例参数</strong>：文件 URI、范围、格式化选项。</li>
<li><strong>示例响应</strong>：一个 <code>TextEdit</code> 数组，描述需要对文档进行的修改。</li>
</ul>
<h2 id="五、代码示例：LSP-消息的发送与接收"><a href="#五、代码示例：LSP-消息的发送与接收" class="headerlink" title="五、代码示例：LSP 消息的发送与接收"></a>五、代码示例：LSP 消息的发送与接收</h2><p>以下是使用 Python 和 Go 语言模拟 LSP 客户端和服务器之间发送和接收 JSON-RPC 消息的简化示例。</p>
<h3 id="5-1-Python-客户端模拟发送-textDocument-definition-请求"><a href="#5-1-Python-客户端模拟发送-textDocument-definition-请求" class="headerlink" title="5.1 Python 客户端模拟发送 textDocument/definition 请求"></a>5.1 Python 客户端模拟发送 <code>textDocument/definition</code> 请求</h3><p>这个示例展示了如何构造一个 <code>textDocument/definition</code> 请求，并模拟通过标准输出发送。实际的 LSP 客户端会监听用户的操作，然后发送相应的请求。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_lsp_message</span>(<span class="params">message: <span class="built_in">dict</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    将 JSON-RPC 消息封装成 LSP 格式并通过标准输出发送。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    content = json.dumps(message, indent=<span class="number">2</span>)</span><br><span class="line">    content_bytes = content.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    content_length = <span class="built_in">len</span>(content_bytes)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印 HTTP 风格的头部</span></span><br><span class="line">    sys.stdout.buffer.write(<span class="string">f&quot;Content-Length: <span class="subst">&#123;content_length&#125;</span>\r\n&quot;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    sys.stdout.buffer.write(<span class="string">b&quot;Content-Type: application/json\r\n&quot;</span>)</span><br><span class="line">    sys.stdout.buffer.write(<span class="string">b&quot;\r\n&quot;</span>) <span class="comment"># 空行分隔头部和消息体</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印消息体</span></span><br><span class="line">    sys.stdout.buffer.write(content_bytes)</span><br><span class="line">    sys.stdout.buffer.flush() <span class="comment"># 确保消息立即发送</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 模拟发送一个 textDocument/definition 请求</span></span><br><span class="line">    definition_request = &#123;</span><br><span class="line">        <span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">123</span>, <span class="comment"># 请求ID，服务器响应时会带上此ID</span></span><br><span class="line">        <span class="string">&quot;method&quot;</span>: <span class="string">&quot;textDocument/definition&quot;</span>,</span><br><span class="line">        <span class="string">&quot;params&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;textDocument&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;uri&quot;</span>: <span class="string">&quot;file:///Users/dev/myproject/main.py&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;position&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;line&quot;</span>: <span class="number">5</span>,</span><br><span class="line">                <span class="string">&quot;character&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;--- Client Sending Request ---&quot;</span>)</span><br><span class="line">    send_lsp_message(definition_request)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Request sent. (Check stdout buffer)&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-2-Golang-服务器模拟接收请求并发送-textDocument-definition-响应"><a href="#5-2-Golang-服务器模拟接收请求并发送-textDocument-definition-响应" class="headerlink" title="5.2 Golang 服务器模拟接收请求并发送 textDocument/definition 响应"></a>5.2 Golang 服务器模拟接收请求并发送 <code>textDocument/definition</code> 响应</h3><p>这个示例展示了一个简化的 Go 语言服务器如何从标准输入读取 LSP 消息，解析请求，并返回一个 <code>textDocument/definition</code> 响应。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bufio&quot;</span></span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// LSPMessageHeader represents the header of an LSP message</span></span><br><span class="line"><span class="keyword">type</span> LSPMessageHeader <span class="keyword">struct</span> &#123;</span><br><span class="line">	ContentLength <span class="type">int</span></span><br><span class="line">	ContentType   <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSON-RPC Request structure</span></span><br><span class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</span><br><span class="line">	JSONRPC <span class="type">string</span> <span class="string">`json:&quot;jsonrpc&quot;`</span></span><br><span class="line">	ID      <span class="type">int</span>    <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">	Method  <span class="type">string</span> <span class="string">`json:&quot;method&quot;`</span></span><br><span class="line">	Params  json.RawMessage <span class="string">`json:&quot;params&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSON-RPC Response structure</span></span><br><span class="line"><span class="keyword">type</span> Response <span class="keyword">struct</span> &#123;</span><br><span class="line">	JSONRPC <span class="type">string</span>      <span class="string">`json:&quot;jsonrpc&quot;`</span></span><br><span class="line">	ID      <span class="type">int</span>         <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">	Result  <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;result,omitempty&quot;`</span></span><br><span class="line">	Error   *Error      <span class="string">`json:&quot;error,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSON-RPC Error structure</span></span><br><span class="line"><span class="keyword">type</span> Error <span class="keyword">struct</span> &#123;</span><br><span class="line">	Code    <span class="type">int</span>         <span class="string">`json:&quot;code&quot;`</span></span><br><span class="line">	Message <span class="type">string</span>      <span class="string">`json:&quot;message&quot;`</span></span><br><span class="line">	Data    <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;data,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LSP Position</span></span><br><span class="line"><span class="keyword">type</span> Position <span class="keyword">struct</span> &#123;</span><br><span class="line">	Line      <span class="type">int</span> <span class="string">`json:&quot;line&quot;`</span></span><br><span class="line">	Character <span class="type">int</span> <span class="string">`json:&quot;character&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LSP Range</span></span><br><span class="line"><span class="keyword">type</span> Range <span class="keyword">struct</span> &#123;</span><br><span class="line">	Start Position <span class="string">`json:&quot;start&quot;`</span></span><br><span class="line">	End   Position <span class="string">`json:&quot;end&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LSP Location</span></span><br><span class="line"><span class="keyword">type</span> Location <span class="keyword">struct</span> &#123;</span><br><span class="line">	URI   <span class="type">string</span> <span class="string">`json:&quot;uri&quot;`</span></span><br><span class="line">	Range Range  <span class="string">`json:&quot;range&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// textDocument/definition request parameters</span></span><br><span class="line"><span class="keyword">type</span> DefinitionParams <span class="keyword">struct</span> &#123;</span><br><span class="line">	TextDocument <span class="keyword">struct</span> &#123;</span><br><span class="line">		URI <span class="type">string</span> <span class="string">`json:&quot;uri&quot;`</span></span><br><span class="line">	&#125; <span class="string">`json:&quot;textDocument&quot;`</span></span><br><span class="line">	Position Position <span class="string">`json:&quot;position&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readLSPMessage</span><span class="params">(reader *bufio.Reader)</span></span> (LSPMessageHeader, []<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> header LSPMessageHeader</span><br><span class="line">	<span class="keyword">var</span> contentLengthFound <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		line, isPrefix, err := reader.ReadLine()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> header, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to read line: %w&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> isPrefix &#123;</span><br><span class="line">			<span class="keyword">return</span> header, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;line too long&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		lineStr := <span class="type">string</span>(line)</span><br><span class="line">		<span class="keyword">if</span> lineStr == <span class="string">&quot;&quot;</span> &#123; <span class="comment">// Empty line signals end of headers</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		parts := bytes.SplitN(line, []<span class="type">byte</span>&#123;<span class="string">&#x27;:&#x27;</span>&#125;, <span class="number">2</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(parts) != <span class="number">2</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;Warning: Malformed header line: %s&quot;</span>, lineStr)</span><br><span class="line">			<span class="keyword">continue</span> <span class="comment">// Skip malformed header lines</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		headerName := <span class="type">string</span>(bytes.TrimSpace(parts[<span class="number">0</span>]))</span><br><span class="line">		headerValue := <span class="type">string</span>(bytes.TrimSpace(parts[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> headerName == <span class="string">&quot;Content-Length&quot;</span> &#123;</span><br><span class="line">			length, err := strconv.Atoi(headerValue)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> header, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;invalid Content-Length value: %w&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			header.ContentLength = length</span><br><span class="line">			contentLengthFound = <span class="literal">true</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> headerName == <span class="string">&quot;Content-Type&quot;</span> &#123;</span><br><span class="line">			header.ContentType = headerValue</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !contentLengthFound &#123;</span><br><span class="line">		<span class="keyword">return</span> header, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;Content-Length header missing&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	body := <span class="built_in">make</span>([]<span class="type">byte</span>, header.ContentLength)</span><br><span class="line">	_, err := io.ReadFull(reader, body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> header, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to read message body: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> header, body, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeLSPMessage</span><span class="params">(writer io.Writer, message <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	content, err := json.Marshal(message)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to marshal JSON: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	header := fmt.Sprintf(<span class="string">&quot;Content-Length: %d\r\nContent-Type: application/json\r\n\r\n&quot;</span>, <span class="built_in">len</span>(content))</span><br><span class="line">	_, err = writer.Write([]<span class="type">byte</span>(header))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to write header: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	_, err = writer.Write(content)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to write content: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">&quot;--- Language Server Started ---&quot;</span>)</span><br><span class="line">	reader := bufio.NewReader(os.Stdin)</span><br><span class="line">	writer := os.Stdout</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		header, body, err := readLSPMessage(reader)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">				log.Println(<span class="string">&quot;Client closed connection.&quot;</span>)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;Error reading message: %v&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		log.Printf(<span class="string">&quot;Received message (Length: %d, Type: %s):\n%s&quot;</span>, header.ContentLength, header.ContentType, <span class="type">string</span>(body))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> req Request</span><br><span class="line">		<span class="keyword">if</span> err := json.Unmarshal(body, &amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;Error unmarshaling request: %v&quot;</span>, err)</span><br><span class="line">			<span class="comment">// Send error response if possible</span></span><br><span class="line">			errResp := Response&#123;</span><br><span class="line">				JSONRPC: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">				ID:      <span class="number">0</span>, <span class="comment">// If ID is unknown, 0 or null is used for parse errors</span></span><br><span class="line">				Error:   &amp;Error&#123;Code: <span class="number">-32700</span>, Message: <span class="string">&quot;Parse error&quot;</span>&#125;,</span><br><span class="line">			&#125;</span><br><span class="line">			_ = writeLSPMessage(writer, errResp)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> req.ID == <span class="number">0</span> &#123; <span class="comment">// Notification, no response expected</span></span><br><span class="line">			log.Printf(<span class="string">&quot;Received Notification: Method=%s&quot;</span>, req.Method)</span><br><span class="line">			<span class="comment">// Handle notifications like didOpen, didChange, initialized etc.</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		log.Printf(<span class="string">&quot;Received Request: ID=%d, Method=%s&quot;</span>, req.ID, req.Method)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> resp <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">		<span class="keyword">switch</span> req.Method &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;initialize&quot;</span>:</span><br><span class="line">			<span class="comment">// Basic initialize response, reporting server capabilities</span></span><br><span class="line">			resp = <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">				<span class="string">&quot;capabilities&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">					<span class="string">&quot;textDocumentSync&quot;</span>: http.StatusText, <span class="comment">// Full, Incremental, None</span></span><br><span class="line">					<span class="string">&quot;completionProvider&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">						<span class="string">&quot;resolveProvider&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">						<span class="string">&quot;triggerCharacters&quot;</span>: []<span class="type">string</span>&#123;<span class="string">&quot;.&quot;</span>&#125;,</span><br><span class="line">					&#125;,</span><br><span class="line">					<span class="string">&quot;definitionProvider&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;textDocument/definition&quot;</span>:</span><br><span class="line">			<span class="keyword">var</span> params DefinitionParams</span><br><span class="line">			<span class="keyword">if</span> err := json.Unmarshal(req.Params, &amp;params); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;Error unmarshaling textDocument/definition params: %v&quot;</span>, err)</span><br><span class="line">				resp = &amp;Error&#123;Code: <span class="number">-32602</span>, Message: <span class="string">&quot;Invalid params&quot;</span>&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;Definition for %s at %d:%d requested.&quot;</span>, params.TextDocument.URI, params.Position.Line, params.Position.Character)</span><br><span class="line">				<span class="comment">// Simulate finding a definition</span></span><br><span class="line">				resp = []Location&#123;</span><br><span class="line">					&#123;</span><br><span class="line">						URI: <span class="string">&quot;file:///Users/dev/myproject/utils.py&quot;</span>,</span><br><span class="line">						Range: Range&#123;</span><br><span class="line">							Start: Position&#123;Line: <span class="number">10</span>, Character: <span class="number">0</span>&#125;,</span><br><span class="line">							End:   Position&#123;Line: <span class="number">10</span>, Character: <span class="number">5</span>&#125;,</span><br><span class="line">						&#125;,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;shutdown&quot;</span>:</span><br><span class="line">			<span class="comment">// Handle shutdown logic, then send response</span></span><br><span class="line">			resp = <span class="literal">nil</span> <span class="comment">// No result needed for shutdown success</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">			log.Println(<span class="string">&quot;Received exit notification. Shutting down.&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="comment">// Terminate server</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			log.Printf(<span class="string">&quot;Unknown method: %s&quot;</span>, req.Method)</span><br><span class="line">			resp = &amp;Error&#123;Code: <span class="number">-32601</span>, Message: fmt.Sprintf(<span class="string">&quot;Method not found: %s&quot;</span>, req.Method)&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Prepare and send response</span></span><br><span class="line">		jsonResp := Response&#123;</span><br><span class="line">			JSONRPC: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">			ID:      req.ID,</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err, isErr := resp.(*Error); isErr &#123;</span><br><span class="line">			jsonResp.Error = err</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			jsonResp.Result = resp</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		log.Printf(<span class="string">&quot;--- Server Sending Response (ID: %d) ---&quot;</span>, req.ID)</span><br><span class="line">		<span class="keyword">if</span> err := writeLSPMessage(writer, jsonResp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;Error writing response: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		log.Println(<span class="string">&quot;Response sent.&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This needs to be run in a separate file or a mock for os.Stdin/os.Stdout</span></span><br><span class="line"><span class="comment">// For actual testing, you&#x27;d run the Python script, pipe its output to the Go program,</span></span><br><span class="line"><span class="comment">// and capture the Go program&#x27;s output.</span></span><br><span class="line"><span class="comment">// Example shell command:</span></span><br><span class="line"><span class="comment">// python client.py | go run server.go &gt; server_output.log</span></span><br></pre></td></tr></table></figure>

<p><strong>注意事项：</strong></p>
<ul>
<li>上述代码仅为简化示例，实际的 LSP 实现会复杂得多，需要处理并发、错误恢复、状态管理、更丰富的消息类型等。</li>
<li><code>readLSPMessage</code> 和 <code>writeLSPMessage</code> 函数模拟了 LSP 消息的头部解析和封装。</li>
<li>Go 服务器会监听标准输入，一旦接收到完整消息，就会解析并根据 <code>method</code> 字段进行处理。</li>
</ul>
<h2 id="六、LSP-的优缺点"><a href="#六、LSP-的优缺点" class="headerlink" title="六、LSP 的优缺点"></a>六、LSP 的优缺点</h2><h3 id="6-1-优点"><a href="#6-1-优点" class="headerlink" title="6.1 优点"></a>6.1 优点</h3><ol>
<li><strong>降低开发成本 (N+M 模型)</strong>：显著减少了为多种语言和多种工具提供智能功能的重复工作。</li>
<li><strong>功能一致性</strong>：所有支持 LSP 的客户端都能获得相同高质量的语言服务体验，因为它们都连接到同一个 Language Server。</li>
<li><strong>语言无关性</strong>：协议本身是通用的，不绑定任何特定语言。</li>
<li><strong>性能优化</strong>：Language Server 可以独立运行在后台进程，使用语言原生工具链进行高效分析，减少主编辑器进程的负担。</li>
<li><strong>社区生态</strong>：LSP 已经成为事实标准，拥有庞大的社区支持和丰富的 Language Server 实现。</li>
</ol>
<h3 id="6-2-缺点与挑战"><a href="#6-2-缺点与挑战" class="headerlink" title="6.2 缺点与挑战"></a>6.2 缺点与挑战</h3><ol>
<li><strong>协议复杂度</strong>：LSP 协议本身非常庞大和详细，实现一个功能完善的 Language Server 需要深入理解协议规范。</li>
<li><strong>性能开销</strong>：JSON 序列化&#x2F;反序列化和进程间通信（IPC）会带来一定的开销，尤其是在处理大型文件或频繁操作时。</li>
<li><strong>冷启动时间</strong>：Language Server 启动和初始化可能需要加载大量数据，导致启动时间较长。</li>
<li><strong>状态管理</strong>：Language Server 需要维护所有打开文档的完整或部分内容，以及整个工作空间的语言模型，这可能消耗大量内存。</li>
<li><strong>调试困难</strong>：由于是两个独立进程之间的通信，调试问题可能比单体应用更复杂。</li>
<li><strong>高级功能限制</strong>：LSP 主要关注文本编辑和静态分析功能，对于更高级的 IDE 功能（如调试器集成、图形化重构工具、特定构建系统集成），LSP 无法直接提供支持，仍需编辑器自行实现。</li>
</ol>
<h2 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h2><p>LSP 是现代开发工具生态系统中的一个革命性协议。它成功地解决了多语言、多编辑器环境下的重复开发和功能碎片化问题，为开发者提供了统一、高效且高质量的语言智能服务。尽管存在一定的复杂性和性能考量，但其带来的巨大收益使得 LSP 成为构建未来开发体验不可或缺的基石。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg">TeaTang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg/8a2eec4e192e/">https://blog.tbf1211.xx.kg/8a2eec4e192e/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tbf1211.xx.kg" target="_blank">1024 维度</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">网络协议</a><a class="post-meta__tags" href="/tags/2025/">2025</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover-03.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/886395cef116/" title="婴儿流口水（流涎）详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-24.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">婴儿流口水（流涎）详解</div></div><div class="info-2"><div class="info-item-1"> 婴儿流口水，医学上称为流涎 (Sialorrhea)，是婴幼儿期常见的生理现象。很多新手父母可能会担心宝宝流口水是不是身体不适，但绝大多数情况下，流口水是宝宝生长发育过程中的正常标志。了解流口水的原因、可能伴随的问题以及如何护理，能帮助父母们更好地应对这一阶段。  核心思想：婴儿流口水主要与唾液腺发育、口腔吞咽功能不成熟、出牙、味觉和触觉刺激以及辅食添加等生理性因素有关。通常是暂时的，并且会在宝宝成长过程中逐渐改善。   一、什么是婴儿流口水？婴儿流口水是指婴儿期唾液分泌量增加，且由于口腔吞咽协调能力尚未完善，导致唾液从口角溢出的现象。 1.1 不同阶段的流口水表现 新生儿期 (0-3个月)：新生儿期的唾液腺分泌功能相对不活跃，口腔吞咽反射也较为频繁，所以新生儿通常很少流口水。如果新生儿有大量流口水，需警惕口腔发育异常或疾病。 3-6个月：随着唾液腺的发育，唾液分泌量开始增加。但此时婴儿口腔吞咽能力仍不成熟，不会主动将多余的唾液吞咽下去，流口水现象开始明显。 6个月-2岁：这是婴儿流口水的高峰期。主要与出牙、辅食添加以及口腔探索有关。随着年龄增长和口腔肌肉协调性的提高，流口水现...</div></div></div></a><a class="pagination-related" href="/077ea84decf4/" title="婴儿红屁股（尿布疹）详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-09.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">婴儿红屁股（尿布疹）详解</div></div><div class="info-2"><div class="info-item-1"> 婴儿红屁股，医学上称为尿布疹（Diaper Rash），是婴幼儿最常见的皮肤问题之一。几乎每个宝宝在成长过程中都可能经历。它表现为宝宝臀部、生殖器和大腿内侧被尿布覆盖的区域出现皮肤发红、出现丘疹、脱皮，甚至溃烂。虽然看似小问题，但处理不当会给宝宝带来不适，甚至可能导致感染。  核心思想：尿布疹主要由长时间接触湿尿布、尿液和粪便刺激、摩擦、不透气以及细菌或真菌感染等多种因素共同引起。预防和及时治疗是关键，核心在于保持宝宝臀部干爽清洁。   一、什么是尿布疹？尿布疹是指在婴儿穿戴尿布的区域（包括臀部、大腿上部、腹股沟和生殖器周围）发生的皮肤炎症。表现为皮肤发红、皮疹、脱皮，严重时甚至可能出现水疱、糜烂、溃疡。 1.1 常见表现 轻度：屁股、会阴、大腿内侧等区域出现轻微发红，皮肤完好，宝宝可能没有明显不适。 中度：发红范围扩大，可能出现红色小丘疹、皮损，宝宝开始感到不适，排尿或排便时哭闹。 重度：皮肤颜色鲜红，出现片状糜烂、水疱，甚至破溃、结痂。可能会继发细菌或真菌感染，出现白色或黄色脓包、异味。  二、尿布疹的常见原因尿布疹的发生通常不是单一原因造成的，而是多种因素相互作用的结果：...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/d244228688e5/" title="HLS (HTTP Live Streaming) 协议详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-08.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-22</div><div class="info-item-2">HLS (HTTP Live Streaming) 协议详解</div></div><div class="info-2"><div class="info-item-1"> HLS (HTTP Live Streaming) 是 Apple 公司在 2009 年推出的一种基于 HTTP 的自适应比特率流媒体传输协议。它将整个媒体流切割成一系列小的、基于 HTTP 的文件片段，通常是 MPEG-2 Transport Stream (TS) 格式。客户端下载这些片段，并通过一个被称为 “manifest” 或 “playlist” 的 M3U8 文件来获取片段的顺序和可用的比特率版本。HLS 最初是为了在 iOS 设备上播放流媒体而设计，但由于其简单、CDN 友好以及自适应比特率等优势，现已成为互联网上最流行的流媒体协议之一。  核心思想：将视频内容切分成小段（TS 文件），用 M3U8 文件描述这些片段的顺序和不同质量版本，客户端通过 HTTP 渐进下载和播放，并根据网络状况动态切换视频质量。   一、为什么需要 HLS？在 HLS 出现之前，传统的流媒体协议如 RTMP (Real-Time Messaging Protocol) 依赖于特定的服务器和协议栈，需要专门的流媒体服务器，并且在防火墙和 CDN 部署方面存在一些挑战。HLS 的出现旨在...</div></div></div></a><a class="pagination-related" href="/a97c16bf3fd0/" title="奇偶检验详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-25.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-14</div><div class="info-item-2">奇偶检验详解</div></div><div class="info-2"><div class="info-item-1"> 奇偶检验 (Parity Check) 是一种最简单、最古老的错误检测方法，用于验证数据在传输或存储过程中是否发生了一位或奇数位的错误。它通过在原始数据的基础上添加一个额外的比特位（称为奇偶校验位）来实现。  核心思想： 通过统计数据位中 ‘1’ 的数量是奇数还是偶数，并添加一个校验位来使其总数符合预设的奇偶性，从而在接收端检测数据是否被意外翻转。   一、奇偶检验的基本原理奇偶检验的基本思想是确保一组二进制位中 ‘1’ 的总数（包括校验位）始终是奇数或偶数。 1.1 两种类型根据要求的奇偶性，奇偶检验分为两种：  奇校验 (Odd Parity Check)：  发送方统计数据位中 ‘1’ 的个数。 如果 ‘1’ 的个数为偶数，则奇偶校验位设置为 ‘1’，使包括校验位在内的所有位中 ‘1’ 的总数为奇数。 如果 ‘1’ 的个数为奇数，则奇偶校验位设置为 ‘0’，使包括校验位在内的所有位中 ‘1’ 的总数仍为奇数。 目标：传输的整个数据串（数据位 + 校验位）中 ‘1’ 的个数为奇数。   偶校验 (Even Parity Check)：  发送方统计数据位中 ‘1’ 的个数。...</div></div></div></a><a class="pagination-related" href="/425bf08190fa/" title="TLS Encrypted Client Hello (ECH) 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-28.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-10</div><div class="info-item-2">TLS Encrypted Client Hello (ECH) 详解</div></div><div class="info-2"><div class="info-item-1"> TLS Encrypted Client Hello (ECH) 是对 TLS 1.3 协议 的一项重要扩展，旨在解决传输层安全性 (TLS) 握手过程中客户端发送的明文 Server Name Indication (SNI) 扩展所带来的隐私和审查问题。通过 ECH，客户端可以在 TLS 握手的第一个消息——Client Hello 中加密它想要连接的服务器主机名，从而阻止网络中间方（如 ISP、审查机构或广告商）窥探用户正在访问的具体网站。  核心思想：在 TLS 握手开始阶段，通过加密客户端请求的服务器主机名 (SNI)，隐藏用户的访问目标，提升网络隐私和抗审查能力。   一、为什么需要 ECH？SNI 的隐私痛点在深入了解 ECH 之前，我们首先需要理解它所要解决的核心问题：明文 SNI (Server Name Indication)。 1.1 SNI 的作用SNI 是 TLS 协议的一个扩展，用于解决虚拟主机 (Virtual Hosting) 问题。在 HTTP&#x2F;1.1 时代，多个网站（具有不同的域名，如 example.com 和 another.c...</div></div></div></a><a class="pagination-related" href="/84980af09d70/" title="HTTP URL 与 IP:端口 的区别详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-25.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-25</div><div class="info-item-2">HTTP URL 与 IP:端口 的区别详解</div></div><div class="info-2"><div class="info-item-1"> 虽然 http://127.0.0.1:1080 和 127.0.0.1:1080 都指向本地机器上的 1080 端口，但它们在含义、使用上下文和系统处理方式上存在根本区别。前者是一个完整的 URL (Uniform Resource Locator)，明确指定了协议 (Protocol)；而后者仅仅是一个 地址:端口 组合，通常用于网络服务的监听或内部配置，本身不包含协议信息。  核心思想：协议 (http://) 定义了客户端与服务端通信的方式和规则，而 IP:端口 仅仅标识了一个网络端点。在不同上下文中，对 IP:端口 的处理方式会有所不同，例如浏览器会自动补全协议，而网络编程接口通常只接收 IP:端口 来监听。   一、核心概念定义在深入探讨两者区别之前，我们先定义几个关键概念： 1.1 IP 地址 (Internet Protocol Address)定义：一个分配给网络上设备的数字标签，用于在计算机网络中标识和定位设备。127.0.0.1 是一个特殊的 IP 地址，称为回环地址 (Loopback Address) 或 本地主机 (localhost)，它总是指向当...</div></div></div></a><a class="pagination-related" href="/c5be75f3ed25/" title="WebSocket 详解：实现全双工实时通信"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-29.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-23</div><div class="info-item-2">WebSocket 详解：实现全双工实时通信</div></div><div class="info-2"><div class="info-item-1"> WebSocket 是一种在单个 TCP 连接上进行全双工（Full-Duplex）通信的网络协议。它在 Web 浏览器和服务器之间提供了一个持久化的连接，允许双方在任何时候发送消息，而无需像传统的 HTTP 请求那样需要先发送请求再接收响应。WebSocket 解决了传统 Web 应用中实现实时通信的诸多难题，是构建实时 Web 应用的关键技术之一。  核心思想：从 HTTP 协议“握手”后，将底层 TCP 连接“升级”为 WebSocket 连接，实现客户端与服务器之间长时间、双向、无阻塞的消息传输，从而大幅降低通信开销，提升实时应用的性能。   一、为什么需要 WebSocket？传统 HTTP 的局限性在 WebSocket 出现之前，Web 应用程序要实现实时通信，如聊天室、股票行情、在线游戏、推送通知等，面临着传统 HTTP 协议的固有局限性：  半双工 (Half-Duplex) 通信：HTTP 协议是单向请求-响应模型。客户端发送请求，服务器返回响应。服务器无法主动向客户端发送消息，除非客户端先发起请求。 效率低下： 频繁连接建立与断开：每个 HTTP 请求都需...</div></div></div></a><a class="pagination-related" href="/c5054902e8b1/" title="iptables 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-31.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-25</div><div class="info-item-2">iptables 详解</div></div><div class="info-2"><div class="info-item-1"> iptables 是 Linux 系统中一个强大的防火墙工具，它基于 Netfilter 框架。Netfilter 是 Linux 内核中的一个数据包过滤和修改框架，而 iptables 是用于在用户空间配置 Netfilter 规则的命令行工具。通过 iptables，系统管理员可以定义各种规则来过滤、修改、转发或拦截网络数据包，从而实现网络流量控制、端口转发、地址伪装等功能。可以说，iptables 是 Linux 系统网络安全和流量管理的基石。  核心思想：基于规则链对数据包进行匹配和处理。 数据包在网络协议栈中穿行时，会根据定义好的规则链进行检查，并按照链中的规则顺序执行相应的动作。   一、Netfilter 框架与 iptables 关系理解 iptables，首先要了解它与 Netfilter 的关系：  Netfilter：位于 Linux 内核中，是一个用于网络数据包过滤、修改、转发和跟踪的框架。它定义了几个”钩子” (Hooks) 点，当数据包经过这些钩子点时，Netfilter 会检查是否有注册的规则需要处理该数据包。 iptables：是用户空间的命令行...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TeaTang</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">545</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">230</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/teatang"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:tea.tang1211@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站更多功能即将上线，敬请期待！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-LSP%EF%BC%9F"><span class="toc-text">一、为什么需要 LSP？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81LSP-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">二、LSP 的核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Language-Server-%E8%AF%AD%E8%A8%80%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">2.1 Language Server (语言服务器)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-LSP-Client-LSP-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">2.2 LSP Client (LSP 客户端)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-JSON-RPC"><span class="toc-text">2.3 JSON-RPC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E9%80%9A%E4%BF%A1%E7%AE%A1%E9%81%93"><span class="toc-text">2.4 通信管道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4%E4%B8%8E%E6%96%87%E6%A1%A3-URI"><span class="toc-text">2.5 工作空间与文档 URI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81LSP-%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">三、LSP 的生命周期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81LSP-%E7%9A%84%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-text">四、LSP 的主要功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%A8-Completion"><span class="toc-text">4.1 代码补全 (Completion)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%AE%9A%E4%B9%89%E8%B7%B3%E8%BD%AC-Go-to-Definition"><span class="toc-text">4.2 定义跳转 (Go to Definition)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%BC%95%E7%94%A8%E6%9F%A5%E6%89%BE-Find-All-References"><span class="toc-text">4.3 引用查找 (Find All References)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E8%AF%8A%E6%96%AD%E4%BF%A1%E6%81%AF-Diagnostics"><span class="toc-text">4.4 诊断信息 (Diagnostics)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%82%AC%E5%81%9C%E6%8F%90%E7%A4%BA-Hover"><span class="toc-text">4.5 悬停提示 (Hover)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E7%AC%A6%E5%8F%B7%E9%87%8D%E5%91%BD%E5%90%8D-Rename-Symbol"><span class="toc-text">4.6 符号重命名 (Rename Symbol)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-%E4%BB%A3%E7%A0%81%E6%A0%BC%E5%BC%8F%E5%8C%96-Formatting"><span class="toc-text">4.7 代码格式化 (Formatting)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B%EF%BC%9ALSP-%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%91%E9%80%81%E4%B8%8E%E6%8E%A5%E6%94%B6"><span class="toc-text">五、代码示例：LSP 消息的发送与接收</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Python-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E6%8B%9F%E5%8F%91%E9%80%81-textDocument-definition-%E8%AF%B7%E6%B1%82"><span class="toc-text">5.1 Python 客户端模拟发送 textDocument&#x2F;definition 请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-Golang-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E6%8B%9F%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%E5%B9%B6%E5%8F%91%E9%80%81-textDocument-definition-%E5%93%8D%E5%BA%94"><span class="toc-text">5.2 Golang 服务器模拟接收请求并发送 textDocument&#x2F;definition 响应</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81LSP-%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-text">六、LSP 的优缺点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E4%BC%98%E7%82%B9"><span class="toc-text">6.1 优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E7%BC%BA%E7%82%B9%E4%B8%8E%E6%8C%91%E6%88%98"><span class="toc-text">6.2 缺点与挑战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">七、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/10349b09ff78/" title="Signal Protocol 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-09.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Signal Protocol 详解"/></a><div class="content"><a class="title" href="/10349b09ff78/" title="Signal Protocol 详解">Signal Protocol 详解</a><time datetime="2026-02-03T22:24:00.000Z" title="发表于 2026-02-04 06:24:00">2026-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/f81355a662b8/" title="ECMAScript ShadowRealm 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-17.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ECMAScript ShadowRealm 详解"/></a><div class="content"><a class="title" href="/f81355a662b8/" title="ECMAScript ShadowRealm 详解">ECMAScript ShadowRealm 详解</a><time datetime="2026-02-01T22:24:00.000Z" title="发表于 2026-02-02 06:24:00">2026-02-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/88fea7b52158/" title="Gzip 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-32.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Gzip 详解"/></a><div class="content"><a class="title" href="/88fea7b52158/" title="Gzip 详解">Gzip 详解</a><time datetime="2026-01-29T22:24:00.000Z" title="发表于 2026-01-30 06:24:00">2026-01-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/8fc7e3e72510/" title="前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-15.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解"/></a><div class="content"><a class="title" href="/8fc7e3e72510/" title="前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解">前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解</a><time datetime="2026-01-27T22:24:00.000Z" title="发表于 2026-01-28 06:24:00">2026-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/5341a0037256/" title="CSS-in-JS 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-08.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CSS-in-JS 详解"/></a><div class="content"><a class="title" href="/5341a0037256/" title="CSS-in-JS 详解">CSS-in-JS 详解</a><time datetime="2026-01-25T22:24:00.000Z" title="发表于 2026-01-26 06:24:00">2026-01-26</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/default_cover-03.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">我的轨迹</div><div class="footer-flex-content"><a href="/archives/2023/" target="_blank" title="🆕 2023">🆕 2023</a><a href="/archives/2024/" target="_blank" title="🆒 2024">🆒 2024</a><a href="/archives/2025/" target="_blank" title="👨‍👩‍👦 2025">👨‍👩‍👦 2025</a><a href="/archives/2026/" target="_blank" title="🆙 2026">🆙 2026</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">维度</div><div class="footer-flex-content"><a href="/categories/" target="_blank" title="📁 分类">📁 分类</a><a href="/tags/" target="_blank" title="🔖 标签">🔖 标签</a><a href="/categories/" target="_blank" title="📽️ 时间线">📽️ 时间线</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/shuoshuo" target="_blank" title="💬 说说">💬 说说</a></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By TeaTang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.9/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (false) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script></div><script data-pjax src="/self/btf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="ture"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,200,200" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js" defer="defer"></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      true
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.4"></script></div></div></body></html>