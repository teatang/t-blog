<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>L4 负载均衡详解 (Layer 4 Load Balancing Explained) | 1024 维度</title><meta name="author" content="TeaTang"><meta name="copyright" content="TeaTang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="L4 负载均衡 (Layer 4 Load Balancing)，也称为传输层负载均衡，是一种在 OSI 模型第四层（传输层）上进行流量分发的负载均衡技术。它主要根据网络数据包的 IP 地址和端口号信息来决定将请求转发到哪个后端服务器，而不解析应用层数据（如 HTTP 头、URL 或 Cookie）。L4 负载均衡器在建立 TCP 连接之初或接收 UDP 数据包时就做出转发决策。  核心思想：基">
<meta property="og:type" content="article">
<meta property="og:title" content="L4 负载均衡详解 (Layer 4 Load Balancing Explained)">
<meta property="og:url" content="https://blog.tbf1211.xx.kg/296c75615ac4/index.html">
<meta property="og:site_name" content="1024 维度">
<meta property="og:description" content="L4 负载均衡 (Layer 4 Load Balancing)，也称为传输层负载均衡，是一种在 OSI 模型第四层（传输层）上进行流量分发的负载均衡技术。它主要根据网络数据包的 IP 地址和端口号信息来决定将请求转发到哪个后端服务器，而不解析应用层数据（如 HTTP 头、URL 或 Cookie）。L4 负载均衡器在建立 TCP 连接之初或接收 UDP 数据包时就做出转发决策。  核心思想：基">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-16.jpg">
<meta property="article:published_time" content="2025-12-12T22:24:00.000Z">
<meta property="article:modified_time" content="2025-12-24T07:56:13.748Z">
<meta property="article:author" content="TeaTang">
<meta property="article:tag" content="计算机网络">
<meta property="article:tag" content="网络技术">
<meta property="article:tag" content="2025">
<meta property="article:tag" content="负载均衡">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-16.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "L4 负载均衡详解 (Layer 4 Load Balancing Explained)",
  "url": "https://blog.tbf1211.xx.kg/296c75615ac4/",
  "image": "https://blog.tbf1211.xx.kg/img/cover/default_cover-16.jpg",
  "datePublished": "2025-12-12T22:24:00.000Z",
  "dateModified": "2025-12-24T07:56:13.748Z",
  "author": [
    {
      "@type": "Person",
      "name": "TeaTang",
      "url": "https://blog.tbf1211.xx.kg"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon-1.ico"><link rel="canonical" href="https://blog.tbf1211.xx.kg/296c75615ac4/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.7/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":true,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: TeaTang","link":"链接: ","source":"来源: 1024 维度","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'L4 负载均衡详解 (Layer 4 Load Balancing Explained)',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="1024 维度" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">431</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">222</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">80</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/cover/default_cover-16.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">1024 维度</span></a><a class="nav-page-title" href="/"><span class="site-name">L4 负载均衡详解 (Layer 4 Load Balancing Explained)</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">L4 负载均衡详解 (Layer 4 Load Balancing Explained)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2025-12-12T22:24:00.000Z" title="发表于 2025-12-13 06:24:00">2025-12-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E6%8A%80%E6%9C%AF/">网络技术</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>15分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><strong>L4 负载均衡 (Layer 4 Load Balancing)</strong>，也称为<strong>传输层负载均衡</strong>，是一种在 OSI 模型第四层（传输层）上进行流量分发的负载均衡技术。它主要根据网络数据包的 IP 地址和端口号信息来决定将请求转发到哪个后端服务器，而不解析应用层数据（如 HTTP 头、URL 或 Cookie）。L4 负载均衡器在建立 TCP 连接之初或接收 UDP 数据包时就做出转发决策。</p>
</blockquote>
<div class="note info flat"><p>核心思想：<strong>基于连接或数据包的源&#x2F;目的 IP 和端口进行快速、高效的流量转发，实现后端服务器的水平扩展和高可用性。</strong></p>
</div>
<hr>
<h2 id="一、为什么需要-L4-负载均衡？"><a href="#一、为什么需要-L4-负载均衡？" class="headerlink" title="一、为什么需要 L4 负载均衡？"></a>一、为什么需要 L4 负载均衡？</h2><p>在许多高性能和高并发的应用场景中，L4 负载均衡是实现可扩展性和可靠性的基础组件：</p>
<ol>
<li><strong>高吞吐量和低延迟</strong>：由于 L4 负载均衡器不需要解析应用层协议内容，其处理速度非常快，能够处理极高的并发连接和请求，并保持较低的延迟。这对于对性能要求极高的应用至关重要。</li>
<li><strong>协议无关性</strong>：L4 负载均衡不限于 HTTP&#x2F;HTTPS 协议，它可以对任何基于 TCP 或 UDP 的协议（如 SSH、FTP、SMTP、DNS、RTP 以及各种私有协议）进行负载均衡。</li>
<li><strong>简单高效</strong>：配置相对简单，因为只关注 IP 和端口。它提供了一种高效的方式来分发工作负载，确保所有后端服务器都能得到充分利用。</li>
<li><strong>服务器健康检查</strong>：能够执行基本的 TCP 连接检查，确保只将流量发送到响应正常的后端服务器，从而提高服务可用性。</li>
<li><strong>透明性</strong>：在某些模式下（如直接路由），L4 负载均衡器可以实现对后端服务器的完全透明，让后端服务器直接响应客户端，保留客户端源 IP。</li>
</ol>
<h2 id="二、L4-负载均衡的工作原理"><a href="#二、L4-负载均衡的工作原理" class="headerlink" title="二、L4 负载均衡的工作原理"></a>二、L4 负载均衡的工作原理</h2><p>L4 负载均衡器在 OSI 模型的传输层（TCP&#x2F;UDP）工作。当客户端发起一个连接请求时，L4 负载均衡器会拦截这个请求，并根据预设的负载均衡算法和后端服务器的健康状况，选择一个合适的后端服务器将请求转发过去。</p>
<p><strong>基本工作流程</strong>：</p>
<div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    sequenceDiagram
    participant Client as 客户端 (浏览器&#x2F;App)
    participant L4LB as L4 负载均衡器
    participant BackendA as 后端服务器 A
    participant BackendB as 后端服务器 B
    participant BackendC as 后端服务器 C

    Client-&gt;&gt;L4LB: 1. 客户端发起连接请求 (e.g., TCP SYN, Dest IP: VIP, Dest Port: 80&#x2F;443)
    L4LB-&gt;&gt;L4LB: 2. **选择后端** (基于 IP, Port 和负载均衡算法)
    alt 选择 Backend A
        L4LB-&gt;&gt;BackendA: 3. 将请求转发到后端服务器 A (e.g., 修改目标 IP&#x2F;Port)
        BackendA-&gt;&gt;L4LB: 4. 返回响应
    else 选择 Backend B
        L4LB-&gt;&gt;BackendB: 3. 将请求转发到后端服务器 B
        BackendB-&gt;&gt;L4LB: 4. 返回响应
    else 选择 Backend C
        L4LB-&gt;&gt;BackendC: 3. 将请求转发到后端服务器 C
        BackendC-&gt;&gt;L4LB: 4. 返回响应
    end
    L4LB-&gt;&gt;Client: 5. 返回最终响应给客户端
  </pre></div>

<p><strong>关键机制与实现方式</strong>：</p>
<p>L4 负载均衡的实现方式主要有以下几种：</p>
<ol>
<li><p><strong>网络地址转换 (NAT - Network Address Translation)</strong>：</p>
<ul>
<li><strong>原理</strong>：L4 负载均衡器接收客户端请求，将请求包的目标 IP 地址和端口号替换为选定后端服务器的 IP 地址和端口号，然后将包转发给后端。后端服务器的响应包会发回给负载均衡器，负载均衡器再将响应包的源 IP 地址和端口号改回为负载均衡器的 IP 和端口，然后返回给客户端。</li>
<li><strong>特点</strong>：请求和响应都经过负载均衡器。负载均衡器成为所有流量的瓶颈，但配置简单。后端服务器无需特殊配置。</li>
<li><strong>缺点</strong>：存在单点瓶颈；后端服务器看不到客户端的真实源 IP（除非负载均衡器使用 <code>proxy protocol</code> 或其他方式注入）。</li>
</ul>
</li>
<li><p><strong>IP 隧道 (IP Tunneling)</strong>：</p>
<ul>
<li><strong>原理</strong>：L4 负载均衡器接收客户端请求，不改变数据包的 IP 头，而是将其封装在一个新的 IP 包中，新包的目标 IP 是选定后端服务器的 IP。后端服务器收到包后，解封装获取原始包，然后直接将响应发送回客户端（无需经过负载均衡器）。</li>
<li><strong>特点</strong>：响应直接返回客户端，提高了效率。后端服务器可以直接看到客户端的源 IP。</li>
<li><strong>缺点</strong>：后端服务器需要支持 IP 隧道协议（如 IPIP）；配置相对复杂；客户端和后端服务器之间不能有防火墙阻挡直接返回的响应。</li>
</ul>
</li>
<li><p><strong>直接路由 (DR - Direct Routing)</strong>：</p>
<ul>
<li><strong>原理</strong>：L4 负载均衡器（通常称为 LVS - Linux Virtual Server）接收客户端请求，只修改数据包的目标 MAC 地址为选定后端服务器的 MAC 地址，而不修改 IP 地址。后端服务器收到请求后，直接将响应发送回客户端，源 IP 地址是负载均衡器的虚拟 IP (VIP)。</li>
<li><strong>特点</strong>：效率最高，请求和响应都只需要经过负载均衡器一次。后端服务器直接响应客户端。负载均衡器只处理入站请求，响应由后端服务器直接发送。</li>
<li><strong>缺点</strong>：配置最复杂；要求负载均衡器和后端服务器在同一个广播域（同一子网）；后端服务器需要配置 VIP，并且需要抑制 ARP 响应（只在内部接口响应，对外由负载均衡器响应）。</li>
</ul>
</li>
</ol>
<p><strong>负载均衡算法</strong>：</p>
<p>L4 负载均衡器通常支持多种算法来选择后端服务器：</p>
<ul>
<li><strong>轮询 (Round Robin)</strong>：按顺序依次将新请求分配给池中的每个服务器。</li>
<li><strong>加权轮询 (Weighted Round Robin)</strong>：根据后端服务器的权重（性能、容量）按比例分配请求。</li>
<li><strong>最少连接数 (Least Connections)</strong>：将新请求分配给当前活动连接数最少的服务器。</li>
<li><strong>加权最少连接数 (Weighted Least Connections)</strong>：结合权重和当前连接数进行决策。</li>
<li><strong>源 IP Hash (Source IP Hashing)</strong>：根据客户端 IP 地址的哈希值来选择后端服务器，确保同一客户端总是被路由到同一后端服务器（实现会话保持，Sticky Sessions）。</li>
</ul>
<h2 id="三、与-L7-负载均衡的比较"><a href="#三、与-L7-负载均衡的比较" class="headerlink" title="三、与 L7 负载均衡的比较"></a>三、与 L7 负载均衡的比较</h2><table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">L4 负载均衡 (传输层)</th>
<th align="left">L7 负载均衡 (应用层)</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>操作层级</strong></td>
<td align="left">TCP&#x2F;UDP (传输层)</td>
<td align="left">HTTP&#x2F;HTTPS (应用层)</td>
</tr>
<tr>
<td align="left"><strong>决策依据</strong></td>
<td align="left">IP 地址、端口号、协议</td>
<td align="left">URL、HTTP Header、Cookie、请求体、方法等</td>
</tr>
<tr>
<td align="left"><strong>性能</strong></td>
<td align="left"><strong>极高</strong>，开销小，不解析应用层数据</td>
<td align="left">相对较低，开销大，需要解析和处理应用层数据</td>
</tr>
<tr>
<td align="left"><strong>功能</strong></td>
<td align="left">简单转发，基于 IP&#x2F;Port 的基本负载均衡</td>
<td align="left">智能路由、SSL 终止、内容缓存、WAF、重写、限流等</td>
</tr>
<tr>
<td align="left"><strong>透传性</strong></td>
<td align="left">可以保留客户端源 IP（DSR, IP 隧道模式）</td>
<td align="left">通常不能直接保留客户端源 IP（需通过 <code>X-Forwarded-For</code> 等 HTTP 头传递）</td>
</tr>
<tr>
<td align="left"><strong>健康检查</strong></td>
<td align="left">基于 TCP 连接、端口状态的简单检查</td>
<td align="left">基于 HTTP 响应状态码、内容的高级健康检查</td>
</tr>
<tr>
<td align="left"><strong>复杂性</strong></td>
<td align="left">相对简单</td>
<td align="left">相对复杂，配置项多</td>
</tr>
<tr>
<td align="left"><strong>适用场景</strong></td>
<td align="left">高性能、非 HTTP 协议、大规模连接、透明性需求</td>
<td align="left">所有 Web 应用、微服务、API 网关、智能路由和内容处理需求</td>
</tr>
</tbody></table>
<h2 id="四、常见的-L4-负载均衡技术和实现"><a href="#四、常见的-L4-负载均衡技术和实现" class="headerlink" title="四、常见的 L4 负载均衡技术和实现"></a>四、常见的 L4 负载均衡技术和实现</h2><ul>
<li><strong>LVS (Linux Virtual Server)</strong>：Linux 内核自带的 L4 负载均衡解决方案，以其超高的性能和稳定性而闻名，支持 NAT、IP Tunneling 和 Direct Routing 三种模式。</li>
<li><strong>IPVS (IP Virtual Server)</strong>：LVS 的一个组件，提供了内核级的 L4 负载均衡功能，常与 keepalived 结合实现高可用。</li>
<li><strong>软件定义网络 (SDN) 负载均衡器</strong>：<ul>
<li><strong>Kubernetes Service (Type: LoadBalancer)</strong>：在云环境中，K8s 的 LoadBalancer 类型服务通常由云服务商的 L4 负载均衡器（如 AWS NLB、GCP TCP&#x2F;UDP LB）实现。</li>
<li><strong>云服务提供商的 L4 负载均衡器</strong>：AWS Network Load Balancer (NLB)、Google Cloud TCP&#x2F;UDP Load Balancing、Azure Load Balancer。这些服务通常提供极致的性能和对大量连接的支持。</li>
</ul>
</li>
<li><strong>HAProxy (TCP 模式)</strong>：HAProxy 不仅是一个优秀的 L7 负载均衡器，也可以在 TCP 模式下作为高性能 L4 负载均衡器使用。</li>
<li><strong>F5 BIG-IP LTM</strong>、<strong>Citrix ADC (NetScaler)</strong> 等企业级硬件&#x2F;软件负载均衡器，在提供 L7 功能的同时，也支持高性能的 L4 负载均衡。</li>
</ul>
<h2 id="五、L4-负载均衡的优缺点"><a href="#五、L4-负载均衡的优缺点" class="headerlink" title="五、L4 负载均衡的优缺点"></a>五、L4 负载均衡的优缺点</h2><h3 id="5-1-优点："><a href="#5-1-优点：" class="headerlink" title="5.1 优点："></a>5.1 优点：</h3><ol>
<li><strong>极高性能和低延迟</strong>：由于不进行应用层解析，处理速度快，能够应对海量并发连接。</li>
<li><strong>协议无关性</strong>：支持任何基于 TCP&#x2F;UDP 的协议，应用范围广泛。</li>
<li><strong>高度透明</strong>：在 DSR 模式下，可以完全保留客户端源 IP，后端服务器直接响应客户端。</li>
<li><strong>稳定性高</strong>：协议栈层级低，逻辑相对简单，通常拥有更高的稳定性和可靠性。</li>
<li><strong>资源消耗低</strong>：相较于 L7 负载均衡，L4 对 CPU 和内存的消耗更少。</li>
</ol>
<h3 id="5-2-缺点："><a href="#5-2-缺点：" class="headerlink" title="5.2 缺点："></a>5.2 缺点：</h3><ol>
<li><strong>缺乏智能路由能力</strong>：无法根据 URL、HTTP Header 等应用层内容进行路由，只能按 IP 和端口转发。</li>
<li><strong>不具备应用层安全功能</strong>：无法提供 WAF、DDoS 防护、SSL&#x2F;TLS 终止等高级安全功能。</li>
<li><strong>不具备内容优化功能</strong>：无法进行内容缓存、压缩、URL 重写等优化操作。</li>
<li><strong>会话保持相对有限</strong>：虽然可以通过源 IP Hash 实现会话保持，但不如 L7 负载均衡器基于 Cookie 或其他更灵活的方式精确。</li>
<li><strong>维护相对复杂</strong>：在直接路由模式下，后端服务器也需要进行特定的网络配置。</li>
</ol>
<h2 id="六、应用场景"><a href="#六、应用场景" class="headerlink" title="六、应用场景"></a>六、应用场景</h2><ul>
<li><strong>高性能 TCP&#x2F;UDP 服务</strong>：如 DNS 服务器、MySQL 数据库集群、Redis 缓存服务器、实时游戏服务器、消息队列 (Kafka&#x2F;RabbitMQ) 集群等。</li>
<li><strong>大规模连接处理</strong>：需要处理大量短连接或长连接的场景。</li>
<li><strong>非 HTTP&#x2F;HTTPS 协议的服务</strong>：例如 FTP、SMTP、SSH、VPN 等。</li>
<li><strong>对性能和低延迟有严格要求</strong>的应用。</li>
<li><strong>作为 L7 负载均衡器的前置</strong>：在某些架构中，可能会先用 L4 负载均衡器来处理海量连接，再将部分连接转发给 L7 负载均衡器进行更精细的流量管理。</li>
<li><strong>直播、音视频流服务</strong>：这些服务通常需要高吞吐量和低延迟，并且可能使用自定义的传输层协议。</li>
</ul>
<h2 id="七、代码示例-Python-概念性"><a href="#七、代码示例-Python-概念性" class="headerlink" title="七、代码示例 (Python - 概念性)"></a>七、代码示例 (Python - 概念性)</h2><p>实现一个真实的 L4 负载均衡器需要高度底层网络编程的知识（如 Socket 编程、IP 包封装&#x2F;解封装、MAC 地址处理等），并且通常在内核或专门的硬件中实现以达到高性能。下面的 Python 示例是一个<strong>高度简化</strong>的<strong>概念演示</strong>，它使用 <code>socket</code> 模块<strong>模拟</strong>了一个基于最少连接数算法的 TCP 代理，展示 L4 负载均衡器是如何将 TCP 连接转发给后端服务器的。</p>
<p>这个例子仅用于说明概念，不具备实际 L4 负载均衡器的所有功能和性能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># L4 负载均衡器监听的端口</span></span><br><span class="line">LB_LISTEN_PORT = <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟的后端服务器列表 (IP, PORT)</span></span><br><span class="line"><span class="comment"># 真实环境中这里会是不同的实际服务器</span></span><br><span class="line">BACKEND_SERVERS = [</span><br><span class="line">    (<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8001</span>),</span><br><span class="line">    (<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8002</span>),</span><br><span class="line">    (<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8003</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存储后端服务器的当前连接数</span></span><br><span class="line"><span class="comment"># 真实环境中需要更复杂的健康检查和状态管理</span></span><br><span class="line">backend_connections = &#123;server: <span class="number">0</span> <span class="keyword">for</span> server <span class="keyword">in</span> BACKEND_SERVERS&#125;</span><br><span class="line">backend_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_backend</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    负载均衡算法：最少连接数 (Least Connections)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> backend_lock:</span><br><span class="line">        min_connections = <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)</span><br><span class="line">        selected_server = <span class="literal">None</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment"># 简单健康检查：如果连接数为0，或者随机让它“宕机”一段时间，模拟不健康</span></span><br><span class="line">        healthy_backends = []</span><br><span class="line">        <span class="keyword">for</span> server, connections <span class="keyword">in</span> backend_connections.items():</span><br><span class="line">            <span class="comment"># 模拟后端服务器有时“不在线”或者响应慢</span></span><br><span class="line">            <span class="keyword">if</span> random.random() &gt; <span class="number">0.1</span>: <span class="comment"># 90%概率认为健康</span></span><br><span class="line">                 healthy_backends.append((server, connections))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> healthy_backends:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;No healthy backend servers available!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> server, connections <span class="keyword">in</span> healthy_backends:</span><br><span class="line">            <span class="keyword">if</span> connections &lt; min_connections:</span><br><span class="line">                min_connections = connections</span><br><span class="line">                selected_server = server</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> selected_server:</span><br><span class="line">            backend_connections[selected_server] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> selected_server</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_client</span>(<span class="params">client_socket</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    处理客户端连接，并转发到后端</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    client_address = client_socket.getpeername()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[LB] New client connection from <span class="subst">&#123;client_address&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    backend_ip, backend_port = select_backend()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (backend_ip <span class="keyword">and</span> backend_port):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[LB] No backend available for <span class="subst">&#123;client_address&#125;</span>. Closing connection.&quot;</span>)</span><br><span class="line">        client_socket.close()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[LB] Routing client <span class="subst">&#123;client_address&#125;</span> to backend <span class="subst">&#123;backend_ip&#125;</span>:<span class="subst">&#123;backend_port&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 连接后端服务器</span></span><br><span class="line">        backend_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        backend_socket.connect((backend_ip, backend_port))</span><br><span class="line">      </span><br><span class="line">        <span class="comment"># 双向转发数据 (L4 核心逻辑)</span></span><br><span class="line">        <span class="comment"># 用两个线程分别处理客户端到后端，和后端到客户端的数据流</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">forward_data</span>(<span class="params">source_sock, dest_sock, direction</span>):</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    data = source_sock.recv(<span class="number">4096</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    dest_sock.sendall(data)</span><br><span class="line">                    <span class="comment"># print(f&quot;[&#123;direction&#125;] Forwarded &#123;len(data)&#125; bytes.&quot;)</span></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="comment"># print(f&quot;Error forwarding &#123;direction&#125; data: &#123;e&#125;&quot;)</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">          </span><br><span class="line">            <span class="comment"># 关闭另一头的发送，表示数据流结束</span></span><br><span class="line">            <span class="comment"># dest_sock.shutdown(socket.SHUT_WR) </span></span><br><span class="line">            <span class="comment"># 优雅关机可能需要更复杂的逻辑，这里直接关闭 socket</span></span><br><span class="line">            <span class="comment"># print(f&quot;[&#123;direction&#125;] Data forwarding stopped.&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        client_to_backend_thread = threading.Thread(target=forward_data, args=(client_socket, backend_socket, <span class="string">&quot;Client-&gt;Backend&quot;</span>))</span><br><span class="line">        backend_to_client_thread = threading.Thread(target=forward_data, args=(backend_socket, client_socket, <span class="string">&quot;Backend-&gt;Client&quot;</span>))</span><br><span class="line"></span><br><span class="line">        client_to_backend_thread.start()</span><br><span class="line">        backend_to_client_thread.start()</span><br><span class="line"></span><br><span class="line">        client_to_backend_thread.join()</span><br><span class="line">        backend_to_client_thread.join()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[LB] Error connecting to backend or during data forwarding: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 关闭所有 socket</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[LB] Connection to <span class="subst">&#123;client_address&#125;</span> closed. Decrementing connection count for <span class="subst">&#123;backend_ip&#125;</span>:<span class="subst">&#123;backend_port&#125;</span>&quot;</span>)</span><br><span class="line">        client_socket.close()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;backend_connections&#x27;</span> <span class="keyword">in</span> <span class="built_in">globals</span>() <span class="keyword">and</span> (backend_ip, backend_port) <span class="keyword">in</span> backend_connections:</span><br><span class="line">            <span class="keyword">with</span> backend_lock:</span><br><span class="line">                backend_connections[(backend_ip, backend_port)] -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> backend_socket:</span><br><span class="line">            backend_socket.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_backend_server</span>(<span class="params">port</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模拟一个简单的后端 TCP 服务器&quot;&quot;&quot;</span></span><br><span class="line">    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    server_socket.bind((<span class="string">&quot;127.0.0.1&quot;</span>, port))</span><br><span class="line">    server_socket.listen(<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Backend Server <span class="subst">&#123;port&#125;</span> listening on 127.0.0.1:<span class="subst">&#123;port&#125;</span>&quot;</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn, addr = server_socket.accept()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  [Backend <span class="subst">&#123;port&#125;</span>] Accepted connection from <span class="subst">&#123;addr&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 模拟处理请求</span></span><br><span class="line">            data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> data:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  [Backend <span class="subst">&#123;port&#125;</span>] Received: <span class="subst">&#123;data.decode().strip()&#125;</span>&quot;</span>)</span><br><span class="line">                response = <span class="string">f&quot;Hello from Backend <span class="subst">&#123;port&#125;</span>! (Received: <span class="subst">&#123;data.decode().strip()&#125;</span>)\n&quot;</span>.encode()</span><br><span class="line">                time.sleep(random.uniform(<span class="number">0.1</span>, <span class="number">0.5</span>)) <span class="comment"># 模拟处理延迟</span></span><br><span class="line">                conn.sendall(response)</span><br><span class="line">            conn.close()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  [Backend <span class="subst">&#123;port&#125;</span>] Connection with <span class="subst">&#123;addr&#125;</span> closed.&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># print(f&quot;  [Backend &#123;port&#125;] Error in backend server: &#123;e&#125;&quot;)</span></span><br><span class="line">            <span class="keyword">pass</span> <span class="comment"># 允许Ctrl+C退出</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 启动模拟后端服务器</span></span><br><span class="line">    backend_threads = []</span><br><span class="line">    <span class="keyword">for</span> ip, port <span class="keyword">in</span> BACKEND_SERVERS:</span><br><span class="line">        thread = threading.Thread(target=start_backend_server, args=(port,))</span><br><span class="line">        thread.daemon = <span class="literal">True</span> <span class="comment"># 让主线程退出时，子线程也退出</span></span><br><span class="line">        thread.start()</span><br><span class="line">        backend_threads.append(thread)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 稍微等待后端启动</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 启动 L4 负载均衡器</span></span><br><span class="line">    lb_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    lb_socket.bind((<span class="string">&quot;&quot;</span>, LB_LISTEN_PORT))</span><br><span class="line">    lb_socket.listen(<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;L4 Load Balancer listening on 0.0.0.0:<span class="subst">&#123;LB_LISTEN_PORT&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            client_sock, client_addr = lb_socket.accept()</span><br><span class="line">            client_handler = threading.Thread(target=handle_client, args=(client_sock,))</span><br><span class="line">            client_handler.start()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nL4 Load Balancer shutting down.&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        lb_socket.close()</span><br><span class="line">        <span class="comment"># 后端线程会被 daemon 属性自动终止</span></span><br></pre></td></tr></table></figure>

<p><strong>如何运行此示例：</strong></p>
<ol>
<li>保存代码为 <code>l4_lb_demo.py</code>。</li>
<li>在终端中运行：<code>python l4_lb_demo.py</code></li>
</ol>
<p><strong>测试请求（可以使用 <code>netcat</code> 或自定义的简单客户端）：</strong></p>
<p>打开多个终端，分别执行：</p>
<ul>
<li><code>nc localhost 8080</code> (然后输入一些文本，比如 <code>Hello L4 LB</code>)</li>
<li><code>nc localhost 8080</code></li>
<li><code>nc localhost 8080</code></li>
</ul>
<p>你会在运行 <code>l4_lb_demo.py</code> 的终端中，看到负载均衡器将不同的客户端连接路由到 <code>Backend Server 8001</code>, <code>8002</code>, <code>8003</code>，并且会打印出每个后端服务器收到的消息和响应。这是通过最少连接数算法实现的简单 L4 负载均衡概念。</p>
<h2 id="八、总结"><a href="#八、总结" class="headerlink" title="八、总结"></a>八、总结</h2><p>L4 负载均衡作为网络基础设施的关键组成部分，以其卓越的性能、低延迟和协议无关性，在处理大规模并发连接和非 HTTP 协议的服务方面发挥着不可替代的作用。它为后端服务器提供了高可用性和可伸缩性，是构建高性能分布式系统的基石。尽管它在智能路由和应用层功能上不及 L7 负载均衡器，但在许多场景下，其简单高效的特性使其成为首选。在实际架构设计中，L4 和 L7 负载均衡器常常结合使用，以充分发挥各自的优势，构建出既高性能又功能丰富的应用交付网络。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg">TeaTang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg/296c75615ac4/">https://blog.tbf1211.xx.kg/296c75615ac4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tbf1211.xx.kg" target="_blank">1024 维度</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E6%8A%80%E6%9C%AF/">网络技术</a><a class="post-meta__tags" href="/tags/2025/">2025</a><a class="post-meta__tags" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">负载均衡</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover-16.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/974825c9c64f/" title="L7 负载均衡详解 (Layer 7 Load Balancing Explained)"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-26.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">L7 负载均衡详解 (Layer 7 Load Balancing Explained)</div></div><div class="info-2"><div class="info-item-1"> L7 负载均衡 (Layer 7 Load Balancing)，也被称为应用层负载均衡，是基于 OSI 模型第七层（应用层）信息（如 HTTP&#x2F;HTTPS 请求的 URL、URI、Header、Cookie 或请求方法）来智能分发客户端请求的一种负载均衡技术。与仅基于 IP 地址和端口进行分发的 L4 负载均衡不同，L7 负载均衡能够对应用层数据包的内容进行深度检查和解析，从而实现更精细、更智能的流量分发策略。  核心思想：理解应用层请求的“意图”，并根据这些意图将请求路由到最合适的后端服务器或服务。 它能够对流量进行更深入的控制和优化。   一、为什么需要 L7 负载均衡？随着现代应用程序架构（如微服务、API 网关、无服务器）的日益复杂，以及对性能、安全性和可伸缩性需求的提升，L4 负载均衡的局限性逐渐显现。L7 负载均衡应运而生，主要解决了以下问题：  更细粒度的路由 (Fine-grained Routing)：L4 负载均衡只能基于 IP 和端口分发，无法区分同一端口上的不同应用或 API。L7 能够根据 URL 路径 (/api/users 到用户服务，...</div></div></div></a><a class="pagination-related" href="/bfcc84247c6a/" title="智能体 (Agent) 详解：深入 LangChain 开发实践"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-05.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">智能体 (Agent) 详解：深入 LangChain 开发实践</div></div><div class="info-2"><div class="info-item-1"> 智能体 (Agent) 是人工智能领域中的一个核心概念，特指能够感知环境、进行决策并采取行动以实现特定目标或利益的实体。在当前的技术浪潮中，特别是随着大语言模型 (LLM) 的突破，智能体这一概念被赋予了新的活力和强大的实现路径。基于 LLM 的智能体能够理解复杂的指令、规划任务、执行外部工具并进行自我反思，从而展现出接近自主解决问题的能力。  核心思想：智能体是一个自主运行的系统，它通过感知 (Perception)、思考 (Thought&#x2F;Planning)、行动 (Action) 和反馈 (Feedback&#x2F;Memory) 的闭环循环，在动态环境中追求并实现预设目标。Python 中的 LangChain 库提供了一套强大的工具和框架，用于快速构建和部署基于 LLM 的智能体，使其能够与各种外部资源和工具交互。   一、智能体的基本概念1.1 什么是智能体？在广义的人工智能领域，智能体是一个能够自主地运作以影响其所处环境的实体。其核心能力体现在以下循环：  感知 (Perception)：接收来自环境的信息（传感器输入，如文本、图像、数据）。 思考&#...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/974825c9c64f/" title="L7 负载均衡详解 (Layer 7 Load Balancing Explained)"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-26.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-15</div><div class="info-item-2">L7 负载均衡详解 (Layer 7 Load Balancing Explained)</div></div><div class="info-2"><div class="info-item-1"> L7 负载均衡 (Layer 7 Load Balancing)，也被称为应用层负载均衡，是基于 OSI 模型第七层（应用层）信息（如 HTTP&#x2F;HTTPS 请求的 URL、URI、Header、Cookie 或请求方法）来智能分发客户端请求的一种负载均衡技术。与仅基于 IP 地址和端口进行分发的 L4 负载均衡不同，L7 负载均衡能够对应用层数据包的内容进行深度检查和解析，从而实现更精细、更智能的流量分发策略。  核心思想：理解应用层请求的“意图”，并根据这些意图将请求路由到最合适的后端服务器或服务。 它能够对流量进行更深入的控制和优化。   一、为什么需要 L7 负载均衡？随着现代应用程序架构（如微服务、API 网关、无服务器）的日益复杂，以及对性能、安全性和可伸缩性需求的提升，L4 负载均衡的局限性逐渐显现。L7 负载均衡应运而生，主要解决了以下问题：  更细粒度的路由 (Fine-grained Routing)：L4 负载均衡只能基于 IP 和端口分发，无法区分同一端口上的不同应用或 API。L7 能够根据 URL 路径 (/api/users 到用户服务，...</div></div></div></a><a class="pagination-related" href="/a92b9122509b/" title="Ubuntu UFW (Uncomplicated Firewall) 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-29.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-01</div><div class="info-item-2">Ubuntu UFW (Uncomplicated Firewall) 详解</div></div><div class="info-2"><div class="info-item-1"> UFW (Uncomplicated Firewall) 是 Ubuntu Linux 及其衍生发行版中一个简化且易于使用的防火墙配置工具。它作为 iptables 的前端，提供了一个用户友好的命令行界面，让普通用户和系统管理员能够更轻松地管理 Linux 内核的 Netfilter 防火墙规则。UFW 的目标是“不复杂”，即简化防火墙的管理，使其不再令人生畏。  核心思想： UFW 提供了一种高级抽象，将复杂的 iptables 命令封装成少数直观的指令，使得用户无需深入理解 iptables 规则链即可实现基本的防火墙配置。   一、为什么选择 UFW？Linux 系统内置了强大的 Netfilter 框架和 iptables 工具，但 iptables 的语法复杂，规则众多，对于初学者来说学习曲线陡峭。UFW 旨在解决以下问题：  简化防火墙管理：  易于上手：通过简单的命令即可配置常见的防火墙规则，无需掌握复杂的 iptables 语法。 减少错误：简化后的命令减少了因语法错误导致配置失误的风险。   增强系统安全性：  默认拒绝策略：UFW 默认采用“默认拒绝所有传入...</div></div></div></a><a class="pagination-related" href="/e261890c2af2/" title="SSL&#x2F;TLS 终止详解 (SSL&#x2F;TLS Termination Explained)"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-23.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-01</div><div class="info-item-2">SSL&#x2F;TLS 终止详解 (SSL&#x2F;TLS Termination Explained)</div></div><div class="info-2"><div class="info-item-1"> SSL&#x2F;TLS 终止 (SSL&#x2F;TLS Termination) 是指在客户端和后端服务器之间，由一个中间设备（如负载均衡器、反向代理、API 网关等）负责解密传入的 SSL&#x2F;TLS 加密流量，并在将请求转发到后端服务器之前对其进行处理的过程。同样地，该设备也负责对来自后端服务器的响应进行加密，然后发送给客户端。这个中间设备即充当了 SSL&#x2F;TLS 连接的“终点”。  核心思想：将繁重的 SSL&#x2F;TLS 加密&#x2F;解密计算从后端应用服务器上卸载到专门的设备，以此提高后端服务器的性能、简化证书管理，并实现流量的可见性和控制。   一、为什么需要 SSL&#x2F;TLS 终止？在现代网络架构中，尤其是面对高并发和微服务环境时，SSL&#x2F;TLS 终止变得尤为重要。它解决了直接在应用服务器上处理 SSL&#x2F;&#x2F;TLS 的诸多挑战：  性能优化 (Performance Offloading)：SSL&#x2F;TLS 加密和解密是一个计算密集型操作，涉及复杂的握手过程和密钥交换。将此任务从后端应用服务器卸...</div></div></div></a><a class="pagination-related" href="/9b793354c088/" title="nftables 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-26.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-28</div><div class="info-item-2">nftables 详解</div></div><div class="info-2"><div class="info-item-1"> nftables 是 Linux 内核 Netfilter 项目的下一代包过滤框架。它旨在逐步取代传统的 iptables (以及 ip6tables, arptables, ebtables) 工具集，提供一个统一的、高效的、更易于管理和扩展的防火墙解决方案。nftables 引入了一套全新的语法和设计理念，旨在解决 iptables 长期存在的一些问题，例如命令复杂性、重复代码以及 IPv4 和 IPv6 规则管理的独立性等。  核心思想：基于表达式的统一规则集，支持原子性更新，并针对 IPv4&#x2F;IPv6&#x2F;桥接等协议提供统一管理。 它的设计哲学是从指令式规则集转向声明式通用虚拟机指令，使得规则处理更高效、更灵活。   一、为什么需要 nftables？iptables 的局限性虽然 iptables 强大且稳定，但它在设计和使用上存在一些固有的局限性，促使 Netfilter 社区开发 nftables：  语法复杂且碎片化：  iptables (用于 IPv4)、ip6tables (用于 IPv6)、arptables (用于 ARP)、ebtab...</div></div></div></a><a class="pagination-related" href="/c5054902e8b1/" title="iptables 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-25.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-25</div><div class="info-item-2">iptables 详解</div></div><div class="info-2"><div class="info-item-1"> iptables 是 Linux 系统中一个强大的防火墙工具，它基于 Netfilter 框架。Netfilter 是 Linux 内核中的一个数据包过滤和修改框架，而 iptables 是用于在用户空间配置 Netfilter 规则的命令行工具。通过 iptables，系统管理员可以定义各种规则来过滤、修改、转发或拦截网络数据包，从而实现网络流量控制、端口转发、地址伪装等功能。可以说，iptables 是 Linux 系统网络安全和流量管理的基石。  核心思想：基于规则链对数据包进行匹配和处理。 数据包在网络协议栈中穿行时，会根据定义好的规则链进行检查，并按照链中的规则顺序执行相应的动作。   一、Netfilter 框架与 iptables 关系理解 iptables，首先要了解它与 Netfilter 的关系：  Netfilter：位于 Linux 内核中，是一个用于网络数据包过滤、修改、转发和跟踪的框架。它定义了几个”钩子” (Hooks) 点，当数据包经过这些钩子点时，Netfilter 会检查是否有注册的规则需要处理该数据包。 iptables：是用户空间的命令行...</div></div></div></a><a class="pagination-related" href="/a97c16bf3fd0/" title="奇偶检验详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-31.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-14</div><div class="info-item-2">奇偶检验详解</div></div><div class="info-2"><div class="info-item-1"> 奇偶检验 (Parity Check) 是一种最简单、最古老的错误检测方法，用于验证数据在传输或存储过程中是否发生了一位或奇数位的错误。它通过在原始数据的基础上添加一个额外的比特位（称为奇偶校验位）来实现。  核心思想： 通过统计数据位中 ‘1’ 的数量是奇数还是偶数，并添加一个校验位来使其总数符合预设的奇偶性，从而在接收端检测数据是否被意外翻转。   一、奇偶检验的基本原理奇偶检验的基本思想是确保一组二进制位中 ‘1’ 的总数（包括校验位）始终是奇数或偶数。 1.1 两种类型根据要求的奇偶性，奇偶检验分为两种：  奇校验 (Odd Parity Check)：  发送方统计数据位中 ‘1’ 的个数。 如果 ‘1’ 的个数为偶数，则奇偶校验位设置为 ‘1’，使包括校验位在内的所有位中 ‘1’ 的总数为奇数。 如果 ‘1’ 的个数为奇数，则奇偶校验位设置为 ‘0’，使包括校验位在内的所有位中 ‘1’ 的总数仍为奇数。 目标：传输的整个数据串（数据位 + 校验位）中 ‘1’ 的个数为奇数。   偶校验 (Even Parity Check)：  发送方统计数据位中 ‘1’ 的个数。...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TeaTang</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">431</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">222</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">80</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/teatang"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:tea.tang1211@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站更多功能即将上线，敬请期待！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-L4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%9F"><span class="toc-text">一、为什么需要 L4 负载均衡？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81L4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">二、L4 负载均衡的工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%B8%8E-L7-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%AF%94%E8%BE%83"><span class="toc-text">三、与 L7 负载均衡的比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%B8%B8%E8%A7%81%E7%9A%84-L4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%8A%80%E6%9C%AF%E5%92%8C%E5%AE%9E%E7%8E%B0"><span class="toc-text">四、常见的 L4 负载均衡技术和实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81L4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-text">五、L4 负载均衡的优缺点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E4%BC%98%E7%82%B9%EF%BC%9A"><span class="toc-text">5.1 优点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E7%BC%BA%E7%82%B9%EF%BC%9A"><span class="toc-text">5.2 缺点：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">六、应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-Python-%E6%A6%82%E5%BF%B5%E6%80%A7"><span class="toc-text">七、代码示例 (Python - 概念性)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">八、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/0c48c5fa5942/" title="CFFI (C Foreign Function Interface for Python) 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-13.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CFFI (C Foreign Function Interface for Python) 详解"/></a><div class="content"><a class="title" href="/0c48c5fa5942/" title="CFFI (C Foreign Function Interface for Python) 详解">CFFI (C Foreign Function Interface for Python) 详解</a><time datetime="2025-12-23T22:24:00.000Z" title="发表于 2025-12-24 06:24:00">2025-12-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/03cebd3cc28a/" title="行为驱动开发 (BDD) 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-12.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="行为驱动开发 (BDD) 详解"/></a><div class="content"><a class="title" href="/03cebd3cc28a/" title="行为驱动开发 (BDD) 详解">行为驱动开发 (BDD) 详解</a><time datetime="2025-12-21T22:24:00.000Z" title="发表于 2025-12-22 06:24:00">2025-12-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/7bb082434be0/" title="测试驱动开发 (TDD) 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-09.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="测试驱动开发 (TDD) 详解"/></a><div class="content"><a class="title" href="/7bb082434be0/" title="测试驱动开发 (TDD) 详解">测试驱动开发 (TDD) 详解</a><time datetime="2025-12-19T22:24:00.000Z" title="发表于 2025-12-20 06:24:00">2025-12-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/24ffc0bedb41/" title="IPFS (InterPlanetary File System) 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-14.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="IPFS (InterPlanetary File System) 详解"/></a><div class="content"><a class="title" href="/24ffc0bedb41/" title="IPFS (InterPlanetary File System) 详解">IPFS (InterPlanetary File System) 详解</a><time datetime="2025-12-16T22:24:00.000Z" title="发表于 2025-12-17 06:24:00">2025-12-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/974825c9c64f/" title="L7 负载均衡详解 (Layer 7 Load Balancing Explained)"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-26.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="L7 负载均衡详解 (Layer 7 Load Balancing Explained)"/></a><div class="content"><a class="title" href="/974825c9c64f/" title="L7 负载均衡详解 (Layer 7 Load Balancing Explained)">L7 负载均衡详解 (Layer 7 Load Balancing Explained)</a><time datetime="2025-12-14T22:24:00.000Z" title="发表于 2025-12-15 06:24:00">2025-12-15</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/default_cover-16.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">我的轨迹</div><div class="footer-flex-content"><a href="/archives/2023/" target="_blank" title="📌 2023">📌 2023</a><a href="/archives/2024/" target="_blank" title="❓ 2024">❓ 2024</a><a href="/archives/2025/" target="_blank" title="🚀 2025">🚀 2025</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">维度</div><div class="footer-flex-content"><a href="/categories/" target="_blank" title="分类">分类</a><a href="/tags/" target="_blank" title="标签">标签</a><a href="/categories/" target="_blank" title="时间线">时间线</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/shuoshuo" target="_blank" title="说说">说说</a></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2025 By TeaTang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.7/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script></div><script data-pjax src="/self/btf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="ture"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,200,200" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js" defer="defer"></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      true
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.3"></script></div></div></body></html>