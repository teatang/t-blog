<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Docker镜像构建与管理：打造标准化、可复用的容器镜像 | 1024 维度</title><meta name="author" content="TeaTang"><meta name="copyright" content="TeaTang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文由 简悦 SimpRead 转码， 原文地址 mp.weixin.qq.com  Docker 镜像构建与管理：打造标准化、可复用的容器镜像开篇：你是否也在镜像管理上栽过跟头？凌晨 2 点，生产环境突然告警，新部署的容器启动失败。排查后发现：开发环境用的镜像 800MB，生产环境的却有 3.2GB，里面塞满了编译工具、测试数据，甚至还有开发同学的 SSH 私钥… 这种 “镜像肥胖症” 你遇到">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker镜像构建与管理：打造标准化、可复用的容器镜像">
<meta property="og:url" content="https://blog.tbf1211.xx.kg/2023/2023-02-01_Docker%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8E%E7%AE%A1%E7%90%86%EF%BC%9A%E6%89%93%E9%80%A0%E6%A0%87%E5%87%86%E5%8C%96%E3%80%81%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F/index.html">
<meta property="og:site_name" content="1024 维度">
<meta property="og:description" content="本文由 简悦 SimpRead 转码， 原文地址 mp.weixin.qq.com  Docker 镜像构建与管理：打造标准化、可复用的容器镜像开篇：你是否也在镜像管理上栽过跟头？凌晨 2 点，生产环境突然告警，新部署的容器启动失败。排查后发现：开发环境用的镜像 800MB，生产环境的却有 3.2GB，里面塞满了编译工具、测试数据，甚至还有开发同学的 SSH 私钥… 这种 “镜像肥胖症” 你遇到">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-14.jpg">
<meta property="article:published_time" content="2023-01-31T22:24:00.000Z">
<meta property="article:modified_time" content="2025-10-23T10:07:11.564Z">
<meta property="article:author" content="TeaTang">
<meta property="article:tag" content="2023">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="容器技术">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-14.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Docker镜像构建与管理：打造标准化、可复用的容器镜像",
  "url": "https://blog.tbf1211.xx.kg/2023/2023-02-01_Docker%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8E%E7%AE%A1%E7%90%86%EF%BC%9A%E6%89%93%E9%80%A0%E6%A0%87%E5%87%86%E5%8C%96%E3%80%81%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F/",
  "image": "https://blog.tbf1211.xx.kg/img/cover/default_cover-14.jpg",
  "datePublished": "2023-01-31T22:24:00.000Z",
  "dateModified": "2025-10-23T10:07:11.564Z",
  "author": [
    {
      "@type": "Person",
      "name": "TeaTang",
      "url": "https://blog.tbf1211.xx.kg"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon-1.ico"><link rel="canonical" href="https://blog.tbf1211.xx.kg/2023/2023-02-01_Docker%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8E%E7%AE%A1%E7%90%86%EF%BC%9A%E6%89%93%E9%80%A0%E6%A0%87%E5%87%86%E5%8C%96%E3%80%81%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=5.5.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":true,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: TeaTang","link":"链接: ","source":"来源: 1024 维度","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Docker镜像构建与管理：打造标准化、可复用的容器镜像',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="1024 维度" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">166</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">160</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">55</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/cover/default_cover-14.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">1024 维度</span></a><a class="nav-page-title" href="/"><span class="site-name">Docker镜像构建与管理：打造标准化、可复用的容器镜像</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Docker镜像构建与管理：打造标准化、可复用的容器镜像</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-01-31T22:24:00.000Z" title="发表于 2023-02-01 06:24:00">2023-02-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Docker/">Docker</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">2.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>10分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="umamiPV" data-path="/2023/2023-02-01_Docker%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8E%E7%AE%A1%E7%90%86%EF%BC%9A%E6%89%93%E9%80%A0%E6%A0%87%E5%87%86%E5%8C%96%E3%80%81%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F/"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p>本文由 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://ksria.com/simpread/">简悦 SimpRead</a> 转码， 原文地址 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s/CrYgNqRQ_KYjlBrxiW2pSw">mp.weixin.qq.com</a></p>
</blockquote>
<h1 id="Docker-镜像构建与管理：打造标准化、可复用的容器镜像"><a href="#Docker-镜像构建与管理：打造标准化、可复用的容器镜像" class="headerlink" title="Docker 镜像构建与管理：打造标准化、可复用的容器镜像"></a>Docker 镜像构建与管理：打造标准化、可复用的容器镜像</h1><h2 id="开篇：你是否也在镜像管理上栽过跟头？"><a href="#开篇：你是否也在镜像管理上栽过跟头？" class="headerlink" title="开篇：你是否也在镜像管理上栽过跟头？"></a>开篇：你是否也在镜像管理上栽过跟头？</h2><p><strong>凌晨 2 点，生产环境突然告警，新部署的容器启动失败。排查后发现：开发环境用的镜像 800MB，生产环境的却有 3.2GB，里面塞满了编译工具、测试数据，甚至还有开发同学的 SSH 私钥…</strong></p>
<p>这种 “镜像肥胖症” 你遇到过吗？或者更糟糕的：</p>
<ul>
<li>同一个服务，测试环境能跑，生产环境启动就报错</li>
<li>镜像仓库里堆满了 latest、v1、v1-final、v1-final-final 这种让人崩溃的标签</li>
<li>构建一次镜像要等 20 分钟，因为每次都要重新下载依赖包</li>
</ul>
<p><strong>今天这篇文章，我会基于 5 年运维实战经验，教你构建一套标准化的镜像管理体系</strong>：从多阶段构建优化到镜像安全扫描，从版本管理策略到自动化构建流程，让你的镜像体积缩小 70%、构建速度提升 5 倍，并且永远不会再出现 “这个镜像到底能不能用” 的灵魂拷问。</p>
<h2 id="一、镜像构建的三大核心原则（90-的人都忽略了）"><a href="#一、镜像构建的三大核心原则（90-的人都忽略了）" class="headerlink" title="一、镜像构建的三大核心原则（90% 的人都忽略了）"></a>一、镜像构建的三大核心原则（90% 的人都忽略了）</h2><h3 id="1-最小化原则：镜像里只放-“必需品”"><a href="#1-最小化原则：镜像里只放-“必需品”" class="headerlink" title="1. 最小化原则：镜像里只放 “必需品”"></a>1. 最小化原则：镜像里只放 “必需品”</h3><p>很多人写 Dockerfile 就像搬家，什么都往里塞。我见过最离谱的：一个 Node.js 应用镜像，里面包含了完整的 gcc 编译工具链、Python3、甚至还有 vim 和 htop。</p>
<p><strong>正确做法：分清 “构建时依赖” 和 “运行时依赖”</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># ❌ 错误示例：单阶段构建，所有东西都打包进去</span><br><span class="line">FROM node:16</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY . .</span><br><span class="line">RUN npm install</span><br><span class="line">RUN npm run build</span><br><span class="line">CMD [&quot;npm&quot;, &quot;start&quot;]</span><br><span class="line"># 最终镜像大小：1.2GB</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># ✅ 正确示例：多阶段构建，只保留运行时必需</span><br><span class="line"># 构建阶段</span><br><span class="line">FROM node:16-alpine AS builder</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY package*.json ./</span><br><span class="line">RUN npm ci --only=production</span><br><span class="line"></span><br><span class="line"># 运行阶段</span><br><span class="line">FROM node:16-alpine</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY --from=builder /app/node_modules ./node_modules</span><br><span class="line">COPY . .</span><br><span class="line">CMD [&quot;node&quot;, &quot;index.js&quot;]</span><br><span class="line"># 最终镜像大小：180MB</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>关键命令：<code>docker history &lt;镜像名&gt;</code> 查看每层大小，找出 “肥胖层”</strong></p>
<h3 id="2-可复现原则：今天能构建，明年也要能构建"><a href="#2-可复现原则：今天能构建，明年也要能构建" class="headerlink" title="2. 可复现原则：今天能构建，明年也要能构建"></a>2. 可复现原则：今天能构建，明年也要能构建</h3><p>我曾经历过这样的生产事故：6 个月前的镜像需要重新构建（修复安全漏洞），结果构建失败了——因为 Dockerfile 里写的是 <code>apt-get install nginx</code>，没指定版本，新版本 nginx 配置格式变了。</p>
<p><strong>铁律：所有依赖必须锁定版本</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># ❌ 危险写法</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y nginx</span><br><span class="line">RUN pip install flask</span><br><span class="line"></span><br><span class="line"># ✅ 安全写法</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">    nginx=1.18.0-6ubuntu14.4 \</span><br><span class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="line">    </span><br><span class="line">COPY requirements.txt .</span><br><span class="line">RUN pip install --no-cache-dir -r requirements.txt</span><br><span class="line"># requirements.txt 中明确版本：flask==2.3.2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-安全原则：不要让镜像成为安全漏洞的温床"><a href="#3-安全原则：不要让镜像成为安全漏洞的温床" class="headerlink" title="3. 安全原则：不要让镜像成为安全漏洞的温床"></a>3. 安全原则：不要让镜像成为安全漏洞的温床</h3><p><strong>血泪教训：</strong> 2023 年某次安全审计，发现生产环境 30% 的镜像存在高危漏洞，原因是基础镜像用的 <code>ubuntu:latest</code>，构建后就没更新过。</p>
<p><strong>安全加固清单：</strong></p>
<ul>
<li>使用特定版本的基础镜像：<code>FROM alpine:3.18.4</code> 而非 <code>FROM alpine:latest</code></li>
<li>创建非 root 用户运行应用</li>
<li>删除构建缓存和包管理器缓存</li>
<li>定期扫描镜像漏洞</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安全镜像模板</span><br><span class="line">FROM python:3.11-slim-bullseye</span><br><span class="line"></span><br><span class="line"># 创建非root用户</span><br><span class="line">RUN groupadd -r appuser &amp;&amp; useradd -r -g appuser appuser</span><br><span class="line"></span><br><span class="line"># 安装依赖并清理缓存</span><br><span class="line">COPY requirements.txt .</span><br><span class="line">RUN pip install --no-cache-dir -r requirements.txt \</span><br><span class="line">    &amp;&amp; rm -rf /root/.cache/pip</span><br><span class="line"></span><br><span class="line"># 切换到非root用户</span><br><span class="line">USER appuser</span><br><span class="line"></span><br><span class="line">COPY --chown=appuser:appuser . /app</span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line">CMD [&quot;python&quot;, &quot;app.py&quot;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="二、实战：5-步打造生产级镜像构建体系"><a href="#二、实战：5-步打造生产级镜像构建体系" class="headerlink" title="二、实战：5 步打造生产级镜像构建体系"></a>二、实战：5 步打造生产级镜像构建体系</h2><h3 id="Step-1：编写高效的-Dockerfile（附最佳实践模板）"><a href="#Step-1：编写高效的-Dockerfile（附最佳实践模板）" class="headerlink" title="Step 1：编写高效的 Dockerfile（附最佳实践模板）"></a>Step 1：编写高效的 Dockerfile（附最佳实践模板）</h3><p><strong>核心技巧：利用构建缓存机制，把变化频率低的放前面</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># 生产级 Dockerfile 模板（以 Java Spring Boot 为例）</span><br><span class="line"># 第一阶段：依赖下载（利用缓存）</span><br><span class="line">FROM maven:3.8.6-openjdk-11-slim AS deps</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY pom.xml .</span><br><span class="line">RUN mvn dependency:go-offline -B</span><br><span class="line"></span><br><span class="line"># 第二阶段：构建应用</span><br><span class="line">FROM maven:3.8.6-openjdk-11-slim AS builder</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY --from=deps /root/.m2 /root/.m2</span><br><span class="line">COPY . .</span><br><span class="line">RUN mvn clean package -DskipTests</span><br><span class="line"></span><br><span class="line"># 第三阶段：运行时镜像</span><br><span class="line">FROM openjdk:11-jre-slim</span><br><span class="line">RUN groupadd -r spring &amp;&amp; useradd -r -g spring spring</span><br><span class="line"></span><br><span class="line"># 安装监控工具（可选）</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">    curl=7.74.0-1.3+deb11u7 \</span><br><span class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line"># 复制 jar 包</span><br><span class="line">COPY --from=builder /app/target/*.jar app.jar</span><br><span class="line"></span><br><span class="line"># 健康检查</span><br><span class="line">HEALTHCHECK --interval=30s --timeout=3s --retries=3 \</span><br><span class="line">    CMD curl -f http://localhost:8080/actuator/health || exit 1</span><br><span class="line"></span><br><span class="line">USER spring</span><br><span class="line">EXPOSE 8080</span><br><span class="line">ENTRYPOINT [&quot;java&quot;, &quot;-Xmx512m&quot;, &quot;-jar&quot;, &quot;/app.jar&quot;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Step-2：构建参数化（一个-Dockerfile-适配多环境）"><a href="#Step-2：构建参数化（一个-Dockerfile-适配多环境）" class="headerlink" title="Step 2：构建参数化（一个 Dockerfile 适配多环境）"></a>Step 2：构建参数化（一个 Dockerfile 适配多环境）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 使用 ARG 实现构建时参数化</span><br><span class="line">ARG APP_ENV=production</span><br><span class="line">ARG NODE_VERSION=16-alpine</span><br><span class="line"></span><br><span class="line">FROM node:$&#123;NODE_VERSION&#125; AS builder</span><br><span class="line"></span><br><span class="line"># 根据环境安装不同依赖</span><br><span class="line">ARG APP_ENV</span><br><span class="line">RUN if [ &quot;$APP_ENV&quot; = &quot;development&quot; ]; then \</span><br><span class="line">        npm install; \</span><br><span class="line">    else \</span><br><span class="line">        npm ci --only=production; \</span><br><span class="line">    fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>构建命令：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 开发环境构建</span><br><span class="line">docker build --build-arg APP_ENV=development -t myapp:dev .</span><br><span class="line"></span><br><span class="line"># 生产环境构建</span><br><span class="line">docker build --build-arg APP_ENV=production -t myapp:prod .</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Step-3：自动化镜像扫描（提前发现安全隐患）"><a href="#Step-3：自动化镜像扫描（提前发现安全隐患）" class="headerlink" title="Step 3：自动化镜像扫描（提前发现安全隐患）"></a>Step 3：自动化镜像扫描（提前发现安全隐患）</h3><p><strong>实用脚本：镜像安全扫描自动化</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># scan_image.sh - 镜像安全扫描脚本</span><br><span class="line"></span><br><span class="line">IMAGE_NAME=$1</span><br><span class="line">REPORT_FILE=&quot;scan_report_$(date +%Y%m%d_%H%M%S).json&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;🔍 开始扫描镜像: $IMAGE_NAME&quot;</span><br><span class="line"></span><br><span class="line"># 使用 Trivy 扫描（需提前安装：apt-get install trivy）</span><br><span class="line">trivy image --severity HIGH,CRITICAL \</span><br><span class="line">          --format json \</span><br><span class="line">          --output $REPORT_FILE \</span><br><span class="line">          $IMAGE_NAME</span><br><span class="line"></span><br><span class="line"># 解析扫描结果</span><br><span class="line">CRITICAL_COUNT=$(jq &#x27;[.Results[].Vulnerabilities[]? | select(.Severity==&quot;CRITICAL&quot;)] | length&#x27; $REPORT_FILE)</span><br><span class="line">HIGH_COUNT=$(jq &#x27;[.Results[].Vulnerabilities[]? | select(.Severity==&quot;HIGH&quot;)] | length&#x27; $REPORT_FILE)</span><br><span class="line"></span><br><span class="line">echo &quot;📊 扫描结果：&quot;</span><br><span class="line">echo &quot;  - 严重漏洞: $CRITICAL_COUNT 个&quot;</span><br><span class="line">echo &quot;  - 高危漏洞: $HIGH_COUNT 个&quot;</span><br><span class="line"></span><br><span class="line"># 如果存在严重漏洞，阻止发布</span><br><span class="line">if [ $CRITICAL_COUNT -gt 0 ]; then</span><br><span class="line">    echo&quot;❌ 发现严重漏洞，禁止发布！&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;✅ 安全检查通过&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Step-4：镜像版本管理（告别-latest-地狱）"><a href="#Step-4：镜像版本管理（告别-latest-地狱）" class="headerlink" title="Step 4：镜像版本管理（告别 latest 地狱）"></a>Step 4：镜像版本管理（告别 latest 地狱）</h3><p><strong>标准化标签规范：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 版本标签格式：&lt;主版本&gt;.&lt;次版本&gt;.&lt;修订版本&gt;-&lt;构建号&gt;-&lt;git commit&gt;</span><br><span class="line"># 示例：v1.2.3-20231125-7a3b5c9</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line"># tag_image.sh - 自动生成镜像标签</span><br><span class="line"></span><br><span class="line"># 获取版本信息</span><br><span class="line">VERSION=$(cat VERSION)  # 从 VERSION 文件读取</span><br><span class="line">BUILD_DATE=$(date +%Y%m%d)</span><br><span class="line">GIT_COMMIT=$(git rev-parse --short HEAD)</span><br><span class="line"></span><br><span class="line"># 生成标签</span><br><span class="line">TAG=&quot;v$&#123;VERSION&#125;-$&#123;BUILD_DATE&#125;-$&#123;GIT_COMMIT&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 构建并打标签</span><br><span class="line">docker build -t myapp:$&#123;TAG&#125; .</span><br><span class="line">docker tag myapp:$&#123;TAG&#125; myapp:latest</span><br><span class="line"></span><br><span class="line"># 推送到仓库</span><br><span class="line">docker push myapp:$&#123;TAG&#125;</span><br><span class="line">docker push myapp:latest</span><br><span class="line"></span><br><span class="line">echo &quot;✅ 镜像已发布: myapp:$&#123;TAG&#125;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Step-5：构建流水线集成（CI-CD-最佳实践）"><a href="#Step-5：构建流水线集成（CI-CD-最佳实践）" class="headerlink" title="Step 5：构建流水线集成（CI&#x2F;CD 最佳实践）"></a>Step 5：构建流水线集成（CI&#x2F;CD 最佳实践）</h3><p><strong>GitLab CI 配置示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># .gitlab-ci.yml</span><br><span class="line">stages:</span><br><span class="line">- build</span><br><span class="line">- scan</span><br><span class="line">- push</span><br><span class="line"></span><br><span class="line">variables:</span><br><span class="line">  DOCKER_REGISTRY:&quot;registry.company.com&quot;</span><br><span class="line">  IMAGE_NAME:&quot;$DOCKER_REGISTRY/myapp&quot;</span><br><span class="line"></span><br><span class="line">build:</span><br><span class="line">stage: build</span><br><span class="line">script:</span><br><span class="line">    -docker build-t $IMAGE_NAME:$CI_COMMIT_SHA.</span><br><span class="line">    -docker save$IMAGE_NAME:$CI_COMMIT_SHA &gt;image.tar</span><br><span class="line">  artifacts:</span><br><span class="line">    paths:</span><br><span class="line">      -image.tar</span><br><span class="line">    expire_in:1 hour</span><br><span class="line"></span><br><span class="line">security_scan:</span><br><span class="line">  stage:scan</span><br><span class="line">  script:</span><br><span class="line">    - dockerload &lt;image.tar</span><br><span class="line">    -trivy image--exit-code 1--severity HIGH,CRITICAL$IMAGE_NAME:$CI_COMMIT_SHA</span><br><span class="line">  dependencies:</span><br><span class="line">    - build</span><br><span class="line"></span><br><span class="line">push_image:</span><br><span class="line">  stage:push</span><br><span class="line">  script:</span><br><span class="line">    - dockerload &lt;image.tar</span><br><span class="line">    -docker tag$IMAGE_NAME:$CI_COMMIT_SHA $IMAGE_NAME:latest</span><br><span class="line">    - dockerpush $IMAGE_NAME:$CI_COMMIT_SHA</span><br><span class="line">    - dockerpush $IMAGE_NAME:latest</span><br><span class="line">only:</span><br><span class="line">    -main</span><br><span class="line">  dependencies:</span><br><span class="line">    - build</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="三、进阶优化：让镜像构建效率翻倍"><a href="#三、进阶优化：让镜像构建效率翻倍" class="headerlink" title="三、进阶优化：让镜像构建效率翻倍"></a>三、进阶优化：让镜像构建效率翻倍</h2><h3 id="1-使用-BuildKit-加速构建"><a href="#1-使用-BuildKit-加速构建" class="headerlink" title="1. 使用 BuildKit 加速构建"></a>1. 使用 BuildKit 加速构建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 开启 BuildKit（构建速度提升 30-50%）</span><br><span class="line">export DOCKER_BUILDKIT=1</span><br><span class="line"></span><br><span class="line"># 利用 BuildKit 的并行构建特性</span><br><span class="line">docker build --build-arg BUILDKIT_INLINE_CACHE=1 \</span><br><span class="line">             --cache-from registry.company.com/myapp:latest \</span><br><span class="line">             -t myapp:new .</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-构建缓存优化策略"><a href="#2-构建缓存优化策略" class="headerlink" title="2. 构建缓存优化策略"></a>2. 构建缓存优化策略</h3><p><strong>缓存优化脚本：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># optimize_cache.sh - 智能缓存管理</span><br><span class="line"></span><br><span class="line"># 清理悬空镜像</span><br><span class="line">docker image prune -f</span><br><span class="line"></span><br><span class="line"># 清理超过7天未使用的镜像</span><br><span class="line">docker image prune -a --filter &quot;until=168h&quot; -f</span><br><span class="line"></span><br><span class="line"># 保留最近5个版本的镜像</span><br><span class="line">IMAGE_</span><br><span class="line">docker images --format &quot;&#123;&#123;.Repository&#125;&#125;:&#123;&#123;.Tag&#125;&#125;&quot; | \</span><br><span class="line">  grep &quot;^$&#123;IMAGE_NAME&#125;:&quot; | \</span><br><span class="line">sort -V | \</span><br><span class="line">head -n -5 | \</span><br><span class="line">  xargs -r docker rmi</span><br><span class="line"></span><br><span class="line">echo &quot;✅ 缓存优化完成&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-镜像体积极限压缩"><a href="#3-镜像体积极限压缩" class="headerlink" title="3. 镜像体积极限压缩"></a>3. 镜像体积极限压缩</h3><p><strong>压缩技巧汇总：</strong></p>
<ul>
<li><p>• 使用 Alpine 基础镜像（比 Ubuntu 小 90%）</p>
</li>
<li><p>• 合并 RUN 指令减少层数</p>
</li>
<li><p>• 使用 <code>--no-install-recommends</code> 参数</p>
</li>
<li><p>• 删除不必要的文档和示例</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 极限压缩示例（Go 应用）</span><br><span class="line">FROM golang:1.20-alpine AS builder</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY . .</span><br><span class="line">RUN CGO_ENABLED=0 go build -ldflags=&quot;-s -w&quot; -o app</span><br><span class="line"></span><br><span class="line">FROM scratch  # 从零开始，终极精简</span><br><span class="line">COPY --from=builder /app/app /</span><br><span class="line">ENTRYPOINT [&quot;/app&quot;]</span><br><span class="line"># 最终大小：&lt; 10MB</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="四、踩坑血泪史：这些错误你千万别犯"><a href="#四、踩坑血泪史：这些错误你千万别犯" class="headerlink" title="四、踩坑血泪史：这些错误你千万别犯"></a>四、踩坑血泪史：这些错误你千万别犯</h2><h3 id="坑-1：在镜像里存储敏感信息"><a href="#坑-1：在镜像里存储敏感信息" class="headerlink" title="坑 1：在镜像里存储敏感信息"></a>坑 1：在镜像里存储敏感信息</h3><p><strong>事故回放：</strong> 2022 年某次代码审计，发现镜像里包含数据库密码、AWS Access Key。虽然代码里用环境变量，但构建时的 <code>.env</code> 文件被 COPY 进去了。</p>
<p><strong>解决方案：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 使用 .dockerignore 排除敏感文件</span><br><span class="line"># .dockerignore 内容：</span><br><span class="line">*.env</span><br><span class="line">*.pem</span><br><span class="line">.git/</span><br><span class="line">.aws/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="坑-2：滥用-sudo-和-root-权限"><a href="#坑-2：滥用-sudo-和-root-权限" class="headerlink" title="坑 2：滥用 sudo 和 root 权限"></a>坑 2：滥用 sudo 和 root 权限</h3><p><strong>教训：</strong> 容器被攻破后，攻击者直接获得宿主机 root 权限。</p>
<p><strong>正确做法：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 永远不要在生产环境用 root 运行</span><br><span class="line">USER 1000:1000  # 使用 UID 而非用户名，避免用户不存在的问题</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="坑-3：忽视时区问题"><a href="#坑-3：忽视时区问题" class="headerlink" title="坑 3：忽视时区问题"></a>坑 3：忽视时区问题</h3><p><strong>症状：</strong> 日志时间总是差 8 小时，定时任务执行时间错乱。</p>
<p><strong>修复方法：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 设置时区</span><br><span class="line">ENV TZ=Asia/Shanghai</span><br><span class="line">RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="实用工具：一键镜像优化脚本"><a href="#实用工具：一键镜像优化脚本" class="headerlink" title="实用工具：一键镜像优化脚本"></a>实用工具：一键镜像优化脚本</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># docker_optimize.sh - 一键优化 Docker 镜像</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">IMAGE_NAME=$1</span><br><span class="line">OPTIMIZED_NAME=&quot;$&#123;IMAGE_NAME&#125;_optimized&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;🚀 开始优化镜像: $IMAGE_NAME&quot;</span><br><span class="line"></span><br><span class="line"># 1. 分析原始镜像大小</span><br><span class="line">ORIGINAL_SIZE=$(docker images --format &quot;&#123;&#123;.Size&#125;&#125;&quot; $IMAGE_NAME)</span><br><span class="line">echo &quot;原始大小: $ORIGINAL_SIZE&quot;</span><br><span class="line"></span><br><span class="line"># 2. 导出镜像并重新导入（去除历史层）</span><br><span class="line">docker save $IMAGE_NAME | docker load</span><br><span class="line"></span><br><span class="line"># 3. 使用 docker-slim 优化（需提前安装）</span><br><span class="line">docker-slim build --target $IMAGE_NAME --tag $OPTIMIZED_NAME \</span><br><span class="line">                  --http-probe=false \</span><br><span class="line">                  --continue-after=10</span><br><span class="line"></span><br><span class="line"># 4. 对比优化效果</span><br><span class="line">NEW_SIZE=$(docker images --format &quot;&#123;&#123;.Size&#125;&#125;&quot; $OPTIMIZED_NAME)</span><br><span class="line">echo &quot;✅ 优化完成&quot;</span><br><span class="line">echo &quot;  原始大小: $ORIGINAL_SIZE&quot;</span><br><span class="line">echo &quot;  优化后: $NEW_SIZE&quot;</span><br><span class="line"></span><br><span class="line"># 5. 运行测试</span><br><span class="line">echo&quot;🧪 运行测试...&quot;</span><br><span class="line">docker run --rm $OPTIMIZED_NAMEecho &quot;Test passed&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;💡 优化后的镜像: $OPTIMIZED_NAME&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="总结：掌握这-5-步，镜像管理不再是难题"><a href="#总结：掌握这-5-步，镜像管理不再是难题" class="headerlink" title="总结：掌握这 5 步，镜像管理不再是难题"></a>总结：掌握这 5 步，镜像管理不再是难题</h2><p>回顾今天的核心内容：</p>
<ul>
<li><p><strong>三大原则</strong>：最小化、可复现、安全性</p>
</li>
<li><p><strong>五步体系</strong>：高效 Dockerfile → 参数化构建 → 安全扫描 → 版本管理 → CI&#x2F;CD 集成</p>
</li>
<li><p><strong>优化技巧</strong>：BuildKit 加速、缓存管理、极限压缩</p>
</li>
</ul>
<p><strong>掌握这套方法论，你的镜像将实现：体积缩小 70%、构建速度提升 5 倍、安全漏洞降低 90%。</strong> 下次再遇到 “镜像太大”” 构建太慢 “”版本混乱” 的问题，10 分钟就能搞定。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg">TeaTang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg/2023/2023-02-01_Docker%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8E%E7%AE%A1%E7%90%86%EF%BC%9A%E6%89%93%E9%80%A0%E6%A0%87%E5%87%86%E5%8C%96%E3%80%81%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F/">https://blog.tbf1211.xx.kg/2023/2023-02-01_Docker%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8E%E7%AE%A1%E7%90%86%EF%BC%9A%E6%89%93%E9%80%A0%E6%A0%87%E5%87%86%E5%8C%96%E3%80%81%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tbf1211.xx.kg" target="_blank">1024 维度</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/2023/">2023</a><a class="post-meta__tags" href="/tags/Docker/">Docker</a><a class="post-meta__tags" href="/tags/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/">容器技术</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover-14.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2023/2023-02-05_Docker%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E8%AF%A6%E8%A7%A3%EF%BC%9A%E4%BB%8EDockerfile%E5%88%B0%E9%AB%98%E6%95%88%E5%AE%9E%E8%B7%B5/" title="Docker镜像构建详解：从Dockerfile到高效实践"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-22.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Docker镜像构建详解：从Dockerfile到高效实践</div></div><div class="info-2"><div class="info-item-1"> Docker 镜像是 Docker 的核心组成部分之一。它是一个轻量级、独立、可执行的软件包，包含运行应用程序所需的一切：代码、运行时、系统工具、系统库和设置。构建 Docker 镜像是实现应用程序容器化的关键步骤，通过 Dockerfile 文件，我们可以定义镜像的构建过程。  “Docker 镜像本质上是文件系统和配置的组合，它通过层（Layer）的概念实现了高效的存储和复用。理解 Dockerfile 的每一条指令以及如何优化构建过程，是成为 Docker 高手的必经之路。”   一、Docker 镜像构建概述 Dockerfile：一个文本文件，包含一系列指令，用于自动化地在 Docker 环境中构建镜像。 构建上下文 (Build Context)：在执行 docker build 命令时，你指定了一个路径（通常是当前目录）。这个路径下的所有文件和目录都会被发送到 Docker daemon，作为构建上下文。只有在构建上下文中包含的文件才能被 Dockerfile 中的指令（如 ADD, COPY）访问。 镜像层 (Image Layer)：Docker 镜像由一系列...</div></div></div></a><a class="pagination-related" href="/2023/2023-01-27_MySQL%20%E7%B4%A2%E5%BC%95%E8%AF%A6%E8%A7%A3/" title="MySQL 索引详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-20.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">MySQL 索引详解</div></div><div class="info-2"><div class="info-item-1"> 索引是数据库中用于提高查询速度的一种数据结构。在 MySQL 中，合理有效地使用索引能够显著提升数据库的查询性能，减少 I&#x2F;O 操作。然而，不恰当的索引也可能带来额外的开销。理解 MySQL 索引的原理和优化策略，是数据库性能调优的关键。  “好的索引，事半功倍；坏的索引，越帮越忙。” - 数据库优化格言   一、什么是索引？索引（Index）是一种特殊的查找表，数据库搜索引擎可以利用它来快速定位数据。可以将其类比为一本书的目录，通过目录我们可以快速找到感兴趣的章节，而不需要通读整本书。 在数据库中，没有索引的查询需要全表扫描，即逐行检查每条记录，直到找到符合条件的记录。当数据量非常大时，这种操作的效率会非常低下。索引通过创建指向数据物理位置的指针，使得数据库在查询时能够直接跳转到相关记录，从而大大加快查询速度。 二、索引的优缺点优点 显著提高数据检索速度：这是索引最核心、最主要的优点。 加快表与表之间的连接速度：对于 JOIN 操作，索引可以加速连接条件的匹配。 加快分组和排序操作：GROUP BY 和 ORDER BY 操作通常通过消除临时表和对文件进行排序来提高...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/2023-02-05_Docker%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E8%AF%A6%E8%A7%A3%EF%BC%9A%E4%BB%8EDockerfile%E5%88%B0%E9%AB%98%E6%95%88%E5%AE%9E%E8%B7%B5/" title="Docker镜像构建详解：从Dockerfile到高效实践"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-22.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-05</div><div class="info-item-2">Docker镜像构建详解：从Dockerfile到高效实践</div></div><div class="info-2"><div class="info-item-1"> Docker 镜像是 Docker 的核心组成部分之一。它是一个轻量级、独立、可执行的软件包，包含运行应用程序所需的一切：代码、运行时、系统工具、系统库和设置。构建 Docker 镜像是实现应用程序容器化的关键步骤，通过 Dockerfile 文件，我们可以定义镜像的构建过程。  “Docker 镜像本质上是文件系统和配置的组合，它通过层（Layer）的概念实现了高效的存储和复用。理解 Dockerfile 的每一条指令以及如何优化构建过程，是成为 Docker 高手的必经之路。”   一、Docker 镜像构建概述 Dockerfile：一个文本文件，包含一系列指令，用于自动化地在 Docker 环境中构建镜像。 构建上下文 (Build Context)：在执行 docker build 命令时，你指定了一个路径（通常是当前目录）。这个路径下的所有文件和目录都会被发送到 Docker daemon，作为构建上下文。只有在构建上下文中包含的文件才能被 Dockerfile 中的指令（如 ADD, COPY）访问。 镜像层 (Image Layer)：Docker 镜像由一系列...</div></div></div></a><a class="pagination-related" href="/2023/2023-04-23_Dockerfile%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3/" title="Dockerfile 常用指令详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-23.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-23</div><div class="info-item-2">Dockerfile 常用指令详解</div></div><div class="info-2"><div class="info-item-1"> Dockerfile 是一个文本文件，其中包含用户可以在命令行上调用以组装映像的所有命令。Docker 可以通过读取 Dockerfile 中的指令自动构建映像。它本质上是一个“可执行程序脚本”，用于自动化构建 Docker 镜像的过程。  理解和熟练使用 Dockerfile 指令是 Docker 应用开发和部署的核心技能之一。一个优化良好、结构清晰的 Dockerfile 不仅能构建出高效、安全、体积小的镜像，还能提高构建速度和可维护性。   一、Dockerfile 基础概念 镜像 (Image)：一个只读的模板，包含了创建 Docker 容器所需的所有文件和配置。 容器 (Container)：镜像运行时的实例。可以启动、停止、删除。 层 (Layer)：Dockerfile 中的每个指令都会创建一个新的镜像层。这些层是只读的，可以被缓存和共享，是 Docker 镜像高效和可复用的关键。 构建上下文 (Build Context)：当执行 docker build 命令时，它会向 Docker 守护进程发送一个目录（通常是当前目录）及其所有内容。这个目录被称为构建上下文...</div></div></div></a><a class="pagination-related" href="/2023/2023-04-27_Docker%20Compose%20%E8%AF%A6%E8%A7%A3%EF%BC%9A%E5%AE%9A%E4%B9%89%E5%92%8C%E8%BF%90%E8%A1%8C%E5%A4%9A%E5%AE%B9%E5%99%A8%20Docker%20%E5%BA%94%E7%94%A8/" title="Docker Compose 详解：定义和运行多容器 Docker 应用"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-01.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-27</div><div class="info-item-2">Docker Compose 详解：定义和运行多容器 Docker 应用</div></div><div class="info-2"><div class="info-item-1"> Docker Compose 是一个用于定义和运行多容器 Docker 应用程序的工具。通过一个 YAML 文件（通常命名为 docker-compose.yml），你可以配置应用程序的所有服务（容器）、网络和卷。然后，只需一个命令，就可以从这个配置文件中启动、停止和管理整个应用程序。  在实际的生产环境中，一个完整的应用程序通常由多个服务组成，例如一个 Web 应用可能包含一个 Web 服务器（Nginx&#x2F;Apache）、一个应用服务（Python&#x2F;Node.js&#x2F;Java）、一个数据库（PostgreSQL&#x2F;MySQL）和一个缓存服务（Redis）。手动管理这些独立容器的创建、网络连接和启动顺序非常繁琐且容易出错。Docker Compose 的出现正是为了解决这些多容器应用的管理复杂性。   一、Docker Compose 简介与核心优势Docker Compose 简化了多容器应用的开发、测试和（小规模）部署。它将应用的整个拓扑结构描述在一个文件中，实现了“基础设施即代码”的理念。 Docker Compose 的核心优势：  ...</div></div></div></a><a class="pagination-related" href="/2023/2023-01-26_%E4%BB%8E%E5%8D%95%E6%9C%BA%E5%88%B0%E5%93%A8%E5%85%B5%E4%B8%80%E5%BC%A0%E5%9B%BE%E7%90%86%E6%B8%85redis%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B/" title="从单机到哨兵，一张图理清redis架构演进！"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-08.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-26</div><div class="info-item-2">从单机到哨兵，一张图理清redis架构演进！</div></div><div class="info-2"><div class="info-item-1">Redis 的架构是逐步演进而来的，正所谓“罗马不是一天建成的”。   2010 年：单机版 Redis  当 Redis1.0在 2010 年首次发布时，整体架构非常简单，通常作为业务系统的缓存使用。不过，Redis 的数据是存储在内存中的，一旦重启，数据就会全部丢失，导致请求会直接打到数据库上，带来较大的压力。  2013 年：持久化机制上线  2013 年，Redis2.8版本发布，解决了之前“重启就丢数据”的问题。Redis 引入了 RDB（内存快照）机制，用于定时将内存中的数据持久化到磁盘。同时还支持 AOF（只追加文件）方式，将每一次写操作都记录到日志文件中，实现更高级别的持久化保障。  2013 年：主从复制机制  同样在 Redis2.8中，官方引入了主从复制功能，提升了系统的高可用性。主节点负责处理实时的读写请求，从节点则负责同步主节点的数据，起到备份和读扩展的作用。  2013 年：Sentinel 哨兵机制上线  在 Redis2.8版本中，引入了 Sentinel（哨兵）机制，用于实时监控 Redis 实例的运行状态。它主要负责以下几个方面的工作：   监...</div></div></div></a><a class="pagination-related" href="/2023/2023-01-27_MySQL%20%E7%B4%A2%E5%BC%95%E8%AF%A6%E8%A7%A3/" title="MySQL 索引详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-20.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-27</div><div class="info-item-2">MySQL 索引详解</div></div><div class="info-2"><div class="info-item-1"> 索引是数据库中用于提高查询速度的一种数据结构。在 MySQL 中，合理有效地使用索引能够显著提升数据库的查询性能，减少 I&#x2F;O 操作。然而，不恰当的索引也可能带来额外的开销。理解 MySQL 索引的原理和优化策略，是数据库性能调优的关键。  “好的索引，事半功倍；坏的索引，越帮越忙。” - 数据库优化格言   一、什么是索引？索引（Index）是一种特殊的查找表，数据库搜索引擎可以利用它来快速定位数据。可以将其类比为一本书的目录，通过目录我们可以快速找到感兴趣的章节，而不需要通读整本书。 在数据库中，没有索引的查询需要全表扫描，即逐行检查每条记录，直到找到符合条件的记录。当数据量非常大时，这种操作的效率会非常低下。索引通过创建指向数据物理位置的指针，使得数据库在查询时能够直接跳转到相关记录，从而大大加快查询速度。 二、索引的优缺点优点 显著提高数据检索速度：这是索引最核心、最主要的优点。 加快表与表之间的连接速度：对于 JOIN 操作，索引可以加速连接条件的匹配。 加快分组和排序操作：GROUP BY 和 ORDER BY 操作通常通过消除临时表和对文件进行排序来提高...</div></div></div></a><a class="pagination-related" href="/2023/2023-02-09_Python%E5%85%83%E7%B1%BB(Metaclass)%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" title="Python元类(Metaclass)深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-05.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-09</div><div class="info-item-2">Python元类(Metaclass)深度解析</div></div><div class="info-2"><div class="info-item-1">Python 元类深度解析：从概念到实战  “Everything is an object.” - Python之禅“Classes are objects too.” - 元类的核心思想  在 Python 中，万物皆对象。你用 class 关键字定义的类，例如 str、int、list，它们本身也是对象。那么，是谁创建了这些类对象呢？答案就是“元类”(Metaclass)。元类是创建类的类，它允许我们在类被创建时对其行为进行定制，是 Python 中进行高级面向对象编程的强大工具。 1. 什么是元类？在 Python 中，当你定义一个类 class MyClass: pass 的时候，Python 解释器会自动执行以下步骤：  定义一个类对象：解释器读取 MyClass 的定义，并创建一个名为 MyClass 的类对象。 将类对象绑定到命名空间：这个 MyClass 类对象被绑定到当前的命名空间中。  然后，当你通过 my_instance = MyClass() 来创建实例时，MyClass 这个类对象就会被调用，从而创建并返回一个实例对象。 元类就是用来创建这些类对象的...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TeaTang</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">166</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">160</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">55</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/teatang"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:tea.tang1211@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站更多功能即将上线，敬请期待！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8E%E7%AE%A1%E7%90%86%EF%BC%9A%E6%89%93%E9%80%A0%E6%A0%87%E5%87%86%E5%8C%96%E3%80%81%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F"><span class="toc-text">Docker 镜像构建与管理：打造标准化、可复用的容器镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E7%AF%87%EF%BC%9A%E4%BD%A0%E6%98%AF%E5%90%A6%E4%B9%9F%E5%9C%A8%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86%E4%B8%8A%E6%A0%BD%E8%BF%87%E8%B7%9F%E5%A4%B4%EF%BC%9F"><span class="toc-text">开篇：你是否也在镜像管理上栽过跟头？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E7%9A%84%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83%E5%8E%9F%E5%88%99%EF%BC%8890-%E7%9A%84%E4%BA%BA%E9%83%BD%E5%BF%BD%E7%95%A5%E4%BA%86%EF%BC%89"><span class="toc-text">一、镜像构建的三大核心原则（90% 的人都忽略了）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9C%80%E5%B0%8F%E5%8C%96%E5%8E%9F%E5%88%99%EF%BC%9A%E9%95%9C%E5%83%8F%E9%87%8C%E5%8F%AA%E6%94%BE-%E2%80%9C%E5%BF%85%E9%9C%80%E5%93%81%E2%80%9D"><span class="toc-text">1. 最小化原则：镜像里只放 “必需品”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8F%AF%E5%A4%8D%E7%8E%B0%E5%8E%9F%E5%88%99%EF%BC%9A%E4%BB%8A%E5%A4%A9%E8%83%BD%E6%9E%84%E5%BB%BA%EF%BC%8C%E6%98%8E%E5%B9%B4%E4%B9%9F%E8%A6%81%E8%83%BD%E6%9E%84%E5%BB%BA"><span class="toc-text">2. 可复现原则：今天能构建，明年也要能构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%89%E5%85%A8%E5%8E%9F%E5%88%99%EF%BC%9A%E4%B8%8D%E8%A6%81%E8%AE%A9%E9%95%9C%E5%83%8F%E6%88%90%E4%B8%BA%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%B8%A9%E5%BA%8A"><span class="toc-text">3. 安全原则：不要让镜像成为安全漏洞的温床</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%AE%9E%E6%88%98%EF%BC%9A5-%E6%AD%A5%E6%89%93%E9%80%A0%E7%94%9F%E4%BA%A7%E7%BA%A7%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%BD%93%E7%B3%BB"><span class="toc-text">二、实战：5 步打造生产级镜像构建体系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-1%EF%BC%9A%E7%BC%96%E5%86%99%E9%AB%98%E6%95%88%E7%9A%84-Dockerfile%EF%BC%88%E9%99%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%A8%A1%E6%9D%BF%EF%BC%89"><span class="toc-text">Step 1：编写高效的 Dockerfile（附最佳实践模板）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-2%EF%BC%9A%E6%9E%84%E5%BB%BA%E5%8F%82%E6%95%B0%E5%8C%96%EF%BC%88%E4%B8%80%E4%B8%AA-Dockerfile-%E9%80%82%E9%85%8D%E5%A4%9A%E7%8E%AF%E5%A2%83%EF%BC%89"><span class="toc-text">Step 2：构建参数化（一个 Dockerfile 适配多环境）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-3%EF%BC%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E9%95%9C%E5%83%8F%E6%89%AB%E6%8F%8F%EF%BC%88%E6%8F%90%E5%89%8D%E5%8F%91%E7%8E%B0%E5%AE%89%E5%85%A8%E9%9A%90%E6%82%A3%EF%BC%89"><span class="toc-text">Step 3：自动化镜像扫描（提前发现安全隐患）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-4%EF%BC%9A%E9%95%9C%E5%83%8F%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%EF%BC%88%E5%91%8A%E5%88%AB-latest-%E5%9C%B0%E7%8B%B1%EF%BC%89"><span class="toc-text">Step 4：镜像版本管理（告别 latest 地狱）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-5%EF%BC%9A%E6%9E%84%E5%BB%BA%E6%B5%81%E6%B0%B4%E7%BA%BF%E9%9B%86%E6%88%90%EF%BC%88CI-CD-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%EF%BC%89"><span class="toc-text">Step 5：构建流水线集成（CI&#x2F;CD 最佳实践）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E8%BF%9B%E9%98%B6%E4%BC%98%E5%8C%96%EF%BC%9A%E8%AE%A9%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E6%95%88%E7%8E%87%E7%BF%BB%E5%80%8D"><span class="toc-text">三、进阶优化：让镜像构建效率翻倍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8-BuildKit-%E5%8A%A0%E9%80%9F%E6%9E%84%E5%BB%BA"><span class="toc-text">1. 使用 BuildKit 加速构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9E%84%E5%BB%BA%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-text">2. 构建缓存优化策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%95%9C%E5%83%8F%E4%BD%93%E7%A7%AF%E6%9E%81%E9%99%90%E5%8E%8B%E7%BC%A9"><span class="toc-text">3. 镜像体积极限压缩</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E8%B8%A9%E5%9D%91%E8%A1%80%E6%B3%AA%E5%8F%B2%EF%BC%9A%E8%BF%99%E4%BA%9B%E9%94%99%E8%AF%AF%E4%BD%A0%E5%8D%83%E4%B8%87%E5%88%AB%E7%8A%AF"><span class="toc-text">四、踩坑血泪史：这些错误你千万别犯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91-1%EF%BC%9A%E5%9C%A8%E9%95%9C%E5%83%8F%E9%87%8C%E5%AD%98%E5%82%A8%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF"><span class="toc-text">坑 1：在镜像里存储敏感信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91-2%EF%BC%9A%E6%BB%A5%E7%94%A8-sudo-%E5%92%8C-root-%E6%9D%83%E9%99%90"><span class="toc-text">坑 2：滥用 sudo 和 root 权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91-3%EF%BC%9A%E5%BF%BD%E8%A7%86%E6%97%B6%E5%8C%BA%E9%97%AE%E9%A2%98"><span class="toc-text">坑 3：忽视时区问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7%EF%BC%9A%E4%B8%80%E9%94%AE%E9%95%9C%E5%83%8F%E4%BC%98%E5%8C%96%E8%84%9A%E6%9C%AC"><span class="toc-text">实用工具：一键镜像优化脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9A%E6%8E%8C%E6%8F%A1%E8%BF%99-5-%E6%AD%A5%EF%BC%8C%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86%E4%B8%8D%E5%86%8D%E6%98%AF%E9%9A%BE%E9%A2%98"><span class="toc-text">总结：掌握这 5 步，镜像管理不再是难题</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/2025-10-23_Go%E8%AF%AD%E8%A8%80%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C%E8%AF%A6%E8%A7%A3/" title="Go语言并发与并行详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-19.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go语言并发与并行详解"/></a><div class="content"><a class="title" href="/2025/2025-10-23_Go%E8%AF%AD%E8%A8%80%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C%E8%AF%A6%E8%A7%A3/" title="Go语言并发与并行详解">Go语言并发与并行详解</a><time datetime="2025-10-22T22:24:00.000Z" title="发表于 2025-10-23 06:24:00">2025-10-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/2025-10-16_%E5%B8%B8%E7%94%A8%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95%E7%9A%84Go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E8%AF%A6%E8%A7%A3/" title="常用限流算法的Go语言实现详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="常用限流算法的Go语言实现详解"/></a><div class="content"><a class="title" href="/2025/2025-10-16_%E5%B8%B8%E7%94%A8%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95%E7%9A%84Go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E8%AF%A6%E8%A7%A3/" title="常用限流算法的Go语言实现详解">常用限流算法的Go语言实现详解</a><time datetime="2025-10-15T22:24:00.000Z" title="发表于 2025-10-16 06:24:00">2025-10-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/2025-10-10_NativeScript-Vue3%E8%AF%A6%E8%A7%A3/" title="NativeScript-Vue3详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-08.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="NativeScript-Vue3详解"/></a><div class="content"><a class="title" href="/2025/2025-10-10_NativeScript-Vue3%E8%AF%A6%E8%A7%A3/" title="NativeScript-Vue3详解">NativeScript-Vue3详解</a><time datetime="2025-10-09T22:24:00.000Z" title="发表于 2025-10-10 06:24:00">2025-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/2025-10-08_Hyper-V%20%E6%B7%B1%E5%BA%A6%E8%AF%A6%E8%A7%A3%EF%BC%9AWindows%20%E5%B9%B3%E5%8F%B0%E4%B8%8A%E7%9A%84%E4%B8%93%E4%B8%9A%E7%BA%A7%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/" title="Hyper-V 深度详解：Windows 平台上的专业级虚拟化技术"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-14.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hyper-V 深度详解：Windows 平台上的专业级虚拟化技术"/></a><div class="content"><a class="title" href="/2025/2025-10-08_Hyper-V%20%E6%B7%B1%E5%BA%A6%E8%AF%A6%E8%A7%A3%EF%BC%9AWindows%20%E5%B9%B3%E5%8F%B0%E4%B8%8A%E7%9A%84%E4%B8%93%E4%B8%9A%E7%BA%A7%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/" title="Hyper-V 深度详解：Windows 平台上的专业级虚拟化技术">Hyper-V 深度详解：Windows 平台上的专业级虚拟化技术</a><time datetime="2025-10-07T22:24:00.000Z" title="发表于 2025-10-08 06:24:00">2025-10-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/2025-10-06_TresJS%E8%AF%A6%E8%A7%A3%EF%BC%9A%E7%94%A8Vue%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9E%84%E5%BB%BAThree.js%E5%9C%BA%E6%99%AF/" title="TresJS详解：用Vue的方式构建Three.js场景"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-13.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TresJS详解：用Vue的方式构建Three.js场景"/></a><div class="content"><a class="title" href="/2025/2025-10-06_TresJS%E8%AF%A6%E8%A7%A3%EF%BC%9A%E7%94%A8Vue%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9E%84%E5%BB%BAThree.js%E5%9C%BA%E6%99%AF/" title="TresJS详解：用Vue的方式构建Three.js场景">TresJS详解：用Vue的方式构建Three.js场景</a><time datetime="2025-10-05T22:24:00.000Z" title="发表于 2025-10-06 06:24:00">2025-10-06</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/default_cover-14.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">我的轨迹</div><div class="footer-flex-content"><a href="/tags/2023/" target="_blank" title="📌 2023">📌 2023</a><a href="/tags/2024/" target="_blank" title="❓ 2024">❓ 2024</a><a href="/tags/2025/" target="_blank" title="🚀 2025">🚀 2025</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">维度</div><div class="footer-flex-content"><a href="/categories/" target="_blank" title="分类">分类</a><a href="/tags/" target="_blank" title="标签">标签</a><a href="/categories/" target="_blank" title="时间线">时间线</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/shuoshuo" target="_blank" title="说说">说说</a></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2021 - 2025 By TeaTang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.1"></script><script src="/js/main.js?v=5.5.1"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script></div><script data-pjax src="/self/btf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="ture"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,200,200" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      true
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script>(() => {
  const option = null
  const config = {"site_uv":true,"site_pv":true,"page_pv":true,"token":"qTvz1SkmPDt785fgh6BpiA5qiFFIVUwxj8Ft+rPW+cdN59v1hXjwRgSmy0+ji9m+oLlcxvo2NfDSMa6epVl3NTlsN3ejCIwWeP8Y51aEJ0Sbem4UexGmJLspB7AkOBId2SdtT6QWEBlGmFIIQgchQ2zAKYxTmc/kpBED5aLSr+3uvmQ9/G7FJQeVFpveDkK0xM1hu36xq4a6/FSeROxtoEp5zabzTWiYTlLsQzIl/NlELnCq3nxK+oo/vl3UQo/oM/rae/gJX/MaVKsgIUCd2ABJogNkx2KTenBIBpbPki5FzOgPh6/z4GPa4HvhNO51DDVG1SEQZooqEYmt/gnybLBWFbN+7liZWw=="}

  const runTrack = () => {
    if (typeof umami !== 'undefined' && typeof umami.track === 'function') {
      umami.track(props => ({ ...props, url: window.location.pathname, title: GLOBAL_CONFIG_SITE.title }))
    } else {
      console.warn('Umami Analytics: umami.track is not available')
    }
  }

  const loadUmamiJS = () => {
    btf.getScript('https://umami.012700.xyz/script.js', {
      'data-website-id': '2a796d6c-6499-42d8-8eb4-d9a2930b0ff3',
      'data-auto-track': 'false',
      ...option
    }).then(() => {
      runTrack()
    }).catch(error => {
      console.error('Umami Analytics: Error loading script', error)
    })
  }

  const getData = async (isPost) => {
    try {
      const now = Date.now()
      const keyUrl = isPost ? `&url=${window.location.pathname}` : ''
      const headerList = { 'Accept': 'application/json' }

      if (true) {
        headerList['Authorization'] = `Bearer ${config.token}`
      } else {
        headerList['x-umami-api-key'] = config.token
      }

      const res = await fetch(`https://umami.012700.xyz/api/websites/2a796d6c-6499-42d8-8eb4-d9a2930b0ff3/stats?startAt=0000000000&endAt=${now}${keyUrl}`, {
        method: "GET",
        headers: headerList
      })

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`)
      }

      return await res.json()
    } catch (error) {
      console.error('Umami Analytics: Failed to fetch data', error)
      throw error
    }
  }

  const insertData = async () => {
    try {
      if (GLOBAL_CONFIG_SITE.pageType === 'post' && config.page_pv) {
        const pagePV = document.getElementById('umamiPV')
        if (pagePV) {
          const data = await getData(true)
          if (data && data.pageviews && typeof data.pageviews.value !== 'undefined') {
            pagePV.textContent = data.pageviews.value
          } else {
            console.warn('Umami Analytics: Invalid page view data received')
          }
        }
      }

      if (config.site_uv || config.site_pv) {
        const data = await getData(false)

        if (config.site_uv) {
          const siteUV = document.getElementById('umami-site-uv')
          if (siteUV && data && data.visitors && typeof data.visitors.value !== 'undefined') {
            siteUV.textContent = data.visitors.value
          } else if (siteUV) {
            console.warn('Umami Analytics: Invalid site UV data received')
          }
        }

        if (config.site_pv) {
          const sitePV = document.getElementById('umami-site-pv')
          if (sitePV && data && data.pageviews && typeof data.pageviews.value !== 'undefined') {
            sitePV.textContent = data.pageviews.value
          } else if (sitePV) {
            console.warn('Umami Analytics: Invalid site PV data received')
          }
        }
      }
    } catch (error) {
      console.error('Umami Analytics: Failed to insert data', error)
    }
  }

  btf.addGlobalFn('pjaxComplete', runTrack, 'umami_analytics_run_track')
  btf.addGlobalFn('pjaxComplete', insertData, 'umami_analytics_insert')


  loadUmamiJS()

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', insertData)
  } else {
    setTimeout(insertData, 100)
  }
})()</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.1"></script></div></div></body></html>