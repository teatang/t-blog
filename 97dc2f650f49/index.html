<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Jinja2 深度解析 | 1024 维度</title><meta name="author" content="TeaTang"><meta name="copyright" content="TeaTang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Jinja2 是一个功能强大、灵活且广泛使用的 Python 模板引擎。它由 Armin Ronacher 创建，是 Flask Web 框架默认的模板引擎，但也常用于其他 Python 项目，如静态网站生成、自动化配置管理（例如 Ansible）等。Jinja2 的设计灵感来源于 Django 模板语言，但提供了更多高级功能和更易用的 API。 本文将深入探讨 Jinja2 的核心特性，并着重">
<meta property="og:type" content="article">
<meta property="og:title" content="Jinja2 深度解析">
<meta property="og:url" content="https://blog.tbf1211.xx.kg/97dc2f650f49/index.html">
<meta property="og:site_name" content="1024 维度">
<meta property="og:description" content="Jinja2 是一个功能强大、灵活且广泛使用的 Python 模板引擎。它由 Armin Ronacher 创建，是 Flask Web 框架默认的模板引擎，但也常用于其他 Python 项目，如静态网站生成、自动化配置管理（例如 Ansible）等。Jinja2 的设计灵感来源于 Django 模板语言，但提供了更多高级功能和更易用的 API。 本文将深入探讨 Jinja2 的核心特性，并着重">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-03.jpg">
<meta property="article:published_time" content="2023-08-11T22:24:00.000Z">
<meta property="article:modified_time" content="2026-01-04T09:13:31.544Z">
<meta property="article:author" content="TeaTang">
<meta property="article:tag" content="2023">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="模板引擎">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-03.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Jinja2 深度解析",
  "url": "https://blog.tbf1211.xx.kg/97dc2f650f49/",
  "image": "https://blog.tbf1211.xx.kg/img/cover/default_cover-03.jpg",
  "datePublished": "2023-08-11T22:24:00.000Z",
  "dateModified": "2026-01-04T09:13:31.544Z",
  "author": [
    {
      "@type": "Person",
      "name": "TeaTang",
      "url": "https://blog.tbf1211.xx.kg"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon-1.ico"><link rel="canonical" href="https://blog.tbf1211.xx.kg/97dc2f650f49/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.7/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":true,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: TeaTang","link":"链接: ","source":"来源: 1024 维度","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Jinja2 深度解析',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="1024 维度" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">455</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">226</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">81</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/cover/default_cover-03.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">1024 维度</span></a><a class="nav-page-title" href="/"><span class="site-name">Jinja2 深度解析</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Jinja2 深度解析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-08-11T22:24:00.000Z" title="发表于 2023-08-12 06:24:00">2023-08-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Python/">Python</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Python/%E5%BA%93/">库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><strong>Jinja2</strong> 是一个功能强大、灵活且广泛使用的 Python 模板引擎。它由 Armin Ronacher 创建，是 Flask Web 框架默认的模板引擎，但也常用于其他 Python 项目，如静态网站生成、自动化配置管理（例如 Ansible）等。Jinja2 的设计灵感来源于 Django 模板语言，但提供了更多高级功能和更易用的 API。</p>
<p>本文将深入探讨 Jinja2 的核心特性，并着重介绍一系列<strong>高效使用技巧</strong>，帮助开发者更优雅、更高效地构建动态内容。</p>
</blockquote>
<div class="note info flat"><p>核心思想：<strong>Jinja2 旨在将应用的逻辑（Python 代码）与展示逻辑（HTML&#x2F;文本）清晰地分离。它提供了一种简洁的语法，允许开发者在模板中嵌入变量、控制结构（如循环、条件判断）和自定义过滤器，从而动态生成文本内容。高效利用 Jinja2 的高级功能和最佳实践，可以显著提升开发效率和模板的可维护性。</strong></p>
</div>
<hr>
<h2 id="一、为什么需要模板引擎？"><a href="#一、为什么需要模板引擎？" class="headerlink" title="一、为什么需要模板引擎？"></a>一、为什么需要模板引擎？</h2><p>在 Web 开发或其他需要生成动态文本内容的场景中，我们经常需要将程序数据（如从数据库获取的数据、用户输入等）与预定义的结构化文本（如 HTML 页面、配置文件、邮件内容）结合起来。</p>
<p>直接在 Python 代码中拼接大量 HTML 字符串不仅繁琐、易错，而且难以维护：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 糟糕的实践</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">user_name, items</span>):</span><br><span class="line">    html = <span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;</span></span><br><span class="line">    html += <span class="string">f&quot;&lt;h1&gt;Hello, <span class="subst">&#123;user_name&#125;</span>!&lt;/h1&gt;&quot;</span></span><br><span class="line">    html += <span class="string">&quot;&lt;ul&gt;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">        html += <span class="string">f&quot;&lt;li&gt;<span class="subst">&#123;item&#125;</span>&lt;/li&gt;&quot;</span></span><br><span class="line">    html += <span class="string">&quot;&lt;/ul&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br></pre></td></tr></table></figure>

<p>模板引擎通过引入一种专门的<strong>模板语言 (Template Language)</strong> 来解决这个问题。它允许：</p>
<ol>
<li><strong>逻辑与视图分离</strong>：后端只关注数据处理和业务逻辑，前端（或模板设计师）只关注页面结构和展示。</li>
<li><strong>代码复用</strong>：通过继承、包含等机制，减少重复代码。</li>
<li><strong>易于维护</strong>：修改页面布局或文本结构时，无需改动后端代码。</li>
<li><strong>安全</strong>：模板引擎通常内置了自动转义功能，可以有效防范 XSS (Cross-Site Scripting) 攻击。</li>
</ol>
<p>Jinja2 便是 Python 世界中非常流行且功能强大的模板引擎之一。</p>
<h2 id="二、Jinja2-的核心特性回顾"><a href="#二、Jinja2-的核心特性回顾" class="headerlink" title="二、Jinja2 的核心特性回顾"></a>二、Jinja2 的核心特性回顾</h2><h3 id="2-1-简洁的语法"><a href="#2-1-简洁的语法" class="headerlink" title="2.1 简洁的语法"></a>2.1 简洁的语法</h3><p>Jinja2 采用类 Django 的语法风格，易于学习和阅读。主要有三种类型的语法结构：</p>
<ol>
<li><p><strong><code>&#123;&#123; ... &#125;&#125;</code> (变量表达式)</strong>：用于输出变量的值或表达式的结果。Jinja2 会自动对输出进行 HTML 转义，防止 XSS 攻击。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, &#123;&#123; user.name &#125;&#125;!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Current date: &#123;&#123; now() | datetimeformat &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>&#123;% ... %&#125;</code> (控制流语句)</strong>：用于实现循环 (for)、条件判断 (if&#x2F;else)、宏 (macro)、块 (block)、继承 (extends) 等逻辑。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if user.is_authenticated %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Welcome back, &#123;&#123; user.name &#125;&#125;!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/login&quot;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% for item in items %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; item.name &#125;&#125; - $&#123;&#123; item.price &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>&#123;\# ... #&#125;</code> (注释)</strong>：用于在模板中添加注释，这些注释在渲染时会被忽略。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;# This is a comment, it will not appear in the output #&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-2-强大的功能"><a href="#2-2-强大的功能" class="headerlink" title="2.2 强大的功能"></a>2.2 强大的功能</h3><ul>
<li><strong>变量与表达式</strong>：支持 Python 风格的变量访问（点号 <code>.</code>, 下标 <code>[]</code>）、算术运算、比较运算、逻辑运算等。</li>
<li><strong>过滤器 (Filters)</strong>：可以对变量值进行转换和处理。例如，<code>&#123;&#123; name | upper &#125;&#125;</code> 将 <code>name</code> 转换为大写，<code>&#123;&#123; items | length &#125;&#125;</code> 获取列表长度。</li>
<li><strong>测试器 (Tests)</strong>：用于测试变量的属性或状态。例如，<code>&#123;% if user is defined %&#125;</code> 检查变量是否已定义，<code>&#123;% if user.name is not none %&#125;</code> 检查变量是否非空。</li>
<li><strong>循环与条件</strong>：<code>for</code> 循环（支持 <code>else</code> 分支、<code>loop</code> 对象）、<code>if/elif/else</code> 条件判断。</li>
<li><strong>模板继承 (Template Inheritance)</strong>：允许创建基础模板 (base template) 和子模板，子模板可以重写父模板中定义的块 (block)，实现页面布局的复用。</li>
<li><strong>宏 (Macros)</strong>：类似于编程语言中的函数，可以在模板中定义可重用的代码片段。</li>
<li><strong>包含 (Includes)</strong>：可以将一个模板文件的内容插入到另一个模板中，实现组件化。</li>
<li><strong>沙箱 (Sandboxing)</strong>：Jinja2 可以在一个安全的沙箱环境中执行模板，限制模板能访问的 Python 对象和方法，提高安全性。</li>
<li><strong>国际化 (Internationalization)</strong>：支持使用 <code>gettext</code> 等工具进行模板的国际化。</li>
<li><strong>自定义扩展</strong>：允许开发者编写自定义的过滤器、测试器、全局函数甚至标签。</li>
</ul>
<h2 id="三、Jinja2-高效使用技巧"><a href="#三、Jinja2-高效使用技巧" class="headerlink" title="三、Jinja2 高效使用技巧"></a>三、Jinja2 高效使用技巧</h2><h3 id="3-1-模板继承与块-Blocks-：构建可复用布局"><a href="#3-1-模板继承与块-Blocks-：构建可复用布局" class="headerlink" title="3.1 模板继承与块 (Blocks)：构建可复用布局"></a>3.1 模板继承与块 (Blocks)：构建可复用布局</h3><p>模板继承是 Jinja2 最强大的功能之一，它允许您定义一个骨架模板（<code>base.html</code>），其中包含网站的公共结构和占位符（<code>&#123;% block ... %&#125;</code>），然后子模板可以填充或修改这些占位符。</p>
<p><strong>技巧：细化块的粒度</strong><br>不要只使用一个巨大的 <code>&#123;% block content %&#125;</code>。将页面布局分解成更小的、有语义的块，如 <code>&#123;% block head_meta %&#125;</code>、<code>&#123;% block head_css %&#125;</code>、<code>&#123;% block page_title %&#125;</code>、<code>&#123;% block header %&#125;</code>、<code>&#123;% block main_content %&#125;</code>、<code>&#123;% block footer_js %&#125;</code> 等。这使得子模板可以更精确地控制要修改的区域，而不需要复制大量 HTML。</p>
<p><strong>示例：</strong></p>
<p><code>base.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    &#123;% block head_meta %&#125;&#123;% endblock %&#125; &#123;# 允许子模板添加额外的meta标签 #&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;% block title %&#125;My Awesome Site&#123;% endblock %&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    &#123;% block head_css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/static/main.css&quot;</span>&gt;</span></span><br><span class="line">    &#123;% endblock %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">header</span>&gt;</span>&#123;% block header %&#125;<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Website Header<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>&#123;% endblock %&#125;<span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span>&gt;</span>&#123;% block navigation %&#125;<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/about&quot;</span>&gt;</span>About<span class="tag">&lt;/<span class="name">a</span>&gt;</span>&#123;% endblock %&#125;<span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">main</span>&gt;</span></span><br><span class="line">        &#123;% block main_content %&#125;&#123;% endblock %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">footer</span>&gt;</span>&#123;% block footer %&#125;All rights reserved.&#123;% endblock %&#125;<span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line">    &#123;% block body_js %&#125;&#123;% endblock %&#125; &#123;# 允许子模板添加页面底部的JS #&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>user_profile.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;User Profile - &#123;&#123; super() &#125;&#125;&#123;% endblock %&#125; &#123;# super() 调用父块内容 #&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block head_css %&#125;</span><br><span class="line">    &#123;&#123; super() &#125;&#125; &#123;# 保留父块的CSS #&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/static/profile.css&quot;</span>&gt;</span> &#123;# 添加额外的CSS #&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user-header&quot;</span>&gt;</span></span><br><span class="line">        Welcome, &#123;&#123; user.username &#125;&#125;!</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/logout&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block main_content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>User Details<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Email: &#123;&#123; user.email &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Last Login: &#123;&#123; user.last_login | datetimeformat &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block body_js %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/static/profile.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-宏-Macros-：组件化与代码复用"><a href="#3-2-宏-Macros-：组件化与代码复用" class="headerlink" title="3.2 宏 (Macros)：组件化与代码复用"></a>3.2 宏 (Macros)：组件化与代码复用</h3><p>宏是 Jinja2 中的“函数”，用于定义可重用的 UI 组件或 HTML 片段。它们有助于减少重复代码并提高模板的模块化。</p>
<p><strong>技巧：将常用组件封装成宏</strong><br>将表单字段、按钮、警告消息、分页器等重复出现的 HTML 结构定义为宏，并存储在独立的宏文件中。</p>
<p><strong>示例：</strong><br><code>macros.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;# 定义一个渲染表单字段的宏 #&#125;</span><br><span class="line">&#123;% macro render_field(field) %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;&#123;&#123; field.id &#125;&#125;&quot;</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;&#123;&#123; field.type | default(&#x27;text&#x27;) &#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">id</span>=<span class="string">&quot;&#123;&#123; field.id &#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">name</span>=<span class="string">&quot;&#123;&#123; field.name &#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">value</span>=<span class="string">&quot;&#123;&#123; field.value | default(&#x27;&#x27;) &#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">               &#123;% <span class="attr">if</span> <span class="attr">field.required</span> %&#125;<span class="attr">required</span>&#123;% <span class="attr">endif</span> %&#125;</span></span><br><span class="line"><span class="tag">               <span class="attr">class</span>=<span class="string">&quot;form-control &#123;&#123; &#x27;is-invalid&#x27; if field.errors &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        &#123;% if field.errors %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;invalid-feedback&quot;</span>&gt;</span></span><br><span class="line">                &#123;% for error in field.errors %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; error &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line"></span><br><span class="line">&#123;# 定义一个渲染警告消息的宏 #&#125;</span><br><span class="line">&#123;% macro flash_message(message, category=&#x27;info&#x27;) %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-&#123;&#123; category &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        &#123;&#123; message &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endmacro %&#125;</span><br></pre></td></tr></table></figure>

<p>在其他模板中使用宏：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;% from &#x27;macros.html&#x27; import render_field, flash_message %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block main_content %&#125;</span><br><span class="line">    &#123;% if messages %&#125;</span><br><span class="line">        &#123;% for category, message in messages %&#125;</span><br><span class="line">            &#123;&#123; flash_message(message, category) &#125;&#125;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">        &#123;&#123; render_field(form.username) &#125;&#125;</span><br><span class="line">        &#123;&#123; render_field(form.password, type=&#x27;password&#x27;) &#125;&#125; &#123;# 也可以覆盖默认参数 #&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-包含-Includes-：插入静态内容或小型组件"><a href="#3-3-包含-Includes-：插入静态内容或小型组件" class="headerlink" title="3.3 包含 (Includes)：插入静态内容或小型组件"></a>3.3 包含 (Includes)：插入静态内容或小型组件</h3><p><code>&#123;% include 'some_file.html' %&#125;</code> 用于将另一个模板文件的内容直接插入当前位置。与宏的区别在于，<code>include</code> 更侧重于静态内容的插入或简单的可复用片段，而宏更侧重于带参数的动态渲染。</p>
<p><strong>技巧：用于导航栏、页脚、侧边栏等静态部分</strong><br>这些部分通常是独立的 HTML 片段，无需太多参数即可直接插入。</p>
<p><strong>示例：</strong><br><code>header.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span> |</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/products&quot;</span>&gt;</span>Products<span class="tag">&lt;/<span class="name">a</span>&gt;</span> |</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/contact&quot;</span>&gt;</span>Contact<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>footer.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">footer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="symbol">&amp;copy;</span> 2024 MyCompany. All rights reserved.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>base.html</code> 中使用：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    &#123;% include &#x27;header.html&#x27; %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">main</span>&gt;</span></span><br><span class="line">        &#123;% block content %&#125;&#123;% endblock %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">    &#123;% include &#x27;footer.html&#x27; %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="3-4-过滤器-Filters-与测试器-Tests-：数据处理与逻辑判断"><a href="#3-4-过滤器-Filters-与测试器-Tests-：数据处理与逻辑判断" class="headerlink" title="3.4 过滤器 (Filters) 与测试器 (Tests)：数据处理与逻辑判断"></a>3.4 过滤器 (Filters) 与测试器 (Tests)：数据处理与逻辑判断</h3><p>过滤器用于在模板中转换或处理变量的值，测试器用于检查变量的属性。</p>
<p><strong>技巧1：合理使用内置过滤器</strong><br>Jinja2 提供了丰富的内置过滤器，如 <code>upper</code>, <code>lower</code>, <code>capitalize</code>, <code>title</code>, <code>length</code>, <code>trim</code>, <code>striptags</code>, <code>default</code>, <code>safe</code>, <code>urlencode</code> 等。熟练使用它们可以避免在 Python 代码中进行不必要的预处理。</p>
<p><strong>示例：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>User Name: &#123;&#123; user.username | upper &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Post Snippet: &#123;&#123; post.content | truncate(50, true, &#x27;...&#x27;) &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> &#123;# 截断文本并添加省略号 #&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Item Count: &#123;&#123; items | length &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Greeting: &#123;&#123; greeting | default(&#x27;Hello&#x27;) &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>技巧2：创建自定义过滤器</strong><br>当内置过滤器无法满足需求时，可以在 Python 代码中定义自定义过滤器并注册到 Jinja2 环境中。这保持了模板的简洁性，同时将复杂逻辑保留在 Python 端。</p>
<p><strong>示例：Python 代码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Environment, FileSystemLoader</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_datetime</span>(<span class="params">value, format_string=<span class="string">&quot;%Y-%m-%d %H:%M&quot;</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, (datetime.datetime, datetime.date)):</span><br><span class="line">        <span class="comment"># 尝试将字符串转换为 datetime 对象</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value = datetime.datetime.strptime(<span class="built_in">str</span>(value), <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> (ValueError, TypeError):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span> <span class="comment"># 或返回原始值，或抛出错误</span></span><br><span class="line">    <span class="keyword">return</span> value.strftime(format_string)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Jinja2 环境</span></span><br><span class="line">env = Environment(loader=FileSystemLoader(<span class="string">&#x27;templates&#x27;</span>))</span><br><span class="line"><span class="comment"># 注册自定义过滤器</span></span><br><span class="line">env.filters[<span class="string">&#x27;datetime&#x27;</span>] = format_datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="comment"># template = env.get_template(&#x27;my_template.html&#x27;)</span></span><br><span class="line"><span class="comment"># output = template.render(created_at=datetime.datetime.now())</span></span><br></pre></td></tr></table></figure>

<p><strong>示例：模板中</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Created At: &#123;&#123; created_at | datetime &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Last Modified: &#123;&#123; updated_at | datetime(&#x27;%H:%M:%S %Y-%m-%d&#x27;) &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>技巧3：利用测试器进行条件渲染</strong><br>测试器可以使 <code>if</code> 语句更加简洁和富有表现力。</p>
<p><strong>示例：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if user.posts is not empty %&#125; &#123;# 检查列表是否非空 #&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Your Posts<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% if item.price is number %&#125; &#123;# 检查变量是否是数字 #&#125;</span><br><span class="line">    Price: $&#123;&#123; item.price &#125;&#125;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    Price: N/A</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% if username is startingwith(&#x27;admin&#x27;) %&#125; &#123;# 检查字符串是否以特定前缀开始 #&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;admin-user&quot;</span>&gt;</span>Admin User<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-循环-For-Loops-与-loop-对象：增强迭代控制"><a href="#3-5-循环-For-Loops-与-loop-对象：增强迭代控制" class="headerlink" title="3.5 循环 (For Loops) 与 loop 对象：增强迭代控制"></a>3.5 循环 (For Loops) 与 <code>loop</code> 对象：增强迭代控制</h3><p>Jinja2 的 <code>for</code> 循环功能强大，尤其是 <code>loop</code> 对象提供了许多有用的信息。</p>
<p><strong>技巧：充分利用 <code>loop</code> 对象</strong><br><code>loop</code> 对象提供了当前循环的状态信息，如 <code>loop.index</code> (从1开始)、<code>loop.index0</code> (从0开始)、<code>loop.first</code>、<code>loop.last</code>、<code>loop.revindex</code> (倒序索引)、<code>loop.length</code> 等。</p>
<p><strong>示例：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;% for user in users %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;&#123;&#123; &#x27;odd&#x27; if loop.index is odd else &#x27;even&#x27; &#125;&#125;</span></span></span><br><span class="line"><span class="string"><span class="tag">                   &#123;&#123; &#x27;first&#x27; if loop.first &#125;&#125;</span></span></span><br><span class="line"><span class="string"><span class="tag">                   &#123;&#123; &#x27;last&#x27; if loop.last &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">            &#123;&#123; loop.index &#125;&#125;. &#123;&#123; user.name &#125;&#125; (ID: &#123;&#123; user.id &#125;&#125;)</span><br><span class="line">            &#123;% if loop.last %&#125;<span class="tag">&lt;<span class="name">small</span>&gt;</span> (End of list)<span class="tag">&lt;/<span class="name">small</span>&gt;</span>&#123;% endif %&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    &#123;% else %&#125; &#123;# 列表为空时执行 #&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>No users found.<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>技巧：<code>for ... in ... recursive</code> 实现递归遍历</strong><br>对于树形结构的数据，可以使用递归循环。</p>
<p><strong>示例：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro render_item(item) %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;&#123; item.name &#125;&#125;</span><br><span class="line">        &#123;% if item.children %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                &#123;% for child in item.children recursive %&#125;</span><br><span class="line">                    &#123;&#123; render_item(child) &#125;&#125;</span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;% for item in navigation recursive %&#125;</span><br><span class="line">        &#123;&#123; render_item(item) &#125;&#125;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>对应 Python 数据结构：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">navigation = [</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Home&#x27;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Products&#x27;</span>, <span class="string">&#x27;children&#x27;</span>: [</span><br><span class="line">        &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Electronics&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Books&#x27;</span>, <span class="string">&#x27;children&#x27;</span>: [</span><br><span class="line">            &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Fiction&#x27;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Non-fiction&#x27;</span>&#125;</span><br><span class="line">        ]&#125;</span><br><span class="line">    ]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;About&#x27;</span>&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="3-6-空白控制-Whitespace-Control-：优化输出格式"><a href="#3-6-空白控制-Whitespace-Control-：优化输出格式" class="headerlink" title="3.6 空白控制 (Whitespace Control)：优化输出格式"></a>3.6 空白控制 (Whitespace Control)：优化输出格式</h3><p>Jinja2 默认会保留模板中的所有空白字符，这可能导致输出 HTML 中有多余的换行符和空格。通过在控制流标签的开头或结尾添加 <code>+</code> 或 <code>-</code>，可以控制空白字符的生成。</p>
<ul>
<li><code>-</code> (减号)：去除该标签前的所有空白字符（包括换行符）。</li>
<li><code>+</code> (加号)：去除该标签后的所有空白字符（包括换行符）。</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;# 默认行为 #&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% for item in items %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; item.name &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;# 可能会输出：</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Item1<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Item2<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">#&#125;</span><br><span class="line"></span><br><span class="line">&#123;# 使用空白控制 #&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;%- for item in items -%&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; item.name &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    &#123;%- endfor -%&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;# 输出：</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>Item1<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>Item2<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">#&#125;</span><br></pre></td></tr></table></figure>

<p><strong>技巧：在需要紧凑输出的场景中使用 <code>-</code></strong><br>尤其是在生成 HTML 标签之间不应有空白的情况，如 <code>&lt;li&gt;</code> 标签之间的换行符。但过度使用可能降低模板可读性，需权衡。</p>
<h3 id="3-7-上下文-Context-传递与全局变量"><a href="#3-7-上下文-Context-传递与全局变量" class="headerlink" title="3.7 上下文 (Context) 传递与全局变量"></a>3.7 上下文 (Context) 传递与全局变量</h3><p>Jinja2 的 <code>render()</code> 方法接收一个字典，作为模板的上下文。此外，您还可以在 <code>Environment</code> 中设置全局变量，这些变量在所有模板中都可用。</p>
<p><strong>技巧：将常用函数或常量注册为全局变量</strong><br>例如，日期格式化函数、网站名称、CDN 地址等。</p>
<p><strong>示例：Python 代码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Environment, FileSystemLoader</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_current_year</span>():</span><br><span class="line">    <span class="keyword">return</span> datetime.datetime.now().year</span><br><span class="line"></span><br><span class="line">env = Environment(loader=FileSystemLoader(<span class="string">&#x27;templates&#x27;</span>))</span><br><span class="line">env.<span class="built_in">globals</span>[<span class="string">&#x27;SITE_NAME&#x27;</span>] = <span class="string">&#x27;My Global Site&#x27;</span></span><br><span class="line">env.<span class="built_in">globals</span>[<span class="string">&#x27;current_year&#x27;</span>] = get_current_year</span><br><span class="line">env.<span class="built_in">globals</span>[<span class="string">&#x27;enumerate&#x27;</span>] = <span class="built_in">enumerate</span> <span class="comment"># 将Python内置函数暴露给模板</span></span><br><span class="line"></span><br><span class="line">template = env.from_string(<span class="string">&quot;&lt;footer&gt;&amp;copy; &#123;&#123; current_year &#125;&#125; &#123;&#123; SITE_NAME &#125;&#125;&lt;/footer&gt;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(template.render())</span><br><span class="line"><span class="comment"># Output: &lt;footer&gt;&amp;copy; 2024 My Global Site&lt;/footer&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-8-调试技巧"><a href="#3-8-调试技巧" class="headerlink" title="3.8 调试技巧"></a>3.8 调试技巧</h3><p>当模板渲染出错时，Jinja2 会提供有用的回溯信息。</p>
<p><strong>技巧：在开发环境中启用详细错误信息</strong><br>在 Flask 中，调试模式会自动提供详细的 Jinja2 错误。对于独立使用，可以捕获 <code>TemplateSyntaxError</code> 或 <code>UndefinedError</code>。</p>
<p><strong>示例：Python 代码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Environment, FileSystemLoader, TemplateSyntaxError, UndefinedError</span><br><span class="line"></span><br><span class="line">env = Environment(loader=FileSystemLoader(<span class="string">&#x27;templates&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    template = env.get_template(<span class="string">&#x27;broken.html&#x27;</span>)</span><br><span class="line">    output = template.render(data=&#123;&#125;)</span><br><span class="line">    <span class="built_in">print</span>(output)</span><br><span class="line"><span class="keyword">except</span> (TemplateSyntaxError, UndefinedError) <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Jinja2 Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;File: <span class="subst">&#123;<span class="built_in">getattr</span>(e, <span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>, Line: <span class="subst">&#123;<span class="built_in">getattr</span>(e, <span class="string">&#x27;lineno&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># broken.html (假设有语法错误或变量未定义)</span></span><br><span class="line"><span class="comment"># &#123;&#123; user.name &#125;</span></span><br><span class="line"><span class="comment"># &#123;&#123; non_existent_variable &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="八、总结"><a href="#八、总结" class="headerlink" title="八、总结"></a>八、总结</h2><p>Jinja2 是 Python 开发者工具箱中不可或缺的一部分。通过深入理解其核心功能并掌握上述高效使用技巧，您不仅能够构建出结构清晰、易于维护的模板，还能显著提升开发效率。合理利用模板继承、宏、包含、过滤器和空白控制，可以使您的模板代码更加模块化、可读性更强，并最终交付更优质的产品。始终记住，保持模板的展示逻辑纯粹，将复杂业务逻辑保留在 Python 代码中，是使用 Jinja2 的最佳实践。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg">TeaTang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg/97dc2f650f49/">https://blog.tbf1211.xx.kg/97dc2f650f49/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tbf1211.xx.kg" target="_blank">1024 维度</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/2023/">2023</a><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E/">模板引擎</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover-03.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/90492206afee/" title="Java BIO、NIO、AIO 对比详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-17.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Java BIO、NIO、AIO 对比详解</div></div><div class="info-2"><div class="info-item-1"> Java I&#x2F;O (Input&#x2F;Output) 是应用程序与外部设备之间进行数据传输的桥梁。随着并发编程和高性能网络应用的需求日益增长，Java 提供了多种 I&#x2F;O 模型，以适应不同的使用场景。其中，最核心的三种模型是 BIO (Blocking I&#x2F;O)、NIO (Non-blocking I&#x2F;O) 和 AIO (Asynchronous I&#x2F;O)，它们在处理数据流和网络通信方面有着显著的区别。  核心思想：理解 BIO、NIO 和 AIO 的根本差异在于它们对 I&#x2F;O 操作的阻塞特性、线程管理方式 以及 事件通知机制 的处理。这直接影响着应用在并发、吞吐量和资源利用率方面的表现。   一、同步与异步，阻塞与非阻塞在深入探讨 BIO、NIO、AIO 之前，我们首先明确两个基本概念：  同步 (Synchronous) vs 异步 (Asynchronous)：  同步：发起一个 I&#x2F;O 操作后，调用者需要等待操作完成才能继续执行后续任务。 异步：发起一个 I&#x2F;O 操作后，调用者可以立即返...</div></div></div></a><a class="pagination-related" href="/4a690b26610d/" title="Golang 防止循环依赖 (Circular Dependencies) 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-32.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Golang 防止循环依赖 (Circular Dependencies) 详解</div></div><div class="info-2"><div class="info-item-1"> 循环依赖 (Circular Dependency) 指的是两个或多个模块（在 Go 中通常是包 package）之间相互直接或间接地依赖对方。例如，包 A 导入了包 B，同时包 B 也导入了包 A。在 Golang 中，编译器会直接拒绝包含循环依赖的代码，这与一些允许循环依赖但可能导致运行时问题的语言（如 Java 或 Python）不同。因此，理解并有效解决循环依赖是 Go 语言开发中的一项重要实践。  核心思想：循环依赖是 Go 语言设计中的一个“不允许”的错误。它强制开发者构建清晰、单向的依赖图，从而提高代码的模块化、可测试性和可维护性。   一、为什么循环依赖是一个问题？尽管 Go 编译器直接阻止循环依赖，但理解其背后存在的问题有助于更好地设计软件：  编译失败 (Go 特有)：这是 Go 语言最直接的体现。当检测到循环依赖时，go build 或 go run 命令会报错，阻止代码成功编译。 1234567# 示例错误信息package main:    imports cycle:    main    imports github.com/user/projec...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/832eaf04ac40/" title="Python多线程实现生产者-消费者模式详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-12.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-21</div><div class="info-item-2">Python多线程实现生产者-消费者模式详解</div></div><div class="info-2"><div class="info-item-1"> 生产者-消费者模式是并发编程中一个非常常见的设计模式，用于解决生产者和消费者之间由于生产和消费的速度不一致而导致的同步问题。在 Python 中，由于全局解释器锁 (GIL) 的存在，多线程在 CPU 密集型任务上并不能真正并行，但在 I&#x2F;O 密集型任务上，多线程仍然可以有效地提高程序的效率和响应速度。本篇将详细介绍如何使用 Python 的 threading 模块和 queue 模块实现多线程版的生产者-消费者模式。  核心思想：利用线程安全的共享队列作为缓冲，实现生产者与消费者解耦，并通过队列自带的互斥锁和条件变量进行同步，避免数据不一致和资源竞争。   一、生产者-消费者模式与多线程概述1.1 生产者-消费者模式参考 Python 多进程生产者-消费者模式详解 中的概述，其核心构成和解决的问题在多线程场景下是相同的：  生产者 (Producer)：生成数据并放入队列。 消费者 (Consumer)：从队列取出数据并处理。 缓冲区 (Queue)：共享的、线程安全的数据容器。  1.2 Python 多线程与 GIL threading 模块：Python 标...</div></div></div></a><a class="pagination-related" href="/60590698f89d/" title="Python abc模块详解 - 抽象基类 (Abstract Base Classes)"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-30.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-27</div><div class="info-item-2">Python abc模块详解 - 抽象基类 (Abstract Base Classes)</div></div><div class="info-2"><div class="info-item-1"> Python 的 abc 模块 (Abstract Base Classes) 提供了一种定义抽象基类 (ABC) 的方式。抽象基类强制其子类实现特定的方法，从而为类结构引入了正式的接口定义能力。这在没有显式接口概念的 Python 中，是一种实现“鸭子类型 (Duck Typing)”的更严格、更可控的方式。它有助于构建可预测且易于维护的面向对象代码结构。  核心思想：强制子类遵循父类定义的“契约”，即必须实现某些方法，以确保API的一致性。这提升了代码的可读性、可维护性和健壮性。    一、为什么需要抽象基类 (ABC)？Python 是一种动态类型语言，其核心原则之一是“鸭子类型” (Duck Typing)：  “如果它走起来像鸭子，叫起来像鸭子，那么它就是一只鸭子。”  这意味着，只要一个对象实现了某个方法，我们就可以像对待具有该方法的任何其他对象一样使用它，而无需关心其继承关系或具体类型。 鸭子类型非常灵活，但在某些情况下也会带来问题：  接口不明确：当你在设计一个库或框架时，你可能希望用户提供的类必须实现某些方法。没有明确的接口，用户可能不知道要实现哪些方法，或者...</div></div></div></a><a class="pagination-related" href="/a1d408b2ddbe/" title="Python多进程实现生产者-消费者模式详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-29.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-15</div><div class="info-item-2">Python多进程实现生产者-消费者模式详解</div></div><div class="info-2"><div class="info-item-1"> 生产者-消费者模式是并发编程中一个非常常见的设计模式，用于解决生产者和消费者之间由于生产和消费的速度不一致而导致的线程（或进程）同步问题。在 Python 中，可以使用 multiprocessing 模块实现多进程版的生产者-消费者模式，以充分利用多核 CPU 资源。  核心思想：利用共享队列作为缓冲，实现生产者与消费者解耦，并通过互斥锁和条件变量（或自带的线程安全队列）进行同步，避免数据不一致和资源竞争。   一、生产者-消费者模式概述模式构成：  生产者 (Producer)：负责生成数据，并将其放入共享的缓冲区（队列）中。 消费者 (Consumer)：负责从共享的缓冲区（队列）中取出数据进行处理。 缓冲区 (Buffer &#x2F; Queue)：一个共享的数据结构，通常是一个队列，用于存储生产者生产的数据和消费者消费的数据。它充当了生产者和消费者之间的桥梁。  解决的问题：  解耦：生产者和消费者可以独立运行，互不干扰，提高系统的灵活性。 并发：允许多个生产者和多个消费者同时存在，提高处理效率。 削峰填谷：当生产速度快于消费速度时，缓冲区可以存储多余的数据，防止数...</div></div></div></a><a class="pagination-related" href="/3d8fe1e715a5/" title="Python lxml详解：高效XML&#x2F;HTML解析与处理"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-30.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-05</div><div class="info-item-2">Python lxml详解：高效XML&#x2F;HTML解析与处理</div></div><div class="info-2"><div class="info-item-1"> lxml 是 Python 的一个强大且功能丰富的库，用于解析和处理 XML 和 HTML 文档。它结合了 C 语言库 libxml2 和 libxslt 的速度和功能，以及 Python 的简洁和灵活性。lxml 提供了多种解析方式（如 ElementTree API 和 SAX），并支持强大的 XPath 和 CSS 选择器进行数据提取。在高性能要求的场景下，lxml 往往是处理大型 XML&#x2F;HTML 文档的首选。  核心思想：lxml 利用底层的 C 库，提供了比纯 Python 解析器快得多的性能，同时通过 Pythonic 的接口，使得 XML&#x2F;HTML 的解析、导航和数据提取变得高效而直观。   一、为什么选择 lxml？在 Python 处理 XML&#x2F;HTML 文档时，我们有多种选择，例如 Python 标准库中的 xml.etree.ElementTree、minidom，以及 Beautiful Soup。然而，lxml 在性能和功能上提供了独特的优势：  极高的性能：由于其核心解析引擎是用 C 语言实现的 libxml2 和 l...</div></div></div></a><a class="pagination-related" href="/f6307a80c973/" title="Python 防止循环依赖 (Circular Dependencies) 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-19.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-07</div><div class="info-item-2">Python 防止循环依赖 (Circular Dependencies) 详解</div></div><div class="info-2"><div class="info-item-1"> 循环依赖 (Circular Dependency) 指的是两个或多个模块（在 Python 中通常是文件或包）之间相互直接或间接地导入对方。例如，moduleA.py 导入了 moduleB.py，而 moduleB.py 也导入了 moduleA.py。与 Golang 等语言在编译时直接报错不同，Python 在运行时才处理导入，因此循环依赖通常不会立即导致语法错误，但会在运行时触发 ImportError 或导致不可预测的行为，使代码难以理解、测试和维护。  核心思想：Python 允许在运行时灵活处理导入，但循环依赖是一个设计缺陷的信号，会导致运行时错误或维护噩梦。解决它的关键在于重构代码以建立单向依赖。   一、为什么循环依赖是一个问题？尽管 Python 不像 Go 那样在编译时严格禁止循环依赖，但它依然是需要极力避免的设计缺陷：  运行时 ImportError:这是最常见的直接问题。当 Python 解释器遇到循环导入时，某个模块在被完全初始化之前可能就被另一个模块尝试导入，导致模块中的对象、函数或类尚未定义而引发 ImportError。 示例：module...</div></div></div></a><a class="pagination-related" href="/91353ff26772/" title="Peewee ORM 详解：接口使用与实践"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-12.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-11</div><div class="info-item-2">Peewee ORM 详解：接口使用与实践</div></div><div class="info-2"><div class="info-item-1"> Peewee 是一个小型、富有表现力、功能齐全的 Python ORM (Object-Relational Mapper)。它提供了一种简单且 Pythonic 的方式来与数据库进行交互，支持 SQLite、PostgreSQL 和 MySQL 等多种关系型数据库。Peewee 的设计理念是轻量级和易用性，使得开发者可以快速地构建应用程序，而无需编写大量的 SQL 语句。  核心思想：将数据库表映射为 Python 类，将表的行映射为类的实例，将表的列映射为类的属性。 通过 Python 对象和方法来操作数据库，从而抽象掉底层的 SQL 细节。   一、为什么选择 Peewee？在 Python 生态中，存在多种 ORM 解决方案，如 SQLAlchemy、Django ORM 等。Peewee 在其中脱颖而出，主要归因于以下特点：  轻量级与简洁性：Peewee 本身代码量较少，API 设计简洁直观，学习曲线平缓。 富有表现力：其查询 API 允许开发者使用类似 Python 原生语法的方式链式调用，构建复杂的查询。 兼容性强：支持 SQLite、PostgreSQL 和 ...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TeaTang</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">455</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">226</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">81</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/teatang"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:tea.tang1211@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站更多功能即将上线，敬请期待！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%EF%BC%9F"><span class="toc-text">一、为什么需要模板引擎？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Jinja2-%E7%9A%84%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7%E5%9B%9E%E9%A1%BE"><span class="toc-text">二、Jinja2 的核心特性回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%AE%80%E6%B4%81%E7%9A%84%E8%AF%AD%E6%B3%95"><span class="toc-text">2.1 简洁的语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%BC%BA%E5%A4%A7%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-text">2.2 强大的功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Jinja2-%E9%AB%98%E6%95%88%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7"><span class="toc-text">三、Jinja2 高效使用技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%A8%A1%E6%9D%BF%E7%BB%A7%E6%89%BF%E4%B8%8E%E5%9D%97-Blocks-%EF%BC%9A%E6%9E%84%E5%BB%BA%E5%8F%AF%E5%A4%8D%E7%94%A8%E5%B8%83%E5%B1%80"><span class="toc-text">3.1 模板继承与块 (Blocks)：构建可复用布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AE%8F-Macros-%EF%BC%9A%E7%BB%84%E4%BB%B6%E5%8C%96%E4%B8%8E%E4%BB%A3%E7%A0%81%E5%A4%8D%E7%94%A8"><span class="toc-text">3.2 宏 (Macros)：组件化与代码复用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%8C%85%E5%90%AB-Includes-%EF%BC%9A%E6%8F%92%E5%85%A5%E9%9D%99%E6%80%81%E5%86%85%E5%AE%B9%E6%88%96%E5%B0%8F%E5%9E%8B%E7%BB%84%E4%BB%B6"><span class="toc-text">3.3 包含 (Includes)：插入静态内容或小型组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E8%BF%87%E6%BB%A4%E5%99%A8-Filters-%E4%B8%8E%E6%B5%8B%E8%AF%95%E5%99%A8-Tests-%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E4%B8%8E%E9%80%BB%E8%BE%91%E5%88%A4%E6%96%AD"><span class="toc-text">3.4 过滤器 (Filters) 与测试器 (Tests)：数据处理与逻辑判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E5%BE%AA%E7%8E%AF-For-Loops-%E4%B8%8E-loop-%E5%AF%B9%E8%B1%A1%EF%BC%9A%E5%A2%9E%E5%BC%BA%E8%BF%AD%E4%BB%A3%E6%8E%A7%E5%88%B6"><span class="toc-text">3.5 循环 (For Loops) 与 loop 对象：增强迭代控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E7%A9%BA%E7%99%BD%E6%8E%A7%E5%88%B6-Whitespace-Control-%EF%BC%9A%E4%BC%98%E5%8C%96%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F"><span class="toc-text">3.6 空白控制 (Whitespace Control)：优化输出格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-%E4%B8%8A%E4%B8%8B%E6%96%87-Context-%E4%BC%A0%E9%80%92%E4%B8%8E%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-text">3.7 上下文 (Context) 传递与全局变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7"><span class="toc-text">3.8 调试技巧</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">八、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/3059cdc5f529/" title="Golang sqlc 框架详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-32.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Golang sqlc 框架详解"/></a><div class="content"><a class="title" href="/3059cdc5f529/" title="Golang sqlc 框架详解">Golang sqlc 框架详解</a><time datetime="2026-01-01T22:24:00.000Z" title="发表于 2026-01-02 06:24:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/4e0d929e572f/" title="如何防止 Golang Goroutine 泄漏"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-08.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="如何防止 Golang Goroutine 泄漏"/></a><div class="content"><a class="title" href="/4e0d929e572f/" title="如何防止 Golang Goroutine 泄漏">如何防止 Golang Goroutine 泄漏</a><time datetime="2025-12-30T22:24:00.000Z" title="发表于 2025-12-31 06:24:00">2025-12-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/0c48c5fa5942/" title="CFFI (C Foreign Function Interface for Python) 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-24.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CFFI (C Foreign Function Interface for Python) 详解"/></a><div class="content"><a class="title" href="/0c48c5fa5942/" title="CFFI (C Foreign Function Interface for Python) 详解">CFFI (C Foreign Function Interface for Python) 详解</a><time datetime="2025-12-23T22:24:00.000Z" title="发表于 2025-12-24 06:24:00">2025-12-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/03cebd3cc28a/" title="行为驱动开发 (BDD) 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-22.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="行为驱动开发 (BDD) 详解"/></a><div class="content"><a class="title" href="/03cebd3cc28a/" title="行为驱动开发 (BDD) 详解">行为驱动开发 (BDD) 详解</a><time datetime="2025-12-21T22:24:00.000Z" title="发表于 2025-12-22 06:24:00">2025-12-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/7bb082434be0/" title="测试驱动开发 (TDD) 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-15.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="测试驱动开发 (TDD) 详解"/></a><div class="content"><a class="title" href="/7bb082434be0/" title="测试驱动开发 (TDD) 详解">测试驱动开发 (TDD) 详解</a><time datetime="2025-12-19T22:24:00.000Z" title="发表于 2025-12-20 06:24:00">2025-12-20</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/default_cover-03.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">我的轨迹</div><div class="footer-flex-content"><a href="/archives/2023/" target="_blank" title="🆕 2023">🆕 2023</a><a href="/archives/2024/" target="_blank" title="🆒 2024">🆒 2024</a><a href="/archives/2025/" target="_blank" title="👨‍👩‍👦 2025">👨‍👩‍👦 2025</a><a href="/archives/2026/" target="_blank" title="🆙 2026">🆙 2026</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">维度</div><div class="footer-flex-content"><a href="/categories/" target="_blank" title="📁 分类">📁 分类</a><a href="/tags/" target="_blank" title="🔖 标签">🔖 标签</a><a href="/categories/" target="_blank" title="📽️ 时间线">📽️ 时间线</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/shuoshuo" target="_blank" title="💬 说说">💬 说说</a></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By TeaTang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.7/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script></div><script data-pjax src="/self/btf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="ture"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,200,200" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js" defer="defer"></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      true
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.3"></script></div></div></body></html>