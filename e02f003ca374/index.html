<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Golang Ent 框架详解 | 1024 维度</title><meta name="author" content="TeaTang"><meta name="copyright" content="TeaTang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Ent 是一个用于 Golang 的实体框架 (Entity Framework)，它提供了一个强大的 ORM (Object-Relational Mapping) 解决方案。与许多基于反射或运行时代码生成的 ORM 不同，Ent 采用代码生成 (Code Generation) 的方式，通过定义 Go 结构体来描述数据库 Schema，然后自动生成类型安全、可维护的 Go 代码，用于与数据库">
<meta property="og:type" content="article">
<meta property="og:title" content="Golang Ent 框架详解">
<meta property="og:url" content="https://blog.tbf1211.xx.kg/e02f003ca374/index.html">
<meta property="og:site_name" content="1024 维度">
<meta property="og:description" content="Ent 是一个用于 Golang 的实体框架 (Entity Framework)，它提供了一个强大的 ORM (Object-Relational Mapping) 解决方案。与许多基于反射或运行时代码生成的 ORM 不同，Ent 采用代码生成 (Code Generation) 的方式，通过定义 Go 结构体来描述数据库 Schema，然后自动生成类型安全、可维护的 Go 代码，用于与数据库">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-02.jpg">
<meta property="article:published_time" content="2025-02-01T22:24:00.000Z">
<meta property="article:modified_time" content="2026-01-27T10:04:33.695Z">
<meta property="article:author" content="TeaTang">
<meta property="article:tag" content="Golang">
<meta property="article:tag" content="ORM">
<meta property="article:tag" content="2025">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-02.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Golang Ent 框架详解",
  "url": "https://blog.tbf1211.xx.kg/e02f003ca374/",
  "image": "https://blog.tbf1211.xx.kg/img/cover/default_cover-02.jpg",
  "datePublished": "2025-02-01T22:24:00.000Z",
  "dateModified": "2026-01-27T10:04:33.695Z",
  "author": [
    {
      "@type": "Person",
      "name": "TeaTang",
      "url": "https://blog.tbf1211.xx.kg"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon-1.ico"><link rel="canonical" href="https://blog.tbf1211.xx.kg/e02f003ca374/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.9/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":true,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: TeaTang","link":"链接: ","source":"来源: 1024 维度","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Golang Ent 框架详解',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="1024 维度" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">522</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">229</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/cover/default_cover-02.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">1024 维度</span></a><a class="nav-page-title" href="/"><span class="site-name">Golang Ent 框架详解</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Golang Ent 框架详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2025-02-01T22:24:00.000Z" title="发表于 2025-02-02 06:24:00">2025-02-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Golang/">Golang</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Golang/%E5%BA%93/">库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">5.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>21分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><strong>Ent</strong> 是一个用于 Golang 的<strong>实体框架 (Entity Framework)</strong>，它提供了一个强大的 ORM (Object-Relational Mapping) 解决方案。与许多基于反射或运行时代码生成的 ORM 不同，Ent 采用<strong>代码生成 (Code Generation)</strong> 的方式，通过定义 Go 结构体来描述数据库 Schema，然后自动生成类型安全、可维护的 Go 代码，用于与数据库进行交互。</p>
</blockquote>
<div class="note info flat"><p><strong>核心理念</strong>：Schema-first (Schema 优先) 和 Code Generation (代码生成)。通过 Go 代码定义数据库 Schema，然后 Ent 根据这些定义生成一套完整的、类型安全的数据库操作客户端代码。</p>
</div>

<hr>
<h2 id="一、为什么选择-Ent？"><a href="#一、为什么选择-Ent？" class="headerlink" title="一、为什么选择 Ent？"></a>一、为什么选择 Ent？</h2><p>在 Golang 生态中，存在多种数据库交互方式，包括标准库 <code>database/sql</code>、各种第三方 ORM (如 GORM, XORM) 等。Ent 在此背景下脱颖而出，主要有以下几个优势：</p>
<ol>
<li><strong>类型安全 (Type-Safety)</strong>：Ent 生成的代码在编译时就能捕获许多潜在的数据库错误，而不是在运行时。这意味着开发者在编写查询或更新逻辑时，可以获得 IDE 的强大补全和类型检查支持，显著减少运行时错误。</li>
<li><strong>Schema-First 方法</strong>：数据库 Schema 是通过 Go 代码清晰定义的，而不是通过 SQL 或结构体标签。这种方式使得 Schema 成为代码库的一部分，易于版本控制和审查。</li>
<li><strong>代码生成 (Code Generation)</strong>：Ent 不依赖反射。所有数据库交互逻辑都在编译前生成，这使得运行时性能更高，同时避免了反射带来的复杂性和潜在的运行时错误。</li>
<li><strong>强大的查询 API</strong>：Ent 提供了富有表现力的链式 API 来构建复杂查询，支持强大的过滤、排序、分页和预加载关联数据等功能。</li>
<li><strong>关系管理 (Relationship Management)</strong>：轻松定义和管理实体之间的关系（一对一、一对多、多对多），并提供方便的 API 进行遍历和操作。</li>
<li><strong>可扩展性 (Extensibility)</strong>：支持 Hooks (钩子)、Interceptors (拦截器)、Mixins (混入) 等高级功能，允许开发者在数据库操作的不同阶段插入自定义逻辑。</li>
<li><strong>数据库迁移 (Migration)</strong>：内置对数据库 Schema 迁移的支持，可以生成 SQL 迁移脚本或直接执行自动迁移。</li>
</ol>
<p><strong>与传统 ORM 的对比</strong>：</p>
<table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">传统 ORM (如 GORM)</th>
<th align="left">Ent (实体框架)</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Schema 定义</td>
<td align="left">Go 结构体标签</td>
<td align="left">Go 代码 (独立的 <code>schema</code> 包)</td>
</tr>
<tr>
<td align="left">数据库交互</td>
<td align="left">运行时反射 &#x2F; 拼接 SQL</td>
<td align="left">编译时生成代码</td>
</tr>
<tr>
<td align="left">类型安全</td>
<td align="left">运行时错误较多</td>
<td align="left">编译时捕获错误，高度类型安全</td>
</tr>
<tr>
<td align="left">性能</td>
<td align="left">略有运行时开销</td>
<td align="left">接近手写 SQL 性能</td>
</tr>
<tr>
<td align="left">代码量</td>
<td align="left">相对简洁 (但缺乏类型检查)</td>
<td align="left">初始生成代码量大，后续维护方便</td>
</tr>
<tr>
<td align="left">学习曲线</td>
<td align="left">相对平缓</td>
<td align="left">初始学习曲线稍陡峭</td>
</tr>
</tbody></table>
<h2 id="二、Ent-的核心概念"><a href="#二、Ent-的核心概念" class="headerlink" title="二、Ent 的核心概念"></a>二、Ent 的核心概念</h2><p>Ent 的设计围绕以下几个核心概念：</p>
<h3 id="2-1-Schema-数据模式"><a href="#2-1-Schema-数据模式" class="headerlink" title="2.1 Schema (数据模式)"></a>2.1 Schema (数据模式)</h3><p>Schema 是 Ent 的核心。你需要在 <code>ent/schema</code> 目录下定义 Go 结构体，每个结构体对应数据库中的一张表。这些结构体定义了表的字段 (Fields) 和实体之间的关系 (Edges)。</p>
<ul>
<li><strong>Field (字段)</strong>：定义了表中列的属性，如类型、唯一性、可空性、默认值、索引等。</li>
<li><strong>Edge (边&#x2F;关系)</strong>：定义了实体之间的关系，如一对一 (<code>OneToOne</code>)、一对多 (<code>OneToMany</code>)、多对多 (<code>ManyToMany</code>)。Ent 会根据这些关系自动生成相应的外键和关联表。</li>
</ul>
<p><strong>示例：</strong><br><code>ent/schema/user.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> schema</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;entgo.io/ent&quot;</span></span><br><span class="line">	<span class="string">&quot;entgo.io/ent/schema/edge&quot;</span></span><br><span class="line">	<span class="string">&quot;entgo.io/ent/schema/field&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// User holds the schema definition for the User entity.</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	ent.Schema</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fields of the User.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(User)</span></span> Fields() []ent.Field &#123;</span><br><span class="line">	<span class="keyword">return</span> []ent.Field&#123;</span><br><span class="line">		field.String(<span class="string">&quot;name&quot;</span>).</span><br><span class="line">			MaxLen(<span class="number">255</span>).</span><br><span class="line">			NotEmpty(),</span><br><span class="line">		field.String(<span class="string">&quot;email&quot;</span>).</span><br><span class="line">			Unique().</span><br><span class="line">			MaxLen(<span class="number">255</span>).</span><br><span class="line">			NotEmpty(),</span><br><span class="line">		field.Int(<span class="string">&quot;age&quot;</span>).</span><br><span class="line">			Positive(), <span class="comment">// Must be a positive integer</span></span><br><span class="line">		field.Time(<span class="string">&quot;created_at&quot;</span>).</span><br><span class="line">			Default(time.Now). <span class="comment">// Default to current time</span></span><br><span class="line">			Immutable(),       <span class="comment">// Cannot be updated after creation</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Edges of the User.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(User)</span></span> Edges() []ent.Edge &#123;</span><br><span class="line">	<span class="keyword">return</span> []ent.Edge&#123;</span><br><span class="line">		edge.To(<span class="string">&quot;pets&quot;</span>, Pet.Type), <span class="comment">// User has many Pets</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ent/schema/pet.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> schema</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;entgo.io/ent&quot;</span></span><br><span class="line">	<span class="string">&quot;entgo.io/ent/schema/edge&quot;</span></span><br><span class="line">	<span class="string">&quot;entgo.io/ent/schema/field&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pet holds the schema definition for the Pet entity.</span></span><br><span class="line"><span class="keyword">type</span> Pet <span class="keyword">struct</span> &#123;</span><br><span class="line">	ent.Schema</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fields of the Pet.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Pet)</span></span> Fields() []ent.Field &#123;</span><br><span class="line">	<span class="keyword">return</span> []ent.Field&#123;</span><br><span class="line">		field.String(<span class="string">&quot;name&quot;</span>).</span><br><span class="line">			MaxLen(<span class="number">255</span>).</span><br><span class="line">			NotEmpty(),</span><br><span class="line">		field.Enum(<span class="string">&quot;type&quot;</span>). <span class="comment">// Enum field with predefined values</span></span><br><span class="line">			Values(<span class="string">&quot;dog&quot;</span>, <span class="string">&quot;cat&quot;</span>, <span class="string">&quot;bird&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Edges of the Pet.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Pet)</span></span> Edges() []ent.Edge &#123;</span><br><span class="line">	<span class="keyword">return</span> []ent.Edge&#123;</span><br><span class="line">		edge.From(<span class="string">&quot;owner&quot;</span>, User.Type). <span class="comment">// Pet belongs to one User</span></span><br><span class="line">			Ref(<span class="string">&quot;pets&quot;</span>).             <span class="comment">// Refers to the &quot;pets&quot; edge in User schema</span></span><br><span class="line">			Unique(),                <span class="comment">// Each pet has a unique owner</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Code-Generation-代码生成"><a href="#2-2-Code-Generation-代码生成" class="headerlink" title="2.2 Code Generation (代码生成)"></a>2.2 Code Generation (代码生成)</h3><p>在你定义好 Schema 后，Ent 会根据这些定义自动生成 Go 代码。这些代码包括：</p>
<ul>
<li><strong>Ent Client</strong>: 用于与数据库交互的核心 API。</li>
<li><strong>Entity Structures</strong>: 对应数据库表的 Go 结构体，用于表示单个实体数据。</li>
<li><strong>Mutation Builders</strong>: 用于创建、更新和删除实体的 API。</li>
<li><strong>Query Builders</strong>: 用于构建复杂查询的 API。</li>
<li><strong>各种辅助函数和类型</strong>: 如 predicates (查询条件)、hooks (钩子) 等。</li>
</ul>
<p><strong>工作流程图：</strong></p>
<div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    graph TD
    A[Go Schema Definitions] --&gt; B{ent generate command};
    B --&gt; C[Generated Ent Client API];
    B --&gt; D[Generated Entity Structures];
    B --&gt; E[Generated Mutation Builders];
    B --&gt; F[Generated Query Builders];
    B --&gt; G[Generated Predicates &lt;br&gt;&amp; Helpers];
    C --&gt; H[&quot;Application Code &lt;br&gt;(Uses Ent Client)&quot;];
    D --&gt; H;
    E --&gt; H;
    F --&gt; H;
    G --&gt; H;
  </pre></div>

<h3 id="2-3-Ent-Client-客户端"><a href="#2-3-Ent-Client-客户端" class="headerlink" title="2.3 Ent Client (客户端)"></a>2.3 Ent Client (客户端)</h3><p>生成的 <code>ent.Client</code> 是你与数据库交互的入口点。它包含了所有实体类型的 Builder (构造器)，通过这些 Builder 可以执行 CRUD (创建、读取、更新、删除) 操作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go (连接数据库并创建客户端)</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;entdemo/ent&quot;</span> <span class="comment">// 替换为你的项目路径</span></span><br><span class="line"></span><br><span class="line">	_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span> <span class="comment">// 引入 MySQL 驱动</span></span><br><span class="line">	<span class="comment">// _ &quot;github.com/lib/pq&quot; // 或 PostgreSQL 驱动</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(databaseURL <span class="type">string</span>)</span></span> *ent.Client &#123;</span><br><span class="line">	client, err := ent.Open(<span class="string">&quot;mysql&quot;</span>, databaseURL) <span class="comment">// &quot;mysql&quot; 或 &quot;postgres&quot;</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed opening connection to database: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Run the auto migration tool.</span></span><br><span class="line">	<span class="comment">// client.Schema.Create(context.Background()) 可以用于快速开发环境的自动迁移</span></span><br><span class="line">	<span class="keyword">return</span> client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	databaseURL := <span class="string">&quot;root:pass@tcp(localhost:3306)/ent_demo?parseTime=true&quot;</span></span><br><span class="line">	<span class="comment">// databaseURL := &quot;postgresql://user:pass@localhost:5432/ent_demo?sslmode=disable&quot;</span></span><br><span class="line">	client := Open(databaseURL)</span><br><span class="line">	<span class="keyword">defer</span> client.Close()</span><br><span class="line"></span><br><span class="line">	ctx := context.Background()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 数据库 Schema 迁移 ---</span></span><br><span class="line">	<span class="comment">// 推荐在生产环境使用版本化的迁移，但在开发环境可以使用自动迁移</span></span><br><span class="line">	<span class="keyword">if</span> err := client.Schema.Create(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed creating schema resources: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 接下来可以进行 CRUD 操作</span></span><br><span class="line">	log.Println(<span class="string">&quot;Database client and schema created successfully.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-Hooks-钩子-和-Interceptors-拦截器"><a href="#2-4-Hooks-钩子-和-Interceptors-拦截器" class="headerlink" title="2.4 Hooks (钩子) 和 Interceptors (拦截器)"></a>2.4 Hooks (钩子) 和 Interceptors (拦截器)</h3><ul>
<li><strong>Hooks (钩子)</strong>：允许你在特定实体的生命周期事件 (如创建、更新、删除) 之前或之后执行自定义逻辑。例如，在创建用户前哈希密码。Hook 定义在 Schema 中。</li>
<li><strong>Interceptors (拦截器)</strong>：更强大的机制，可以在所有查询或修改操作上添加逻辑。它工作在 <code>ent.Client</code> 级别，可以用于实现审计日志、软删除、权限检查等。</li>
</ul>
<h3 id="2-5-Mixins-混入"><a href="#2-5-Mixins-混入" class="headerlink" title="2.5 Mixins (混入)"></a>2.5 Mixins (混入)</h3><p>Mixins 允许你定义可重用的字段和边，并将其“混入”到多个 Schema 中。这对于管理公共字段 (如 <code>created_at</code>, <code>updated_at</code>) 或实现软删除等功能非常有用，避免了重复代码。</p>
<h2 id="三、Ent-的使用流程-以-User-和-Pet-实体为例"><a href="#三、Ent-的使用流程-以-User-和-Pet-实体为例" class="headerlink" title="三、Ent 的使用流程 (以 User 和 Pet 实体为例)"></a>三、Ent 的使用流程 (以 User 和 Pet 实体为例)</h2><h3 id="3-1-准备工作"><a href="#3-1-准备工作" class="headerlink" title="3.1 准备工作"></a>3.1 准备工作</h3><ol>
<li><p><strong>初始化 Go 项目</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ent-demo &amp;&amp; <span class="built_in">cd</span> ent-demo</span><br><span class="line">go mod init ent-demo</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>安装 Ent CLI 工具和数据库驱动</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go install entgo.io/ent/cmd/ent@latest</span><br><span class="line">go get entgo.io/ent@latest</span><br><span class="line">go get github.com/go-sql-driver/mysql <span class="comment"># 或者 github.com/lib/pq for PostgreSQL</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>初始化 Ent 项目结构</strong><br>这将创建 <code>ent/</code> 目录和 <code>ent/generate.go</code> 文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run entgo.io/ent/cmd/ent init User Pet</span><br></pre></td></tr></table></figure>
<p><code>ent/generate.go</code> 的内容：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:build ignore</span></span><br><span class="line"><span class="comment">// +build ignore</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;entgo.io/ent/entc&quot;</span></span><br><span class="line">	<span class="string">&quot;entgo.io/ent/entc/gen&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := entc.Generate(<span class="string">&quot;./schema&quot;</span>, &amp;gen.Config&#123;</span><br><span class="line">		Target:  <span class="string">&quot;./&quot;</span>,</span><br><span class="line">		<span class="comment">// ... 其他配置</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;running ent codegen: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请注意 <code>//go:build ignore</code> 这行，表示此文件不应直接编译。你需要通过 <code>go generate ./ent</code> 来运行它。</p>
</li>
</ol>
<h3 id="3-2-定义-Schema"><a href="#3-2-定义-Schema" class="headerlink" title="3.2 定义 Schema"></a>3.2 定义 Schema</h3><p>如前面 <code>ent/schema/user.go</code> 和 <code>ent/schema/pet.go</code> 所示，定义 User 和 Pet 的字段和关系。</p>
<h3 id="3-3-生成代码"><a href="#3-3-生成代码" class="headerlink" title="3.3 生成代码"></a>3.3 生成代码</h3><p>运行以下命令，Ent 会根据 Schema 定义生成所有客户端代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go generate ./ent</span><br></pre></td></tr></table></figure>
<p>这将会在 <code>ent/</code> 目录下生成大量文件，如 <code>ent/client.go</code>, <code>ent/user.go</code>, <code>ent/pet.go</code>, <code>ent/migrate/migrate.go</code> 等。</p>
<h3 id="3-4-连接数据库与-Schema-迁移"><a href="#3-4-连接数据库与-Schema-迁移" class="headerlink" title="3.4 连接数据库与 Schema 迁移"></a>3.4 连接数据库与 Schema 迁移</h3><p>在 <code>main.go</code> 中编写连接数据库的代码，并进行 Schema 迁移。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go (完整示例)</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;ent-demo/ent&quot;</span> <span class="comment">// 替换为你的项目路径</span></span><br><span class="line">	<span class="string">&quot;ent-demo/ent/pet&quot;</span></span><br><span class="line">	<span class="string">&quot;ent-demo/ent/user&quot;</span></span><br><span class="line"></span><br><span class="line">	_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span> <span class="comment">// 引入 MySQL 驱动</span></span><br><span class="line">	<span class="comment">// _ &quot;github.com/lib/pq&quot; // 或 PostgreSQL 驱动</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(databaseURL <span class="type">string</span>)</span></span> *ent.Client &#123;</span><br><span class="line">	client, err := ent.Open(<span class="string">&quot;mysql&quot;</span>, databaseURL) <span class="comment">// &quot;mysql&quot; 或 &quot;postgres&quot;</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed opening connection to database: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	databaseURL := <span class="string">&quot;root:pass@tcp(localhost:3306)/ent_demo?parseTime=true&quot;</span></span><br><span class="line">	client := Open(databaseURL)</span><br><span class="line">	<span class="keyword">defer</span> client.Close()</span><br><span class="line"></span><br><span class="line">	ctx := context.Background()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 自动创建数据库 Schema (仅限开发环境使用，生产环境推荐版本化迁移)</span></span><br><span class="line">	<span class="keyword">if</span> err := client.Schema.Create(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed creating schema resources: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Println(<span class="string">&quot;Database client and schema created successfully.&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 执行 CRUD 操作 ---</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. 创建 (Create)</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- Create Operations ---&quot;</span>)</span><br><span class="line">	u, err := client.User.</span><br><span class="line">		Create().</span><br><span class="line">		SetName(<span class="string">&quot;Alice&quot;</span>).</span><br><span class="line">		SetEmail(<span class="string">&quot;alice@example.com&quot;</span>).</span><br><span class="line">		SetAge(<span class="number">30</span>).</span><br><span class="line">		Save(ctx) <span class="comment">// Save() 执行实际的创建操作</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed creating user: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Created user: %v\n&quot;</span>, u)</span><br><span class="line"></span><br><span class="line">	p1, err := client.Pet.</span><br><span class="line">		Create().</span><br><span class="line">		SetName(<span class="string">&quot;Buddy&quot;</span>).</span><br><span class="line">		SetType(pet.TypeDog).</span><br><span class="line">		SetOwner(u). <span class="comment">// 设置关联的 Owner</span></span><br><span class="line">		Save(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed creating pet 1: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Created pet 1: %v\n&quot;</span>, p1)</span><br><span class="line"></span><br><span class="line">	p2, err := client.Pet.</span><br><span class="line">		Create().</span><br><span class="line">		SetName(<span class="string">&quot;Whiskers&quot;</span>).</span><br><span class="line">		SetType(pet.TypeCat).</span><br><span class="line">		SetOwner(u).</span><br><span class="line">		Save(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed creating pet 2: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Created pet 2: %v\n&quot;</span>, p2)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 查询 (Read)</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- Read Operations ---&quot;</span>)</span><br><span class="line">	<span class="comment">// 查询所有用户</span></span><br><span class="line">	users, err := client.User.</span><br><span class="line">		Query().</span><br><span class="line">		All(ctx) <span class="comment">// All() 返回所有匹配的实体</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed querying users: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;All users:&quot;</span>)</span><br><span class="line">	<span class="keyword">for</span> _, u := <span class="keyword">range</span> users &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;- %v\n&quot;</span>, u)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据 ID 查询用户</span></span><br><span class="line">	userByID, err := client.User.</span><br><span class="line">		Query().</span><br><span class="line">		Where(user.ID(u.ID)). <span class="comment">// 使用 Where 子句指定条件</span></span><br><span class="line">		Only(ctx)             <span class="comment">// Only() 期望只返回一个结果，否则报错</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed querying user by ID: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;User by ID %d: %v\n&quot;</span>, u.ID, userByID)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据 Email 查询用户</span></span><br><span class="line">	userByEmail, err := client.User.</span><br><span class="line">		Query().</span><br><span class="line">		Where(user.Email(<span class="string">&quot;alice@example.com&quot;</span>)).</span><br><span class="line">		Only(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed querying user by email: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;User by email: %v\n&quot;</span>, userByEmail)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查询用户的宠物 (Eager Loading)</span></span><br><span class="line">	userWithPets, err := client.User.</span><br><span class="line">		Query().</span><br><span class="line">		Where(user.ID(u.ID)).</span><br><span class="line">		WithPets(). <span class="comment">// 预加载关联的 Pets</span></span><br><span class="line">		Only(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed querying user with pets: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;User %s has pets: %v\n&quot;</span>, userWithPets.Name, userWithPets.Edges.Pets)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. 更新 (Update)</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- Update Operations ---&quot;</span>)</span><br><span class="line">	updatedUser, err := client.User.</span><br><span class="line">		UpdateOne(u). <span class="comment">// UpdateOne() 更新单个实体</span></span><br><span class="line">		SetAge(<span class="number">31</span>).</span><br><span class="line">		SetNillableEmail(<span class="string">&quot;alice.smith@example.com&quot;</span>). <span class="comment">// 设置为可空字段</span></span><br><span class="line">		Save(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed updating user: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Updated user: %v\n&quot;</span>, updatedUser)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 更新多个用户 (如果需要)</span></span><br><span class="line">	_, err = client.User.</span><br><span class="line">		Update().</span><br><span class="line">		Where(user.AgeGT(<span class="number">25</span>)). <span class="comment">// 将所有年龄大于25的用户的年龄增加1</span></span><br><span class="line">		AddAge(<span class="number">1</span>).</span><br><span class="line">		Save(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed updating multiple users: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;Updated multiple users (age incremented by 1).&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4. 删除 (Delete)</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- Delete Operations ---&quot;</span>)</span><br><span class="line">	err = client.User.</span><br><span class="line">		DeleteOne(u). <span class="comment">// DeleteOne() 删除单个实体</span></span><br><span class="line">		Exec(ctx)     <span class="comment">// Exec() 执行删除操作，不返回实体</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed deleting user: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Deleted user ID: %d\n&quot;</span>, u.ID)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 尝试查询被删除的用户</span></span><br><span class="line">	_, err = client.User.</span><br><span class="line">		Query().</span><br><span class="line">		Where(user.ID(u.ID)).</span><br><span class="line">		Only(ctx)</span><br><span class="line">	<span class="keyword">if</span> ent.IsNotFound(err) &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;User ID %d not found (successfully deleted).\n&quot;</span>, u.ID)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed querying deleted user: %v&quot;</span>, err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;User ID %d found (deletion failed).\n&quot;</span>, u.ID)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 演示事务</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;\n--- Transaction Example ---&quot;</span>)</span><br><span class="line">	tx, err := client.Tx(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;starting transaction: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">			tx.Rollback()</span><br><span class="line">			log.Fatalf(<span class="string">&quot;transaction panicked: %v&quot;</span>, r)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	bob, err := tx.User.</span><br><span class="line">		Create().</span><br><span class="line">		SetName(<span class="string">&quot;Bob&quot;</span>).</span><br><span class="line">		SetEmail(fmt.Sprintf(<span class="string">&quot;bob_%d@example.com&quot;</span>, time.Now().UnixNano())).</span><br><span class="line">		SetAge(<span class="number">25</span>).</span><br><span class="line">		Save(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed creating Bob in transaction: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Created Bob in transaction: %v\n&quot;</span>, bob)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 故意制造一个错误来演示回滚</span></span><br><span class="line">	<span class="comment">// _, err = tx.User.Create().SetEmail(&quot;invalid&quot;).Save(ctx) // 假设这里会因为校验失败而报错</span></span><br><span class="line">	<span class="comment">// if err != nil &#123;</span></span><br><span class="line">	<span class="comment">// 	tx.Rollback()</span></span><br><span class="line">	<span class="comment">// 	log.Printf(&quot;rolling back transaction due to error: %v\n&quot;, err)</span></span><br><span class="line">	<span class="comment">// &#125; else &#123;</span></span><br><span class="line">	<span class="comment">// 	tx.Commit()</span></span><br><span class="line">	<span class="comment">// 	log.Println(&quot;Transaction committed successfully.&quot;)</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">	tx.Commit()</span><br><span class="line">	log.Println(<span class="string">&quot;Transaction committed successfully.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-运行示例"><a href="#3-5-运行示例" class="headerlink" title="3.5 运行示例"></a>3.5 运行示例</h3><ol>
<li>确保 MySQL 或 PostgreSQL 数据库已运行，并创建了名为 <code>ent_demo</code> 的数据库。</li>
<li>更新 <code>databaseURL</code> 为你的数据库连接字符串。</li>
<li>运行 <code>main.go</code>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="四、高级功能"><a href="#四、高级功能" class="headerlink" title="四、高级功能"></a>四、高级功能</h2><h3 id="4-1-数据库迁移-Migrations"><a href="#4-1-数据库迁移-Migrations" class="headerlink" title="4.1 数据库迁移 (Migrations)"></a>4.1 数据库迁移 (Migrations)</h3><p>Ent 提供了强大的数据库 Schema 迁移工具。</p>
<ol>
<li><p><strong>自动迁移 (Auto Migration)</strong>：<br><code>client.Schema.Create(ctx)</code> 适用于开发环境快速迭代。它会根据当前 Schema 自动创建或更新表结构。不推荐在生产环境使用，因为它可能导致数据丢失，尤其是在删除字段时。</p>
</li>
<li><p><strong>版本化迁移 (Versioned Migrations)</strong>：<br>Ent 可以生成 SQL 迁移脚本，让你像 <code>flyway</code> 或 <code>golang-migrate</code> 一样进行版本控制和安全部署。</p>
<ul>
<li><p>生成新的迁移文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run entgo.io/ent/cmd/ent migrate diff --to ent/schema --<span class="built_in">dir</span> ent/migrate &lt;migration_name&gt;</span><br></pre></td></tr></table></figure>
<p>例如：<code>go run entgo.io/ent/cmd/ent migrate diff --to ent/schema --dir ent/migrate add_email_field</code><br>这会在 <code>ent/migrate</code> 目录下生成一个带时间戳的 SQL 文件 (e.g., <code>20231221100000_add_email_field.sql</code>)。</p>
</li>
<li><p>应用迁移：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ent/migrate/main.go (通常你会有一个独立的迁移工具)</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;ent-demo/ent/migrate&quot;</span> <span class="comment">// 替换为你的项目路径</span></span><br><span class="line"></span><br><span class="line">	_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span> <span class="comment">// 或其他数据库驱动</span></span><br><span class="line">	<span class="string">&quot;entgo.io/ent/dialect&quot;</span></span><br><span class="line">	<span class="string">&quot;entgo.io/ent/dialect/sql/schema&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// databaseURL := &quot;root:pass@tcp(localhost:3306)/ent_demo?parseTime=true&quot;</span></span><br><span class="line">	<span class="comment">// drv, err := sql.Open(&quot;mysql&quot;, databaseURL)</span></span><br><span class="line">	<span class="comment">// if err != nil &#123;</span></span><br><span class="line">	<span class="comment">// 	log.Fatalf(&quot;failed opening connection to database: %v&quot;, err)</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">	<span class="comment">// defer drv.Close()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Options: with driver &amp; database name</span></span><br><span class="line">	<span class="comment">// ctx := context.Background()</span></span><br><span class="line">	<span class="comment">// if err := migrate.NamedDiff(ctx, drv, dialect.MySQL, &quot;ent_demo&quot;, migrate.With</span></span><br><span class="line">	<span class="comment">// if err := migrate.Schema(drv, dialect.MySQL, &quot;ent_demo&quot;).Create(context.Background()); err != nil &#123;</span></span><br><span class="line">	<span class="comment">// 	log.Fatalf(&quot;failed creating schema resources: %v&quot;, err)</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// 上面是老的写法，现在推荐使用 ent.Schema.Create</span></span><br><span class="line">    <span class="comment">// 具体应用迁移可以使用 ent/migrate.go 中的 Migrate 函数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 示例：使用 ent.Schema.Create(ctx, migrate.With</span></span><br><span class="line">    <span class="comment">// 具体生产环境的迁移工具通常会直接执行生成的SQL文件</span></span><br><span class="line">    <span class="comment">// 或者通过 Ent 提供的 migrate 包来管理</span></span><br><span class="line">    <span class="comment">// client := Open(&quot;root:pass@tcp(localhost:3306)/ent_demo?parseTime=true&quot;) // 需要一个 Ent client</span></span><br><span class="line">    <span class="comment">// if err := client.Schema.Create(context.Background(),</span></span><br><span class="line">    <span class="comment">//     migrate.WithDropColumn(true),</span></span><br><span class="line">    <span class="comment">//     migrate.WithDropIndex(true),</span></span><br><span class="line">    <span class="comment">// ); err != nil &#123;</span></span><br><span class="line">    <span class="comment">//     log.Fatalf(&quot;failed creating schema resources: %v&quot;, err)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 推荐手动运行生成的 SQL 文件或者使用专门的迁移工具来执行</span></span><br><span class="line">    log.Println(<span class="string">&quot;For production, manually apply SQL files generated by `ent migrate diff`.&quot;</span>)</span><br><span class="line">    log.Println(<span class="string">&quot;For development, `client.Schema.Create(ctx)` is often sufficient.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实际应用场景中，通常会有一个单独的 Go 程序来执行这些迁移文件</span></span><br><span class="line">    <span class="comment">// 比如使用 migrate.Go() 或者将生成的 SQL 文件通过其他工具执行</span></span><br><span class="line">    <span class="comment">// 这里的 `ent/migrate/migrate.go` 提供了 `Migrate` 函数来执行 `Schema.Create`</span></span><br><span class="line">    <span class="comment">// 并可以传入各种选项，如 `migrate.WithDropIndex(true)` 等。</span></span><br><span class="line">    <span class="comment">// 完整生产级迁移需要更复杂的设置，这里只做概念性说明。</span></span><br><span class="line">    <span class="comment">// 详情请参考 Ent 官方文档的迁移部分。</span></span><br><span class="line">    log.Println(<span class="string">&quot;Migration example omitted for brevity, please refer to Ent official documentation for production-ready migrations.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h3 id="4-2-事务-Transactions"><a href="#4-2-事务-Transactions" class="headerlink" title="4.2 事务 (Transactions)"></a>4.2 事务 (Transactions)</h3><p>Ent 提供了 <code>Tx()</code> 方法来开始一个数据库事务，确保一系列操作的原子性。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... in main.go</span></span><br><span class="line">tx, err := client.Tx(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;starting transaction: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 延迟函数确保事务最终会被提交或回滚</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123; <span class="comment">// 发生 panic 时回滚</span></span><br><span class="line">        tx.Rollback()</span><br><span class="line">        log.Fatalf(<span class="string">&quot;transaction panicked: %v&quot;</span>, r)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在事务中执行数据库操作</span></span><br><span class="line">bob, err := tx.User.</span><br><span class="line">    Create().</span><br><span class="line">    SetName(<span class="string">&quot;Bob&quot;</span>).</span><br><span class="line">    SetEmail(fmt.Sprintf(<span class="string">&quot;bob_%d@example.com&quot;</span>, time.Now().UnixNano())).</span><br><span class="line">    SetAge(<span class="number">25</span>).</span><br><span class="line">    Save(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    tx.Rollback() <span class="comment">// 发生错误时回滚</span></span><br><span class="line">    log.Fatalf(<span class="string">&quot;failed creating Bob in transaction: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Created Bob in transaction: %v\n&quot;</span>, bob)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设这里还有其他操作</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err = tx.Commit(); err != <span class="literal">nil</span> &#123; <span class="comment">// 所有操作成功后提交事务</span></span><br><span class="line">    tx.Rollback() <span class="comment">// 提交失败时回滚</span></span><br><span class="line">    log.Fatalf(<span class="string">&quot;committing transaction: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">log.Println(<span class="string">&quot;Transaction committed successfully.&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="4-3-复杂查询-Predicates-Aggregations-Pagination"><a href="#4-3-复杂查询-Predicates-Aggregations-Pagination" class="headerlink" title="4.3 复杂查询 (Predicates, Aggregations, Pagination)"></a>4.3 复杂查询 (Predicates, Aggregations, Pagination)</h3><p>Ent 的查询 API 非常强大。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Predicates: 复杂条件查询</span></span><br><span class="line">users, err = client.User.</span><br><span class="line">    Query().</span><br><span class="line">    Where(</span><br><span class="line">        user.And( <span class="comment">// 组合条件 (AND)</span></span><br><span class="line">            user.AgeGT(<span class="number">20</span>), <span class="comment">// 大于 20</span></span><br><span class="line">            user.Or(        <span class="comment">// 组合条件 (OR)</span></span><br><span class="line">                user.NameHasPrefix(<span class="string">&quot;A&quot;</span>),</span><br><span class="line">                user.EmailHasSuffix(<span class="string">&quot;.com&quot;</span>),</span><br><span class="line">            ),</span><br><span class="line">        ),</span><br><span class="line">    ).</span><br><span class="line">    Order(ent.Desc(user.FieldAge)). <span class="comment">// 排序</span></span><br><span class="line">    Limit(<span class="number">10</span>).                      <span class="comment">// 限制数量</span></span><br><span class="line">    Offset(<span class="number">0</span>).                      <span class="comment">// 偏移量 (分页)</span></span><br><span class="line">    All(ctx)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聚合查询</span></span><br><span class="line">count, err := client.User.</span><br><span class="line">    Query().</span><br><span class="line">    Aggregate(ent.Count()). <span class="comment">// 计数</span></span><br><span class="line">    Int(ctx)</span><br><span class="line">avgAge, err := client.User.</span><br><span class="line">    Query().</span><br><span class="line">    Aggregate(ent.Avg(user.FieldAge)). <span class="comment">// 平均值</span></span><br><span class="line">    Float64(ctx)</span><br></pre></td></tr></table></figure>

<h2 id="五、优缺点与适用场景"><a href="#五、优缺点与适用场景" class="headerlink" title="五、优缺点与适用场景"></a>五、优缺点与适用场景</h2><h3 id="5-1-优点："><a href="#5-1-优点：" class="headerlink" title="5.1 优点："></a>5.1 优点：</h3><ol>
<li><strong>极高的类型安全性</strong>：编译时检查，减少运行时错误。</li>
<li><strong>卓越的性能</strong>：生成的代码接近手写 SQL 性能，无运行时反射开销。</li>
<li><strong>可维护性强</strong>：生成的代码可读性好，易于理解和调试。</li>
<li><strong>强大的关系管理</strong>：直观定义实体关系，并提供丰富的 API 进行操作。</li>
<li><strong>Schema-First</strong>：数据库 Schema 即代码，易于版本控制和团队协作。</li>
<li><strong>可扩展性高</strong>：Hooks, Interceptors, Mixins 等机制提供了强大的定制能力。</li>
<li><strong>良好的社区支持和文档</strong>。</li>
</ol>
<h3 id="5-2-缺点："><a href="#5-2-缺点：" class="headerlink" title="5.2 缺点："></a>5.2 缺点：</h3><ol>
<li><strong>学习曲线</strong>：对于习惯了传统 ORM 的开发者，Ent 的 Schema-First 和代码生成范式需要一定时间适应。</li>
<li><strong>生成代码量大</strong>：虽然带来了类型安全和性能，但生成的代码目录会比较庞大。</li>
<li><strong>调试有时复杂</strong>：由于生成的代码层级较深，在某些复杂问题排查时可能需要深入理解生成代码。</li>
<li><strong>不适用于动态 Schema 场景</strong>：Schema 必须在编译前定义，不适合运行时动态修改数据库结构。</li>
</ol>
<h3 id="5-3-适用场景："><a href="#5-3-适用场景：" class="headerlink" title="5.3 适用场景："></a>5.3 适用场景：</h3><ul>
<li><strong>长期项目和大型项目</strong>：项目的可维护性和代码质量是关键因素时，Ent 的优势尤为突出。</li>
<li><strong>对性能和类型安全有高要求</strong>：例如后端 API 服务、数据处理服务。</li>
<li><strong>团队偏好 Go 语言风格</strong>：Ent 强制使用 Go 结构体定义 Schema，与 Go 语言风格高度契合。</li>
<li><strong>微服务架构</strong>：在微服务中，每个服务可以拥有自己的数据库和 Ent 客户端，实现高内聚低耦合。</li>
</ul>
<h2 id="六、安全性考虑"><a href="#六、安全性考虑" class="headerlink" title="六、安全性考虑"></a>六、安全性考虑</h2><ol>
<li><strong>SQL 注入防护</strong>：Ent 框架在生成 SQL 时，会使用参数化查询，自动防止 SQL 注入。</li>
<li><strong>敏感数据处理</strong>：不要在 Schema 中直接存储敏感信息（如密码明文），应进行加密或哈希处理。</li>
<li><strong>错误处理</strong>：始终检查 Ent 操作返回的 <code>error</code>，并进行适当处理，避免敏感信息泄露或服务崩溃。</li>
<li><strong>数据库连接安全</strong>：保护数据库连接字符串，不要硬编码在代码中，应从环境变量、配置文件或秘密管理服务中获取。</li>
<li><strong>权限控制</strong>：Ent 本身不提供权限管理，需要在应用层结合拦截器 (Interceptors) 或业务逻辑实现细粒度的访问控制。</li>
<li><strong>Schema 变更审查</strong>：对于生产环境，应严格审查 <code>ent migrate diff</code> 生成的 SQL 迁移脚本，避免潜在的数据丢失或意外变更。</li>
</ol>
<h2 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h2><p>Golang Ent 框架通过其独特的 Schema-first 和代码生成机制，为 Go 开发者提供了一个类型安全、高性能、可维护的数据库交互解决方案。它将数据库 Schema 管理提升到代码层面，并通过强大的查询 API 和扩展机制，大大简化了数据库操作的复杂性。虽然存在一定的学习曲线和初始代码生成量，但对于追求代码质量、系统稳定性和长期可维护性的项目而言，Ent 无疑是一个值得深入探索和采用的优秀框架。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg">TeaTang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg/e02f003ca374/">https://blog.tbf1211.xx.kg/e02f003ca374/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tbf1211.xx.kg" target="_blank">1024 维度</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Golang/">Golang</a><a class="post-meta__tags" href="/tags/ORM/">ORM</a><a class="post-meta__tags" href="/tags/2025/">2025</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover-02.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/3d287a01feb5/" title="ESP-IDF 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-01.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">ESP-IDF 详解</div></div><div class="info-2"><div class="info-item-1"> ESP-IDF (Espressif IoT Development Framework) 是乐鑫科技 (Espressif Systems) 官方为其 Wi-Fi 和蓝牙 SoC（如 ESP32、ESP32-S 系列、ESP32-C 系列、ESP32-H 系列）提供的官方开发框架。它集成了 FreeRTOS 实时操作系统、lwIP TCP&#x2F;IP 协议栈以及一系列驱动程序、库和工具链，旨在帮助开发者快速、高效地构建基于 ESP 芯片的物联网 (IoT) 应用程序。  ESP-IDF 的核心价值在于：提供了一个全面且高度集成的软件开发环境，将底层硬件抽象、操作系统调度、网络通信和各种外设驱动封装起来，使得开发者可以专注于应用层逻辑的实现，大幅降低了基于 ESP 芯片进行物联网开发的门槛和复杂度。    一、为什么选择 ESP-IDF？乐鑫科技的 ESP 芯片因其内置 Wi-Fi&#x2F;蓝牙、低功耗、高性价比等特点，在物联网领域广受欢迎。ESP-IDF 作为官方提供的开发框架，相较于其他开发方式（如 Arduino IDE、MicroPython），具有以下显著优势：...</div></div></div></a><a class="pagination-related" href="/dd01f3539cef/" title="GORM (Go Object Relational Mapper) 深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-28.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">GORM (Go Object Relational Mapper) 深度解析</div></div><div class="info-2"><div class="info-item-1"> GORM 是 Go 语言中一个功能强大、对开发者友好的 ORM (Object Relational Mapper) 库。它旨在简化 Go 应用程序与数据库之间的交互，通过 Go 结构体（struct）来定义数据模型，并提供了一套丰富的 API 来执行数据库的 CRUD (Create, Read, Update, Delete) 操作、管理数据库迁移、处理关联关系、事务等。GORM 拥有广泛的数据库支持，包括 MySQL, PostgreSQL, SQLite, SQL Server 等。  核心思想：将数据库表映射为 Go 结构体，将数据库操作转换为 Go 对象的增删改查。 屏蔽了底层 SQL 的复杂性，提高了开发效率和代码可维护性。   一、为什么需要 ORM 及 GORM 的优势1.1 传统 SQL 操作的局限性在没有 ORM 的情况下，使用 Go 语言操作数据库通常涉及：  手动编写 SQL 语句：需要为每种操作（增、删、改、查）编写相应的 SQL 语句。 手动映射数据：从数据库查询结果集 (rows) 手动扫描到 Go 结构体中。 类型转换和错误处理：需要处理数据库...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/dd01f3539cef/" title="GORM (Go Object Relational Mapper) 深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-28.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-01</div><div class="info-item-2">GORM (Go Object Relational Mapper) 深度解析</div></div><div class="info-2"><div class="info-item-1"> GORM 是 Go 语言中一个功能强大、对开发者友好的 ORM (Object Relational Mapper) 库。它旨在简化 Go 应用程序与数据库之间的交互，通过 Go 结构体（struct）来定义数据模型，并提供了一套丰富的 API 来执行数据库的 CRUD (Create, Read, Update, Delete) 操作、管理数据库迁移、处理关联关系、事务等。GORM 拥有广泛的数据库支持，包括 MySQL, PostgreSQL, SQLite, SQL Server 等。  核心思想：将数据库表映射为 Go 结构体，将数据库操作转换为 Go 对象的增删改查。 屏蔽了底层 SQL 的复杂性，提高了开发效率和代码可维护性。   一、为什么需要 ORM 及 GORM 的优势1.1 传统 SQL 操作的局限性在没有 ORM 的情况下，使用 Go 语言操作数据库通常涉及：  手动编写 SQL 语句：需要为每种操作（增、删、改、查）编写相应的 SQL 语句。 手动映射数据：从数据库查询结果集 (rows) 手动扫描到 Go 结构体中。 类型转换和错误处理：需要处理数据库...</div></div></div></a><a class="pagination-related" href="/49c9c17349e3/" title="Go语言常用设计模式详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-30.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-13</div><div class="info-item-2">Go语言常用设计模式详解</div></div><div class="info-2"><div class="info-item-1"> 设计模式是对在特定情境下，反复出现的问题提供一套成熟的、可复用的解决方案。Go 语言以其简洁、并发优先的特性，在实现设计模式时通常会有其独特的“Go 惯例”，有时会与传统面向对象设计模式的实现有所不同。本篇将探讨 Go 语言中常用的设计模式，并结合 Go 的特性给出实现示例。  核心思想：Go 语言的设计模式实现通常倾向于简洁、组合而非继承、接口优先以及利用 Goroutine 和 Channel 进行并发处理。   一、Go 语言与设计模式的哲学Go 语言在设计模式的实践上，有一些与传统 OOP 语言不同的哲学：  组合优于继承：Go 没有类继承的概念，而是通过结构体嵌入（Composition）和接口（Interfaces）来实现代码复用和多态。 接口优先：Go 的接口是隐式实现的（implicit interface satisfaction），任何类型只要实现了接口定义的所有方法，就自然地实现了该接口。这使得接口更加灵活，鼓励“小接口，大组合”的原则。 并发原语：Goroutine 和 Channel 是 Go 语言的核心并发原语，许多设计模式在 Go 中会自然融入并发...</div></div></div></a><a class="pagination-related" href="/bcbe0f78ef1d/" title="Go Jaeger 深度解析：分布式追踪实践"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-30.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-05</div><div class="info-item-2">Go Jaeger 深度解析：分布式追踪实践</div></div><div class="info-2"><div class="info-item-1"> Jaeger 是一个开源的分布式追踪系统，由 Uber Technologies 开发并捐赠给 Cloud Native Computing Foundation (CNCF)。它用于监控和排除基于微服务架构的复杂分布式系统中的故障。通过收集、存储和可视化请求在各个服务之间的调用链，Jaeger 帮助开发者理解请求流、识别性能瓶颈和诊断错误。  核心思想：Jaeger 实现了 OpenTracing API（现已融合到 OpenTelemetry 中），通过在请求流经每个服务时生成和传递独特的追踪上下文 (Trace Context)，并在每个服务中记录操作信息 (Span)，将分散的日志和指标关联起来，形成完整的请求链路视图。   一、为什么需要分布式追踪？在单体应用时代，通过日志和 APM (Application Performance Monitoring) 工具可以相对容易地定位问题。然而，随着服务架构向微服务演进，一个用户请求可能涉及数十甚至上百个独立服务的协同处理。这带来了新的挑战：  请求链路复杂性：难以追踪一个请求从前端到后端，再穿越多个微服务的完整路径。 性...</div></div></div></a><a class="pagination-related" href="/b10b8bccf756/" title="Go语言指向指针的指针(Pointer to Pointer)详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-18.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-01</div><div class="info-item-2">Go语言指向指针的指针(Pointer to Pointer)详解</div></div><div class="info-2"><div class="info-item-1"> 在 Go 语言中，指针是一种重要的概念，它存储了一个变量的内存地址。我们通常通过 * 运算符来解引用指针，获取指针指向的值。但 Go 语言还支持更复杂的指针类型，例如指向指针的指针 (Pointer to Pointer)，也称为二级指针 (Double Pointer)。虽然在日常开发中不常用，但理解其工作原理对于深入理解内存管理、某些高级数据结构（如链表、树的修改操作）或在特定场景下修改指针本身的值至关重要。  核心概念：一个指针变量存储一个普通变量的地址，而指向指针的指针存储一个指针变量的地址。   一、基本指针回顾在深入指向指针的指针之前，我们先快速回顾一下 Go 语言中的基本指针：  定义指针：使用 * 符号和类型名来声明一个指针变量，例如 *int 表示一个指向 int 类型的指针。 获取地址：使用 &amp; 运算符来获取一个变量的内存地址。 解引用：使用 * 运算符来访问指针指向的内存中的值。  示例： 123456789101112131415161718192021package mainimport &quot;fmt&quot;func main() &...</div></div></div></a><a class="pagination-related" href="/2565d3c3db01/" title="Go语言embed包详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-12.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-12</div><div class="info-item-2">Go语言embed包详解</div></div><div class="info-2"><div class="info-item-1"> Go 标准库从 Go 1.16 版本开始引入了 embed 1 包。这个包提供了一种简单、声明式的方式，允许开发者将静态文件（如 HTML 模板、CSS、JavaScript、图片、配置文件等）直接嵌入到 Go 可执行文件中。这意味着你可以通过一个独立的二进制文件分发所有应用程序所需的资源，而无需额外管理外部文件，极大地简化了部署和分发过程。  核心思想：将应用程序的外部资源（静态文件）编译进最终的二进制文件，实现“单一二进制文件”的发布和部署，消除外部文件依赖带来的复杂性。   一、为什么需要 embed 包？在 embed 包之前，Go 语言应用程序处理静态资源通常有以下几种方式：  外部文件：将静态文件与可执行文件放在一起分发。这会带来：  部署复杂性：需要确保文件结构正确，并处理文件丢失或路径错误的问题。 文件篡改风险：外部文件容易被修改，可能影响程序的行为或安全性。 分发不便：每次更新都需要同步可执行文件和所有相关资源文件。   go:embed 第三方库：许多第三方库（如 go-bindata, packr）实现了文件嵌入功能。这些库虽然有效，但通常需要一些额外的构...</div></div></div></a><a class="pagination-related" href="/f200f6bfe5fa/" title="Golang 特殊注释 (Special Comments) 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-02.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-15</div><div class="info-item-2">Golang 特殊注释 (Special Comments) 详解</div></div><div class="info-2"><div class="info-item-1"> 在 Go 语言中，除了我们日常用于解释代码逻辑的普通注释 // 和 /* */ 之外，还存在一些具有特殊含义的注释。这些特殊注释通常以 //go: 或 // + 开头，它们并不是为程序员阅读而生，而是作为指令直接与 Go 工具链（编译器、链接器、go generate 等）交互，用于控制编译行为、生成代码、导入 C 代码，或者提供额外的信息。  核心思想：特殊注释是 Go 工具链的“命令”，用于扩展 Go 语言的能力，例如嵌入文件、生成代码、与 C 语言交互或进行性能优化。   一、Go 特殊注释的分类与作用Go 的特殊注释大致可以分为几类：  编译器指令 (Build Constraints)：控制哪些文件或代码块在特定条件下编译。 代码生成指令 (go generate)：标记需要执行特定外部工具来生成代码的位置。 cgo 指令：用于 Go 和 C&#x2F;C++ 代码之间的互操作。 embed 指令：将静态文件嵌入到 Go 二进制文件中 (Go 1.16+)。 运行时或工具指令：用于性能分析、内存管理等内部或高级用途。  接下来的章节将详细介绍这些特殊注释。 二、//g...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TeaTang</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">522</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">229</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/teatang"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:tea.tang1211@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站更多功能即将上线，敬请期待！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9-Ent%EF%BC%9F"><span class="toc-text">一、为什么选择 Ent？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Ent-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">二、Ent 的核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Schema-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%BC%8F"><span class="toc-text">2.1 Schema (数据模式)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Code-Generation-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90"><span class="toc-text">2.2 Code Generation (代码生成)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Ent-Client-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">2.3 Ent Client (客户端)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Hooks-%E9%92%A9%E5%AD%90-%E5%92%8C-Interceptors-%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-text">2.4 Hooks (钩子) 和 Interceptors (拦截器)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Mixins-%E6%B7%B7%E5%85%A5"><span class="toc-text">2.5 Mixins (混入)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Ent-%E7%9A%84%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B-%E4%BB%A5-User-%E5%92%8C-Pet-%E5%AE%9E%E4%BD%93%E4%B8%BA%E4%BE%8B"><span class="toc-text">三、Ent 的使用流程 (以 User 和 Pet 实体为例)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-text">3.1 准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AE%9A%E4%B9%89-Schema"><span class="toc-text">3.2 定义 Schema</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81"><span class="toc-text">3.3 生成代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E-Schema-%E8%BF%81%E7%A7%BB"><span class="toc-text">3.4 连接数据库与 Schema 迁移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B"><span class="toc-text">3.5 运行示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"><span class="toc-text">四、高级功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB-Migrations"><span class="toc-text">4.1 数据库迁移 (Migrations)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E4%BA%8B%E5%8A%A1-Transactions"><span class="toc-text">4.2 事务 (Transactions)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2-Predicates-Aggregations-Pagination"><span class="toc-text">4.3 复杂查询 (Predicates, Aggregations, Pagination)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E4%BC%98%E7%BC%BA%E7%82%B9%E4%B8%8E%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">五、优缺点与适用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E4%BC%98%E7%82%B9%EF%BC%9A"><span class="toc-text">5.1 优点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E7%BC%BA%E7%82%B9%EF%BC%9A"><span class="toc-text">5.2 缺点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A"><span class="toc-text">5.3 适用场景：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%AE%89%E5%85%A8%E6%80%A7%E8%80%83%E8%99%91"><span class="toc-text">六、安全性考虑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">七、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/5341a0037256/" title="CSS-in-JS 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-08.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CSS-in-JS 详解"/></a><div class="content"><a class="title" href="/5341a0037256/" title="CSS-in-JS 详解">CSS-in-JS 详解</a><time datetime="2026-01-25T22:24:00.000Z" title="发表于 2026-01-26 06:24:00">2026-01-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/0b52cb819619/" title="Git 核心对象：Commit, Tree, Blob 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-31.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Git 核心对象：Commit, Tree, Blob 详解"/></a><div class="content"><a class="title" href="/0b52cb819619/" title="Git 核心对象：Commit, Tree, Blob 详解">Git 核心对象：Commit, Tree, Blob 详解</a><time datetime="2026-01-21T22:24:00.000Z" title="发表于 2026-01-22 06:24:00">2026-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/1d2a942bda1e/" title="Terraform 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-27.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Terraform 详解"/></a><div class="content"><a class="title" href="/1d2a942bda1e/" title="Terraform 详解">Terraform 详解</a><time datetime="2026-01-19T22:24:00.000Z" title="发表于 2026-01-20 06:24:00">2026-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/26cdb2447b3d/" title="WebView 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-32.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WebView 详解"/></a><div class="content"><a class="title" href="/26cdb2447b3d/" title="WebView 详解">WebView 详解</a><time datetime="2026-01-17T22:24:00.000Z" title="发表于 2026-01-18 06:24:00">2026-01-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/e62a1e8acade/" title="AI 辅助编程的关键要点与代码幻觉防范"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-11.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI 辅助编程的关键要点与代码幻觉防范"/></a><div class="content"><a class="title" href="/e62a1e8acade/" title="AI 辅助编程的关键要点与代码幻觉防范">AI 辅助编程的关键要点与代码幻觉防范</a><time datetime="2026-01-15T22:24:00.000Z" title="发表于 2026-01-16 06:24:00">2026-01-16</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/default_cover-02.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">我的轨迹</div><div class="footer-flex-content"><a href="/archives/2023/" target="_blank" title="🆕 2023">🆕 2023</a><a href="/archives/2024/" target="_blank" title="🆒 2024">🆒 2024</a><a href="/archives/2025/" target="_blank" title="👨‍👩‍👦 2025">👨‍👩‍👦 2025</a><a href="/archives/2026/" target="_blank" title="🆙 2026">🆙 2026</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">维度</div><div class="footer-flex-content"><a href="/categories/" target="_blank" title="📁 分类">📁 分类</a><a href="/tags/" target="_blank" title="🔖 标签">🔖 标签</a><a href="/categories/" target="_blank" title="📽️ 时间线">📽️ 时间线</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/shuoshuo" target="_blank" title="💬 说说">💬 说说</a></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By TeaTang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.9/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (true) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script></div><script data-pjax src="/self/btf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="ture"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,200,200" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js" defer="defer"></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      true
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.4"></script></div></div></body></html>