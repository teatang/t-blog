---
title: Git命令详解与实践
date: 2023-11-02 06:24:00
tags:
  - 2023
  - 开发工具
  - Git
categories:
  - 开发工具
  - Git
---

> Git 是一款免费、开源的分布式版本控制系统，旨在快速、高效地处理从小规模到超大规模的所有项目。它由 Linux 内核的创建者 Linus Torvalds 于 2005 年创建。Git 的核心理念是**跟踪内容而非文件**，并支持**非线性开发**（即多人并行开发，合并不同的工作流）。

本文将深入介绍 Git 的核心概念、常用命令、工作流程、分支管理策略以及一些最佳实践。

{% note info %}
“Git is a free and open source distributed version control system designed to handle everything from small to very large projects with speed and efficiency.” —— Git 官方 Slogan
{% endnote %}
------

## 一、Git 核心概念

在使用 Git 命令之前，理解其核心概念至关重要。

### 1. 工作区 (Working Directory)

*   你电脑上当前可见的目录，包含你项目的所有文件。
*   你正在进行修改和编辑的地方。

### 2. 暂存区 (Staging Area / Index)

*   一个文件，通常位于 `.git/index`，记录了你下次提交 (commit) 将要包含的所有文件修改。
*   它是工作区和版本库之间的桥梁，用于选择性地添加修改。

### 3. 本地仓库 (Local Repository)

*   你项目 `.git` 目录下的所有内容，包含了项目的所有版本历史记录。
*   所有的提交 (commit) 都存储在这里。

### 4. 远程仓库 (Remote Repository)

*   托管在网络上的仓库，如 GitHub、GitLab、Bitbucket 等。
*   允许团队成员进行协作，共享代码。

理解这三区一库 (工作区、暂存区、本地仓库、远程仓库) 的概念，是掌握 Git 的关键。

![Git工作区、暂存区、本地仓库](/img/post/2023/11/20231102-01.png)
_示意图：Git 工作区、暂存区、本地仓库_

### 5. HEAD

*   一个指向当前所在分支的指针。
*   在分支上，它指向最新的一次提交 (commit)。
*   `HEAD` 总是指向当前提交的快照 (snapshot)。

## 二、Git 基础配置

首次使用 Git 或在新机器上使用时，需要进行一些基本配置。

```bash
# 配置用户名（重要，会记录到每次提交中）
git config --global user.name "Your Name"

# 配置用户邮箱（重要，会记录到每次提交中）
git config --global user.email "your.email@example.com"

# 设置默认的分支名称（Git 2.28+ 或更高版本，默认是 main）
git config --global init.defaultBranch main

# 查看所有配置
git config --list

# 查看某个配置项的值
git config user.name
```

## 三、Git 初始化与克隆

### 1. 初始化本地仓库 (`git init`)

在一个已存在的项目目录中初始化一个新的 Git 仓库。这会在当前目录下创建一个 `.git` 隐藏文件夹。

```bash
mkdir my-new-project
cd my-new-project
git init
```

### 2. 克隆远程仓库 (`git clone`)

从远程仓库下载一个项目到本地，并自动将其配置为本地仓库的远程源。

```bash
git clone <remote-repository-url> [local-directory-name]

# 示例：
git clone https://github.com/octocat/Spoon-Knife.git
# 或者克隆到一个指定名称的目录
git clone https://github.com/octocat/Spoon-Knife.git my-spoon-knife
```

## 四、Git 文件管理

### 1. 查看文件状态 (`git status`)

查看工作区和暂存区文件的状态，哪些被修改了，哪些在暂存区等待提交。

```bash
git status

# 简短输出，更适合快速查看
git status -s
```

### 2. 添加文件到暂存区 (`git add`)

将工作区中文件的修改或新增的文件添加到暂存区。

```bash
# 添加指定文件
git add <file1> <file2> ...

# 添加当前目录下所有修改和新增的文件（不包括删除的文件）
git add .

# 添加所有修改、新增和删除的文件（包括删除的，慎用）
git add -A

# 添加所有修改和新增的文件，包括被删除的（比较常用）
git add -u
```

### 3. 撤销暂存 (`git reset`)

将暂存区的文件移回工作区（取消暂存）。

```bash
# 将指定文件从暂存区中移除，但保留工作区修改
git reset HEAD <file>

# 将所有文件从暂存区中移除，但保留工作区修改
git reset HEAD .
```

### 4. 撤销工作区的修改 (`git checkout` / `git restore`)

丢弃工作区中文件的修改，恢复到上一次提交或暂存时的状态。

*   **`git checkout -- <file>`**: 传统方式，自 Git 2.23 起被 `git restore` 替代。
*   **`git restore <file>`**: 推荐方式（Git 2.23+），操作更清晰。

```bash
# 丢弃指定文件在工作区的修改
git restore <file>

# 丢弃所有文件在工作区的修改（慎用，会丢失未提交的修改）
git restore .
```

### 5. 重命名或移动文件 (`git mv`)

在 Git 中重命名或移动文件，并自动将这些更改暂存。

```bash
git mv <old_path> <new_path>

# 示例：将 test.txt 重命名为 new_test.txt
git mv test.txt new_test.txt
```

### 6. 删除文件 (`git rm`)

将文件从工作区和暂存区中删除，并标记为待提交的删除操作。
如果只想从 Git 追踪中移除文件，但保留在工作区（例如某些临时文件），可以使用 `--cached` 选项。

```bash
# 从工作区和暂存区删除文件
git rm <file>

# 只从暂存区删除文件，保留工作区文件，不再被 Git 追踪
git rm --cached <file>
```

## 五、Git 提交与历史

### 1. 提交修改 (`git commit`)

将暂存区中的所有修改作为一个新的版本提交到本地仓库，并生成一个提交信息。

```bash
# 使用默认编辑器输入提交信息
git commit

# 在命令行中直接输入提交信息
git commit -m "Your commit message here"

# 跳过暂存区，直接提交工作区中所有已追踪的修改（慎用，不推荐常规使用）
# 等同于 git add -u && git commit -m "..."
git commit -am "Your commit message here"

# 修改上一次提交（可用于修改提交信息或添加遗漏的文件）
# 会打开编辑器让你修改提交信息，保存退出即可。如果想添加文件，先 git add，再 git commit --amend
git commit --amend
```

### 2. 查看提交历史 (`git log`)

查看本地仓库的提交历史记录。

```bash
# 查看所有提交历史
git log

# 查看简短的提交历史
git log --oneline

# 以图谱形式查看提交历史（带分支信息，非常有用）
git log --graph --oneline --decorate

# 查看指定文件的提交历史
git log <file>

# 查看某个提交的具体修改内容
git show <commit_id>
```

### 3. 比较差异 (`git diff`)

查看文件之间的差异。

```bash
# 比较工作区和暂存区之间的差异
git diff

# 比较暂存区和最新提交之间的差异
git diff --cached

# 比较工作区和最新提交之间的差异
git diff HEAD

# 比较两个提交之间的差异
git diff <commit_id1> <commit_id2>

# 比较某个文件在工作区与暂存区的差异
git diff <file>
```

## 六、Git 分支管理

分支是 Git 的核心功能之一，允许在不影响主线开发的情况下进行并行开发。

### 1. 查看分支 (`git branch`)

查看本地分支列表。

```bash
# 列出所有本地分支，当前分支前有 *
git branch

# 列出所有本地和远程分支
git branch -a

# 列出所有远程分支
git branch -r
```

### 2. 创建分支 (`git branch`)

创建一个新的分支。

```bash
git branch <new-branch-name>

# 示例：创建一个名为 feature-x 的分支
git branch feature-x
```

### 3. 切换分支 (`git checkout` / `git switch`)

切换到指定分支。

*   **`git checkout <branch-name>`**: 传统方式。
*   **`git switch <branch-name>`**: Git 2.23+ 推荐，将切换操作与恢复操作 (`git restore`) 分离，使命令更清晰。

```bash
# 切换到 feature-x 分支
git switch feature-x

# 切换到上一个分支
git switch -

# 创建并切换到新分支
git switch -c <new-branch-name>
# 等同于 git branch <new-branch-name> && git switch <new-branch-name>
```

### 4. 合并分支 (`git merge`)

将指定分支的修改合并到当前分支。

```bash
# 假设当前在 main 分支，要合并 feature-x
git switch main
git merge feature-x

# 合并时强制执行 fast-forward（快速前进）模式（如果可能）
git merge --ff-only <branch>

# 合并时创建一个新的合并提交，即使可以 fast-forward（默认行为，推荐）
git merge --no-ff <branch>

# 终止正在进行的合并（例如发生冲突时）
git merge --abort
```

### 5. 删除分支 (`git branch -d` / `git branch -D`)

删除一个本地分支。

```bash
# 安全删除分支（只删除已合并的分支）
git branch -d <branch-name>

# 强制删除分支（即使未合并也会删除，慎用！）
git branch -D <branch-name>
```

### 6. 变基 (`git rebase`)

将一系列提交“移”到另一个基底提交之上。它可以使提交历史变得更线性、更整洁。

*   **优点**: 产生线性的、整洁的提交历史，易于代码审查和追溯。
*   **缺点**: 如果 rebase 了一个已经推送到远程的公共分支，会导致历史混乱，**绝对禁止对公共分支进行 rebase**。

```bash
# 假设当前在 feature-x 分支，想将它 rebase 到 main
git switch feature-x
git rebase main

# 交互式 rebase (用于修改、合并、删除提交等)
git rebase -i <commit_id> # 从指定提交到当前 HEAD 之间的提交进行操作
git rebase -i HEAD~3      # 操作最近的3个提交
```

## 七、Git 远程仓库操作

### 1. 查看远程仓库 (`git remote`)

```bash
# 列出所有远程仓库
git remote

# 列出所有远程仓库及其 URL
git remote -v
```

### 2. 添加远程仓库 (`git remote add`)

```bash
git remote add <name> <url>

# 示例：添加一个名为 origin 的远程仓库
git remote add origin https://github.com/your/repo.git
```

### 3. 从远程拉取 (`git pull`)

从远程仓库获取最新修改并合并到当前本地分支。

*   **`git fetch` + `git merge`**: `git pull` 的底层操作。
*   **`git fetch`**: 只从远程获取修改，不合并。

```bash
# 从 origin 远程仓库的 master 分支拉取并合并到当前本地分支
git pull origin master

# 获取所有远程分支的最新状态，但不合并
git fetch origin

# 获取所有远程仓库的所有分支的最新状态
git fetch --all
```

### 4. 推送到远程 (`git push`)

将本地仓库的提交推送到远程仓库。

```bash
# 将当前分支的修改推送到 origin 远程仓库的当前同名分支
git push origin <branch-name>

# 示例：将本地 main 分支推送到 origin 的 main 分支
git push origin main

# 首次推送时，设置上游分支（以后 git push 即可）
git push -u origin main

# 强制推送（慎用！会覆盖远程仓库的历史）
git push -f origin <branch-name>
```

### 5. 同步远程仓库 (`git remote update`)

更新所有远程分支的引用。

```bash
git remote update
```

## 八、Git 撤销操作

Git 提供了多种撤销方式，但需谨慎使用。

### 1. 撤销工作区修改 (`git restore`)

前面已提过，用于丢弃工作区中文件的修改。

```bash
git restore <file>
git restore . # 丢弃所有修改
```

### 2. 撤销暂存区修改 (`git reset HEAD`)

前面已提过，用于将暂存区文件移回工作区。

```bash
git reset HEAD <file>
git reset HEAD . # 撤销所有暂存
```

### 3. 撤销提交 (`git reset`)

*   **`git reset --soft <commit_id>`**:
    *   将 `HEAD` 移到 `<commit_id>`。
    *   保留工作区和暂存区的修改。
    *   你可以重新提交这些修改。
*   **`git reset --mixed <commit_id>` (默认模式)**:
    *   将 `HEAD` 移到 `<commit_id>`。
    *   保留工作区修改。
    *   **清空暂存区**。
    *   你需要重新 `git add` 并 `git commit`。
*   **`git reset --hard <commit_id>`**:
    *   **危险操作！** 将 `HEAD` 移到 `<commit_id>`。
    *   **丢弃工作区和暂存区的所有修改**，强制回到指定提交的状态。
    *   **会丢失未保存的工作，请谨慎使用！**

```bash
# 撤销到上一次提交，保留工作区和暂存区
git reset --soft HEAD~1 

# 撤销到上一次提交，保留工作区，清空暂存区
git reset HEAD~1 

# 撤销到上一次提交，并丢弃所有修改（危险！）
git reset --hard HEAD~1 

# 撤销到指定提交 ID，并丢弃所有修改
git reset --hard <commit_id> 
```

### 4. 反转提交 (`git revert`)

*   **`git revert <commit_id>`**:
    *   用于**撤销一个已存在的提交**。
    *   它会创建一个**新的提交**，这个新提交的内容是指定提交的**逆向修改**。
    *   优点是**不会改写历史**，非常适合在公共分支上撤销提交。

```bash
# 反转指定提交，会创建一个新的反转提交
git revert <commit_id> 
```

### 5. 找回丢失的提交 (`git reflog`)

如果在使用 `git reset --hard` 或其他操作时不小心丢弃了提交，`git reflog` 可以帮助你找回。

```bash
git reflog
# 查看 reflog 输出，找到你需要的 commit_id
# 然后使用 git reset --hard <commit_id> 恢复
```

## 九、Git 标签 (Tags)

标签用于标记仓库历史中的重要里程碑，例如发布版本。

```bash
# 列出所有标签
git tag

# 创建轻量标签（不含提交者信息，更像是一个分支指针）
git tag <tag-name>

# 创建附注标签（推荐，包含提交者、日期、信息等，对象在 Git 数据库中）
git tag -a <tag-name> -m "Tag message"

# 给特定提交创建标签
git tag -a <tag-name> <commit_id> -m "Tag message"

# 推送标签到远程仓库（默认 git push 不推送标签）
git push origin <tag-name>

# 推送所有标签到远程仓库
git push origin --tags

# 删除本地标签
git tag -d <tag-name>

# 删除远程标签
git push origin --delete <tag-name>
```

## 十、Git 临时存贮 (`git stash`)

当你在一个分支上工作时，突然需要切换到另一个分支处理紧急问题，但又不希望提交当前未完成的工作，`git stash` 就能派上用场。它会**保存当前工作区和暂存区的修改**，然后将工作区恢复到 `HEAD` 的状态。

```bash
# 存储当前修改（暂存区和工作区）
git stash save "Work in progress on feature X"

# 列出所有存储的 stash
git stash list

# 应用最近的 stash（不会从列表中删除）
git stash apply

# 应用最近的 stash 并从列表中删除
git stash pop

# 应用指定的 stash
git stash apply stash@{1}

# 删除最近的 stash
git stash drop

# 删除指定的 stash
git stash drop stash@{1}

# 删除所有 stash
git stash clear
```

## 十一、Git 最佳实践

1.  **提交粒度小而精**: 每次提交只做一件事情，且提交信息清晰明了。
2.  **提交信息规范**: 遵循一定的提交信息规范，例如 `feat: 新增功能`, `fix: 修复 bug`, `docs: 更新文档` 等。
3.  **频繁提交**: 经常在本地进行提交，保持工作区干净。
4.  **合理使用分支**: 为每个功能、bug 修复或实验性任务创建独立的分支。
5.  **主分支保持稳定**: `main` (或 `master`) 等主分支应始终保持可发布状态。
6.  **禁止对公共分支进行 `rebase`**: `rebase` 适用于在本地清理提交历史，但切勿在已推送到远程的公共分支上强制 `rebase`，这会造成历史混乱。
7.  **经常 `pull` / `fetch`**: 与团队成员协作时，保持本地仓库与远程仓库同步。
8.  **代码审查 (Code Review)**: 通过 Pull Request/Merge Request 进行代码审查，确保代码质量。
9.  **忽略不必要的文件**: 使用 `.gitignore` 文件忽略编译产物、日志、依赖模块等不应提交的文件。
10. **学习 `git reflog`**: 它是你的后悔药，可以帮你找回“丢失”的提交。

## 十二、总结

Git 是现代软件开发不可或缺的工具。掌握了这些基础和进阶命令，你就能自信地管理项目代码，与团队高效协作。记住，实践是最好的学习方式，多加练习才能真正领会 Git 的强大之处。如果你有任何疑问，Git 官方文档和社区是获取帮助的最好资源。