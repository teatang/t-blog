---
title: Hysteria2 详解
date: 2023-10-30 06:24:00
tags:
  - 2023
  - Hysteria2
  - 代理协议
  - 计算机网络
categories:
  - 计算机网络
  - 代理协议
---

> **Hysteria2** 是 Hysteria 协议的下一代版本，它是一个基于 **QUIC 协议**和 **UDP 传输**的高性能代理工具。Hysteria2 旨在提供**极低的延迟**和**高吞吐量**，尤其是在**网络条件不佳或有较高延迟**的环境下表现出色。它通过其独特的拥塞控制算法和流量调度机制，优化了性能，并提供了强大的抗审查能力。

{% note info %}
核心思想：**Hysteria2 利用 QUIC 和 UDP 的优势，在传输层实现了更快的连接建立、多路复用和零RTT握手，并通过可插拔的拥塞控制算法和流量混淆，提供高性能、低延迟且具一定抗审查能力的代理服务。**
{% endnote %}

## 一、为什么需要 Hysteria2？

传统的基于 TCP 的代理协议（如 Shadowsocks、V2Ray 等的 TCP 模式）在一些网络环境下可能面临以下问题：

1.  **TCP 队头阻塞 (Head-of-Line Blocking)**：TCP 的可靠性机制可能在数据包丢失或乱序时导致整个连接阻塞，影响性能。
2.  **三次握手延迟**：TCP 连接建立需要三次握手，增加了初始连接延迟。
3.  **弱加密和抗审查能力不足**：一些协议的流量特征可能比较明显，容易被识别和阻断。
4.  **UDP 传输优势不足**：虽然一些协议支持 UDP，但可能没有充分利用 UDP 的优势进行优化。

Hysteria2 旨在解决这些痛点，尤其关注**在网络不稳定、高丢包、高延迟**或需要**规避网络审查**的场景下提供更平滑、更快的用户体验。

## 二、Hysteria2 的工作原理

Hysteria2 的核心在于其对 **QUIC 协议**的深度利用和优化。

### 2.1 QUIC 协议 (Quick UDP Internet Connections)

QUIC 是由 Google 开发并得到 IETF 标准化的多路复用传输协议，运行在 UDP 之上。它结合了 TCP 的可靠性功能与 UDP 的速度，并引入了多项改进：

1.  **零 RTT 连接建立 (0-RTT)**：在客户端与服务器有过一次成功连接后，再次连接可直接发送加密数据，大大减少了连接延迟。
2.  **多路复用 (Multiplexing)**：在单个 QUIC 连接上可以同时发送多个流，某个流的丢包不会影响其他流的传输，解决了 TCP 的队头阻塞问题。
3.  **传输加密 (TLS 1.3)**：QUIC 从设计之初就强制使用 TLS 1.3 对所有数据进行加密，提供了强大的安全性。
4.  **更快的连接迁移**：客户端 IP 地址变化时，QUIC 连接可以更快地迁移，对移动设备尤其友好。
5.  **自定义拥塞控制**：QUIC 允许在用户空间实现和修改拥塞控制算法，这为 Hysteria2 提供了巨大的优化空间。

### 2.2 Hysteria2 的特性和优化

1.  **基于 QUIC**：利用上述 QUIC 的所有优势，提供高性能、低延迟和高并发。
2.  **自定义拥塞控制**：Hysteria2 内置了多种可插拔的拥塞控制算法，例如：
    *   **BBR (Bottleneck Bandwidth and RTT)**：Google 开发的一种拥塞控制算法，旨在更好地利用网络带宽，减少排队延迟。
    *   **Cubic**：Linux 内核默认的拥塞控制算法，适用于高带宽长距离网络。
    *   **Hybla**：针对卫星链路等高 RTT 环境进行了优化。
    这些算法可以根据实际网络环境进行选择和优化。
3.  **流量混淆 (Obfuscation)**：Hysteria2 可以在 QUIC 层之上进行流量伪装，使其看起来像常规的流量（例如 HTTPS 流量），从而增加抗审查能力。这是通过配置 `masquerade` 字段实现的，将请求伪装成访问特定网站的流量。
4.  **UDP 转发**：支持 UDP 流量的转发，适用于 DNS 解析、游戏等对延迟敏感的应用。
5.  **认证与授权**：通过密码或证书进行客户端认证，确保只有授权用户才能连接。
6.  **QUIC 流量控制**：Hysteria2 可以在 QUIC 的流量控制机制上进行进一步的优化，以更好地适应网络状况。

### 2.3 工作流程图

{% mermaid %}
graph TD
    A[客户端] -->|本地代理/Socks5/HTTP| B(Hysteria2 客户端)
    B -->|"QUIC over UDP (加密/混淆)"| C(Hysteria2 服务器)
    C -->|解密/转发请求| D[目标网站/服务]
    D -->|返回响应| C
    C -->|"QUIC over UDP (加密/混淆)"| B
    B -->|本地代理/Socks5/HTTP| A
{% endmermaid %}

## 三、Hysteria2 的安装与配置示例 (Linux)

### 3.1 下载 Hysteria2

访问 Hysteria2 的 GitHub Releases 页面 ([https://github.com/apernet/hysteria/releases](https://github.com/apernet/hysteria/releases)) 下载适合您系统的最新版本。通常是 `hysteria-linux-amd64` 等二进制文件。

**示例 (以 x64 Linux 为例)：**

```bash
# 在服务器和客户端分别执行
wget https://github.com/apernet/hysteria/releases/download/v2.x.x/hysteria-linux-amd64
mv hysteria-linux-amd64 hysteria
chmod +x hysteria
```

### 3.2 配置 Hysteria2 服务器端 (Server)

在**公网服务器**上创建 `server.yaml` 配置文件：

```yaml
# server.yaml
listen: :443                 # 服务器监听端口，建议使用标准 HTTPS 端口 443
acme:
  domains:
    - your_domain.com       # 替换为您的域名
  email: your_email@example.com # 接收证书过期通知
# alternatively, use a plain certificate
# cert: /path/to/your/cert.pem
# key: /path/to/your/key.pem

auth:
  type: password
  # 也可以是 type: simple
  # passwords:
  #   - your_password_1
  #   - your_password_2
  # - 或使用文件
  # passwords_file: /path/to/passwords.txt
  password: your_secret_password # 替换为您的密码

bandwidth:
  up: 100 Mbps                  # 上行带宽限制
  down: 1 Gbps                  # 下行带宽限制

# 混淆设置，使其看起来像访问 example.com
# 请替换为您真正可以访问的合法网站
masquerade:
  type: http
  # 例如伪装成访问 Google
  path: /
  host: google.com

log_level: info                 # 日志级别
```
**说明：**
*   **`listen`**：服务器监听的 IP 和端口。推荐使用 `443` 端口，因为它被广泛用于 HTTPS 流量，有助于混淆。
*   **`acme` 或 `cert/key`**：
    *   `acme`：配置此项可让 Hysteria2 自动通过 Let's Encrypt 申请和管理 TLS 证书，非常方便。您需要将 `your_domain.com` 解析到您的公网服务器 IP。
    *   `cert/key`：如果您有自己的证书，可以指定证书和私钥路径。
*   **`auth`**：配置认证方式。`password` 最简单，安全性尚可。
*   **`bandwidth`**：您可以设置上行和下行带宽限制，单位可以是 `b`, `Kbps`, `Mbps`, `Gbps`。
*   **`masquerade`**：**关键的混淆功能**。设置为一个真实的、可访问的网站域名和路径，Hysteria2 的 QUIC 流量在被防火墙探测时，会伪装成对该网站的访问，增强抗审查能力。

**启动 Hysteria2 服务器：**

```bash
./hysteria server --config ./server.yaml
```
强烈推荐使用 `systemd` 进行服务管理，确保其开机自启和稳定运行。

### 3.3 配置 Hysteria2 客户端 (Client)

在**客户端机器**上创建 `client.yaml` 配置文件：

```yaml
# client.yaml
server: your_server_ip:443      # Hysteria2 服务器的公网 IP 和端口

auth:
  type: password
  password: your_secret_password # 与服务器端配置的密码一致

# 如果服务器端使用了 ACME 或自签名证书，客户端可能需要跳过证书验证
# insecure_skip_verify: true

# 本地 SOCKS5 代理监听端口
# 其他应用通过连接此端口使用代理
proxies:
  - socks5://127.0.0.1:1080      # 监听 1080 端口提供 SOCKS5 代理
  - http://127.0.0.1:8080        # 监听 8080 端口提供 HTTP 代理

# 客户端的带宽配置（通常不需要严格限制，除非网络条件极端）
bandwidth:
  up: 100 Mbps
  down: 1 Gbps

# 可选：配置拥塞控制算法，与服务器端不要求一致
# congestion_control: bbr

log_level: info
```
**说明：**
*   **`server`**：填写您的 Hysteria2 服务器的公网 IP 地址和监听端口。
*   **`auth`**：与服务器端一致的认证信息。
*   **`insecure_skip_verify`**：如果服务器使用自签名证书或 ACME 证书域名没有正确解析，可能需要设置为 `true`。**但在生产环境中，应确保证书链的信任，尽量避免使用此选项。**
*   **`proxies`**：定义客户端提供的代理类型和监听地址。通常使用 SOCKS5 或 HTTP 代理。
*   `congestion_control`：客户端也可以选择拥塞控制算法。

**启动 Hysteria2 客户端：**

```bash
./hysteria client --config ./client.yaml
```

### 3.4 防火墙配置

**公网服务器端**：
需要开放 `listen` 端口 (例如 443)，并确保 UDP 流量可以通过此端口。

**客户端机器**：
无需特别开放端口，但需要确保其他应用可以连接到 `proxies` 中配置的本地代理端口 (例如 1080, 8080)。

## 四、Hysteria2 的优缺点与适用场景

### 4.1 优点：

1.  **高性能、低延迟**：基于 QUIC 协议，支持 0-RTT 连接，多路复用，有效地解决了 TCP 的队头阻塞问题，在网络不佳（高延迟、高丢包）环境下表现尤为出色。
2.  **强大的抗审查能力**：通过 HTTPS 伪装（masquerade）和 QUIC 固有的加密特性 (TLS 1.3)，使其流量特征不明显，难以被识别和阻断。
3.  **灵活的拥塞控制**：支持多种拥塞控制算法，可根据网络环境灵活选择，优化传输效率。
4.  **UDP 转发支持**：兼容 UDP 流量，适合游戏、DNS 等对延迟敏感的应用。
5.  **易于部署**：只有一个简单的二进制文件和 YAML 配置文件，部署相对简单。

### 4.2 缺点：

1.  **资源消耗**：由于 QUIC 协议在用户空间实现，相比内核级的 TCP 可能会消耗更多的 CPU 资源。
2.  **UDP 端口的限制**：某些网络环境可能会对 UDP 流量进行限制或 QoS 降级，影响性能。
3.  **尚未广泛兼容**：作为相对新的协议，并非所有客户端软件都原生支持 Hysteria2，可能需要配合特定客户端或配置使用。
4.  **配置相对复杂**：虽然配置文件清晰，但相对于 Shadowsocks 等单一端口、单一密码的配置，Hysteria2 涉及证书、混淆、拥塞控制等选项，略显复杂。

### 4.3 适用场景：

*   **广域网环境下的高速代理**：尤其适用于跨国、长距离的网络连接，在丢包率高、延迟大的环境中能保持更佳的体验。
*   **网络审查严格的地区**：其流量伪装和基于 UDP 的传输特性，有助于规避网络审查。
*   **对游戏、实时通信等延迟敏感的应用**：提供更低的延迟和更高的稳定性。
*   **需要高性能内网穿透**：结合 FRP 等内网穿透工具，可以提供高性能的远程访问。

## 五、总结

Hysteria2 作为新一代的代理协议，充分发挥了 QUIC 协议的优势，针对高性能、低延迟和抗审查场景进行了深度优化。它通过灵活的拥塞控制、强大的流量混淆和原生的 TLS 1.3 加密，为用户提供了一个高效且安全的网络连接解决方案。尽管其资源消耗和部署复杂度略高于一些传统协议，但在面对恶劣网络环境或特定需求时，Hysteria2 的性能优势使其成为一个非常具有吸引力的选择。