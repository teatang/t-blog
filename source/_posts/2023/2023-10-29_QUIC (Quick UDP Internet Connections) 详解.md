---
title: QUIC (Quick UDP Internet Connections) 详解
date: 2023-10-29 06:24:00
tags:
  - 2023
  - Hysteria2
  - 网络协议
  - 计算机网络
categories:
  - 计算机网络
  - 网络协议
---

> **QUIC (Quick UDP Internet Connections)** 是由 Google 最早开发的一种**通用的传输层网络协议**，它旨在通过在 **UDP 协议**之上实现可靠性和安全性来加速 HTTP 流量。QUIC 合并了 TCP、TLS 和 HTTP/2 的最佳特性，并针对现代互联网环境进行了优化，解决了 TCP 的一些固有局限性。目前，QUIC 已经由 IETF (Internet Engineering Task Force) 标准化为 **RFC 9000** 系列，并作为 **HTTP/3** 的底层传输协议。

{% note info %}
核心思想：**QUIC 将 TCP 连接管理、TLS 加密和 HTTP/2 多路复用等功能集成到 UDP 上，通过 0-RTT 连接、独立流、更快的连接迁移和可插拔拥塞控制，实现了低延迟、高吞吐量和强大的安全性。**
{% endnote %}
------

## 一、为什么需要 QUIC？

尽管 TCP/IP 协议栈在过去几十年中支撑了整个互联网，但随着网络应用的发展和移动设备的普及，TCP 的一些固有缺陷逐渐显现出来：

1.  **TCP 三次握手延迟 (3-RTT)**：每次建立新的 TCP 连接都需要客户端和服务器之间进行三次数据包交换，增加了初始连接的延迟。而 HTTPS 又需要额外的 TLS 握手。
2.  **队头阻塞 (Head-of-Line Blocking, HOLB)**：TCP 是一个字节流协议，保证数据包的有序交付。如果一个数据包丢失，后续所有已接收的数据包都必须等待该丢失数据包重传成功并重新排序，才能交付给应用层，这会阻塞整个连接上所有数据的传输。
3.  **弱连接迁移**：当客户端的 IP 地址发生变化（如从 Wi-Fi 切换到蜂窝网络），新的 IP 地址无法沿用旧的 TCP 连接，需要重新建立连接，导致业务中断。
4.  **内核实现限制**：TCP 协议通常在操作系统内核中实现，更新和改进其拥塞控制算法或安全特性需要更新整个操作系统，灵活性较差。
5.  **缺乏多路复用优化**：虽然 HTTP/2 引入了多路复用，但它仍运行在 TCP 之上，受限于 TCP 的队头阻塞问题。

QUIC 的出现正是为了解决这些问题，提供一个在 UDP 基础上，集成了安全、并发和高效传输的新一代协议。

## 二、QUIC 的核心特性与工作原理

QUIC 协议运行在 UDP 之上，但提供了所有 TCP 的可靠性和流控制功能，并集成了 TLS 加密。

### 2.1 零 RTT 连接建立 (0-RTT)

*   **加速握手**：QUIC 首次连接时，客户端和服务器只需完成一次握手即可建立安全连接 (1-RTT)。
*   **重复连接**：在客户端与服务器有过一次成功连接后，客户端可以在重新连接时直接在握手包中携带加密数据，实现**零 RTT (0-RTT)** 往返时间，大大减少了连接建立的延迟。这得益于 QUIC 的连接 ID 机制和预共享密钥。

### 2.2 多路复用 (Multiplexing) 与无队头阻塞

*   **独立的流**：QUIC 在单个连接上支持创建多个独立的逻辑流，每个流都有自己的流控制和重传机制。
*   **流之间互不影响**：一个流上的数据包丢失或乱序不会影响到其他流的传输和交付。这彻底解决了 TCP 的队头阻塞问题，使得 HTTP/3 能够更高效地并发传输多个资源。

{% mermaid %}
graph TD
    subgraph TCP with HTTP/2
        A[Client] -- 1 (Stream 1) --> B[Server]
        A -- 2 (Stream 2) --> B
        A -- 3 (Stream 3) --> B
        direction LR
        B -- Loss of Data (Stream 1) --> B_retrans[TCP Stack Blocked]
        B_retrans --> B[All Streams Wait]
    end

    subgraph QUIC with HTTP/3
        X[Client] -- S1 (Stream 1) --> Y[Server]
        X -- S2 (Stream 2) --> Y
        X -- S3 (Stream 3) --> Y
        direction LR
        Y -- Loss of Data (Stream 1) --> Y_retrans[Only Stream 1 Blocked]
        Y_retrans --> Y[Other Streams Continue]
    end
{% endmermaid %}

### 2.3 传输层加密 (TLS 1.3 内置)

*   **强制加密**：QUIC 从设计之初就将 TLS 1.3 集成到传输层，并且强制要求所有通信都必须加密。这意味着握手数据和数据传输都是加密的，提供了比 TCP+TLS 更强的安全性。
*   **减少攻击面**：由于加密在 QUIC 内部完成，中间网络设备无法篡改传输层头部，减少了中间路径攻击。

### 2.4 更快的连接迁移 (Connection Migration)

*   **连接 ID**：QUIC 连接不是由 IP 地址和端口号标识，而是由一个**连接 ID (Connection ID)** 标识。
*   **IP 地址变化不中断**：当客户端的 IP 地址或端口号发生变化时（例如从 Wi-Fi 切换到 4G 网络，或从移动数据切换到 Wi-Fi），只要连接 ID 不变，QUIC 连接就可以保持活跃并无缝迁移，而无需重新建立连接。这对于移动设备用户体验的提升非常显著。

### 2.5 可插拔的拥塞控制

*   **用户空间实现**：QUIC 的拥塞控制算法是在用户空间（而不是内核）实现的。这使得开发者可以更容易地更新、测试和部署新的拥塞控制算法，例如 Google 的 **BBR (Bottleneck Bandwidth and RTT)** 算法，而无需更新操作系统内核。
*   **多种算法选择**：可以根据不同的网络环境选择最适合的拥塞控制算法，优化性能。

### 2.6 NAT 穿越与防火墙友好

虽然 QUIC 运行在 UDP 之上，可能会有人担心 UDP 在某些防火墙上可能被限制。但由于 QUIC 通常使用 HTTPS 相同的端口（443），并且其流量经过混淆后看起来像 HTTPS 流量，因此在NAT 穿越和穿透防火墙方面通常表现良好。

## 三、HTTP/3 与 QUIC 的关系

**HTTP/3 正是基于 QUIC 协议构建的下一代 HTTP 协议**。

*   **HTTP/1.1**：基于 TCP，每个请求/响应一对一，队头阻塞严重。
*   **HTTP/2**：基于 TCP，引入多路复用和头部压缩，但受限于底层 TCP 的队头阻塞。
*   **HTTP/3**：基于 QUIC，继承了 QUIC 的所有优势，彻底解决了 TCP 的队头阻塞，并提供了更快的连接建立和更强的安全性。

QUIC 为 HTTP/3 提供了更快、更可靠、更安全的传输层，使得 HTTP/3 在性能上有了质的飞跃。

## 四、QUIC 的优缺点

### 4.1 优点：

1.  **性能卓越**：
    *   **0-RTT/1-RTT**：显著减少连接建立时间。
    *   **无队头阻塞**：提升多资源并发加载效率。
    *   **连接迁移**：提高移动设备等网络切换场景下的用户体验。
2.  **增强安全性**：
    *   **内置 TLS 1.3**：强制全程加密，防止窃听和篡改。
    *   **降低协议僵化风险**：加密的连接 ID 和帧类型使得中间设备难以窥探和干扰协议内部机制。
3.  **灵活性高**：
    *   **用户空间实现**：便于快速迭代和部署新的拥塞控制算法、协议特性等。
    *   **更适应现代网络**：针对高延迟、高丢包、网络切换频繁的移动互联网环境进行了优化。
4.  **与 HTTP/3 协同**：作为 HTTP/3 的底层传输，共同提升 Web 应用性能。

### 4.2 缺点：

1.  **UDP 的限制**：尽管 QUIC 解决了许多 UDP 的可靠性问题，但部分老旧或严格的防火墙可能仍会默认限制 UDP 流量，导致其无法工作或性能受限。
2.  **资源消耗**：由于协议栈在用户空间而非内核实现，可能会带来更高的 CPU 资源消耗，尤其是在高并发场景下。
3.  **部署和调试复杂性**：相对于成熟的 TCP 协议，QUIC 仍较新，协议调试工具和经验相对较少。
4.  **尚未完全普及**：虽然主流浏览器和 CDN 已支持，但并非所有服务器、代理和网络设备都完全支持 QUIC。

## 五、QUIC 的应用现状与展望

*   **浏览器支持**：Chrome、Firefox、Edge 等主流浏览器已经广泛支持 QUIC 和 HTTP/3。
*   **服务器支持**：Google 的服务器、Cloudflare CDN、Caddy Server、Nginx (通过模块) 等都已支持 QUIC / HTTP/3。
*   **移动应用**：许多移动应用，如 YouTube、Google Search，已经在内部使用 QUIC 来加速数据传输。
*   **代理工具**：Hysteria、v2ray 等高性能代理工具也已基于 QUIC 实现其核心功能，以提供更低延迟的代理体验。

随着互联网对速度和安全性的要求不断提高，QUIC 作为新一代的传输协议，必将得到更广泛的应用。它代表着未来网络传输的方向，将在云计算、边缘计算、物联网等领域发挥重要作用。

## 六、总结

QUIC 是一种革命性的传输层协议，它通过在 UDP 之上集成 TCP 的可靠性、TLS 的安全性以及 HTTP/2 的多路复用，有效地解决了传统 TCP 协议在现代互联网环境中的各种限制。凭借其 0-RTT 连接、无队头阻塞、连接迁移和可插拔拥塞控制等核心特性，QUIC 显著提升了网络传输的性能、效率和安全性，为 HTTP/3 奠定了坚实的基础，并为未来的网络通信带来了无限可能。