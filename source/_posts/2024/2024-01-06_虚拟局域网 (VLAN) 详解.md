---
title: 虚拟局域网 (VLAN) 详解
date: 2024-01-06 06:24:00
tags:
  - 2024
  - 计算机网络
  - 网络技术
categories:
  - 计算机网络
  - 网络技术
---

> **虚拟局域网 (VLAN - Virtual Local Area Network)** 是一种在物理上共享同一网络基础设施（如交换机、网线）的局域网中，通过**逻辑划分**而不是物理划分来创建多个独立广播域的技术。它允许网络管理员将一个物理局域网划分成多个逻辑上独立的网络，每个 VLAN 都是一个独立的广播域。VLAN 技术是现代企业网络设计中不可或缺的组成部分，它极大地增强了网络的**安全性、性能、灵活性和可管理性**。

{% note info %}
核心思想：在不改变物理连接的情况下，将一个物理交换机划分出多个逻辑隔离的广播域，实现设备间的逻辑分段通信。
{% endnote %}
------

## 一、什么是 VLAN？

在传统的以太网中，所有连接到同一个交换机或集线器的设备都属于同一个**广播域 (Broadcast Domain)**。这意味着当任何一台设备发送一个广播帧（例如 ARP 请求），这个广播帧会到达该域内的所有其他设备。随着网络规模的扩大，广播流量会显著增加，导致网络性能下降并带来安全隐患。

VLAN 技术应运而生，它通过在数据链路层（OSI 模型第二层）对以太网帧进行标识和处理，从而实现：

1.  **逻辑隔离**：即使设备物理上连接在同一台交换机上，如果它们属于不同的 VLAN，它们也无法直接通过二层通信。
2.  **创建多个广播域**：每个 VLAN 都是一个独立的广播域。广播流量被限制在所属的 VLAN 内部，不会扩散到其他 VLAN。

简单来说，VLAN 就像在一个大的开放办公室里，用虚拟的墙壁隔出了多个独立的部门。虽然大家在同一个屋檐下，但不同部门的人员不能直接交流（除非通过外部的路由）。

## 二、为什么需要 VLAN？

在现代网络环境中，VLAN 带来了多方面的重要优势：

1.  **提高网络安全性 (Security)**：
    *   将敏感数据或服务器隔离到独立的 VLAN 中，即使网络中的其他部分受到攻击，这些敏感资源也能得到保护。
    *   防止未经授权的用户访问特定网络资源。
    *   将不同部门（例如财务部、研发部、访客网络）的用户物理隔离，即使他们连接在同一台交换机上。
2.  **优化网络性能 (Performance)**：
    *   缩小广播域，减少广播流量（如 ARP 请求、DHCP 发现），从而降低 CPU 负载和网络拥堵。
    *   提高网络设备的 VLAN 间转发效率。
3.  **增强网络管理和灵活性 (Management & Flexibility)**：
    *   便于移动、添加和更改网络设备。用户可以物理上连接在网络的任何端口，只要其端口被配置为正确的 VLAN，就能访问所需资源，而无需重新布线。
    *   逻辑地组织网络资源，例如将所有服务器放入一个 VLAN，所有工作站放入另一个 VLAN。
    *   简化网络故障排除。
4.  **节约成本 (Cost-Effectiveness)**：
    *   通过逻辑划分，减少了购买额外物理交换机的需求，充分利用现有网络硬件。
    *   简化布线。

## 三、VLAN 的工作原理

VLAN 的核心工作机制是基于 **IEEE 802.1Q 标准**的**帧标记 (Frame Tagging)**。

1.  **VLAN 标识 (VLAN ID)**：每个 VLAN 都有一个唯一的标识符，称为 VLAN ID (VID)，取值范围通常为 1-4094。
2.  **交换机识别**：支持 VLAN 的交换机在收到以太网帧时，会根据帧的流向和端口的配置，判断帧所属的 VLAN。
3.  **帧处理**：
    *   **入站帧 (Ingress Frame)**：当一个以太网帧进入交换机端口时，交换机会根据该端口所属的 VLAN ID，在帧头中插入一个 802.1Q 标签（如果该帧需要跨多个 VLAN 传输或前往其他 VLAN 感知设备）。
    *   **出站帧 (Egress Frame)**：当一个以太网帧从交换机端口发出时，交换机会检查端口类型。如果是连接到终端设备的接入端口，在发出前会移除 VLAN 标签，确保终端设备接收到标准的以太网帧；如果是连接到其他交换机或路由器的干道端口，帧会带着 VLAN 标签发出。
4.  **转发决策**：交换机内部根据 VLAN ID 和 MAC 地址表来进行二层转发决策。来自 VLAN A 的帧只会被转发到 VLAN A 内部的端口，而不会转发到 VLAN B 的端口，除非通过三层路由设备。

## 四、VLAN 标记 (VLAN Tagging) - IEEE 802.1Q

IEEE 802.1Q 是目前最广泛采用的 VLAN 标记标准。它在标准的以太网帧头中插入了一个 4 字节的标签 (Tag)。

### 802.1Q 标签结构

原始以太网帧：
`目的MAC | 源MAC | 类型/长度 | 数据 | FCS`

带有 802.1Q 标签的以太网帧：
`目的MAC | 源MAC | TPID | TCI | 类型/长度 | 数据 | FCS`

其中：

*   **TPID (Tag Protocol Identifier - 2 字节)**：通常固定为 `0x8100`，表示这是一个 802.1Q 标记帧。
*   **TCI (Tag Control Information - 2 字节)**：
    *   **Priority (3 bits)**：也称作 PCP (Priority Code Point)，用于 QoS (服务质量) 优先级，0-7，最高优先权为 7。
    *   **DEI (Drop Eligible Indicator - 1 bit)**：当网络拥塞时，路由器可以选择性丢弃带有 DEI = 1 的帧。
    *   **VLAN ID (VID - 12 bits)**：这是最重要的部分，表示帧所属的 VLAN 编号。可表示 2^12 = 4096 个 VLAN (0 和 4095 通常保留，所以实际可用 1-4094)。

## 五、VLAN 端口模式

交换机端口（接口）根据其在 VLAN 环境中的角色，可以配置为不同的模式。

### 5.1 Access Port (接入端口 / Access Mode)

*   **特点**：
    *   属于且**只能属于一个 VLAN**。
    *   连接**终端设备**，如 PC、服务器、打印机、IP 电话等。
    *   不发送/接收带 VLAN 标签的帧。当数据进入端口时，交换机为其添加所属 VLAN 的标签；当数据离开端口时，交换机去除标签。终端设备对此过程**无感知**。
*   **用途**：隔离终端用户流量。

### 5.2 Trunk Port (干道端口 / Trunk Mode)

*   **特点**：
    *   用于**承载多个 VLAN 的流量**。
    *   连接**交换机与交换机**之间，或**交换机与路由器/防火墙**之间。
    *   发送和接收**带 VLAN 标签的帧**。
    *   **Native VLAN (本征 VLAN)**：干道端口可以配置一个“本征 VLAN”。属于本征 VLAN 的流量在干道上传输时**不带标签**。这意味着，如果干道端口接收到一个不带标签的帧，它会将其视为来自本征 VLAN 的流量。两端干道端口的本征 VLAN 必须匹配，否则可能导致通信问题或安全漏洞。
*   **用途**：实现 VLAN 流量在不同网络设备间的透明传输。

{% mermaid %}
graph TD
    subgraph Network A
        A1(PC_VLAN10) --- Access_VLAN10[Access Port VLAN 10]
        A2(PC_VLAN20) --- Access_VLAN20[Access Port VLAN 20]
        Switch_A[Layer 2 Switch A]
        Access_VLAN10 --> Switch_A
        Access_VLAN20 --> Switch_A
    end

    subgraph Network B
        B1(PC_VLAN10) --- Access_VLAN10_B[Access Port VLAN 10]
        B2(PC_VLAN20) --- Access_VLAN20_B[Access Port VLAN 20]
        Switch_B[Layer 2 Switch B]
        Access_VLAN10_B --> Switch_B
        Access_VLAN20_B --> Switch_B
    end

    Switch_A --- Trunk_Port_A["Trunk Port (VLAN 10,20 tagged)"]
    Switch_B --- Trunk_Port_B["Trunk Port (VLAN 10,20 tagged)"]

    Trunk_Port_A -- 802.1Q Tagged Frames --> Trunk_Port_B

    style A1 fill:#D4EDDA,stroke-width:2px,stroke:#28A745;
    style A2 fill:#F8D7DA,stroke-width:2px,stroke:#DC3545;
    style B1 fill:#D4EDDA,stroke-width:2px,stroke:#28A745;
    style B2 fill:#F8D7DA,stroke-width:2px,stroke:#DC3545;
    style Access_VLAN10 stroke-dasharray: 5 5;
    style Access_VLAN20 stroke-dasharray: 5 5;
    style Access_VLAN10_B stroke-dasharray: 5 5;
    style Access_VLAN20_B stroke-dasharray: 5 5;
    style Trunk_Port_A stroke-dasharray: 5 5;
    style Trunk_Port_B stroke-dasharray: 5 5;
    style Switch_A fill:#F9E79F,stroke:#F1C40F,stroke-width:2px;
    style Switch_B fill:#F9E79F,stroke:#F1C40F,stroke-width:2px;
{% endmermaid %}

## 六、VLAN 间路由 (Inter-VLAN Routing)

由于每个 VLAN 都是一个独立的广播域，不同 VLAN 之间的设备不能直接进行二层通信。如果需要实现不同 VLAN 之间的通信，就必须通过**三层设备（路由器或三层交换机）**进行路由。这个过程称为 **VLAN 间路由**。

### 6.1 Router-on-a-Stick (ROAS)

*   **原理**：利用路由器的**一个物理接口**，通过配置**多个逻辑子接口** (Sub-interfaces)，每个子接口配置不同的 IP 地址和 VLAN 封装信息 (802.1Q dot1Q)。
*   **工作机制**：交换机的干道端口连接到路由器的物理接口。当一个 VLAN 的流量需要到达另一个 VLAN 时，流量会通过干道发送到路由器。路由器解封装帧，进行路由查找，然后重新封装到目标 VLAN 的帧中（添加对应 VLAN ID 的标签），再通过同一个物理接口发送回交换机。
*   **优点**：成本低，只需要一个路由器接口。
*   **缺点**：单个物理接口可能成为**性能瓶颈 (单臂路由)**。

### 6.2 Layer 3 Switch (三层交换机)

*   **原理**：三层交换机集成了二层交换和三层路由功能。它可以在内部直接进行 VLAN 间路由，而无需将流量发送到外部路由器。
*   **工作机制**：为每个 VLAN 创建一个 **SVI (Switch Virtual Interface - 虚拟交换接口)**，并为其分配 IP 地址。三层交换机可以直接根据目的 IP 地址在内部进行路由查找和数据包转发。
*   **优点**：路由速度快，大容量，低延迟，因为路由是在硬件中完成的。
*   **缺点**：成本相对较高。

{% mermaid %}
graph TD
    User_VLAN10(PC VLAN 10) --- Access10[Access Port VLAN 10]
    User_VLAN20(PC VLAN 20) --- Access20[Access Port VLAN 20]
    User_VLAN30(PC VLAN 30) --- Access30[Access Port VLAN 30]

    Access10 --> L2Switch[Layer 2 交换机]
    Access20 --> L2Switch
    Access30 --> L2Switch

    L2Switch --- Trunk["Trunk Port (连接路由器)"]
    Trunk --- RouterPhysical[路由器物理接口]

    subgraph Router
        RouterPhysical --> RouterSub10[子接口 GigabitEthernet0/0.10, VLAN 10 SVI]
        RouterPhysical --> RouterSub20[子接口 GigabitEthernet0/0.20, VLAN 20 SVI]
        RouterPhysical --> RouterSub30[子接口 GigabitEthernet0/0.30, VLAN 30 SVI]
        RouterSub10 --- RouterL3[路由器处理路由]
        RouterSub20 --- RouterL3
        RouterSub30 --- RouterL3
    end

    RouterPhysical -- 802.1Q Tagged Frames --> Trunk
{% endmermaid %}

## 七、配置示例 (Cisco IOS CLI)

以下是一些基于 Cisco IOS 命令行的典型 VLAN 配置示例。

### 7.1 交换机 VLAN 配置

```
// 创建 VLAN 并命名
Switch>enable
Switch#configure terminal
Switch(config)#vlan 10
Switch(config-vlan)#name Sales_Dept
Switch(config-vlan)#exit
Switch(config)#vlan 20
Switch(config-vlan)#name IT_Dept
Switch(config-vlan)#exit

// 配置 Access 端口
Switch(config)#interface FastEthernet0/1 // 或 GigabitEthernet0/1
Switch(config-if)#switchport mode access
Switch(config-if)#switchport access vlan 10 // 将此端口分配给 VLAN 10
Switch(config-if)#exit

Switch(config)#interface FastEthernet0/2
Switch(config-if)#switchport mode access
Switch(config-if)#switchport access vlan 20 // 将此端口分配给 VLAN 20
Switch(config-if)#exit

// 配置 Trunk 端口
// Trunke 端口通常用于连接另一个交换机或路由器
Switch(config)#interface GigabitEthernet0/1 // 连接路由器的端口
Switch(config-if)#switchport mode trunk
Switch(config-if)#switchport trunk encapsulation dot1q // 多数现代交换机默认此封装，但明确指定更好
Switch(config-if)#switchport trunk allowed vlan 10,20 // 允许 VLAN 10 和 20 的流量通过此干道
Switch(config-if)#switchport trunk native vlan 99 // (可选) 配置本征 VLAN，不带标签的流量属于 VLAN 99
Switch(config-if)#exit

// 查看 VLAN 配置
Switch#show vlan brief
Switch#show interfaces trunk
Switch#show running-config interface FastEthernet0/1
```

### 7.2 路由器间 VLAN 路由 (Router-on-a-Stick)

假设路由器接口是 `GigabitEthernet0/0`，连接到交换机的 Trunk 端口。

```
// 路由器配置
Router>enable
Router#configure terminal

// 配置物理接口为 no shutdown，不分配 IP 地址
Router(config)#interface GigabitEthernet0/0
Router(config-if)#no ip address
Router(config-if)#no shutdown
Router(config-if)#exit

// 配置 VLAN 10 的子接口
Router(config)#interface GigabitEthernet0/0.10
Router(config-subif)#encapsulation dot1Q 10 // 指定此子接口处理 VLAN ID 为 10 的流量
Router(config-subif)#ip address 192.168.10.1 255.255.255.0 // 为 VLAN 10 设置网关 IP
Router(config-subif)#exit

// 配置 VLAN 20 的子接口
Router(config)#interface GigabitEthernet0/0.20
Router(config-subif)#encapsulation dot1Q 20 // 指定此子接口处理 VLAN ID 为 20 的流量
Router(config-subif)#ip address 192.168.20.1 255.255.255.0 // 为 VLAN 20 设置网关 IP
Router(config-subif)#exit

// 查看路由器接口状态
Router#show ip interface brief
Router#show running-config interface GigabitEthernet0/0
```

## 八、VLAN 的优缺点

### 8.1 优点：

1.  **增强了网络安全性**：通过逻辑隔离，限制了攻击范围。
2.  **提高了网络性能**：缩小广播域，减少广播风暴。
3.  **简化了网络管理**：逻辑分区使得网络重构和故障排除更容易。
4.  **节约了网络硬件成本**：提高了物理交换机端口的利用率。
5.  **增强了灵活性**：用户和设备可以独立于物理位置进行组织。

### 8.2 缺点与挑战：

1.  **增加了配置复杂性**：需要正确配置交换机端口和 VLAN 路由，任何错误都可能导致通信故障。
2.  **“VLAN Hopping”等安全风险**：如果配置不当（例如不安全的本征 VLAN 默认设置），攻击者可能利用 VLAN 跳跃技术从一个 VLAN 渗透到另一个 VLAN。
3.  **单点故障**：Router-on-a-Stick 模式下，物理接口或路由器是瓶颈，一旦故障，多个 VLAN 间的通信会中断。
4.  **广播域仍有**：虽然缩小了广播域，但 VLAN 内部仍然存在广播，广播仍需控制。
5.  **设计挑战**：大型网络的 VLAN 规划需要深思熟虑，包括 VLAN ID 分配、IP 地址规划、端口分配等。

## 九、总结

VLAN 技术是现代企业网络设计中的基石，它通过逻辑划分实现网络的隔离和优化，有效解决了传统物理局域网在安全性、性能和管理上的固有挑战。通过理解 VLAN 的工作原理、802.1Q 标记标准以及访问端口和干道端口的区别，网络管理员可以有效地设计和实现一个高性能、高安全性和易于管理的网络环境。随着云计算和虚拟化技术的普及，VLAN 的概念和应用也在不断演进，成为实现更高级网络分段（如微服务网络、SDN）的基础。合理规划和部署 VLAN，是构建健壮和高效网络架构的关键一步。