---
title: Vite配置详解：从入门到精通
date: 2024-01-26 06:24:00
tags:
  - 2024
  - JavaScript
  - TypeScript
  - Vite
  - 项目构建
categories:
  - 前端技术
  - 项目构建
---

> **Vite** 是一款由 Vue.js 创始人尤雨溪开发的现代前端构建工具。它旨在通过**原生 ES 模块**提供极速的开发体验，并在生产环境中利用 **Rollup** 进行高效打包。Vite 的配置非常灵活，可以通过 `vite.config.js`（或 `.ts`）文件进行全面定制。

{% note info %}
“Vite 的配置就是对 `vite.config.js` 文件中导出的配置对象进行操作。这个配置文件提供了对开发服务器、构建过程、插件、别名等一切的控制。”
{% endnote %}

## 一、Vite 配置文件的位置与类型

*   **文件名**：通常是 `vite.config.js`、`vite.config.ts`、`vite.config.mjs` 或 `vite.config.cjs`。建议使用 `.ts` 文件以获得更好的类型提示。
*   **位置**：通常位于项目根目录。

### 1.1 基本结构

Vite 配置文件默认导出一个配置对象。这个对象可以使用 `defineConfig` 辅助函数包裹，以获得更好的类型提示。

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import vue from '@vitejs/plugin-vue';

// https://vitejs.dev/config/
export default defineConfig({
  // 这里是你的 Vite 配置选项
  plugins: [vue()],
  server: {
    port: 3000,
  },
  build: {
    outDir: 'dist',
  }
});
```

## 二、核心配置选项详解

Vite 的配置对象包含多个顶级字段，每个字段控制着不同的方面。

### 2.1 `root`

*   **类型**：`string`
*   **默认值**：`process.cwd()` (项目根目录)
*   **描述**：项目根目录（`index.html` 所在的目录）。也可以通过命令行 `vite --root ./some-dir` 指定。

### 2.2 `base`

*   **类型**：`string`
*   **默认值**：`/`
*   **描述**：公共基础路径。
    *   **开发环境**：在开发服务器上，资源会从 `http://localhost:port/` 加载。如果你需要部署在一个子路径下，如 `example.com/my-app/`，则 `base` 应该设置为 `/my-app/`。
    *   **生产环境**：用于打包后的资源路径。

### 2.3 `mode`

*   **类型**：`string`
*   **默认值**：
    *   开发环境：`development`
    *   生产环境：`production`
*   **描述**：指定项目运行的模式。这会影响 `import.meta.env.MODE` 的值。

### 2.4 `plugins`

*   **类型**：`Array<PluginOption | PluginOption[]>`
*   **描述**：要使用的 Vite 插件数组。插件是扩展 Vite 功能的主要方式。
*   **示例**：
    ```typescript
    import { defineConfig } from 'vite';
    import vue from '@vitejs/plugin-vue'; // 官方 Vue 插件
    import eslintPlugin from 'vite-plugin-eslint'; // 第三方 ESlint 插件

    export default defineConfig({
      plugins: [
        vue(),
        eslintPlugin({
          include: ['src/**/*.js', 'src/**/*.vue', 'src/**/*.ts'],
          exclude: ['./node_modules/**'],
        }),
      ],
    });
    ```
    **注意**：插件的顺序很重要，通常官方推荐的顺序已经是最优的。

### 2.5 `publicDir`

*   **类型**：`string | false`
*   **默认值**：`'public'`
*   **描述**：用于存放不需要构建处理的静态资源目录。这个目录下的文件会被直接复制到构建输出目录的根目录。
    *   在代码中可以通过 `/文件名.扩展名` 来访问这些文件。
    *   例如，`public/favicon.ico` 在 HTML 中就是 `<link rel="icon" href="/favicon.ico">`。
    *   设置为 `false` 可以禁用此功能。

### 2.6 `resolve`

*   **类型**：`object`
*   **描述**：配置模块解析规则。

#### 2.6.1 `alias`

*   **类型**：`Array<{ find: string | RegExp, replacement: string }>`
*   **描述**：配置路径别名。这在处理深层嵌套的导入路径时非常有用。
*   **示例**：
    ```typescript
    import { defineConfig } from 'vite';
    import { resolve } from 'path'; // NodeJS 路径模块

    export default defineConfig({
      resolve: {
        alias: [
          { find: '@', replacement: resolve(__dirname, 'src') },
          { find: 'components', replacement: resolve(__dirname, 'src/components') },
          // 确保在 TypeScript 中也配置路径别名，在 tsconfig.json 中
          // "paths": { "@/*": ["src/*"], "components/*": ["src/components/*"] }
        ],
      },
    });
    ```

#### 2.6.2 `dedupe`

*   **类型**：`string[]`
*   **描述**：强制预绑定（预优化）的依赖。可以解决某些库在同一项目中出现多个实例的问题。

#### 2.6.3 `extensions`

*   **类型**：`string[]`
*   **默认值**：`['.mjs', '.js', '.ts', '.jsx', '.tsx', '.json', '.vue']`
*   **描述**：导入时会尝试的扩展名列表。

### 2.7 `css`

*   **类型**：`object`
*   **描述**：配置 CSS 相关的选项。

#### 2.7.1 `preprocessorOptions`

*   **类型**：`Record<string, object>`
*   **描述**：指定 CSS 预处理器的选项。
*   **示例**：
    ```typescript
    export default defineConfig({
      css: {
        preprocessorOptions: {
          scss: {
            additionalData: `@import "@/styles/variables.scss";`, // 全局引入 SCSS 变量
          },
          less: {
            javascriptEnabled: true, // 允许 Less 中使用 JavaScript
          },
        },
      },
    });
    ```

#### 2.7.2 `modules`

*   **类型**：`CSSModulesOptions`
*   **描述**：配置 CSS Modules 的行为。

#### 2.7.3 `postcss`

*   **类型**：`string | (postcss.ProcessOptions & { plugins?: (postcss.Plugin | string)[] })`
*   **描述**：自定义 PostCSS 配置。

### 2.8 `json`

*   **类型**：`object`
*   **描述**：配置 JSON 导入的行为。

#### 2.8.1 `stringify`

*   **类型**：`boolean`
*   **默认值**：`false`
*   **描述**：导入的 JSON 会被字符串化为 `export default JSON.parse("...")`。这会禁用命名导入，但可以提供更好的性能。

### 2.9 `esbuild`

*   **类型**：`ESBuildOptions | false`
*   **描述**：配置 `esbuild` 转换选项。Vite 使用 `esbuild` 进行 JavaScript/TypeScript 的语法转换和压缩。
*   **示例**：
    ```typescript
    export default defineConfig({
      esbuild: {
        jsxFactory: 'h',      // JSX 的工厂函数
        jsxFragment: 'Fragment', // JSX 的片段
        // 更多 esbuild 选项，参考其文档
      },
    });
    ```
    设置为 `false` 可以禁用 `esbuild`（不推荐）。

### 2.10 `server`

*   **类型**：`object`
*   **描述**：配置开发服务器选项。

#### 2.10.1 `host`

*   **类型**：`string | boolean`
*   **默认值**：`'localhost'`
*   **描述**：指定服务器监听的 IP 地址。
    *   `true`：监听所有地址，包括局域网和公共地址（例如 `0.0.0.0`）。
    *   `false`：使用 `localhost`。
    *   `'0.0.0.0'` 或 `true` 允许通过局域网 IP 访问。

#### 2.10.2 `port`

*   **类型**：`number`
*   **默认值**：`5173` (Vite 3+), `3000` (Vite 2)
*   **描述**：指定开发服务器的端口。

#### 2.10.3 `strictPort`

*   **类型**：`boolean`
*   **默认值**：`false`
*   **描述**：如果端口已被占用，是否严格退出。`false` 会自动尝试下一个可用端口。

#### 2.10.4 `https`

*   **类型**：`boolean | https.ServerOptions`
*   **默认值**：`false`
*   **描述**：启用 TLS + HTTP/2。可以传入 HTTPS 证书选项。

#### 2.10.5 `open`

*   **类型**：`string | boolean`
*   **默认值**：`false`
*   **描述**：服务器启动时自动在浏览器中打开。
    *   `true`：打开项目根目录。
    *   `string`：指定要打开的 URL 路径 (例如 `/docs/index.html`)。

#### 2.10.6 `proxy`

*   **类型**：`Record<string, string | ProxyOptions>`
*   **描述**：配置自定义代理规则。这对于跨域请求非常有用。
*   **示例**：
    ```typescript
    export default defineConfig({
      server: {
        proxy: {
          '/api': {
            target: 'http://localhost:8000', // 后端 API 地址
            changeOrigin: true,            // 改变源（重要）
            rewrite: (path) => path.replace(/^\/api/, ''), // 重写路径, 去掉 '/api'
          },
          // 多个代理规则
          '/another-api': {
            target: 'http://another-backend.com',
            changeOrigin: true,
            // ...
          },
        },
      },
    });
    ```

#### 2.10.7 `cors`

*   **类型**：`boolean | CorsOptions`
*   **默认值**：`false`
*   **描述**：配置 CORS。

### 2.11 `build`

*   **类型**：`object`
*   **描述**：配置生产环境构建选项。`build` 下的选项都会直接传递给 Rollup。

#### 2.11.1 `target`

*   **类型**：`string | string[]`
*   **默认值**：`'modules'`
*   **描述**：`esbuild` 转换的最低目标浏览器版本（例如 `'es2015'`、`['chrome58', 'firefox57']`）。

#### 2.11.2 `outDir`

*   **类型**：`string`
*   **默认值**：`'dist'`
*   **描述**：指定打包输出目录。

#### 2.11.3 `assetsDir`

*   **类型**：`string`
*   **默认值**：`'assets'`
*   **描述**：指定静态资源（图片、字体等）的输出目录，相对于 `outDir`。

#### 2.11.4 `assetsInlineLimit`

*   **类型**：`number`
*   **默认值**：`4096` (4KB)
*   **描述**：小于此阈值的导入资源将内联为 base64 URLs。

#### 2.11.5 `cssCodeSplit`

*   **类型**：`boolean`
*   **默认值**：`true`
*   **描述**：如果为 `true`，CSS 将会按异步模块的依赖在它们对应的块中进行代码分割。

#### 2.11.6 `sourcemap`

*   **类型**：`boolean | 'inline' | 'hidden'`
*   **默认值**：`false`
*   **描述**：是否生成 `sourcemap`。

#### 2.11.7 `minify`

*   **类型**：`boolean | 'terser' | 'esbuild'`
*   **默认值**：`'esbuild'`
*   **描述**：指定是否压缩代码。
    *   `'terser'`：使用 `terser` 进行压缩，功能更强大，但速度稍慢。
    *   `'esbuild'`：使用 `esbuild` 进行压缩，速度较快，但压缩率可能略低一点。
    *   `false`：不压缩。

#### 2.11.8 `rollupOptions`

*   **类型**：`RollupOptions` (来自 Rollup 库的类型)
*   **描述**：直接传递给 Rollup 的额外选项。用于更高级的打包定制。
*   **示例**：
    ```typescript
    export default defineConfig({
      build: {
        rollupOptions: {
          output: {
            manualChunks(id) {
              if (id.includes('node_modules')) {
                // 将所有 node_modules 依赖打包到 vender.js
                return 'vendor';
              }
            },
            // 控制 js 和 css 文件的命名
            entryFileNames: 'assets/[name]-[hash].js',
            chunkFileNames: 'assets/[name]-[hash].js',
            assetFileNames: 'assets/[name]-[hash].[ext]',
          },
        },
      },
    });
    ```

### 2.12 `define`

*   **类型**：`Record<string, string>`
*   **描述**：定义全局常量替换。键会被自动字符串化。
*   **示例**：
    ```typescript
    export default defineConfig({
      define: {
        __APP_VERSION__: JSON.stringify('1.0.0'), // 注入应用版本号
        'process.env.NODE_ENV': JSON.stringify('production'), // 兼容旧代码
      },
    });
    ```

### 2.13 `envDir`

*   **类型**：`string`
*   **默认值**：`root`
*   **描述**：加载 `.env` 文件的目录。

### 2.14 `optimizeDeps`

*   **类型**：`DepOptimizationOptions`
*   **描述**：配置依赖预构建（Dependency Pre-Bundling）选项。Vite 在开发服务器启动时会预构建 `node_modules` 中的 CommonJS/UMD 模块为 ES 模块，以加速页面加载。

#### 2.14.1 `include`

*   **类型**：`string[]`
*   **描述**：强制预构建的依赖包。
    *   某些 ESM 兼容性较差的库可能需要手动添加到这里。
    *   例如：`['lodash']`

#### 2.14.2 `exclude`

*   **类型**：`string[]`
*   **描述**：从预构建中排除的依赖包。
    *   如果你确定某个库已经是纯 ESM 并且不需要预构建，可以将其排除。

#### 2.14.3 `entries`

*   **类型**：`string | string[]`
*   **描述**：指定分析依赖的入口文件。默认会分析 `index.html`。

## 三、环境变量

Vite 通过 `import.meta.env` 对象暴露环境变量。

*   `import.meta.env.MODE`：当前模式 (`development` 或 `production`)。
*   `import.meta.env.BASE_URL`：配置的 `base` 公共基础路径。
*   `import.meta.env.PROD`：是否在生产环境。
*   `import.meta.env.DEV`：是否在开发环境。
*   以 `VITE_` 开头的自定义环境变量：例如在 `.env` 文件中定义 `VITE_API_URL=http://api.example.com`，则可以通过 `import.meta.env.VITE_API_URL` 访问。

```typescript
// vite.config.ts 可以根据模式加载不同的配置
import { defineConfig, loadEnv } from 'vite';

export default defineConfig(({ command, mode }) => {
  // 根据当前工作目录中的 `mode` 加载 .env 文件
  // 设置 `process.env` 的键值对
  const env = loadEnv(mode, process.cwd(), ''); // 第三个参数是前缀，'' 表示加载所有

  return {
    // vite 配置
    define: {
      __APP_ENV__: JSON.stringify(env.APP_ENV), // 可以将环境变量注入到代码中
    },
    // 根据 mode 条件性配置
    server: {
      port: (mode === 'development') ? 3000 : undefined,
    }
  };
});
```

## 四、条件式配置

Vite 配置文件可以导出一个函数，该函数接收 `command` 和 `mode` 参数，允许你根据不同的环境或命令返回不同的配置对象。

*   `command`：`'serve'` (开发环境) 或 `'build'` (生产环境)。
*   `mode`：`development` 或 `production`，或通过 `--mode` 参数指定。

```typescript
// vite.config.ts
import { defineConfig } from 'vite';

export default defineConfig(({ command, mode }) => {
  if (command === 'serve') {
    // 开发环境专用配置
    return {
      server: {
        open: true,
        proxy: {
          '/api': 'http://localhost:8000',
        },
      },
      plugins: [/* dev plugins */],
    };
  } else {
    // `command === 'build'`
    // 生产环境专用配置
    return {
      build: {
        sourcemap: false,
        minify: 'terser',
        // ...
      },
      plugins: [/* prod plugins */],
    };
  }
});
```

## 五、总结

Vite 的配置文件 `vite.config.js` (`.ts`等) 是定制整个构建和开发流程的控制中心。通过对 `plugins`、`server`、`build`、`resolve` 等核心选项的灵活配置，可以满足绝大多数前端项目的需求。

*   **原生 ES 模块**：理解 Vite 在开发模式下直接利用浏览器原生 ES 模块的特性，有助于理解其极速启动的原因。
*   **Rollup 生产打包**：生产构建时，Vite 内部使用 Rollup，因此其许多 `build` 选项都直接映射到 Rollup 的配置。
*   **插件生态**：Vite 的强大功能很大程度上依赖于其丰富的插件生态。
*   **环境变量**：善用 `import.meta.env` 和 `.env` 文件来管理不同环境下的配置。

熟练掌握 Vite 配置，将大大提升你的开发效率和项目构建质量。