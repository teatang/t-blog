---
title: IPv4 (Internet Protocol version 4) 详解
date: 2024-11-16 06:24:00
tags:
  - 2024
  - 计算机网络
  - 网络技术
categories:
  - 计算机网络
  - 网络技术
---

> **IPv4 (Internet Protocol version 4)** 是互联网协议家族（TCP/IP 协议族）中最核心的协议之一，也是当前互联网上使用最广泛的协议。它位于 OSI 模型的网络层（第三层），负责在复杂的互联网中**数据包的寻址和路由**。IPv4 定义了数据包的格式以及在网络中传输和转发的机制，使得不同网络中的设备能够相互通信。尽管其地址耗尽问题催生了 IPv6，但 IPv4 仍是支撑全球互联网运行的基石。

{% note info %}
核心思想：在互联网这个异构网络中，为每个连接的设备提供一个唯一的逻辑地址，并设计一种数据包转发机制，确保数据能从源头准确无误地传输到目的地。
{% endnote %}
------

## 一、什么是 IPv4？

IPv4 是互联网协议的第四个版本。它是一种**无连接的协议**，意味着每个数据包都独立发送，不保证顺序或可靠性（这些由上层协议如 TCP 负责）。IPv4 的主要职责包括：

*   **寻址 (Addressing)**：为网络上的每个设备分配一个唯一的 32 位数字地址（IP 地址），用于标识设备。
*   **路由 (Routing)**：根据数据包的目的 IP 地址，决定数据包在网络中传输的最佳路径，并将其转发到下一个路由器。
*   **分片 (Fragmentation)**：当数据包大小超过了网络路径中链路的最大传输单元 (MTU) 时，IPv4 会将数据包分割成更小的片段进行传输，并在目的地重新组装。

## 二、IPv4 地址

IPv4 地址是一个 32 位的二进制数字，通常以**点分十进制 (Dotted Decimal Notation)** 的形式表示，例如 `192.168.1.1`。

### 2.1 地址结构

一个 IPv4 地址被分为四个 **八位字节 (octet)**，每个八位字节的取值范围是 0 到 255。

*   **32 位**：这决定了 IPv4 地址空间的总量为 $2^{32} \approx 4.3$ 亿个地址。
*   **点分十进制**：为了方便人类阅读和记忆，我们将 32 位二进制地址每 8 位分为一组，转换为十进制数字，并用点号隔开。

**示例：**
二进制：`11000000.10101000.00000001.00000001`
十进制：`192.168.1.1`

### 2.2 IP 地址的组成：网络部分和主机部分

一个 IP 地址包含两部分信息：

1.  **网络部分 (Network Portion)**：标识设备所属的网络。在同一个网络中的设备，其 IP 地址的网络部分是相同的。
2.  **主机部分 (Host Portion)**：标识网络中的具体设备。在同一个网络中，每台设备的 IP 地址的主机部分是唯一的。

如何区分网络部分和主机部分？这需要**子网掩码 (Subnet Mask)**。

### 2.3 子网掩码 (Subnet Mask)

子网掩码也是一个 32 位的二进制数字，与 IP 地址对应。它的作用是：

*   **网络部分的标识**：子网掩码中，**连续的 1** 对应 IP 地址的**网络部分**。
*   **主机部分的标识**：子网掩码中，**连续的 0** 对应 IP 地址的**主机部分**。

子网掩码通常也以点分十进制表示，例如 `255.255.255.0`。
或者使用 **CIDR (Classless Inter-Domain Routing) 表示法**，即在 IP 地址后面加上斜杠和网络部分的位数，例如 `192.168.1.1/24`。`/24` 表示网络部分有 24 位。

**示例：**
IP 地址：`192.168.1.1`
子网掩码：`255.255.255.0` (CIDR: `/24`)

*   `192.168.1` 是网络部分。
*   `1` 是主机部分。

### 2.4 网络地址和广播地址

在任何一个子网中，有两个特殊的 IP 地址不能分配给主机：

*   **网络地址 (Network Address)**：主机部分全为 0 的地址。它代表整个子网，用于路由表中标识子网。
    *   例如：`192.168.1.0/24` 中的 `192.168.1.0`。
*   **广播地址 (Broadcast Address)**：主机部分全为 1 的地址。向此地址发送的数据包会发送到该子网内的所有设备。
    *   例如：`192.168.1.0/24` 中的 `192.168.1.255`。

### 2.5 IP 地址分类 (历史遗留)

在 CIDR 出现之前，IPv4 地址被划分为不同的类别 (Class A, B, C, D, E)。虽然现在已不再严格使用分类，但了解它们有助于理解网络历史和某些概念：

*   **A 类地址**：网络部分 8 位，主机部分 24 位。 (第一位为 `0`)
    *   `1.0.0.0` - `126.255.255.255`
    *   默认子网掩码：`255.0.0.0` (`/8`)
    *   适用于大型网络。
*   **B 类地址**：网络部分 16 位，主机部分 16 位。 (前两位为 `10`)
    *   `128.0.0.0` - `191.255.255.255`
    *   默认子网掩码：`255.255.0.0` (`/16`)
    *   适用于中型网络。
*   **C 类地址**：网络部分 24 位，主机部分 8 位。 (前三位为 `110`)
    *   `192.0.0.0` - `223.255.255.255`
    *   默认子网掩码：`255.255.255.0` (`/24`)
    *   适用于小型网络。
*   **D 类地址**：组播地址 (Multicast)。 (前四位为 `1110`)
    *   `224.0.0.0` - `239.255.255.255`
*   **E 类地址**：保留地址，用于研究。 (前四位为 `1111`)
    *   `240.0.0.0` - `255.255.255.255`

### 2.6 私有 IP 地址和公共 IP 地址

为了缓解 IPv4 地址枯竭问题，IETF 定义了以下私有 IP 地址范围，这些地址只能在**本地局域网 (LAN)** 内部使用，不能在互联网上直接路由。

*   **A 类私有地址**：`10.0.0.0` - `10.255.255.255` (即 `10.0.0.0/8`)
*   **B 类私有地址**：`172.16.0.0` - `172.31.255.255` (即 `172.16.0.0/12`)
*   **C 类私有地址**：`192.168.0.0` - `192.168.255.255` (即 `192.168.0.0/16`)

**公共 IP 地址 (Public IP Address)** 则是由 ISP (互联网服务提供商) 分配的，可以在互联网上直接访问和路由的全球唯一地址。

**NAT (Network Address Translation - 网络地址转换)** 技术允许多个使用私有 IP 地址的设备共享一个或少数几个公共 IP 地址访问互联网。

### 2.7 特殊的 IPv4 地址

*   **`0.0.0.0`**：
    *   在路由表中，表示**默认路由**，即“任何地址”。
    *   在服务器监听端口时，表示“监听所有可用接口上的指定端口”。
*   **`127.0.0.1`**：**回环地址 (Loopback Address)**。用于指代本机，通常用于测试网络服务。
*   **`255.255.255.255`**：受限广播地址，用于向当前网络发送广播，但不会被路由器转发。

## 三、IPv4 数据报文格式

IPv4 数据报文由**头部 (Header)** 和**数据部分 (Payload/Data)** 组成。头部包含控制信息，数据部分是上层协议（如 TCP、UDP）的数据。

{% mermaid %}
graph TD
    A[IPv4 数据报文] --> B["IPv4 头部 (Header)"]
    A --> C["数据部分 (Payload)"]

    subgraph "IPv4 头部 (20-60 字节)"
        B1["版本 (4 bits) \n IHL (4 bits)"]
        B2["服务类型 (8 bits)"]
        B3["总长度 (16 bits)"]
        B4["标识 (16 bits)"]
        B5["标志 (3 bits) \n 片偏移 (13 bits)"]
        B6["生存时间 (TTL - 8 bits)"]
        B7["协议 (8 bits)"]
        B8["头部校验和 (16 bits)"]
        B9["源 IP 地址 (32 bits)"]
        B10["目的 IP 地址 (32 bits)"]
        B11["选项 (0-40 字节)"]
        B12["填充 (Padding)"]
    end

    B1 --- B2 --- B3
    B4 --- B5 --- B6
    B7 --- B8 --- B9
    B10 --- B11 --- B12
{% endmermaid %}

**IPv4 头部字段解释：**

*   **版本 (Version)** (4 bits)：永远是 `0100`，表示 IPv4。
*   **IHL (Internet Header Length)** (4 bits)：IPv4 头部长度，以 32 位字 (4 字节) 为单位。最小值是 5 (20 字节)，最大值是 15 (60 字节)。
*   **服务类型 (Type of Service/DSCP)** (8 bits)：用于 QoS (服务质量)。
*   **总长度 (Total Length)** (16 bits)：整个 IPv4 数据报文的长度（头部 + 数据），以字节为单位。最大长度为 65535 字节。
*   **标识 (Identification)** (16 bits)：用于唯一标识一个原始数据报文。当数据报文被分片时，所有片段都使用相同的标识号，以便在目的地正确重组。
*   **标志 (Flags)** (3 bits)：
    *   第 0 位（Reserved）：保留，必须为 0。
    *   第 1 位（Don't Fragment - DF）：如果设置为 1，则表示该数据报文不允许被分片。如果路由器必须分片才能转发，就会丢弃该数据报文并返回一个 ICMP 错误。
    *   第 2 位（More Fragments - MF）：如果设置为 1，表示后面还有该数据报文的更多片段。最后一个片段的 MF 位为 0。
*   **片偏移 (Fragment Offset)** (13 bits)：表示该片段在原始数据报文中的相对位置，以 8 字节为单位。
*   **生存时间 (Time To Live - TTL)** (8 bits)：数据报文在网络中可以经过的最大跳数（路由器数）。每经过一个路由器，TTL 值减 1。当 TTL 减到 0 时，路由器会丢弃该数据报文并返回一个 ICMP 错误，防止数据报文在网络中无限循环。
*   **协议 (Protocol)** (8 bits)：标识数据部分承载的上层协议类型，例如：
    *   `1`：ICMP (Internet Control Message Protocol)
    *   `6`：TCP (Transmission Control Protocol)
    *   `17`：UDP (User Datagram Protocol)
*   **头部校验和 (Header Checksum)** (16 bits)：仅对 IPv4 头部进行校验，确保头部在传输过程中没有损坏。每经过一个路由器，TTL 会改变，校验和也必须重新计算。
*   **源 IP 地址 (Source IP Address)** (32 bits)：发送数据报文的设备的 IP 地址。
*   **目的 IP 地址 (Destination IP Address)** (32 bits)：接收数据报文的设备的 IP 地址。
*   **选项 (Options)** (0-40 字节)：不常用，用于扩展 IPv4 头部功能，例如记录路径、时间戳等。
*   **填充 (Padding)**：如果选项字段的长度不足 32 位字的倍数，会用 0 填充到 32 位字的倍数，以保证头部长度是 32 位字的整数倍。

## 四、IP 地址的获取方式

设备获取 IP 地址主要有以下几种方式：

1.  **静态配置 (Static IP)**：手动为设备配置 IP 地址、子网掩码、默认网关和 DNS 服务器。适用于服务器、路由器等需要固定地址的设备。
2.  **DHCP (Dynamic Host Configuration Protocol)**：动态主机配置协议。客户端设备在启动时自动向 DHCP 服务器请求 IP 地址和其他网络配置信息。这是大多数普通用户设备（PC、手机）获取 IP 地址的方式。
3.  **PPPoE (Point-to-Point Protocol over Ethernet)**：以太网上的点对点协议。通常用于 ADSL 或光纤宽带拨号上网，通过用户名和密码进行认证，然后由运营商分配公共 IP 地址。

## 五、IPv4 路由

IP 路由是根据目标 IP 地址选择数据包转发路径的过程。

1.  **直接连接网络**：如果数据包的目的 IP 地址与发送设备在同一个子网内，设备会直接通过二层协议（如 ARP 解析 MAC 地址）将数据包发送给目标设备。
2.  **间接连接网络**：如果目的 IP 地址不在本子网内，发送设备会将数据包发送给**默认网关 (Default Gateway)** (通常是局域网中的路由器)。
3.  **路由器转发**：路由器接收到数据包后，会查询其**路由表 (Routing Table)**。路由表包含了目的地网络和到达该目的地的下一跳 (Next Hop) 地址的映射关系。
    *   如果找到匹配的路由，路由器会将数据包转发给下一跳路由器。
    *   如果找不到特定匹配，路由器会发送给默认路由（如果有配置）。
    *   如果都找不到，数据包将被丢弃。
4.  **TTL 机制**：TTL 字段确保数据包不会在网络中无限循环，一旦 TTL 归零即被丢弃。

{% mermaid %}
graph TD
    ClientA["Client A (192.168.1.10/24)"] --> L2SwitchA[L2 Switch A]
    ServerB["Server B (192.168.1.20/24)"] --> L2SwitchA

    ClientC["Client C (10.0.0.10/8)"] --> L2SwitchB[L2 Switch B]
    ServerD["Server D (10.0.0.20/8)"] --> L2SwitchB

    L2SwitchA --- RouterA["Router A (GW: 192.168.1.1)"]
    L2SwitchB --- RouterB["Router B (GW: 10.0.0.1)"]

    RouterA --- Internet[Internet / Core Router]
    RouterB --- Internet

    subgraph "Network 1 (192.168.1.0/24)"
        ClientA
        ServerB
        L2SwitchA
        RouterA
    end

    subgraph "Network 2 (10.0.0.0/8)"
        ClientC
        ServerD
        L2SwitchB
        RouterB
    end
  
    ClientA -- PING 192.168.1.20 --> ServerB
    ClientA -- PING 10.0.0.10 (跨网络) --> RouterA
    RouterA -- Forward --> Internet
    Internet -- Forward --> RouterB
    RouterB -- Forward --> ClientC
  
    style RouterA fill:#DAE8FC,stroke:#1E90FF,stroke-width:2px;
    style RouterB fill:#DAE8FC,stroke:#1E90FF,stroke-width:2px;
{% endmermaid %}

## 六、IPv4 地址枯竭问题

IPv4 地址空间总共只有约 4.3 亿个地址。随着互联网用户的爆炸式增长以及物联网设备的不断涌现，IPv4 地址的枯竭问题日益严重。虽然 NAT 技术在一定程度上缓解了这个问题，但它并非长久之计，且增加了网络复杂性。

**解决策略：**

1.  **CIDR (Classless Inter-Domain Routing)**：无类别域间路由，取代了传统的 A/B/C 类地址划分，允许更灵活地分配 IP 地址块，有效提高了地址利用率。
2.  **NAT (Network Address Translation)**：网络地址转换，允许多个私有 IP 地址的设备共享少数几个公共 IP 地址访问互联网。
3.  **IPv6 (Internet Protocol version 6)**：提供 128 位地址空间，理论上地址数量为 $2^{128}$，旨在彻底解决 IPv4 地址枯竭问题，并提供更优的功能。目前 IPv4 和 IPv6 正在共存并逐步过渡。

## 七、总结

IPv4 作为互联网的核心协议，成功地支撑了全球信息网络的蓬勃发展。它通过 32 位的逻辑地址和健全的路由机制，实现了全球范围内的设备互联。尽管面临地址枯竭的挑战，并逐渐被 IPv6 所替代，但深入理解 IPv4 的地址结构、子网划分、报文格式和路由原理，依然是所有网络工程师和开发者掌握网络基础知识的基石。在很长一段时间内，IPv4 仍将与 IPv6 并存，共同构成我们所依赖的互联网。