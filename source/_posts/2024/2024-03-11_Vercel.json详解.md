---
title: Vercel.json详解
date: 2024-03-11 06:24:00
tags:
  - 2024
  - Vercel
  - Serverless
  - 云服务
categories:
  - 开发工具
  - 云服务
---

> **`vercel.json`** 是 Vercel 平台用于配置项目部署行为的核心文件。它允许开发者精细地控制构建过程、路由规则、Serverless Functions、环境变量、域名设置等。理解和熟练使用 `vercel.json` 对于优化 Vercel 上的应用性能、实现复杂的路由逻辑和管理部署具有至关重要的作用。

{% note info %}
“The `vercel.json` file is a powerful tool for configuring your Vercel Project. It allows you to customize various aspects of your deployments, from build settings to routing rules and Serverless Functions.” —— Vercel Documentation
{% endnote %}
------

## 一、`vercel.json` 的作用与重要性

`vercel.json` 是一个位于项目根目录的 JSON 配置文件。当您将代码部署到 Vercel 时，Vercel 会读取此文件来获取构建、部署和运行时行为的指示。

**主要作用包括：**

*   **自定义构建过程**: 指定构建命令、输出目录等。
*   **路由重写与重定向**: 实现友好的 URL、A/B 测试、多语言站点的路由等。
*   **Serverless Functions 配置**: 控制函数的运行时、内存、超时、环境变量等。
*   **环境变量管理**: 区分不同环境（开发、预览、生产）的变量。
*   **HTTP 响应头配置**: 增加安全头、缓存控制头等。
*   **域名与别名管理**: 配置自定义域名和别名。
*   **项目类型检测覆盖**: 强制指定项目框架。

## 二、`vercel.json` 结构概览

一个典型的 `vercel.json` 文件可能包含以下顶级字段：

```json
{
  "version": 2,
  "name": "my-vercel-project",
  "builds": [
    // ... 构建配置
  ],
  "routes": [
    // ... 路由规则
  ],
  "env": {
    // ... 环境变量
  },
  "regions": ["sfo1"], // Serverless Functions 部署区域
  "functions": {
    // ... Serverless Functions 特定配置
  },
  "headers": [
    // ... 全局HTTP响应头
  ],
  "cleanUrls": true, // 移除 .html 扩展名
  "rewrites": [
    // ... 重写规则 (routes 数组的简化语法)
  ],
  "redirects": [
    // ... 重定向规则 (routes 数组的简化语法)
  ],
  "trailingSlash": true // URL 末尾是否添加斜杠
}
```

接下来，我们详细讲解一些常用和重要的字段。

## 三、常用配置字段详解

### 1. `version`

*   **类型**: `number`
*   **默认值**: `2`
*   **说明**: 指定 `vercel.json` 配置文件的版本。目前推荐使用 `2`。

### 2. `name`

*   **类型**: `string`
*   **说明**: 可选字段，用于在 Vercel UI 中显示的项目名称。

### 3. `builds` (构建配置)

*   **类型**: `Array<Object>`
*   **说明**: 定义构建步骤和构建器的配置。每个对象代表一个构建器。

    *   `src`: 要处理的源文件或 glob 模式 (例如 `*.js` 或 `api/*.py`)。
    *   `use`: 使用的构建器名称 (例如 `@vercel/static-build`, `@vercel/node`, `@vercel/python`)。
    *   `config`: 传递给构建器的特定配置。

    **示例**:
    ```json
    {
      "builds": [
        {
          "src": "package.json",
          "use": "@vercel/static-build",
          "config": { "distDir": "build" } // 告诉 Vercel 静态文件输出在 build 目录
        },
        {
          "src": "api/**/*.js",
          "use": "@vercel/node"
        }
      ]
    }
    ```
    *   **注意**: 对于 Next.js 项目，通常不需要手动配置 `builds`，Vercel 会自动识别并使用 `@vercel/next` 作为构建器。

### 4. `routes` (路由规则)

*   **类型**: `Array<Object>`
*   **说明**: 这是 `vercel.json` 中最强大的字段之一，允许定义复杂的请求处理逻辑。Vercel 会按序处理这些规则。

    每个路由对象可以包含以下属性：
    *   `src`: 匹配传入请求的路径（正则表达式）。
    *   `dest`: 请求的目标路径（可以包含捕获组）。
    *   `status`: HTTP 状态码 (用于重定向，如 `301`, `302`, `307`, `308`)。
    *   `headers`: 要添加到响应的 HTTP 头部。
    *   `methods`: 匹配的 HTTP 方法 (例如 `["GET", "POST"]`)。
    *   `continue`: 是否继续匹配后续路由规则。
    *   `handle`: 特殊处理类型，如 `filesystem` (忽略文件系统路径)、`rewrite` (重写)、`redirect` (重定向)、`hit` (匹配但不处理)。
    *   `locale`: 匹配特定语言环境。

    **示例**:
    ```json
    {
      "routes": [
        // 重定向 http://example.com/old-path 到 http://example.com/new-path
        { "src": "/old-path", "status": 301, "dest": "/new-path" },

        // 重写 /api/* 到 Serverless Functions 的 /api 目录
        { "src": "/api/(.*)", "dest": "/api/$1" },

        // 匹配所有非文件系统路径，重写到 /index.html (SPA 路由)
        { "src": "/(.*)", "dest": "/index.html", "handle": "filesystem" },

        // 添加安全HTTP头
        {
          "src": "/(.*)",
          "headers": {
            "Content-Security-Policy": "default-src 'self' data: https: "
          },
          "continue": true
        }
      ]
    }
    ```

    *   **优先级**: `routes` 数组中的规则按顺序匹配。一旦一个规则匹配并执行了 `dest` 或 `status` 操作，后续规则通常不再执行（除非设置了 `continue: true`）。
    *   **`rewrites` 和 `redirects` 简化**: 对于简单的重写和重定向，Vercel 提供了 `rewrites` 和 `redirects` 顶级字段，它们的内部实现也是基于 `routes`。

### 5. `env` (环境变量)

*   **类型**: `Object<string, string>`
*   **说明**: 定义部署时注入到构建过程和 Serverless Functions 的环境变量。
*   **注意**: 这些变量仅在部署时有效，不会在客户端代码中暴露。对于客户端环境变量，请在前端框架的配置中处理 (例如 Next.js 的 `NEXT_PUBLIC_*`)。
*   **推荐**: 敏感信息（如 API 密钥）应在 Vercel UI 或 CLI 中作为 Secret 变量管理，而不是直接写入 `vercel.json`。

    **示例**:
    ```json
    {
      "env": {
        "DATABASE_URL": "@my_database_url", // 使用Vercel Secret
        "ANALYTICS_ID": "UA-XXXXX-Y"
      }
    }
    ```

### 6. `functions` (Serverless Functions 特定配置)

*   **类型**: `Object<string, Object>`
*   **说明**: 允许对部署为 Serverless Functions 的特定文件或 glob 模式应用配置。

    *   `memory`: 分配给函数的内存（MB）。
    *   `maxDuration`: 函数允许运行的最长时间（秒）。
    *   `runtime`: 指定函数的运行时版本 (例如 `@vercel/node@20.x`)。
    *   `includeFiles`, `excludeFiles`: 包含或排除特定文件。

    **示例**:
    ```json
    {
      "functions": {
        "api/heavy-task.js": {
          "memory": 1024,
          "maxDuration": 60
        },
        "api/**/*.py": {
          "runtime": "@vercel/python@3.11"
        }
      }
    }
    ```

### 7. `headers` (全局 HTTP 响应头)

*   **类型**: `Array<Object>`
*   **说明**: 定义添加到匹配路由的 HTTP 响应头。常用于缓存控制和安全设置。

    *   `source`: 匹配的 URL 路径。
    *   `headers`: 要添加的 HTTP 头键值对。

    **示例**:
    ```json
    {
      "headers": [
        {
          "source": "/(.*)",
          "headers": [
            { "key": "Cache-Control", "value": "s-maxage=1, stale-while-revalidate" },
            { "key": "X-Frame-Options", "value": "DENY" }
          ]
        }
      ]
    }
    ```

### 8. `rewrites` (重写)

*   **类型**: `Array<Object>`
*   **说明**: 语法更简单的重写规则，与 `routes` 中的重写行为相同，但更简洁。
    *   `source`: 匹配的路径。
    *   `destination`: 重写到的目标路径。

    **示例**:
    ```json
    {
      "rewrites": [
        { "source": "/old-path", "destination": "/new-path" },
        { "source": "/blog/(.*)", "destination": "/posts/$1" }
      ]
    }
    ```

### 9. `redirects` (重定向)

*   **类型**: `Array<Object>`
*   **说明**: 语法更简单的重定向规则。
    *   `source`: 匹配的路径。
    *   `destination`: 重定向到的目标路径。
    *   `permanent`: `true` 表示 308 (永久重定向)，`false` 表示 307 (临时重定向)。

    **示例**:
    ```json
    {
      "redirects": [
        { "source": "/legacy-page", "destination": "/modern-page", "permanent": true },
        { "source": "/old-docs/(.*)", "destination": "https://docs.newsite.com/$1", "permanent": false }
      ]
    }
    ```

### 10. `cleanUrls`

*   **类型**: `boolean`
*   **默认值**: `true`
*   **说明**: 如果设置为 `true`，Vercel 会自动移除 `.html` 文件扩展名 (例如 `/about.html` 变为 `/about`)。

### 11. `trailingSlash`

*   **类型**: `boolean`
*   **默认值**: `false`
*   **说明**: 控制 URL 路径末尾是否强制存在或移除斜杠。
    *   `true`: `/pathname` 将重定向到 `/pathname/`。
    *   `false`: `/pathname/` 将重定向到 `/pathname`。

### 12. `app` (Vercel App Directory 支持)

*   **类型**: `Object`
*   **说明**: 针对 Next.js `app` 目录的特定配置。

    *   `analytics`: 控制 Vercel 性能分析 (Web Analytics) 的收集，例如 `enabled: true`。

## 四、`vercel.json` 最佳实践

*   **从简单开始**: 对于大多数 Next.js 等框架项目，您甚至不需要一个 `vercel.json` 文件，Vercel 会自动处理。
*   **逐步添加配置**: 仅在需要自定义构建、路由或函数行为时才添加和修改 `vercel.json`。
*   **使用 Vercel CLI 本地测试**: 使用 `vercel dev` 命令可以在本地模拟 Vercel 的生产环境，包括 `vercel.json` 中的路由和函数。
*   **版本控制**: 将 `vercel.json` 文件纳入您的 Git 版本控制，确保团队成员和部署环境之间配置的一致性。
*   **利用环境变量和 Secret**: 避免将敏感信息硬编码到 `vercel.json` 中，而是通过 Vercel 的环境变量和 Secret 功能进行管理。
*   **理解路由优先级**: `routes` 数组中的规则按顺序匹配，先匹配的规则会优先执行。仔细测试，避免意外的路由行为。
*   **文档参考**: Vercel 官方文档是学习 `vercel.json` 最新和最详细信息的最佳资源。

## 五、总结

`vercel.json` 是 Vercel 开发者手中的一把瑞士军刀，它赋予了您对基于该平台的应用程序部署行为进行精细控制的能力。无论是实现复杂的路由，优化 Serverless Functions 的性能，还是仅仅为了启用一些安全头，`vercel.json` 都是不可或缺的。掌握它的用法，将使您能够更充分地利用 Vercel 平台的强大功能，构建和部署高性能、高可用的现代化 Web 应用。