<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>前端文件下载的各种方式的详解 | 1024 维度</title><meta name="author" content="TeaTang"><meta name="copyright" content="TeaTang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="在 Web 开发中，文件下载是一个常见且重要的功能。无论是下载用户生成的数据、报告、图片，还是静态资源，前端开发者都需要掌握多种实现文件下载的方法。本文将详细探讨前端实现文件下载的各种技术，包括 HTML 原生方式、JavaScript 编程方式以及涉及服务器端配合的场景。  核心思想：前端文件下载的核心在于如何将文件数据（无论是服务器传输的还是客户端生成的）转化为可供浏览器识别并触发下载操作的">
<meta property="og:type" content="article">
<meta property="og:title" content="前端文件下载的各种方式的详解">
<meta property="og:url" content="https://blog.tbf1211.xx.kg/0c202b3d53be/index.html">
<meta property="og:site_name" content="1024 维度">
<meta property="og:description" content="在 Web 开发中，文件下载是一个常见且重要的功能。无论是下载用户生成的数据、报告、图片，还是静态资源，前端开发者都需要掌握多种实现文件下载的方法。本文将详细探讨前端实现文件下载的各种技术，包括 HTML 原生方式、JavaScript 编程方式以及涉及服务器端配合的场景。  核心思想：前端文件下载的核心在于如何将文件数据（无论是服务器传输的还是客户端生成的）转化为可供浏览器识别并触发下载操作的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-21.jpg">
<meta property="article:published_time" content="2023-02-18T22:24:00.000Z">
<meta property="article:modified_time" content="2026-01-30T03:20:58.323Z">
<meta property="article:author" content="TeaTang">
<meta property="article:tag" content="2023">
<meta property="article:tag" content="Web技术">
<meta property="article:tag" content="HTML">
<meta property="article:tag" content="前端技术">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-21.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "前端文件下载的各种方式的详解",
  "url": "https://blog.tbf1211.xx.kg/0c202b3d53be/",
  "image": "https://blog.tbf1211.xx.kg/img/cover/default_cover-21.jpg",
  "datePublished": "2023-02-18T22:24:00.000Z",
  "dateModified": "2026-01-30T03:20:58.323Z",
  "author": [
    {
      "@type": "Person",
      "name": "TeaTang",
      "url": "https://blog.tbf1211.xx.kg"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon-1.ico"><link rel="canonical" href="https://blog.tbf1211.xx.kg/0c202b3d53be/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.9/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":true,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: TeaTang","link":"链接: ","source":"来源: 1024 维度","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '前端文件下载的各种方式的详解',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="1024 维度" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">535</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">229</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/cover/default_cover-21.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">1024 维度</span></a><a class="nav-page-title" href="/"><span class="site-name">前端文件下载的各种方式的详解</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li><li><a class="site-page child" href="/archives/2026/"><i class="fa-fw fa-solid fa-code-branch"></i><span> 2026</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">前端文件下载的各种方式的详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-02-18T22:24:00.000Z" title="发表于 2023-02-19 06:24:00">2023-02-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF/">前端技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF/Web%E6%8A%80%E6%9C%AF/">Web技术</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p>在 Web 开发中，文件下载是一个常见且重要的功能。无论是下载用户生成的数据、报告、图片，还是静态资源，前端开发者都需要掌握多种实现文件下载的方法。本文将详细探讨前端实现文件下载的各种技术，包括 HTML 原生方式、JavaScript 编程方式以及涉及服务器端配合的场景。</p>
</blockquote>
<div class="note info flat"><p>核心思想：<strong>前端文件下载的核心在于如何将文件数据（无论是服务器传输的还是客户端生成的）转化为可供浏览器识别并触发下载操作的格式（如 <code>Blob</code> 对象或直接的 URL），并通过特定的机制（如 <code>&lt;a&gt;</code> 标签的 <code>download</code> 属性或服务器响应头）来提示浏览器进行下载而非直接显示。</strong></p>
</div>
<hr>
<h2 id="一、文件下载的基础概念"><a href="#一、文件下载的基础概念" class="headerlink" title="一、文件下载的基础概念"></a>一、文件下载的基础概念</h2><p>在深入具体方法之前，我们先理解文件下载的一些基本概念：</p>
<ul>
<li><strong>下载 vs. 显示</strong>：浏览器在处理文件时，会根据 <code>Content-Type</code> 和 <code>Content-Disposition</code> 等 HTTP 响应头来决定是下载文件（保存到本地）还是在浏览器中直接显示（如图片、PDF）。</li>
<li><strong>文件来源</strong>：<ul>
<li><strong>服务器端文件</strong>：文件存储在服务器上，前端通过 URL 请求获取。</li>
<li><strong>客户端生成文件</strong>：文件内容由前端 JavaScript 在运行时动态生成（如导出 CSV、JSON 数据）。</li>
</ul>
</li>
<li><strong>二进制数据 (Blob)</strong>：<code>Blob</code> (Binary Large Object) 是 JavaScript 中表示原始二进制数据的一个对象。它是文件操作的核心，许多下载方法都会涉及到将数据封装成 <code>Blob</code>。</li>
<li><strong>Object URL (Blob URL)</strong>：<code>URL.createObjectURL()</code> 方法会为 <code>Blob</code> 对象创建一个唯一的 URL 字符串，这个 URL 可以被浏览器加载，但它是一个内存中的“伪 URL”，不指向服务器上的文件。</li>
</ul>
<h2 id="二、HTML-原生下载方式"><a href="#二、HTML-原生下载方式" class="headerlink" title="二、HTML 原生下载方式"></a>二、HTML 原生下载方式</h2><h3 id="2-1-标签配合-download-属性"><a href="#2-1-标签配合-download-属性" class="headerlink" title="2.1 &lt;a&gt; 标签配合 download 属性"></a>2.1 <code>&lt;a&gt;</code> 标签配合 <code>download</code> 属性</h3><p>这是最简单、最常用的前端文件下载方式，适用于文件 URL 可直接访问的场景。</p>
<p><strong>定义</strong>：<br><code>&lt;a&gt;</code> 标签的 <code>download</code> 属性指示浏览器下载 URL 指定的资源，而不是导航到它。如果属性值为空，浏览器会根据 URL 自动推断文件名；如果指定了值，则作为建议的文件名。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>下载服务器上的静态文件（如图片、PDF、压缩包）。</li>
<li>下载 <code>data:uri</code> 格式的客户端生成数据（不推荐大文件）。</li>
<li>下载 <code>blob:url</code> 格式的客户端生成数据（后面会详细介绍）。</li>
</ul>
<p><strong>优点</strong>：</p>
<ul>
<li><strong>简单易用</strong>：只需 HTML 标签和属性即可实现。</li>
<li><strong>浏览器原生支持</strong>：兼容性好。</li>
<li><strong>支持跨域下载</strong>：只要 <code>href</code> 指向的资源允许被访问，即使跨域也可以下载，但 <code>download</code> 属性在跨域资源上可能无效或行为不一致（取决于浏览器和服务器响应头）。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>无法处理动态生成内容</strong>：对于纯客户端实时生成的内容，直接用 <code>&lt;a&gt;</code> 标签的 <code>href</code> 属性可能不便，需要结合 JavaScript。</li>
<li><strong>无法直接控制下载进度和错误</strong>：所有下载行为都由浏览器管理。</li>
</ul>
<p><strong>示例</strong>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 下载服务器上的图片 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/path/to/image.jpg&quot;</span> <span class="attr">download</span>=<span class="string">&quot;我的图片.jpg&quot;</span>&gt;</span>下载图片<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 下载服务器上的 PDF 文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/path/to/document.pdf&quot;</span> <span class="attr">download</span>=<span class="string">&quot;项目文档.pdf&quot;</span>&gt;</span>下载 PDF<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 下载文本文件 (使用 data:uri) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;data:text/plain;charset=utf-8,Hello%2C%20World!&quot;</span> <span class="attr">download</span>=<span class="string">&quot;hello.txt&quot;</span>&gt;</span>下载文本<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="三、JavaScript-编程下载方式"><a href="#三、JavaScript-编程下载方式" class="headerlink" title="三、JavaScript 编程下载方式"></a>三、JavaScript 编程下载方式</h2><p>JavaScript 提供了更灵活的文件下载控制能力，尤其适用于客户端动态生成内容或需要更精细控制下载行为的场景。</p>
<h3 id="3-1-基于-Blob-和-Object-URL-下载-客户端生成文件"><a href="#3-1-基于-Blob-和-Object-URL-下载-客户端生成文件" class="headerlink" title="3.1 基于 Blob 和 Object URL 下载 (客户端生成文件)"></a>3.1 基于 Blob 和 Object URL 下载 (客户端生成文件)</h3><p>当文件内容是在客户端由 JavaScript 动态生成时（例如，从 Canvas 导出图片、将 JSON 对象保存为文件），此方法最为常用。</p>
<p><strong>核心概念</strong>：</p>
<ul>
<li><strong><code>Blob</code></strong>：一个包含二进制数据的对象。你可以从字符串、数组、<code>ArrayBuffer</code> 等创建它。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="string">&quot;这是我要下载的文本内容。&quot;</span>], &#123; <span class="attr">type</span>: <span class="string">&quot;text/plain;charset=utf-8&quot;</span> &#125;);</span><br><span class="line"><span class="keyword">const</span> imageBlob = <span class="keyword">new</span> <span class="title class_">Blob</span>([imageData], &#123; <span class="attr">type</span>: <span class="string">&quot;image/png&quot;</span> &#125;); <span class="comment">// imageData 是 ArrayBuffer 或类似数据</span></span><br></pre></td></tr></table></figure></li>
<li><strong><code>URL.createObjectURL(blob)</code></strong>：创建一个 DOMString，其中包含一个 URL，可用于表示 <code>blob</code> 对象中的数据。这个 URL 的生命周期与创建它的文档相关联。</li>
<li><strong><code>URL.revokeObjectURL(objectURL)</code></strong>：释放通过 <code>createObjectURL()</code> 创建的 URL。这非常重要，因为 <code>Blob</code> URL 会占用内存，不及时释放可能导致内存泄漏。</li>
</ul>
<p><strong>实现步骤</strong>：</p>
<ol>
<li>根据要下载的内容创建 <code>Blob</code> 对象。</li>
<li>使用 <code>URL.createObjectURL()</code> 为 <code>Blob</code> 创建一个临时的 Object URL。</li>
<li>创建一个虚拟的 <code>&lt;a&gt;</code> 标签。</li>
<li>将 <code>&lt;a&gt;</code> 标签的 <code>href</code> 设置为 Object URL，<code>download</code> 属性设置为所需的文件名。</li>
<li>模拟点击 <code>&lt;a&gt;</code> 标签来触发下载。</li>
<li>下载完成后，调用 <code>URL.revokeObjectURL()</code> 释放 Object URL。</li>
</ol>
<p><strong>示例 (下载客户端生成的文本文件)</strong>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">downloadClientTextFile</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> textContent = <span class="string">`</span></span><br><span class="line"><span class="string">        这是一个在客户端动态生成的文本文件。</span></span><br><span class="line"><span class="string">        生成时间：<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleString()&#125;</span></span></span><br><span class="line"><span class="string">        内容可以来自任何 JavaScript 变量或操作。</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">    <span class="keyword">const</span> filename = <span class="string">&quot;dynamic_report.txt&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> mimeType = <span class="string">&quot;text/plain;charset=utf-8&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 创建 Blob 对象</span></span><br><span class="line">    <span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([textContent], &#123; <span class="attr">type</span>: mimeType &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 创建 Object URL</span></span><br><span class="line">    <span class="keyword">const</span> objectURL = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 创建虚拟的 &lt;a&gt; 标签</span></span><br><span class="line">    <span class="keyword">const</span> a = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">    a.<span class="property">href</span> = objectURL;</span><br><span class="line">    a.<span class="property">download</span> = filename; <span class="comment">// 设置文件名</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 模拟点击触发下载</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(a); <span class="comment">// 某些浏览器可能要求标签在 DOM 中</span></span><br><span class="line">    a.<span class="title function_">click</span>();</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(a); <span class="comment">// 移除虚拟标签</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 释放 Object URL (非常重要！)</span></span><br><span class="line">    <span class="variable constant_">URL</span>.<span class="title function_">revokeObjectURL</span>(objectURL);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`&quot;<span class="subst">$&#123;filename&#125;</span>&quot; 已成功触发下载。`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用函数触发下载</span></span><br><span class="line"><span class="comment">// downloadClientTextFile();</span></span><br></pre></td></tr></table></figure>

<p><strong>示例 (下载 Canvas 绘制的图片)</strong>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">downloadCanvasImage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>);</span><br><span class="line">    canvas.<span class="property">width</span> = <span class="number">200</span>;</span><br><span class="line">    canvas.<span class="property">height</span> = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">    ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;lightblue&#x27;</span>;</span><br><span class="line">    ctx.<span class="title function_">fillRect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="number">100</span>);</span><br><span class="line">    ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;darkblue&#x27;</span>;</span><br><span class="line">    ctx.<span class="property">font</span> = <span class="string">&#x27;20px Arial&#x27;</span>;</span><br><span class="line">    ctx.<span class="title function_">fillText</span>(<span class="string">&#x27;Hello Canvas!&#x27;</span>, <span class="number">20</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 Canvas 内容导出为 Blob</span></span><br><span class="line">    canvas.<span class="title function_">toBlob</span>(<span class="keyword">function</span>(<span class="params">blob</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!blob) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Canvas to Blob failed.&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> filename = <span class="string">&quot;canvas_image.png&quot;</span>;</span><br><span class="line">        <span class="keyword">const</span> objectURL = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">const</span> a = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        a.<span class="property">href</span> = objectURL;</span><br><span class="line">        a.<span class="property">download</span> = filename;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(a);</span><br><span class="line">        a.<span class="title function_">click</span>();</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(a);</span><br><span class="line">        <span class="variable constant_">URL</span>.<span class="title function_">revokeObjectURL</span>(objectURL);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`&quot;<span class="subst">$&#123;filename&#125;</span>&quot; 已成功触发下载。`</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;image/png&#x27;</span>); <span class="comment">// 指定图片类型</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// downloadCanvasImage();</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-通过-Fetch-XHR-获取服务器文件并下载"><a href="#3-2-通过-Fetch-XHR-获取服务器文件并下载" class="headerlink" title="3.2 通过 Fetch&#x2F;XHR 获取服务器文件并下载"></a>3.2 通过 Fetch&#x2F;XHR 获取服务器文件并下载</h3><p>这是下载服务器上文件（特别是需要认证或动态生成的）的常见和推荐方法。前端通过 <code>fetch</code> 或 <code>XMLHttpRequest</code> 请求文件，然后将响应数据处理成 <code>Blob</code>，最后使用 <code>Blob</code> 下载的方法。</p>
<p><strong>实现步骤</strong>：</p>
<ol>
<li>使用 <code>fetch</code> 或 <code>XMLHttpRequest</code> 发送 HTTP 请求到服务器。</li>
<li>设置 <code>responseType</code> 为 <code>blob</code> 或通过 <code>response.blob()</code> 获取响应体。</li>
<li>从响应头中获取文件名（通常从 <code>Content-Disposition</code>）。</li>
<li>将获取到的 <code>Blob</code> 数据通过 <code>URL.createObjectURL()</code> 转换为 Object URL。</li>
<li>创建虚拟 <code>&lt;a&gt;</code> 标签，设置 <code>href</code> 和 <code>download</code> 属性。</li>
<li>模拟点击触发下载，并释放 Object URL。</li>
</ol>
<p><strong>关键点</strong>：</p>
<ul>
<li><strong><code>Content-Disposition</code> HTTP 响应头</strong>：服务器端应设置此响应头来告知浏览器如何处理文件以及建议的文件名。<ul>
<li><code>attachment</code>：指示浏览器下载文件。</li>
<li><code>filename=&quot;your_file_name.ext&quot;</code>：建议的文件名。</li>
</ul>
</li>
<li><strong><code>Content-Type</code> HTTP 响应头</strong>：指定文件的 MIME 类型。</li>
<li><strong>CORS (跨域资源共享)</strong>：如果前端域名与文件服务器域名不同，需要服务器端正确配置 CORS 响应头（如 <code>Access-Control-Allow-Origin</code>）。</li>
</ul>
<p><strong>Go (Gin) 服务器端示例</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span> <span class="comment">// 用于文件操作</span></span><br><span class="line">	<span class="string">&quot;path/filepath&quot;</span> <span class="comment">// 用于处理文件路径</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	router := gin.Default()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 提供一个简单的 HTML 页面用于测试</span></span><br><span class="line">	router.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.Data(http.StatusOK, <span class="string">&quot;text/html&quot;</span>, []<span class="type">byte</span>(<span class="string">`</span></span><br><span class="line"><span class="string">			&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">			&lt;html lang=&quot;en&quot;&gt;</span></span><br><span class="line"><span class="string">			&lt;head&gt;</span></span><br><span class="line"><span class="string">				&lt;meta charset=&quot;UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">				&lt;title&gt;Download Test&lt;/title&gt;</span></span><br><span class="line"><span class="string">			&lt;/head&gt;</span></span><br><span class="line"><span class="string">			&lt;body&gt;</span></span><br><span class="line"><span class="string">				&lt;h1&gt;Download from Server&lt;/h1&gt;</span></span><br><span class="line"><span class="string">				&lt;button onclick=&quot;downloadServerFile()&quot;&gt;下载服务器文件 (报告)&lt;/button&gt;</span></span><br><span class="line"><span class="string">				&lt;button onclick=&quot;downloadServerImage()&quot;&gt;下载服务器图片&lt;/button&gt;</span></span><br><span class="line"><span class="string">				&lt;script&gt;</span></span><br><span class="line"><span class="string">					async function downloadServerFile() &#123;</span></span><br><span class="line"><span class="string">						try &#123;</span></span><br><span class="line"><span class="string">							const response = await fetch(&#x27;/download/report&#x27;);</span></span><br><span class="line"><span class="string">							if (!response.ok) &#123;</span></span><br><span class="line"><span class="string">								throw new Error(`</span>HTTP <span class="type">error</span>! status: $&#123;response.status&#125;<span class="string">`);</span></span><br><span class="line"><span class="string">							&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">							// 获取 Content-Disposition 头中的文件名</span></span><br><span class="line"><span class="string">							const contentDisposition = response.headers.get(&#x27;Content-Disposition&#x27;);</span></span><br><span class="line"><span class="string">							let filename = &#x27;default_report.txt&#x27;;</span></span><br><span class="line"><span class="string">							if (contentDisposition) &#123;</span></span><br><span class="line"><span class="string">								const filenameMatch = contentDisposition.match(/filename=&quot;?([^&quot;]+)&quot;?/);</span></span><br><span class="line"><span class="string">								if (filenameMatch &amp;&amp; filenameMatch[1]) &#123;</span></span><br><span class="line"><span class="string">									filename = decodeURIComponent(filenameMatch[1]);</span></span><br><span class="line"><span class="string">								&#125;</span></span><br><span class="line"><span class="string">							&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">							const blob = await response.blob();</span></span><br><span class="line"><span class="string">							const objectURL = URL.createObjectURL(blob);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">							const a = document.createElement(&#x27;a&#x27;);</span></span><br><span class="line"><span class="string">							a.href = objectURL;</span></span><br><span class="line"><span class="string">							a.download = filename;</span></span><br><span class="line"><span class="string">							document.body.appendChild(a);</span></span><br><span class="line"><span class="string">							a.click();</span></span><br><span class="line"><span class="string">							document.body.removeChild(a);</span></span><br><span class="line"><span class="string">							URL.revokeObjectURL(objectURL);</span></span><br><span class="line"><span class="string">							console.log(&#x27;Server file downloaded successfully!&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">						&#125; catch (error) &#123;</span></span><br><span class="line"><span class="string">							console.error(&#x27;Download failed:&#x27;, error);</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">					</span></span><br><span class="line"><span class="string">					async function downloadServerImage() &#123;</span></span><br><span class="line"><span class="string">						try &#123;</span></span><br><span class="line"><span class="string">							const response = await fetch(&#x27;/download/image&#x27;);</span></span><br><span class="line"><span class="string">							if (!response.ok) &#123;</span></span><br><span class="line"><span class="string">								throw new Error(`</span>HTTP <span class="type">error</span>! status: $&#123;response.status&#125;<span class="string">`);</span></span><br><span class="line"><span class="string">							&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">							const contentDisposition = response.headers.get(&#x27;Content-Disposition&#x27;);</span></span><br><span class="line"><span class="string">							let filename = &#x27;default_image.png&#x27;;</span></span><br><span class="line"><span class="string">							if (contentDisposition) &#123;</span></span><br><span class="line"><span class="string">								const filenameMatch = contentDisposition.match(/filename=&quot;?([^&quot;]+)&quot;?/);</span></span><br><span class="line"><span class="string">								if (filenameMatch &amp;&amp; filenameMatch[1]) &#123;</span></span><br><span class="line"><span class="string">									filename = decodeURIComponent(filenameMatch[1]);</span></span><br><span class="line"><span class="string">								&#125;</span></span><br><span class="line"><span class="string">							&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">							const blob = await response.blob();</span></span><br><span class="line"><span class="string">							const objectURL = URL.createObjectURL(blob);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">							const a = document.createElement(&#x27;a&#x27;);</span></span><br><span class="line"><span class="string">							a.href = objectURL;</span></span><br><span class="line"><span class="string">							a.download = filename;</span></span><br><span class="line"><span class="string">							document.body.appendChild(a);</span></span><br><span class="line"><span class="string">							a.click();</span></span><br><span class="line"><span class="string">							document.body.removeChild(a);</span></span><br><span class="line"><span class="string">							URL.revokeObjectURL(objectURL);</span></span><br><span class="line"><span class="string">							console.log(&#x27;Server image downloaded successfully!&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">						&#125; catch (error) &#123;</span></span><br><span class="line"><span class="string">							console.error(&#x27;Download failed:&#x27;, error);</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">				&lt;/script&gt;</span></span><br><span class="line"><span class="string">			&lt;/body&gt;</span></span><br><span class="line"><span class="string">			&lt;/html&gt;</span></span><br><span class="line"><span class="string">		`</span>))</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 模拟生成报告文件</span></span><br><span class="line">	router.GET(<span class="string">&quot;/download/report&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		<span class="comment">// 模拟从数据库获取或动态生成内容</span></span><br><span class="line">		content := []<span class="type">byte</span>(<span class="string">&quot;This is a simulated report content.\nGenerated at: &quot;</span> + fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, os.Getenv(<span class="string">&quot;TZ&quot;</span>) == <span class="string">&quot;&quot;</span> ? <span class="string">&quot;Local Time&quot;</span> : time.Now().UTC().Format(time.RFC3339)))</span><br><span class="line">		filename := <span class="string">&quot;dynamic_report.txt&quot;</span></span><br><span class="line"></span><br><span class="line">		c.Header(<span class="string">&quot;Content-Disposition&quot;</span>, fmt.Sprintf(<span class="string">&quot;attachment; filename=\&quot;%s\&quot;&quot;</span>, filename))</span><br><span class="line">		c.Data(http.StatusOK, <span class="string">&quot;text/plain&quot;</span>, content) <span class="comment">// Content-Type 设为 text/plain</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 模拟提供图片文件</span></span><br><span class="line">	router.GET(<span class="string">&quot;/download/image&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		<span class="comment">// 实际项目中可以从文件系统读取或动态生成图片数据</span></span><br><span class="line">		<span class="comment">// 这里为了演示，我们假设有一个名为 `test_image.png` 的文件在当前目录</span></span><br><span class="line">		<span class="comment">// 请确保在运行前创建一个 `test_image.png` 文件，例如一个空白图片</span></span><br><span class="line">		imagePath := filepath.Join(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;test_image.png&quot;</span>) <span class="comment">// 假设图片在根目录</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> _, err := os.Stat(imagePath); os.IsNotExist(err) &#123;</span><br><span class="line">			<span class="comment">// 如果文件不存在，可以返回一个默认图片或错误</span></span><br><span class="line">			log.Printf(<span class="string">&quot;Image file not found: %s&quot;</span>, imagePath)</span><br><span class="line">			c.String(http.StatusNotFound, <span class="string">&quot;Image file not found&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		imageData, err := os.ReadFile(imagePath)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;Failed to read image file: %v&quot;</span>, err)</span><br><span class="line">			c.String(http.StatusInternalServerError, <span class="string">&quot;Failed to read image&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		filename := <span class="string">&quot;my_downloaded_image.png&quot;</span></span><br><span class="line">		c.Header(<span class="string">&quot;Content-Disposition&quot;</span>, fmt.Sprintf(<span class="string">&quot;attachment; filename=\&quot;%s\&quot;&quot;</span>, filename))</span><br><span class="line">		c.Data(http.StatusOK, <span class="string">&quot;image/png&quot;</span>, imageData) <span class="comment">// Content-Type 设为 image/png</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 启动 HTTP 服务器</span></span><br><span class="line">	router.Run(<span class="string">&quot;:8080&quot;</span>) <span class="comment">// 监听 8080 端口</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：为了运行 Go Gin 示例，请确保您的 Go 环境已安装 Gin (<code>go get -u github.com/gin-gonic/gin</code>)，并在项目根目录下创建一个名为 <code>test_image.png</code> 的文件（可以是一个空白图片或任意 PNG 图片）。</p>
<h3 id="3-3-表单提交下载-非主流，特定场景"><a href="#3-3-表单提交下载-非主流，特定场景" class="headerlink" title="3.3 &lt;form&gt; 表单提交下载 (非主流，特定场景)"></a>3.3 <code>&lt;form&gt;</code> 表单提交下载 (非主流，特定场景)</h3><p>在某些特定场景下，尤其是当下载需要通过 POST 请求提交大量参数时，可以使用表单提交来触发下载。</p>
<p><strong>工作原理</strong>：</p>
<ol>
<li>创建一个隐藏的 <code>&lt;form&gt;</code> 元素。</li>
<li>设置 <code>form</code> 的 <code>action</code> 为下载文件的 URL，<code>method</code> 为 <code>POST</code>。</li>
<li>添加隐藏的 <code>&lt;input&gt;</code> 元素来传递参数。</li>
<li>设置 <code>form</code> 的 <code>target</code> 属性为 <code>_blank</code> 或一个隐藏的 <code>&lt;iframe&gt;</code>，以避免刷新当前页面。</li>
<li>提交表单。</li>
<li>服务器响应 <code>Content-Disposition: attachment</code> 头，浏览器会触发下载。</li>
</ol>
<p><strong>优点</strong>：</p>
<ul>
<li>可以发送 POST 请求和大量的表单数据。</li>
<li>相对简单，无需处理 Blob。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>无法获取下载进度，无法处理服务器返回的错误信息（如 JSON 格式的错误）。</li>
<li>会打开新标签页或触发 <code>&lt;iframe&gt;</code> 刷新，用户体验可能不佳。</li>
<li>需要服务器返回文件流而不是 JSON。</li>
</ul>
<p><strong>示例</strong>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;downloadByForm()&quot;</span>&gt;</span>通过表单下载<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">downloadByForm</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> form = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;form&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    form.<span class="property">method</span> = <span class="string">&#x27;POST&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    form.<span class="property">action</span> = <span class="string">&#x27;/download/form-report&#x27;</span>; <span class="comment">// 假设服务器有一个 POST 接口处理下载</span></span></span><br><span class="line"><span class="language-javascript">    form.<span class="property">target</span> = <span class="string">&#x27;_blank&#x27;</span>; <span class="comment">// 打开新标签页，防止当前页面跳转</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 添加参数</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> input1 = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;input&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    input1.<span class="property">type</span> = <span class="string">&#x27;hidden&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    input1.<span class="property">name</span> = <span class="string">&#x27;reportType&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    input1.<span class="property">value</span> = <span class="string">&#x27;monthly&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    form.<span class="title function_">appendChild</span>(input1);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> input2 = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;input&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    input2.<span class="property">type</span> = <span class="string">&#x27;hidden&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    input2.<span class="property">name</span> = <span class="string">&#x27;userId&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    input2.<span class="property">value</span> = <span class="string">&#x27;12345&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    form.<span class="title function_">appendChild</span>(input2);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(form);</span></span><br><span class="line"><span class="language-javascript">    form.<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(form);</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Form submission triggered for download.&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>Go (Gin) 服务器端处理表单提交下载</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... Gin router setup ...</span></span><br><span class="line"></span><br><span class="line">router.POST(<span class="string">&quot;/download/form-report&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    reportType := c.PostForm(<span class="string">&quot;reportType&quot;</span>)</span><br><span class="line">    userId := c.PostForm(<span class="string">&quot;userId&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 reportType 和 userId 动态生成报告内容</span></span><br><span class="line">    content := fmt.Sprintf(<span class="string">&quot;Form-generated report for user %s, type: %s.\nGenerated at: %v&quot;</span>, userId, reportType, time.Now().Format(time.RFC3339))</span><br><span class="line">    filename := fmt.Sprintf(<span class="string">&quot;report_%s_%s.txt&quot;</span>, userId, reportType)</span><br><span class="line"></span><br><span class="line">    c.Header(<span class="string">&quot;Content-Disposition&quot;</span>, fmt.Sprintf(<span class="string">&quot;attachment; filename=\&quot;%s\&quot;&quot;</span>, filename))</span><br><span class="line">    c.Data(http.StatusOK, <span class="string">&quot;text/plain&quot;</span>, []<span class="type">byte</span>(content))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="四、第三方库下载-例如-FileSaver-js"><a href="#四、第三方库下载-例如-FileSaver-js" class="headerlink" title="四、第三方库下载 (例如 FileSaver.js)"></a>四、第三方库下载 (例如 <code>FileSaver.js</code>)</h2><p>对于更复杂的客户端文件保存场景，或为了更好的浏览器兼容性，可以使用一些成熟的第三方库，如 <code>FileSaver.js</code>。这些库通常在内部封装了上述 Blob 下载的逻辑，并处理了更多的浏览器兼容性细节。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>需要支持旧版本浏览器 (如 IE10+)。</li>
<li>希望简化 Blob 相关的下载逻辑。</li>
</ul>
<p><strong>示例 (使用 <code>FileSaver.js</code>)</strong>：</p>
<ol>
<li><p><strong>安装</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install file-saver</span><br><span class="line"><span class="comment"># 或通过 CDN 引入</span></span><br><span class="line">&lt;!-- &lt;script src=<span class="string">&quot;https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js&quot;</span>&gt;&lt;/script&gt; --&gt;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>代码</strong>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; saveAs &#125; <span class="keyword">from</span> <span class="string">&#x27;file-saver&#x27;</span>; <span class="comment">// 如果使用模块化</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">downloadWithFileSaver</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> textContent = <span class="string">&quot;这是通过 FileSaver.js 下载的文本内容。&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> filename = <span class="string">&quot;file-saver-demo.txt&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> mimeType = <span class="string">&quot;text/plain;charset=utf-8&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([textContent], &#123; <span class="attr">type</span>: mimeType &#125;);</span><br><span class="line">    <span class="title function_">saveAs</span>(blob, filename); <span class="comment">// 核心方法</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;FileSaver.js download triggered.&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// downloadWithFileSaver();</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="五、安全与注意事项"><a href="#五、安全与注意事项" class="headerlink" title="五、安全与注意事项"></a>五、安全与注意事项</h2><ol>
<li><p><strong>CORS (跨域资源共享)</strong>：</p>
<ul>
<li>如果使用 <code>fetch</code> 或 <code>XMLHttpRequest</code> 从不同源的服务器下载文件，服务器必须配置正确的 CORS 响应头（如 <code>Access-Control-Allow-Origin</code>）。</li>
<li>如果服务器响应头中没有 <code>Content-Disposition</code>，跨域请求可能无法获取到响应头中的文件名信息。</li>
</ul>
</li>
<li><p><strong>MIME 类型 (<code>Content-Type</code>)</strong>：</p>
<ul>
<li>服务器端应返回正确的文件 MIME 类型（如 <code>image/png</code>, <code>application/pdf</code>, <code>application/octet-stream</code>）。这有助于浏览器正确识别文件类型。</li>
<li>对于未知或需要强制下载的文件，<code>application/octet-stream</code> 是一个通用的选择。</li>
</ul>
</li>
<li><p><strong>文件名编码</strong>：</p>
<ul>
<li><code>Content-Disposition</code> 头中的 <code>filename</code> 字段需要正确编码，特别是包含非 ASCII 字符时。通常使用 URL 编码或 RFC 2231 编码。现代浏览器对 UTF-8 编码的 <code>filename</code> 支持较好。</li>
<li>前端解析 <code>Content-Disposition</code> 提取文件名时，也需要注意解码。</li>
</ul>
</li>
<li><p><strong>大文件下载</strong>：</p>
<ul>
<li>对于非常大的文件（例如几 GB），直接在浏览器内存中创建 <code>Blob</code> 或通过 <code>fetch</code> 一次性加载整个文件可能导致内存问题或超时。</li>
<li>可以考虑使用服务器端的 <strong>范围请求 (Range Requests)</strong> 配合客户端分块下载，但前端实现较为复杂，通常由专业的下载工具或库来处理。</li>
<li>对于超大文件，更推荐直接提供原始文件 URL，让浏览器或下载管理器直接处理，而不是通过前端 JS <code>fetch</code>。</li>
</ul>
</li>
<li><p><strong><code>URL.revokeObjectURL()</code></strong>：</p>
<ul>
<li>务必在下载操作完成后调用 <code>URL.revokeObjectURL()</code> 来释放内存。特别是在循环或频繁下载的场景中，不释放会导致内存占用持续增加。</li>
</ul>
</li>
<li><p><strong>XSS 风险</strong>：</p>
<ul>
<li>如果文件内容来自用户输入，需要警惕潜在的 XSS 攻击。例如，如果将用户提供的文件名直接作为 HTML 插入，可能被注入恶意脚本。</li>
</ul>
</li>
<li><p><strong>用户体验</strong>：</p>
<ul>
<li>下载开始时，可以给用户一个视觉反馈（如加载动画）。</li>
<li>处理下载失败的情况，并给出明确的错误提示。</li>
</ul>
</li>
</ol>
<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>前端文件下载提供了多种实现方式，开发者应根据文件来源、下载需求（如是否需要认证、是否需要动态生成内容）、浏览器兼容性以及性能考量来选择最合适的方法：</p>
<ul>
<li><strong>最简单直观</strong>：<code>&lt;a&gt;</code> 标签配合 <code>download</code> 属性（适用于可直接访问的服务器静态文件）。</li>
<li><strong>客户端动态生成</strong>：<code>Blob</code> + <code>URL.createObjectURL()</code> + 虚拟 <code>&lt;a&gt;</code> 标签 <code>click()</code>（适用于 JS 生成内容）。</li>
<li><strong>服务器动态生成或需要认证</strong>：<code>fetch</code> (获取 <code>Blob</code>) + <code>Blob</code> 下载方法（最通用且推荐）。</li>
<li><strong>旧浏览器或大量 POST 参数</strong>：隐藏表单提交（特定场景使用）。</li>
<li><strong>简化开发与兼容性</strong>：第三方库 <code>FileSaver.js</code>。</li>
</ul>
<p>无论选择哪种方式，都需关注服务器端的响应头配置（尤其是 <code>Content-Disposition</code> 和 <code>Content-Type</code>）以及前端的内存管理和错误处理，以确保提供稳定、安全且用户友好的下载体验。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg">TeaTang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg/0c202b3d53be/">https://blog.tbf1211.xx.kg/0c202b3d53be/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tbf1211.xx.kg" target="_blank">1024 维度</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/2023/">2023</a><a class="post-meta__tags" href="/tags/Web%E6%8A%80%E6%9C%AF/">Web技术</a><a class="post-meta__tags" href="/tags/HTML/">HTML</a><a class="post-meta__tags" href="/tags/%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF/">前端技术</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover-21.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/dbdbe99385cd/" title="Python Pandas详解：数据处理与分析的瑞士军刀"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-18.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Python Pandas详解：数据处理与分析的瑞士军刀</div></div><div class="info-2"><div class="info-item-1"> Pandas 是 Python 中用于数据分析和处理的核心库。它提供了一套高性能、易于使用的数据结构，最主要的是 DataFrame（二维表格数据）和 Series（一维带标签数组），用于快速处理和分析结构化数据（如 CSV、Excel、数据库表格数据）。Pandas 以其直观的语法和强大的功能，成为数据科学家和数据工程师的首选工具。  核心思想：Pandas 将表格数据抽象为 DataFrame 和 Series 对象，提供类似 SQL 和 Excel 的操作，通过向量化和 C&#x2F;Cython 实现的底层优化，极大提升了数据处理效率。   一、为什么选择 Pandas？在数据驱动的时代，我们经常需要处理各种形式的表格数据。Python 原生的数据结构（如列表、字典）虽然灵活，但在处理大量、复杂、异构的表格数据时显得力不从心。Pandas 解决了这些痛点：  直观的数据结构：DataFrame 和 Series 提供了强大的标签索引功能，使得数据操作更加直观，无需关注底层实现。 高效的数据操作：底层基于 NumPy 优化，利用 C 和 Cython 实现，对于大规模数据...</div></div></div></a><a class="pagination-related" href="/40c57ff5cb61/" title="Pug(前Jade)模板引擎详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-10.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Pug(前Jade)模板引擎详解</div></div><div class="info-2"><div class="info-item-1"> Pug（发音 &#x2F;pʌɡ&#x2F;），前身为 Jade，是一个高性能的 Node.js 模板引擎。它以其简洁、富有表现力的语法而闻名，旨在让 HTML 编写变得更加高效和愉快。Pug 摒弃了传统 HTML 的尖括号和闭合标签，转而使用缩进和基于文本的语法，这使得模板文件更小、更易读、也更不易出错。  核心思想：Pug 通过简洁的缩进语法替代冗长的 HTML 标签，提供强大的动态数据渲染、代码重用和条件逻辑功能。   一、Pug 简介1.1 什么是模板引擎？模板引擎是一种将数据填充到预定义模板中以生成最终输出（通常是 HTML 字符串）的工具。它将页面的结构（模板）与数据分离，使得前端开发更加模块化和可维护。 1.2 Pug 的特点 独特语法：使用缩进表示嵌套关系，无需关闭标签。 简洁明了：代码量显著少于对应的 HTML。 强大功能：支持变量、循环、条件判断、Mixin（类似于函数或组件）、包含（文件复用）、布局继承等高级特性。 编译到 HTML：Pug 模板最终会被编译成标准的 HTML。 Node.js 支持：作为 Node.js 的模板引擎，Pug 完美集成于 E...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/23aa2938b836/" title="跨域问题详解及解决方案"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-17.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-17</div><div class="info-item-2">跨域问题详解及解决方案</div></div><div class="info-2"><div class="info-item-1"> 在 Web 开发中，“跨域” (Cross-Origin) 是一个非常常见且令人困扰的问题。它源于浏览器的一项重要安全策略：同源策略 (Same-Origin Policy)。理解同源策略以及如何安全有效地解决跨域问题，是每个 Web 开发者必备的知识。  核心思想：同源策略是浏览器的一项安全机制，它限制了来自一个源的文档或脚本与来自另一个源的资源进行交互。当请求的目标源与当前页面的源不一致时，就发生了跨域。解决跨域问题的关键是让服务器端或中间代理明确允许跨域请求。    一、什么是同源策略 (Same-Origin Policy)？同源策略 是浏览器为了保护用户隐私和数据安全而制定的一项基本安全功能。它限制了一个 HMTL 文档中加载的脚本如何与来自不同源的资源进行交互。 1.1 “源”的定义如果两个 URL 的协议 (Protocol)、域名 (Domain) 和端口 (Port) 都相同，则称它们是“同源”的。只要其中任何一个不同，就被认为是“跨源”或“不同源”。    URL A URL B 结果 原因    http://example.com/a.html http...</div></div></div></a><a class="pagination-related" href="/234c44d5851b/" title="HTML5 单页面应用 (SPA) 路由实现详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-03.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-26</div><div class="info-item-2">HTML5 单页面应用 (SPA) 路由实现详解</div></div><div class="info-2"><div class="info-item-1"> 单页面应用 (Single Page Application, SPA) 是一种 Web 应用程序模型，它通过动态重写当前页面而非从服务器加载整个新页面来实现与用户的交互。这种模式极大地提升了用户体验，使其更接近桌面应用。SPA 的核心技术之一是客户端路由 (Client-Side Routing)，它允许应用程序在不进行整页刷新的情况下，根据 URL 路径的变化渲染不同的视图。  核心思想：HTML5 History API 允许 Web 应用程序在客户端直接操纵浏览器会话历史记录，从而实现 URL 的无刷新更新和状态管理，这是现代 SPA 路由的基础。   一、传统页面跳转与 SPA 路由的区别在深入探讨 SPA 路由之前，我们首先理解传统多页面应用 (Multi-Page Application, MPA) 的页面跳转机制及其与 SPA 的根本不同：  传统 MPA 页面跳转：  用户点击链接或提交表单。 浏览器向服务器发送 HTTP 请求，请求新的 HTML 页面。 服务器响应并发送完整的 HTML 文档。 浏览器销毁当前页面，加载并渲染新的 HTML 文档。   特点...</div></div></div></a><a class="pagination-related" href="/40c57ff5cb61/" title="Pug(前Jade)模板引擎详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-10.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-17</div><div class="info-item-2">Pug(前Jade)模板引擎详解</div></div><div class="info-2"><div class="info-item-1"> Pug（发音 &#x2F;pʌɡ&#x2F;），前身为 Jade，是一个高性能的 Node.js 模板引擎。它以其简洁、富有表现力的语法而闻名，旨在让 HTML 编写变得更加高效和愉快。Pug 摒弃了传统 HTML 的尖括号和闭合标签，转而使用缩进和基于文本的语法，这使得模板文件更小、更易读、也更不易出错。  核心思想：Pug 通过简洁的缩进语法替代冗长的 HTML 标签，提供强大的动态数据渲染、代码重用和条件逻辑功能。   一、Pug 简介1.1 什么是模板引擎？模板引擎是一种将数据填充到预定义模板中以生成最终输出（通常是 HTML 字符串）的工具。它将页面的结构（模板）与数据分离，使得前端开发更加模块化和可维护。 1.2 Pug 的特点 独特语法：使用缩进表示嵌套关系，无需关闭标签。 简洁明了：代码量显著少于对应的 HTML。 强大功能：支持变量、循环、条件判断、Mixin（类似于函数或组件）、包含（文件复用）、布局继承等高级特性。 编译到 HTML：Pug 模板最终会被编译成标准的 HTML。 Node.js 支持：作为 Node.js 的模板引擎，Pug 完美集成于 E...</div></div></div></a><a class="pagination-related" href="/699d44e596f6/" title="Web Worker 深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-29.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-28</div><div class="info-item-2">Web Worker 深度解析</div></div><div class="info-2"><div class="info-item-1"> Web Worker 是一种允许 Web 应用程序在后台线程中运行脚本的机制，独立于主执行线程。它使得复杂的、计算密集型的任务可以在不阻塞用户界面 (UI) 的情况下执行，从而显著提升了 Web 应用的响应性和用户体验。  核心思想：Web Worker 解决了 JavaScript 单线程模型在处理耗时任务时可能导致的 UI 阻塞问题。它通过在独立的后台线程中运行 JavaScript 代码，允许主线程继续响应用户交互，从而实现 Web 应用的“多线程”体验。   一、为什么需要 Web Worker？(JavaScript 的单线程本质)JavaScript 在浏览器中是单线程运行的，这意味着所有脚本执行、事件处理、DOM 操作和 UI 渲染都在同一个主线程上进行。这种单线程模型虽然简化了编程模型（避免了复杂的并发问题），但也带来了一个显著的缺点：  UI 阻塞：当主线程执行一个耗时较长的计算任务时（例如，处理大量数据、复杂的图像处理、加密解密操作等），主线程会被这个任务长时间占用。在这期间，浏览器无法响应用户的输入（点击、滚动）、无法更新 UI，导致页面“卡死”或“无响应...</div></div></div></a><a class="pagination-related" href="/b519dd676c66/" title="PWA (Progressive Web Apps) 深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-08.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-05</div><div class="info-item-2">PWA (Progressive Web Apps) 深度解析</div></div><div class="info-2"><div class="info-item-1"> PWA (Progressive Web Apps - 渐进式 Web 应用) 是一种利用现代 Web 技术，将 Web 应用提升至接近原生应用体验的新方法。它旨在结合 Web 的广阔可达性与原生应用的丰富功能，为用户提供可靠 (Reliable)、快速 (Fast)、沉浸式 (Engaging) 的体验。PWA 不仅仅是一种技术，更是一套开发理念和最佳实践。  核心思想：PWA 的目标是让 Web 应用具备类似原生应用的体验和功能，同时保留 Web 的优点（无需安装、易于发现、跨平台）。这主要通过 Service Worker 实现离线能力和性能优化，通过 Web App Manifest 实现安装和应用体验，以及通过 HTTPS 确保安全性来达成。   一、为什么需要 PWA？(Web 与原生应用的融合)传统 Web 应用和原生移动应用各有优缺点：  传统 Web 应用 (网站)： 优点：无需安装、易于发现、跨平台、更新灵活、共享方便。 缺点：依赖网络、加载慢、无离线功能、无法添加到主屏幕、无法发送推送通知、用户体验与原生应用有差距。   原生移动应用： 优点：性能好、可离...</div></div></div></a><a class="pagination-related" href="/402798405a2e/" title="如何从 HTTP 请求中获取用户 IP 地址详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-19.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-26</div><div class="info-item-2">如何从 HTTP 请求中获取用户 IP 地址详解</div></div><div class="info-2"><div class="info-item-1"> 用户 IP 地址 (Internet Protocol Address) 是互联网上设备的唯一标识符，对于网络服务而言，获取用户 IP 地址是常见需求。它在诸多场景中扮演着关键角色，如日志记录、地理位置定位、安全分析、流量统计、反欺诈和访问控制等。然而，由于现代网络架构中广泛使用代理服务器、负载均衡器和 CDN (内容分发网络)，直接获取用户的真实 IP 地址并非总是直截了当。本文将详细探讨如何从 HTTP 请求中正确、安全地获取用户 IP 地址，并提供 Go 语言示例。  核心思想：获取用户 IP 地址的关键在于理解 HTTP 请求的 RemoteAddr (直接连接客户端的 IP) 和一系列 X-Forwarded-For, X-Real-IP 等非标准但广泛使用的 HTTP 头。正确解析这些信息需要结合部署环境（是否存在代理、CDN）及安全考量。   一、IP 地址及其获取的重要性1.1 什么是 IP 地址？IP 地址是分配给连接到计算机网络的设备的数字标签，用于在网络中标识和定位设备。它分为 IPv4（如 192.168.1.1）和 IPv6（如 2001:0db8:8...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TeaTang</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">535</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">229</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">84</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/teatang"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:tea.tang1211@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站更多功能即将上线，敬请期待！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-text">一、文件下载的基础概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81HTML-%E5%8E%9F%E7%94%9F%E4%B8%8B%E8%BD%BD%E6%96%B9%E5%BC%8F"><span class="toc-text">二、HTML 原生下载方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%A0%87%E7%AD%BE%E9%85%8D%E5%90%88-download-%E5%B1%9E%E6%80%A7"><span class="toc-text">2.1 &lt;a&gt; 标签配合 download 属性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81JavaScript-%E7%BC%96%E7%A8%8B%E4%B8%8B%E8%BD%BD%E6%96%B9%E5%BC%8F"><span class="toc-text">三、JavaScript 编程下载方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%9F%BA%E4%BA%8E-Blob-%E5%92%8C-Object-URL-%E4%B8%8B%E8%BD%BD-%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%94%9F%E6%88%90%E6%96%87%E4%BB%B6"><span class="toc-text">3.1 基于 Blob 和 Object URL 下载 (客户端生成文件)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E9%80%9A%E8%BF%87-Fetch-XHR-%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%96%87%E4%BB%B6%E5%B9%B6%E4%B8%8B%E8%BD%BD"><span class="toc-text">3.2 通过 Fetch&#x2F;XHR 获取服务器文件并下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E8%A1%A8%E5%8D%95%E6%8F%90%E4%BA%A4%E4%B8%8B%E8%BD%BD-%E9%9D%9E%E4%B8%BB%E6%B5%81%EF%BC%8C%E7%89%B9%E5%AE%9A%E5%9C%BA%E6%99%AF"><span class="toc-text">3.3 &lt;form&gt; 表单提交下载 (非主流，特定场景)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E4%B8%8B%E8%BD%BD-%E4%BE%8B%E5%A6%82-FileSaver-js"><span class="toc-text">四、第三方库下载 (例如 FileSaver.js)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%AE%89%E5%85%A8%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">五、安全与注意事项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">六、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/8fc7e3e72510/" title="前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-01.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解"/></a><div class="content"><a class="title" href="/8fc7e3e72510/" title="前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解">前端渲染模式：CSR, SSR, SSG, ISR, DPR 详解</a><time datetime="2026-01-27T22:24:00.000Z" title="发表于 2026-01-28 06:24:00">2026-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/5341a0037256/" title="CSS-in-JS 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-08.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CSS-in-JS 详解"/></a><div class="content"><a class="title" href="/5341a0037256/" title="CSS-in-JS 详解">CSS-in-JS 详解</a><time datetime="2026-01-25T22:24:00.000Z" title="发表于 2026-01-26 06:24:00">2026-01-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/0b52cb819619/" title="Git 核心对象：Commit, Tree, Blob 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-22.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Git 核心对象：Commit, Tree, Blob 详解"/></a><div class="content"><a class="title" href="/0b52cb819619/" title="Git 核心对象：Commit, Tree, Blob 详解">Git 核心对象：Commit, Tree, Blob 详解</a><time datetime="2026-01-21T22:24:00.000Z" title="发表于 2026-01-22 06:24:00">2026-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/1d2a942bda1e/" title="Terraform 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-06.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Terraform 详解"/></a><div class="content"><a class="title" href="/1d2a942bda1e/" title="Terraform 详解">Terraform 详解</a><time datetime="2026-01-19T22:24:00.000Z" title="发表于 2026-01-20 06:24:00">2026-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/26cdb2447b3d/" title="WebView 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-16.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WebView 详解"/></a><div class="content"><a class="title" href="/26cdb2447b3d/" title="WebView 详解">WebView 详解</a><time datetime="2026-01-17T22:24:00.000Z" title="发表于 2026-01-18 06:24:00">2026-01-18</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/default_cover-21.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">我的轨迹</div><div class="footer-flex-content"><a href="/archives/2023/" target="_blank" title="🆕 2023">🆕 2023</a><a href="/archives/2024/" target="_blank" title="🆒 2024">🆒 2024</a><a href="/archives/2025/" target="_blank" title="👨‍👩‍👦 2025">👨‍👩‍👦 2025</a><a href="/archives/2026/" target="_blank" title="🆙 2026">🆙 2026</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">维度</div><div class="footer-flex-content"><a href="/categories/" target="_blank" title="📁 分类">📁 分类</a><a href="/tags/" target="_blank" title="🔖 标签">🔖 标签</a><a href="/categories/" target="_blank" title="📽️ 时间线">📽️ 时间线</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/shuoshuo" target="_blank" title="💬 说说">💬 说说</a></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2026 By TeaTang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.9/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (true) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script></div><script data-pjax src="/self/btf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="ture"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,200,200" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js" defer="defer"></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      true
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.4"></script></div></div></body></html>