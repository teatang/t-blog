<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Ansible 深度解析 | 1024 维度</title><meta name="author" content="TeaTang"><meta name="copyright" content="TeaTang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Ansible 是一个开源的自动化引擎，用于配置管理 (Configuration Management)、应用部署 (Application Deployment)、任务自动化 (Task Automation) 和编排 (Orchestration)。它以其无代理 (Agentless)、简单易用和人性化的特点而广受欢迎。Ansible 使用标准的 SSH 协议连接到目标机器，并使用 YAM">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible 深度解析">
<meta property="og:url" content="https://blog.tbf1211.xx.kg/195d130ae5a4/index.html">
<meta property="og:site_name" content="1024 维度">
<meta property="og:description" content="Ansible 是一个开源的自动化引擎，用于配置管理 (Configuration Management)、应用部署 (Application Deployment)、任务自动化 (Task Automation) 和编排 (Orchestration)。它以其无代理 (Agentless)、简单易用和人性化的特点而广受欢迎。Ansible 使用标准的 SSH 协议连接到目标机器，并使用 YAM">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-08.jpg">
<meta property="article:published_time" content="2025-04-28T22:24:00.000Z">
<meta property="article:modified_time" content="2025-12-22T03:39:51.875Z">
<meta property="article:author" content="TeaTang">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="CI&#x2F;CD">
<meta property="article:tag" content="2025">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tbf1211.xx.kg/img/cover/default_cover-08.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Ansible 深度解析",
  "url": "https://blog.tbf1211.xx.kg/195d130ae5a4/",
  "image": "https://blog.tbf1211.xx.kg/img/cover/default_cover-08.jpg",
  "datePublished": "2025-04-28T22:24:00.000Z",
  "dateModified": "2025-12-22T03:39:51.875Z",
  "author": [
    {
      "@type": "Person",
      "name": "TeaTang",
      "url": "https://blog.tbf1211.xx.kg"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon-1.ico"><link rel="canonical" href="https://blog.tbf1211.xx.kg/195d130ae5a4/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.7/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":true,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: TeaTang","link":"链接: ","source":"来源: 1024 维度","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Ansible 深度解析',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="1024 维度" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">414</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">217</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">80</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/cover/default_cover-08.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">1024 维度</span></a><a class="nav-page-title" href="/"><span class="site-name">Ansible 深度解析</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 我的轨迹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/2023/"><i class="fa-fw fa-solid fa-bug"></i><span> 2023</span></a></li><li><a class="site-page child" href="/archives/2024/"><i class="fa-fw fa-solid fa-code"></i><span> 2024</span></a></li><li><a class="site-page child" href="/archives/2025/"><i class="fa-fw fa-solid fa-network-wired"></i><span> 2025</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-solid fa-calendar-days"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Ansible 深度解析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2025-04-28T22:24:00.000Z" title="发表于 2025-04-29 06:24:00">2025-04-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">3.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>13分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="umamiPV" data-path="/195d130ae5a4/"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><strong>Ansible</strong> 是一个开源的自动化引擎，用于<strong>配置管理 (Configuration Management)</strong>、<strong>应用部署 (Application Deployment)</strong>、<strong>任务自动化 (Task Automation)</strong> 和<strong>编排 (Orchestration)</strong>。它以其<strong>无代理 (Agentless)</strong>、<strong>简单易用</strong>和<strong>人性化</strong>的特点而广受欢迎。Ansible 使用标准的 SSH 协议连接到目标机器，并使用 YAML 语法编写自动化任务，使得编写、理解和维护自动化脚本变得直观。</p>
</blockquote>
<div class="note info flat"><p>核心思想：<strong>Ansible 通过 SSH 远程执行操作，无需在被管理节点上安装任何客户端或代理程序。它采用声明式 YAML 语言描述期望的状态，并确保系统达到该状态，同时保证操作的幂等性。</strong></p>
</div>
<hr>
<h2 id="一、为什么选择-Ansible？"><a href="#一、为什么选择-Ansible？" class="headerlink" title="一、为什么选择 Ansible？"></a>一、为什么选择 Ansible？</h2><p>传统的服务器管理和应用部署往往涉及大量重复、手工且容易出错的任务。随着 IT 基础设施的规模不断扩大，这种手工操作的弊端日益凸显：</p>
<ol>
<li><strong>效率低下</strong>：手动操作耗时且重复。</li>
<li><strong>易出错</strong>：人为失误在重复性任务中难以避免。</li>
<li><strong>配置漂移 (Configuration Drift)</strong>：不同服务器的配置可能因手工操作而逐渐不一致。</li>
<li><strong>扩展性差</strong>：难以快速、一致地扩展基础设施。</li>
<li><strong>缺乏可追溯性</strong>：难以记录和审计谁在何时对系统进行了何种更改。</li>
</ol>
<p>Ansible 旨在解决这些问题，提供一种<strong>自动化、可重复、可审计</strong>的解决方案：</p>
<ul>
<li><strong>简化复杂性</strong>：将复杂的运维任务抽象为简单的 YAML Playbook。</li>
<li><strong>提高效率</strong>：自动化重复性任务，显著减少人工干预。</li>
<li><strong>确保一致性</strong>：通过统一的 Playbook，确保所有目标机器的配置一致。</li>
<li><strong>加速部署</strong>：实现应用的快速、可靠部署和更新。</li>
<li><strong>降低风险</strong>：减少人为错误，通过版本控制管理自动化脚本。</li>
<li><strong>实现基础设施即代码 (IaC)</strong>：将基础设施的配置和管理代码化，便于版本控制和协作。</li>
</ul>
<h2 id="二、Ansible-核心概念"><a href="#二、Ansible-核心概念" class="headerlink" title="二、Ansible 核心概念"></a>二、Ansible 核心概念</h2><p>理解以下概念是掌握 Ansible 的基础：</p>
<h3 id="2-1-控制节点-Control-Node"><a href="#2-1-控制节点-Control-Node" class="headerlink" title="2.1 控制节点 (Control Node)"></a>2.1 控制节点 (Control Node)</h3><p>运行 Ansible 的机器。通常是您的工作站或一个专门的自动化服务器。控制节点通过 SSH 连接到被管理节点。</p>
<h3 id="2-2-被管理节点-Managed-Node-Target-Host"><a href="#2-2-被管理节点-Managed-Node-Target-Host" class="headerlink" title="2.2 被管理节点 (Managed Node &#x2F; Target Host)"></a>2.2 被管理节点 (Managed Node &#x2F; Target Host)</h3><p>Ansible 通过 SSH 协议连接并执行任务的远程服务器或设备。这些节点上只需要安装 Python 解释器（通常已预装）。</p>
<h3 id="2-3-清单-Inventory"><a href="#2-3-清单-Inventory" class="headerlink" title="2.3 清单 (Inventory)"></a>2.3 清单 (Inventory)</h3><p>一个包含所有被管理节点信息的文件（或动态生成的方式）。Ansible 根据清单来确定要在哪些主机上执行任务。</p>
<p><strong>示例 (INI 格式):</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[webservers]</span></span><br><span class="line">web1.example.com</span><br><span class="line">web2.example.com</span><br><span class="line"></span><br><span class="line"><span class="section">[databases]</span></span><br><span class="line">db1.example.com</span><br><span class="line"></span><br><span class="line"><span class="section">[all:vars]</span></span><br><span class="line"><span class="attr">ansible_user</span>=remote_user</span><br><span class="line"><span class="attr">ansible_ssh_private_key_file</span>=/path/to/ssh/key</span><br></pre></td></tr></table></figure>

<p><strong>示例 (YAML 格式):</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">all:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="attr">web1.example.com:</span></span><br><span class="line">    <span class="attr">web2.example.com:</span></span><br><span class="line">  <span class="attr">children:</span></span><br><span class="line">    <span class="attr">webservers:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">web1.example.com:</span></span><br><span class="line">        <span class="attr">web2.example.com:</span></span><br><span class="line">    <span class="attr">databases:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">db1.example.com:</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">ansible_user:</span> <span class="string">remote_user</span></span><br><span class="line">    <span class="attr">ansible_ssh_private_key_file:</span> <span class="string">/path/to/ssh/key</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-模块-Module"><a href="#2-4-模块-Module" class="headerlink" title="2.4 模块 (Module)"></a>2.4 模块 (Module)</h3><p>Ansible 实际执行操作的基本单位。每个模块都是一个可执行的 Python 脚本（或 PowerShell、Go 等）。模块是幂等的，这意味着多次运行同一个模块，结果都是一样的，不会产生副作用。</p>
<p><strong>常见模块示例：</strong></p>
<ul>
<li><code>apt</code>, <code>yum</code>: 包管理</li>
<li><code>copy</code>: 复制文件</li>
<li><code>service</code>: 管理服务</li>
<li><code>command</code>, <code>shell</code>: 执行命令</li>
<li><code>file</code>: 管理文件和目录</li>
<li><code>template</code>: 基于 Jinja2 模板生成文件</li>
</ul>
<h3 id="2-5-任务-Task"><a href="#2-5-任务-Task" class="headerlink" title="2.5 任务 (Task)"></a>2.5 任务 (Task)</h3><p>一个 Playbook 中的最小执行单元，代表着在一个或多个主机上执行一个模块及其参数。</p>
<p><strong>示例：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span> <span class="string">web</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure>

<h3 id="2-6-剧本-Playbook"><a href="#2-6-剧本-Playbook" class="headerlink" title="2.6 剧本 (Playbook)"></a>2.6 剧本 (Playbook)</h3><p>Ansible 的核心，是一个 YAML 格式的文件，它定义了要在哪些主机上执行哪些任务，以及它们的顺序。一个 Playbook 可以包含一个或多个 <code>play</code>。</p>
<h3 id="2-7-剧-Play"><a href="#2-7-剧-Play" class="headerlink" title="2.7 剧 (Play)"></a>2.7 剧 (Play)</h3><p>Playbook 中的一个逻辑块，定义了在一组主机上执行的一系列任务。每个 <code>play</code> 都以 <code>hosts</code> 关键字开头，指定目标主机。</p>
<p><strong>示例：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">---</span> <span class="comment"># Playbook 开始标志</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">web</span> <span class="string">servers</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span> <span class="comment"># 提升权限</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ensure</span> <span class="string">Nginx</span> <span class="string">is</span> <span class="string">installed</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ensure</span> <span class="string">Nginx</span> <span class="string">service</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<h3 id="2-8-角色-Role"><a href="#2-8-角色-Role" class="headerlink" title="2.8 角色 (Role)"></a>2.8 角色 (Role)</h3><p>一种组织 Playbook 和相关文件（如变量、模板、文件、处理器）的标准化、可重用结构。角色使得复杂的自动化项目更易于管理和分享。</p>
<p><strong>标准角色目录结构：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">roles/</span><br><span class="line">├── my_webserver_role/</span><br><span class="line">│   ├── tasks/                  # 定义任务的YAML文件</span><br><span class="line">│   │   └── main.yml</span><br><span class="line">│   ├── handlers/               # 定义处理器的YAML文件</span><br><span class="line">│   │   └── main.yml</span><br><span class="line">│   ├── vars/                   # 定义角色的变量</span><br><span class="line">│   │   └── main.yml</span><br><span class="line">│   ├── defaults/               # 定义角色的默认变量 (最低优先级)</span><br><span class="line">│   │   └── main.yml</span><br><span class="line">│   ├── templates/              # Jinja2模板文件</span><br><span class="line">│   ├── files/                  # 静态文件</span><br><span class="line">│   └── meta/                   # 角色元数据</span><br><span class="line">│       └── main.yml</span><br><span class="line">└── another_role/</span><br><span class="line">    └── ...</span><br></pre></td></tr></table></figure>

<h3 id="2-9-事实-Facts"><a href="#2-9-事实-Facts" class="headerlink" title="2.9 事实 (Facts)"></a>2.9 事实 (Facts)</h3><p>Ansible 在执行 Playbook 之前，会自动从被管理节点收集到的系统信息，例如操作系统、IP 地址、内存、CPU 等。这些事实可以在 Playbook 中作为变量使用。</p>
<h3 id="2-10-变量-Variables"><a href="#2-10-变量-Variables" class="headerlink" title="2.10 变量 (Variables)"></a>2.10 变量 (Variables)</h3><p>用于存储动态值的占位符，可以在 Playbook、模板或命令行中使用，以提高灵活性和重用性。</p>
<h3 id="2-11-处理器-Handler"><a href="#2-11-处理器-Handler" class="headerlink" title="2.11 处理器 (Handler)"></a>2.11 处理器 (Handler)</h3><p>一种特殊的任务，只有当它被 Playbook 中的其他任务明确通知 (notified) 时才会执行。处理器通常用于重启服务等操作，确保只在配置真正发生改变时才执行。</p>
<p><strong>示例：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tasks/main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Nginx</span> <span class="string">configuration</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="comment"># 通知处理器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># handlers/main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<h3 id="2-12-保险库-Vault"><a href="#2-12-保险库-Vault" class="headerlink" title="2.12 保险库 (Vault)"></a>2.12 保险库 (Vault)</h3><p>用于加密 Playbook 或敏感数据文件，保护密码、API 密钥等敏感信息。</p>
<h2 id="三、Ansible-架构与工作原理"><a href="#三、Ansible-架构与工作原理" class="headerlink" title="三、Ansible 架构与工作原理"></a>三、Ansible 架构与工作原理</h2><h3 id="3-1-架构概览"><a href="#3-1-架构概览" class="headerlink" title="3.1 架构概览"></a>3.1 架构概览</h3><p>Ansible 的架构非常简洁，主要由<strong>控制节点</strong>和<strong>被管理节点</strong>组成，它们之间通过 SSH 进行通信。</p>
<div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    graph TD
    A[用户&#x2F;CI&#x2F;CD] --&gt; B(Ansible 控制节点);
    B -- Playbooks, Inventory --&gt; C(Ansible 引擎);
    C --&gt; D[&quot;模块 (Modules)&quot;];
    C --&gt; E[&quot;插件 (Plugins)&quot;];
    C -- SSH --&gt; F[被管理节点 1];
    C -- SSH --&gt; G[被管理节点 2];
    C -- SSH --&gt; H[被管理节点 N];
    F -- Python解释器 --&gt; I[执行模块];
    G -- Python解释器 --&gt; J[执行模块];
    H -- Python解释器 --&gt; K[执行模块];
  </pre></div>

<h3 id="3-2-工作原理"><a href="#3-2-工作原理" class="headerlink" title="3.2 工作原理"></a>3.2 工作原理</h3><p>Ansible 的执行流程可以概括为以下步骤：</p>
<ol>
<li><strong>加载配置</strong>：Ansible 根据配置（<code>ansible.cfg</code>）加载 Playbook、清单、变量等。</li>
<li><strong>收集事实</strong>：Ansible 控制节点通过 SSH 连接到被管理节点，并运行一个特殊的 <code>setup</code> 模块，收集目标系统的“事实”（系统信息）。</li>
<li><strong>解析 Playbook</strong>：根据 Playbook 的内容，确定要在哪些主机组上执行哪些任务。</li>
<li><strong>分发模块</strong>：对于每个任务，Ansible 会将对应的模块（通常是 Python 脚本）通过 SSH 临时传输到被管理节点。</li>
<li><strong>执行模块</strong>：在被管理节点上，这些模块会被 Python 解释器执行。模块的执行结果会返回给控制节点。</li>
<li><strong>收集结果</strong>：控制节点收集所有被管理节点返回的结果，并根据结果决定是否触发处理器或继续执行下一个任务。</li>
<li><strong>清理</strong>：模块执行完成后，Ansible 会将被管理节点上的临时模块文件删除。</li>
<li><strong>状态同步</strong>：确保被管理节点达到 Playbook 中声明的期望状态。</li>
</ol>
<h2 id="四、Ansible-的关键特性与优势"><a href="#四、Ansible-的关键特性与优势" class="headerlink" title="四、Ansible 的关键特性与优势"></a>四、Ansible 的关键特性与优势</h2><ol>
<li><strong>无代理 (Agentless)</strong>：无需在被管理节点上安装任何客户端软件或代理。Ansible 仅依靠 SSH 协议（用于Linux&#x2F;Unix）或 WinRM（用于Windows）进行通信。这大大简化了部署和维护，减少了系统开销和安全攻击面。</li>
<li><strong>声明式 (Declarative)</strong>：用户通过 YAML Playbook 描述他们希望系统达到的“最终状态”，而不是如何一步步实现这个状态。Ansible 会负责找出并执行必要的步骤。</li>
<li><strong>幂等性 (Idempotent)</strong>：多次运行同一个 Playbook 或任务，结果都是一致的。如果系统已经处于期望的状态，Ansible 将不会执行任何操作；如果状态不一致，它会进行更改以达到期望状态。这使得重复执行变得安全可靠。</li>
<li><strong>YAML 语法</strong>：Playbook 使用人类可读的 YAML 格式编写，语法简洁，易于学习和理解。</li>
<li><strong>可扩展性 (Extensible)</strong>：Ansible 提供了丰富的模块库，同时支持用户编写自定义模块、插件和角色，以适应各种复杂的自动化需求。</li>
<li><strong>强大的编排能力 (Orchestration)</strong>：除了配置管理，Ansible 能够协调跨多个主机的复杂工作流，例如多层应用部署、滚动更新等。</li>
<li><strong>安全性 (Security)</strong>：通过 Ansible Vault 提供敏感数据的加密功能，确保密码、密钥等信息在版本控制系统和部署过程中得到安全保护。</li>
</ol>
<h2 id="五、Ansible-入门示例"><a href="#五、Ansible-入门示例" class="headerlink" title="五、Ansible 入门示例"></a>五、Ansible 入门示例</h2><h3 id="5-1-安装-Ansible"><a href="#5-1-安装-Ansible" class="headerlink" title="5.1 安装 Ansible"></a>5.1 安装 Ansible</h3><p>在控制节点上安装 Ansible 通常非常简单：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 pip 安装 (推荐)</span></span><br><span class="line">pip install ansible</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用系统包管理器 (例如 Ubuntu/Debian)</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install ansible</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">ansible --version</span><br></pre></td></tr></table></figure>

<h3 id="5-2-创建清单文件-Inventory"><a href="#5-2-创建清单文件-Inventory" class="headerlink" title="5.2 创建清单文件 (Inventory)"></a>5.2 创建清单文件 (Inventory)</h3><p>创建一个名为 <code>hosts</code> 的文件：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[webservers]</span></span><br><span class="line">server1.example.com</span><br><span class="line">server2.example.com</span><br><span class="line"></span><br><span class="line"><span class="section">[databases]</span></span><br><span class="line">db1.example.com</span><br><span class="line"></span><br><span class="line"><span class="section">[all:vars]</span></span><br><span class="line"><span class="attr">ansible_user</span>=your_remote_username <span class="comment"># 远程服务器的用户名</span></span><br><span class="line"><span class="attr">ansible_ssh_private_key_file</span>=~/.ssh/id_rsa <span class="comment"># SSH 私钥路径</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-运行-Ad-hoc-命令"><a href="#5-3-运行-Ad-hoc-命令" class="headerlink" title="5.3 运行 Ad-hoc 命令"></a>5.3 运行 Ad-hoc 命令</h3><p>使用 <code>ansible</code> 命令快速执行单个任务，无需 Playbook。</p>
<p><strong>测试连接：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m ping</span><br><span class="line"><span class="comment"># 预期输出:</span></span><br><span class="line"><span class="comment"># server1.example.com | SUCCESS =&gt; &#123;</span></span><br><span class="line"><span class="comment">#     &quot;ansible_facts&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python3&quot;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &quot;changed&quot;: false,</span></span><br><span class="line"><span class="comment">#     &quot;ping&quot;: &quot;pong&quot;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>检查磁盘使用情况：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible webservers -a <span class="string">&quot;df -h&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-编写并执行第一个-Playbook"><a href="#5-4-编写并执行第一个-Playbook" class="headerlink" title="5.4 编写并执行第一个 Playbook"></a>5.4 编写并执行第一个 Playbook</h3><p>创建一个名为 <code>deploy_nginx.yml</code> 的 Playbook：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">and</span> <span class="string">configure</span> <span class="string">Nginx</span> <span class="string">web</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span> <span class="comment"># 以 root 权限执行</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">nginx_port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nginx_welcome_message:</span> <span class="string">&quot;Hello from Ansible-managed Nginx!&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ensure</span> <span class="string">Nginx</span> <span class="string">is</span> <span class="string">installed</span></span><br><span class="line">      <span class="attr">ansible.builtin.apt:</span> <span class="comment"># 明确指定模块所属的集合</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">        <span class="attr">update_cache:</span> <span class="literal">yes</span> <span class="comment"># 更新apt缓存</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">custom</span> <span class="string">Nginx</span> <span class="string">welcome</span> <span class="string">page</span></span><br><span class="line">      <span class="attr">ansible.builtin.copy:</span></span><br><span class="line">        <span class="attr">content:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">          &lt;html&gt;</span></span><br><span class="line"><span class="string">          &lt;head&gt;</span></span><br><span class="line"><span class="string">              &lt;title&gt;Ansible Nginx&lt;/title&gt;</span></span><br><span class="line"><span class="string">          &lt;/head&gt;</span></span><br><span class="line"><span class="string">          &lt;body&gt;</span></span><br><span class="line"><span class="string">              &lt;h1&gt;&#123;&#123; nginx_welcome_message &#125;&#125;&lt;/h1&gt;</span></span><br><span class="line"><span class="string">              &lt;p&gt;This page is served by Nginx on port &#123;&#123; nginx_port &#125;&#125;.&lt;/p&gt;</span></span><br><span class="line"><span class="string">          &lt;/body&gt;</span></span><br><span class="line"><span class="string">          &lt;/html&gt;</span></span><br><span class="line"><span class="string"></span>        <span class="attr">dest:</span> <span class="string">/var/www/html/index.nginx-debian.html</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www-data</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www-data</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&#x27;0644&#x27;</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="comment"># 通知处理器</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ensure</span> <span class="string">Nginx</span> <span class="string">service</span> <span class="string">is</span> <span class="string">running</span> <span class="string">and</span> <span class="string">enabled</span></span><br><span class="line">      <span class="attr">ansible.builtin.service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">ansible.builtin.service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<p><strong>执行 Playbook：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts deploy_nginx.yml</span><br></pre></td></tr></table></figure>

<h2 id="六、高级概念与最佳实践"><a href="#六、高级概念与最佳实践" class="headerlink" title="六、高级概念与最佳实践"></a>六、高级概念与最佳实践</h2><h3 id="6-1-角色-Roles-的使用"><a href="#6-1-角色-Roles-的使用" class="headerlink" title="6.1 角色 (Roles) 的使用"></a>6.1 角色 (Roles) 的使用</h3><p>角色是组织 Ansible 内容的最佳方式，它将 Playbook、变量、模板、文件和处理器等结构化地组织在一起。</p>
<p><strong>创建角色：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-galaxy init my_webserver_role</span><br></pre></td></tr></table></figure>

<p><strong>在 Playbook 中使用角色：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Apply</span> <span class="string">web</span> <span class="string">server</span> <span class="string">configuration</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">my_webserver_role</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-模板-Templates-与-Jinja2"><a href="#6-2-模板-Templates-与-Jinja2" class="headerlink" title="6.2 模板 (Templates) 与 Jinja2"></a>6.2 模板 (Templates) 与 Jinja2</h3><p>Ansible 使用 Jinja2 模板引擎来生成动态配置文件。</p>
<p><strong>示例 (nginx.conf.j2):</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen &#123;&#123; nginx_port &#125;&#125;;</span><br><span class="line">    server_name &#123;&#123; ansible_fqdn &#125;&#125;; # 使用事实变量</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /var/www/html;</span><br><span class="line">        index index.nginx-debian.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在任务中使用：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Generate</span> <span class="string">Nginx</span> <span class="string">configuration</span> <span class="string">from</span> <span class="string">template</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/nginx/sites-available/default</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-循环-Loops-和条件-Conditions"><a href="#6-3-循环-Loops-和条件-Conditions" class="headerlink" title="6.3 循环 (Loops) 和条件 (Conditions)"></a>6.3 循环 (Loops) 和条件 (Conditions)</h3><p><strong>循环示例：</strong> 安装多个包</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">multiple</span> <span class="string">packages</span></span><br><span class="line">  <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vim</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">git</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">htop</span></span><br></pre></td></tr></table></figure>

<p><strong>条件示例：</strong> 根据操作系统执行不同任务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">apache</span> <span class="string">on</span> <span class="string">Debian</span></span><br><span class="line">  <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">apache2</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">&quot;Debian&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span> <span class="string">on</span> <span class="string">RedHat</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">&quot;RedHat&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-变量管理"><a href="#6-4-变量管理" class="headerlink" title="6.4 变量管理"></a>6.4 变量管理</h3><p>Ansible 有严格的变量优先级顺序。通常，将变量定义在以下位置：</p>
<ul>
<li><strong>清单文件 (<code>inventory</code>):</strong> <code>host_vars</code> 和 <code>group_vars</code> 目录</li>
<li><strong>Playbook:</strong> <code>vars:</code> 节</li>
<li><strong>角色:</strong> <code>vars/main.yml</code>, <code>defaults/main.yml</code></li>
<li><strong>命令行:</strong> <code>-e &quot;key=value&quot;</code></li>
</ul>
<h3 id="6-5-敏感数据管理-Ansible-Vault"><a href="#6-5-敏感数据管理-Ansible-Vault" class="headerlink" title="6.5 敏感数据管理 (Ansible Vault)"></a>6.5 敏感数据管理 (Ansible Vault)</h3><p>用于加密和解密 Playbook 中包含敏感信息的文件或字符串。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建加密文件</span></span><br><span class="line">ansible-vault create vars/secret_vars.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑加密文件</span></span><br><span class="line">ansible-vault edit vars/secret_vars.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Playbook 中使用加密文件</span></span><br><span class="line"><span class="comment"># - import_vars: vars/secret_vars.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行时提供密码</span></span><br><span class="line">ansible-playbook my_playbook.yml --ask-vault-pass</span><br></pre></td></tr></table></figure>

<h3 id="6-6-最佳实践"><a href="#6-6-最佳实践" class="headerlink" title="6.6 最佳实践"></a>6.6 最佳实践</h3><ul>
<li><strong>使用版本控制</strong>：将所有 Playbook、角色和清单文件存入 Git 等版本控制系统。</li>
<li><strong>保持幂等性</strong>：确保每个任务都是幂等的，避免不必要的副作用。</li>
<li><strong>模块化和角色化</strong>：使用角色组织项目，提高重用性和可维护性。</li>
<li><strong>最小权限原则</strong>：使用 <code>become: yes</code> 仅在必要时提升权限。</li>
<li><strong>使用 Ansible Vault</strong>：加密所有敏感数据。</li>
<li><strong>测试 Playbook</strong>：在生产环境部署前，在测试环境中充分测试 Playbook。</li>
<li><strong>动态清单</strong>：对于云环境，使用动态清单脚本自动生成清单。</li>
<li><strong>避免在 Playbook 中硬编码</strong>：使用变量和 Jinja2 模板。</li>
<li><strong>限制更改通知</strong>：仅当实际发生更改时才触发处理器。</li>
</ul>
<h2 id="七、Ansible-的应用场景"><a href="#七、Ansible-的应用场景" class="headerlink" title="七、Ansible 的应用场景"></a>七、Ansible 的应用场景</h2><ul>
<li><strong>配置管理</strong>：管理服务器、网络设备等的基础配置，如安装软件包、配置服务、管理用户等。</li>
<li><strong>应用部署</strong>：自动化部署Web应用、微服务等，包括代码拉取、依赖安装、服务启动等。</li>
<li><strong>系统编排</strong>：协调多个系统之间的操作，例如数据库集群部署、负载均衡配置、滚动升级等。</li>
<li><strong>云资源配置</strong>：与 AWS、Azure、GCP 等云平台集成，自动化虚拟机的创建、网络配置、存储挂载等。</li>
<li><strong>安全自动化</strong>：自动化安全审计、漏洞扫描、安全补丁部署等。</li>
<li><strong>持续集成&#x2F;持续部署 (CI&#x2F;CD)</strong>：作为 CI&#x2F;CD 流水线的一部分，实现自动化测试环境配置、部署到生产环境等。</li>
</ul>
<h2 id="八、总结"><a href="#八、总结" class="headerlink" title="八、总结"></a>八、总结</h2><p>Ansible 以其独特的无代理架构、简洁的 YAML 语法和强大的自动化能力，成为 DevOps 领域不可或缺的工具。它能够将复杂且重复的运维任务转化为可重复、可追溯且高效的自动化流程，极大地提升了 IT 基础设施的管理效率和一致性。深入理解其核心概念，并遵循最佳实践，能够帮助组织构建稳定、可扩展且安全的自动化运维体系。</p>
<p>Ansible 的学习曲线相对平缓，但其能力深度足以应对从小规模配置到大规模企业级编排的各种挑战。对于任何希望提升运维效率、实现基础设施即代码的团队来说，Ansible 都是一个值得深入投入的强大工具。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg">TeaTang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.tbf1211.xx.kg/195d130ae5a4/">https://blog.tbf1211.xx.kg/195d130ae5a4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tbf1211.xx.kg" target="_blank">1024 维度</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/CI-CD/">CI/CD</a><a class="post-meta__tags" href="/tags/2025/">2025</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover-08.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/82498674876b/" title="RAG（检索增强生成）技术详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-28.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">RAG（检索增强生成）技术详解</div></div><div class="info-2"><div class="info-item-1"> RAG (Retrieval Augmented Generation)，即检索增强生成，是一种结合了检索系统与大型语言模型 (LLM) 的人工智能技术。它旨在提高 LLM 在回答问题、生成文本时的准确性、及时性和事实可靠性，尤其是在处理特定领域知识、最新信息或内部数据时。RAG 通过在生成答案之前，从外部知识库中检索相关信息，并将这些信息作为上下文提供给 LLM，从而“增强”其生成能力。  核心思想：克服大语言模型在知识时效性、幻觉和领域特异性方面的局限性。它通过动态地从权威数据源检索相关、准确的事实依据，并以此为基础指导 LLM 进行生成，使得 LLM 的输出更加准确、可追溯且富含最新信息。    一、为什么需要 RAG？大语言模型的局限性大语言模型（LLMs）在处理自然语言任务方面展现出惊人的能力，但它们也存在一些固有的局限性，RAG 正是为了解决这些问题而生：  知识时效性与更新难题 (Knowledge Staleness)  LLM 的知识来源于其训练数据，这些数据在模型发布后就成为了静态的。它们无法获取最新的事件、实时数据或新形成的知识。 每次需要更新知识时，都可...</div></div></div></a><a class="pagination-related" href="/58479316819e/" title="多轮对话与上下文记忆详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-20.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">多轮对话与上下文记忆详解</div></div><div class="info-2"><div class="info-item-1"> 在构建基于大型语言模型 (LLM) 的交互式应用时，仅仅能够进行单次问答是远远不够的。为了实现自然、流畅且富有意义的交流，我们需要让 LLM 能够进行多轮对话，并且记住并理解对话的先前内容，即拥有上下文记忆 (Context Memory)。这使得 LLM 能够在理解历史信息的基础上对新问题做出连贯且相关的响应。  核心思想：多轮对话要求 LLM “记住”之前的交流内容，并通过各种 “记忆策略” (例如拼接、总结、检索) 来将相关上下文传递给每次新的模型调用，从而实现连贯且智能的交互。    一、什么是多轮对话 (Multi-turn Conversation)多轮对话 指的是用户与 AI 之间的一系列相互关联、彼此依赖的交流轮次。与单轮对话（一次提问，一次回答，对话结束）不同，多轮对话中的每一次交互都会受到先前对话内容的影响，并且会为后续对话提供新的上下文。 特点：  连续性：多个请求和响应构成一个逻辑流，而非孤立的事件。 上下文依赖：用户后续的提问或指令常常省略先前已经提及的信息，需要 AI 自动关联。 共同状态维护：用户和 AI 在对话过程中逐渐建立起对某个主题或任务的共...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/e4825d97fe27/" title="Netlify介绍"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-26.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-17</div><div class="info-item-2">Netlify介绍</div></div><div class="info-2"><div class="info-item-1"> Netlify 是一个领先的自动化平台，用于部署和托管现代 Web 项目。它将持续集成&#x2F;持续部署 (CI&#x2F;CD)、全球内容分发网络 (CDN)、Serverless Functions 和边缘计算等功能整合到一个统一的工作流中。Netlify 广受欢迎，尤其是在 Jamstack 生态系统中，它简化了 Web 应用程序的构建、部署和扩展过程，让开发者能够专注于代码，而无需管理复杂的服务器基础设施。  核心思想：Netlify 提供了一个一站式的“前端云”平台，它将 Git 仓库连接、自动化构建、全球 CDN 部署、Serverless 后端和附加服务无缝集成，旨在为开发者提供最快速、最简便的现代化 Web 应用部署体验。   一、为什么选择 Netlify？传统的 Web 部署通常涉及配置服务器、管理 CDN、设置 CI&#x2F;CD 管道等复杂任务。Netlify 应运而生，解决了这些痛点，提供了一套高效的解决方案：  极简部署：只需连接 Git 仓库，每次代码提交都会自动构建和部署。 Jamstack 优化：完美支持静态站点生成器 (SSG) 和单页应...</div></div></div></a><a class="pagination-related" href="/9ac45568d1c2/" title="WSL2详解：在Windows运行Linux的新标准"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-16.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-22</div><div class="info-item-2">WSL2详解：在Windows运行Linux的新标准</div></div><div class="info-2"><div class="info-item-1"> WSL 2 (适用于 Linux 的 Windows 子系统 2 - Windows Subsystem for Linux 2) 是微软推出的一项技术，它允许开发者在 Windows 操作系统上直接运行原生 Linux 环境，而无需双启动或传统虚拟机。WSL 2 相较于其前身 WSL 1，最大的变化是它运行在一个轻量级的虚拟机中，其中包含一个完整的 Linux 内核，这极大地提升了文件系统性能、系统调用兼容性和 Docker Desktop 的体验。  核心思想：在 Windows 内部无缝集成一个高性能、高度兼容的原生 Linux 环境，兼顾 Windows 的图形界面和 Linux 的命令行工具优势。   一、为什么需要 WSL 2？传统的 Linux 开发环境设置通常涉及以下几种方式：  双系统：需要重启电脑才能切换操作系统，且占用硬盘空间大。 虚拟机 (VirtualBox, VMWare)：性能开销大，与 Windows 系统的集成度不高，共享文件、剪贴板等操作相对繁琐。 WSL 1：提供了一个兼容层，将 Linux 系统调用转换为 Windows NT 内核调用。...</div></div></div></a><a class="pagination-related" href="/a92b9122509b/" title="Ubuntu UFW (Uncomplicated Firewall) 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-05.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-01</div><div class="info-item-2">Ubuntu UFW (Uncomplicated Firewall) 详解</div></div><div class="info-2"><div class="info-item-1"> UFW (Uncomplicated Firewall) 是 Ubuntu Linux 及其衍生发行版中一个简化且易于使用的防火墙配置工具。它作为 iptables 的前端，提供了一个用户友好的命令行界面，让普通用户和系统管理员能够更轻松地管理 Linux 内核的 Netfilter 防火墙规则。UFW 的目标是“不复杂”，即简化防火墙的管理，使其不再令人生畏。  核心思想： UFW 提供了一种高级抽象，将复杂的 iptables 命令封装成少数直观的指令，使得用户无需深入理解 iptables 规则链即可实现基本的防火墙配置。   一、为什么选择 UFW？Linux 系统内置了强大的 Netfilter 框架和 iptables 工具，但 iptables 的语法复杂，规则众多，对于初学者来说学习曲线陡峭。UFW 旨在解决以下问题：  简化防火墙管理：  易于上手：通过简单的命令即可配置常见的防火墙规则，无需掌握复杂的 iptables 语法。 减少错误：简化后的命令减少了因语法错误导致配置失误的风险。   增强系统安全性：  默认拒绝策略：UFW 默认采用“默认拒绝所有传入...</div></div></div></a><a class="pagination-related" href="/1beef2825d33/" title="CMake 与 Make：构建系统之辨"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-26.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-15</div><div class="info-item-2">CMake 与 Make：构建系统之辨</div></div><div class="info-2"><div class="info-item-1"> 在 C&#x2F;C++ 等编译型语言的开发中，构建系统 (Build System) 是将源代码转换成可执行程序、库或其他目标文件的核心环节。CMake 和 Make 是其中两个最常用但职责不同的工具。简单来说，CMake 是一个高级的构建系统生成器 (Build System Generator)，而 Make 是一个低级的构建工具 (Build Tool)，用于执行构建任务。  核心思想：CMake 负责“生成”跨平台的构建配置 (如 Makefile)，而 Make 负责“执行”这些配置来实际编译代码。   一、Make：低级构建工具1.1 什么是 Make？Make 是一个自动化构建工具 (Build Automation Tool)，它的核心职责是读取一个名为 Makefile 的文件，根据文件中定义的规则和依赖关系，执行相应的命令来构建项目。Make 在 Unix&#x2F;Linux 系统上历史悠久且广泛应用，是构建 C&#x2F;C++ 项目的基础工具之一。 1.2 MakefileMakefile 是 Make 工具的配置文件，它定义了：  目标 (Targ...</div></div></div></a><a class="pagination-related" href="/92d90a6caba1/" title="Python 项目管理工具 Poetry 详解"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-29.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-10</div><div class="info-item-2">Python 项目管理工具 Poetry 详解</div></div><div class="info-2"><div class="info-item-1"> Poetry 是一款现代化的 Python 项目管理和打包工具。它将依赖管理、虚拟环境管理、打包和发布功能集成在一个直观的命令行界面中。Poetry 的核心理念是提供一个统一的、声明式的项目配置方式，以 pyproject.toml 文件 (遵循 PEP 518 和 PEP 621) 作为所有项目元数据和依赖的唯一真实来源。  核心思想：Poetry 旨在通过一个工具，简化 Python 项目从创建到发布的全生命周期管理，确保环境隔离、依赖可重现性和便捷的打包发布流程。   一、为什么需要 Poetry？传统的 Python 项目管理方式通常涉及多个工具和手动步骤，带来了诸多痛点：  pip 和 requirements.txt 的局限性： requirements.txt 仅记录直接依赖，不处理传递性依赖，容易导致环境不一致。 缺乏强大的依赖解析能力，解决包版本冲突困难。 没有统一的元数据管理，项目信息分散在 setup.py、README.md 等文件中。   虚拟环境管理不便： 需要手动创建 venv 或 virtualenv，并手动激活、切换。 项目与虚拟环境的关联不够...</div></div></div></a><a class="pagination-related" href="/c1538f7d98a1/" title="DevOps 深度解析"><img class="cover" src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-18.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-27</div><div class="info-item-2">DevOps 深度解析</div></div><div class="info-2"><div class="info-item-1"> DevOps 是一种文化理念、一套实践和一套工具的集合，旨在缩短系统开发生命周期，同时高质量、持续不断地交付软件。它强调开发 (Development) 团队与运维 (Operations) 团队之间的协作与沟通，通过自动化流程、持续反馈和共享责任，打破传统上这两个团队之间的壁垒。  核心思想：DevOps 不仅仅是工具链，更是一种文化转型。它关注整个软件交付价值流的优化，从构思到最终用户，实现快速、可靠、高质量的软件交付。   一、为什么需要 DevOps？在传统的软件开发模式中（如瀑布模型），开发和运维团队通常是分离的，各自有不同的目标和激励机制：  开发团队：追求快速迭代、新功能发布，偏好频繁变更。 运维团队：追求系统稳定、高可用性，偏好减少变更。  这种分离导致了许多问题：  “推诿墙” (Wall of Confusion)：开发和运维之间缺乏沟通和协作，导致部署和维护阶段出现大量冲突和瓶颈。 发布周期长：软件从开发完成到最终上线需要漫长的测试、部署和配置过程。 部署风险高：由于变更频率低且批次大，每次发布都可能带来巨大的风险。 反馈回路慢：问题发现到解决的周期长，难...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/loading.gif" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TeaTang</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">414</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">217</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">80</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/teatang"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:tea.tang1211@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站更多功能即将上线，敬请期待！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9-Ansible%EF%BC%9F"><span class="toc-text">一、为什么选择 Ansible？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Ansible-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">二、Ansible 核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9-Control-Node"><span class="toc-text">2.1 控制节点 (Control Node)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E8%A2%AB%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9-Managed-Node-Target-Host"><span class="toc-text">2.2 被管理节点 (Managed Node &#x2F; Target Host)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%B8%85%E5%8D%95-Inventory"><span class="toc-text">2.3 清单 (Inventory)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E6%A8%A1%E5%9D%97-Module"><span class="toc-text">2.4 模块 (Module)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E4%BB%BB%E5%8A%A1-Task"><span class="toc-text">2.5 任务 (Task)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E5%89%A7%E6%9C%AC-Playbook"><span class="toc-text">2.6 剧本 (Playbook)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-%E5%89%A7-Play"><span class="toc-text">2.7 剧 (Play)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-%E8%A7%92%E8%89%B2-Role"><span class="toc-text">2.8 角色 (Role)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-%E4%BA%8B%E5%AE%9E-Facts"><span class="toc-text">2.9 事实 (Facts)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-%E5%8F%98%E9%87%8F-Variables"><span class="toc-text">2.10 变量 (Variables)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11-%E5%A4%84%E7%90%86%E5%99%A8-Handler"><span class="toc-text">2.11 处理器 (Handler)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-12-%E4%BF%9D%E9%99%A9%E5%BA%93-Vault"><span class="toc-text">2.12 保险库 (Vault)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Ansible-%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">三、Ansible 架构与工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88"><span class="toc-text">3.1 架构概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">3.2 工作原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Ansible-%E7%9A%84%E5%85%B3%E9%94%AE%E7%89%B9%E6%80%A7%E4%B8%8E%E4%BC%98%E5%8A%BF"><span class="toc-text">四、Ansible 的关键特性与优势</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81Ansible-%E5%85%A5%E9%97%A8%E7%A4%BA%E4%BE%8B"><span class="toc-text">五、Ansible 入门示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%AE%89%E8%A3%85-Ansible"><span class="toc-text">5.1 安装 Ansible</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%88%9B%E5%BB%BA%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6-Inventory"><span class="toc-text">5.2 创建清单文件 (Inventory)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E8%BF%90%E8%A1%8C-Ad-hoc-%E5%91%BD%E4%BB%A4"><span class="toc-text">5.3 运行 Ad-hoc 命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E7%BC%96%E5%86%99%E5%B9%B6%E6%89%A7%E8%A1%8C%E7%AC%AC%E4%B8%80%E4%B8%AA-Playbook"><span class="toc-text">5.4 编写并执行第一个 Playbook</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E9%AB%98%E7%BA%A7%E6%A6%82%E5%BF%B5%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">六、高级概念与最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E8%A7%92%E8%89%B2-Roles-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">6.1 角色 (Roles) 的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E6%A8%A1%E6%9D%BF-Templates-%E4%B8%8E-Jinja2"><span class="toc-text">6.2 模板 (Templates) 与 Jinja2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%BE%AA%E7%8E%AF-Loops-%E5%92%8C%E6%9D%A1%E4%BB%B6-Conditions"><span class="toc-text">6.3 循环 (Loops) 和条件 (Conditions)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86"><span class="toc-text">6.4 变量管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86-Ansible-Vault"><span class="toc-text">6.5 敏感数据管理 (Ansible Vault)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">6.6 最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81Ansible-%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">七、Ansible 的应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">八、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/24ffc0bedb41/" title="IPFS (InterPlanetary File System) 详解"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-09.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="IPFS (InterPlanetary File System) 详解"/></a><div class="content"><a class="title" href="/24ffc0bedb41/" title="IPFS (InterPlanetary File System) 详解">IPFS (InterPlanetary File System) 详解</a><time datetime="2025-12-16T22:24:00.000Z" title="发表于 2025-12-17 06:24:00">2025-12-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/bfcc84247c6a/" title="智能体 (Agent) 详解：深入 LangChain 开发实践"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="智能体 (Agent) 详解：深入 LangChain 开发实践"/></a><div class="content"><a class="title" href="/bfcc84247c6a/" title="智能体 (Agent) 详解：深入 LangChain 开发实践">智能体 (Agent) 详解：深入 LangChain 开发实践</a><time datetime="2025-12-10T22:24:00.000Z" title="发表于 2025-12-11 06:24:00">2025-12-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/28f993be5cfe/" title="Bun.js 深度解析：冷启动与边缘函数优化"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-22.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Bun.js 深度解析：冷启动与边缘函数优化"/></a><div class="content"><a class="title" href="/28f993be5cfe/" title="Bun.js 深度解析：冷启动与边缘函数优化">Bun.js 深度解析：冷启动与边缘函数优化</a><time datetime="2025-12-07T22:24:00.000Z" title="发表于 2025-12-08 06:24:00">2025-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/bcbe0f78ef1d/" title="Go Jaeger 深度解析：分布式追踪实践"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-20.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go Jaeger 深度解析：分布式追踪实践"/></a><div class="content"><a class="title" href="/bcbe0f78ef1d/" title="Go Jaeger 深度解析：分布式追踪实践">Go Jaeger 深度解析：分布式追踪实践</a><time datetime="2025-12-04T22:24:00.000Z" title="发表于 2025-12-05 06:24:00">2025-12-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/15920229f914/" title="Supabase 深度解析"><img src="/img/loading.gif" data-lazy-src="/img/cover/default_cover-13.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Supabase 深度解析"/></a><div class="content"><a class="title" href="/15920229f914/" title="Supabase 深度解析">Supabase 深度解析</a><time datetime="2025-12-02T22:24:00.000Z" title="发表于 2025-12-03 06:24:00">2025-12-03</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/default_cover-08.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">我的轨迹</div><div class="footer-flex-content"><a href="/archives/2023/" target="_blank" title="📌 2023">📌 2023</a><a href="/archives/2024/" target="_blank" title="❓ 2024">❓ 2024</a><a href="/archives/2025/" target="_blank" title="🚀 2025">🚀 2025</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">维度</div><div class="footer-flex-content"><a href="/categories/" target="_blank" title="分类">分类</a><a href="/tags/" target="_blank" title="标签">标签</a><a href="/categories/" target="_blank" title="时间线">时间线</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/shuoshuo" target="_blank" title="说说">说说</a></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2025 By TeaTang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.7/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script></div><script data-pjax src="/self/btf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="ture"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,200,200" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js" defer="defer"></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      true
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><script>(() => {
  const option = null
  const config = {"site_uv":true,"site_pv":true,"page_pv":true,"token":"qTvz1SkmPDt785fgh6BpiA5qiFFIVUwxj8Ft+rPW+cdN59v1hXjwRgSmy0+ji9m+oLlcxvo2NfDSMa6epVl3NTlsN3ejCIwWeP8Y51aEJ0Sbem4UexGmJLspB7AkOBId2SdtT6QWEBlGmFIIQgchQ2zAKYxTmc/kpBED5aLSr+3uvmQ9/G7FJQeVFpveDkK0xM1hu36xq4a6/FSeROxtoEp5zabzTWiYTlLsQzIl/NlELnCq3nxK+oo/vl3UQo/oM/rae/gJX/MaVKsgIUCd2ABJogNkx2KTenBIBpbPki5FzOgPh6/z4GPa4HvhNO51DDVG1SEQZooqEYmt/gnybLBWFbN+7liZWw=="}

  const runTrack = () => {
    if (typeof umami !== 'undefined' && typeof umami.track === 'function') {
      umami.track(props => ({ ...props, url: window.location.pathname, title: GLOBAL_CONFIG_SITE.title }))
    } else {
      console.warn('Umami Analytics: umami.track is not available')
    }
  }

  const loadUmamiJS = () => {
    btf.getScript('https://umami.012700.xyz/script.js', {
      'data-website-id': '2a796d6c-6499-42d8-8eb4-d9a2930b0ff3',
      'data-auto-track': 'false',
      ...option
    }).then(() => {
      runTrack()
    }).catch(error => {
      console.error('Umami Analytics: Error loading script', error)
    })
  }

  const getData = async (isPost) => {
    try {
      const now = Date.now()
      const keyUrl = isPost ? `&url=${window.location.pathname}&path=${window.location.pathname}` : ''
      const headerList = { 'Accept': 'application/json' }

      if (true) {
        headerList['Authorization'] = `Bearer ${config.token}`
      } else {
        headerList['x-umami-api-key'] = config.token
      }

      const res = await fetch(`https://umami.012700.xyz/api/websites/2a796d6c-6499-42d8-8eb4-d9a2930b0ff3/stats?startAt=0000000000&endAt=${now}${keyUrl}`, {
        method: "GET",
        headers: headerList
      })

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`)
      }

      return await res.json()
    } catch (error) {
      console.error('Umami Analytics: Failed to fetch data', error)
      throw error
    }
  }

  const insertData = async () => {
    try {
      if (GLOBAL_CONFIG_SITE.pageType === 'post' && config.page_pv) {
        const pagePV = document.getElementById('umamiPV')
        if (pagePV) {
          const data = await getData(true)
          if (data && data.pageviews) {
            pagePV.textContent = typeof data.pageviews.value !== 'undefined' ? data.pageviews.value : data.pageviews
          } else {
            console.warn('Umami Analytics: Invalid page view data received')
          }
        }
      }

      if (config.site_uv || config.site_pv) {
        const data = await getData(false)

        if (config.site_uv) {
          const siteUV = document.getElementById('umami-site-uv')
          if (siteUV && data && data.visitors) {
            siteUV.textContent = typeof data.visitors.value !== 'undefined' ? data.visitors.value : data.visitors
          } else if (siteUV) {
            console.warn('Umami Analytics: Invalid site UV data received')
          }
        }

        if (config.site_pv) {
          const sitePV = document.getElementById('umami-site-pv')
          if (sitePV && data && data.pageviews) {
            sitePV.textContent = typeof data.pageviews.value !== 'undefined' ? data.pageviews.value : data.pageviews
          } else if (sitePV) {
            console.warn('Umami Analytics: Invalid site PV data received')
          }
        }
      }
    } catch (error) {
      console.error('Umami Analytics: Failed to insert data', error)
    }
  }

  btf.addGlobalFn('pjaxComplete', runTrack, 'umami_analytics_run_track')
  btf.addGlobalFn('pjaxComplete', insertData, 'umami_analytics_insert')


  loadUmamiJS()

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', insertData)
  } else {
    setTimeout(insertData, 100)
  }
})()</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.3"></script></div></div></body></html>